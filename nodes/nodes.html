
<!-- --- [red-module:node-red/junction] --- -->
<!--
  05-junction.html
  This file exists so that the runtime loads the Junction node into the registry,
  but it is empty so it doesn't appear in the editor palette
-->

<!-- --- [red-module:node-red/inject] --- -->
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-template-name="inject">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>

    <div class="form-row node-input-property-container-row">
        <ol id="node-input-property-container"></ol>
    </div>

    <div class="form-row" id="node-once">
        <label for="node-input-once">&nbsp;</label>
        <input type="checkbox" id="node-input-once" style="display:inline-block; width:15px; vertical-align:baseline;">
        <span data-i18n="inject.onstart"></span>&nbsp;
        <input type="text" id="node-input-onceDelay" placeholder="0.1" style="width:45px; height:28px;">&nbsp;
        <span data-i18n="inject.onceDelay"></span>
    </div>

    <div class="form-row">
        <label for=""><i class="fa fa-repeat"></i> <span data-i18n="inject.label.repeat"></span></label>
        <select id="inject-time-type-select">
            <option value="none" data-i18n="inject.none"></option>
            <option value="interval" data-i18n="inject.interval"></option>
            <option value="interval-time" data-i18n="inject.interval-time"></option>
            <option value="time" data-i18n="inject.time"></option>
        </select>
        <input type="hidden" id="node-input-repeat">
        <input type="hidden" id="node-input-crontab">
    </div>

    <div class="form-row inject-time-row hidden" id="inject-time-row-interval">
        <span data-i18n="inject.every"></span>
        <input id="inject-time-interval-count" class="inject-time-count" value="1"></input>
        <select style="width:100px" id="inject-time-interval-units">
            <option value="s" data-i18n="inject.seconds"></option>
            <option value="m" data-i18n="inject.minutes"></option>
            <option value="h" data-i18n="inject.hours"></option>
        </select><br/>
    </div>

    <div class="form-row inject-time-row hidden" id="inject-time-row-interval-time">
        <span data-i18n="inject.every"></span> <select style="width:90px; margin-left:20px;" id="inject-time-interval-time-units" class="inject-time-int-count" value="1">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="10">10</option>
            <option value="12">12</option>
            <option value="15">15</option>
            <option value="20">20</option>
            <option value="30">30</option>
            <option value="0">60</option>
        </select> <span data-i18n="inject.minutes"></span><br/>
        <span data-i18n="inject.between"></span> <select id="inject-time-interval-time-start" class="inject-time-times"></select>
        <span data-i18n="inject.and"></span> <select id="inject-time-interval-time-end" class="inject-time-times"></select><br/>
        <div id="inject-time-interval-time-days" class="inject-time-days" style="margin-top:5px">
            <div style="display:inline-block; vertical-align:top; margin-right:5px;" data-i18n="inject.on">on</div>
            <div style="display:inline-block;">
                <div>
                    <label><input type='checkbox' checked value='1'/> <span data-i18n="inject.days.0"></span></label>
                    <label><input type='checkbox' checked value='2'/> <span data-i18n="inject.days.1"></span></label>
                    <label><input type='checkbox' checked value='3'/> <span data-i18n="inject.days.2"></span></label>
                </div>
                <div>
                    <label><input type='checkbox' checked value='4'/> <span data-i18n="inject.days.3"></span></label>
                    <label><input type='checkbox' checked value='5'/> <span data-i18n="inject.days.4"></span></label>
                    <label><input type='checkbox' checked value='6'/> <span data-i18n="inject.days.5"></span></label>
                </div>
                <div>
                    <label><input type='checkbox' checked value='0'/> <span data-i18n="inject.days.6"></span></label>
                </div>
            </div>
        </div>
    </div>

    <div class="form-row inject-time-row hidden" id="inject-time-row-time">
        <span data-i18n="inject.at"></span> <input type="text" id="inject-time-time" value="12:00"></input><br/>
        <div id="inject-time-time-days" class="inject-time-days">
            <div style="display:inline-block; vertical-align:top; margin-right:5px;" data-i18n="inject.on"></div>
            <div style="display:inline-block;">
                <div>
                    <label><input type='checkbox' checked value='1'/> <span data-i18n="inject.days.0"></span></label>
                    <label><input type='checkbox' checked value='2'/> <span data-i18n="inject.days.1"></span></label>
                    <label><input type='checkbox' checked value='3'/> <span data-i18n="inject.days.2"></span></label>
                </div>
                <div>
                    <label><input type='checkbox' checked value='4'/> <span data-i18n="inject.days.3"></span></label>
                    <label><input type='checkbox' checked value='5'/> <span data-i18n="inject.days.4"></span></label>
                    <label><input type='checkbox' checked value='6'/> <span data-i18n="inject.days.5"></span></label>
                </div>
                <div>
                    <label><input type='checkbox' checked value='0'/> <span data-i18n="inject.days.6"></span></label>
                </div>
            </div>
        </div>
    </div>

</script>
<style>
    .inject-time-row {
        padding-left: 110px;
    }
    .inject-time-row:not(#inject-time-row-interval) select {
        margin: 3px 0;
    }
    .inject-time-days label {
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        vertical-align: baseline;
        width: 100px;
    }
    .inject-time-days input {
        width: auto !important;
        vertical-align: baseline !important;
    }
    .inject-time-times {
        width: 90px !important;
    }
    #inject-time-time {
        width: 75px;
        margin-left: 8px;
        margin-bottom: 8px;
    }
    .inject-time-count {
        padding-left: 3px !important;
        width: 80px !important;
    }
</style>

<script type="text/javascript">
(function() {

    function resizeDialog(size) {
        size = size || { height: $(".red-ui-tray-content form").height() }
        var rows = $("#dialog-form>div:not(.node-input-property-container-row):visible");
        var height = size.height;
        for (var i=0; i<rows.length; i++) {
            height -= $(rows[i]).outerHeight(true);
        }
        var editorRow = $("#dialog-form>div.node-input-property-container-row");
        height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));
        height += 16;
        $("#node-input-property-container").editableList('height',height);
    }
    /** Retrieve editableList items (refactored for re-use in the form inject button)*/
    function getProps(el, legacy) {
        var result = {
            props: []
        }
        el.each(function(i) {
            var prop = $(this);
            var p = {
                p:prop.find(".node-input-prop-property-name").typedInput('value')
            };
            if (p.p) {
                p.v = prop.find(".node-input-prop-property-value").typedInput('value');
                p.vt = prop.find(".node-input-prop-property-value").typedInput('type');
                if(legacy) {
                    if (p.p === "payload") { // save payload to old "legacy" property
                        result.payloadType = p.vt;
                        result.payload = p.v;
                        delete p.v;
                        delete p.vt;
                    } else if (p.p === "topic" && p.vt === "str") {
                        result.topic = p.v;
                        delete p.v;
                    }
                }
                result.props.push(p);
            }
        });
        return result;
    }
    /** Perform inject, optionally sending a custom msg (refactored for re-use in the form inject button)*/
    function doInject(node, customMsg) {
        var label = node._def.label.call(node,customMsg?customMsg.__user_inject_props__:undefined);
        if (label.length > 30) {
            label = label.substring(0, 50) + "...";
        }
        label = label.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        $.ajax({
            url: "inject/" + node.id,
            type: "POST",
            data: JSON.stringify(customMsg||{}),
            contentType: "application/json; charset=utf-8",
            success: function (resp) {
                RED.notify(node._("inject.success", { label: label }), { type: "success", id: "inject", timeout: 2000 });
            },
            error: function (jqXHR, textStatus, errorThrown) {
                if (jqXHR.status == 404) {
                    RED.notify(node._("common.notification.error", { message: node._("common.notification.errors.not-deployed") }), "error");
                } else if (jqXHR.status == 500) {
                    RED.notify(node._("common.notification.error", { message: node._("inject.errors.failed") }), "error");
                } else if (jqXHR.status == 0) {
                    RED.notify(node._("common.notification.error", { message: node._("common.notification.errors.no-response") }), "error");
                } else {
                    RED.notify(node._("common.notification.error", { message: node._("common.notification.errors.unexpected", { status: jqXHR.status, message: textStatus }) }), "error");
                }
            }
        });
    }
    RED.nodes.registerType('inject',{  
        category: 'common',
        color:"#a6bbcf",
        defaults: {
            name: {value:""},
            props:{value:[{p:"payload"},{p:"topic",vt:"str"}], validate:function(v, opt) {
                    if (!v || v.length === 0) { return true }
                    const errors = []
                    for (var i=0;i<v.length;i++) {
                        if (/^\${[^}]+}$/.test(v[i].v)) {
                            // Allow ${ENV_VAR} value
                            continue
                        }
                        if (/msg|flow|global/.test(v[i].vt)) {
                            if (!RED.utils.validatePropertyExpression(v[i].v)) {
                                errors.push(RED._("node-red:inject.errors.invalid-prop", { prop: 'msg.'+v[i].p, error: v[i].v }))
                            }
                        } else if (v[i].vt === "jsonata") {
                            try{ jsonata(v[i].v); }
                            catch(e){
                                errors.push(RED._("node-red:inject.errors.invalid-jsonata", { prop: 'msg.'+v[i].p, error: e.message }))
                            }
                        } else if (v[i].vt === "json") {
                            try{ JSON.parse(v[i].v); }
                            catch(e){
                                errors.push(RED._("node-red:inject.errors.invalid-json", { prop: 'msg.'+v[i].p, error: e.message }))
                            }
                        } else if (v[i].vt === "num"){
                            if (!/^[+-]?[0-9]*\.?[0-9]*([eE][-+]?[0-9]+)?$/.test(v[i].v)) {
                                errors.push(RED._("node-red:inject.errors.invalid-prop", { prop: 'msg.'+v[i].p, error: v[i].v }))
                            }
                        }
                    }
                    if (errors.length > 0) {
                        return errors
                    }
                    return true;
                }
            },
            repeat: {
                value:"", validate: function(v, opt) {
                    if ((v === "") ||
                        (RED.validators.number()(v) &&
                         (v >= 0) && (v <= 2147483))) {
                        return true;
                    }
                    return RED._("node-red:inject.errors.invalid-repeat");
                }
            },
            crontab: {value:""},
            once: {value:false},
            onceDelay: {value:0.1, validate: RED.validators.number(true)},
            topic: {value:""},
            payload: {value:"", validate: RED.validators.typedInput("payloadType", false) },
            payloadType: {value:"date"},
        },
        icon: "inject.svg",
        inputs:0,
        outputs:1,
        outputLabels: function(index) {
            var lab = '';

            // if only payload and topic - display payload type
            // if only one property - show it's type
            // if more than one property (other than payload and topic) - show "x properties" where x is the number of properties.
            // this.props will not be an array for legacy inject nodes until they are re-deployed
            //
            var props = this.props;
            if (!Array.isArray(props)) {
                props = [
                    { p:"payload", v: this.payload, vt: this.payloadType },
                    { p:"topic", v: this.topic, vt: "str" }
                ]
            }
            if (props) {
                for (var i=0,l=props.length; i<l; i++) {
                    if (i > 0) lab += "\n";
                    if (i === 5) {
                        lab += "... +"+(props.length-5);
                        break;
                    }
                    lab += props[i].p+": ";

                    var propType = props[i].p === "payload"? this.payloadType : props[i].vt;
                    if (propType === "json") {
                        try {
                            var parsedProp = JSON.parse(props[i].p === "payload"? this.payload : props[i].v);
                            propType = typeof parsedProp;
                            if (propType === "object" && Array.isArray(parsedProp)) {
                                propType = "Array";
                            }
                        } catch(e) {
                            propType = "invalid";
                        }
                    }
                    lab += this._("inject.label."+propType);
                }
            }
            return lab;
        },
        label: function(customProps) {
            var suffix = "";
            // if fire once then add small indication
            if (this.once) {
                suffix = " ¹";
            }
            // but replace with repeat one if set to repeat
            if ((this.repeat && this.repeat != 0) || this.crontab) {
                suffix = "\t↻";
            }
            if (this.name) {
                return this.name+suffix;
            }
            var payload = "";
            var payloadType = "str";
            var topic = "";
            if (customProps) {
                for (var i=0;i<customProps.length;i++) {
                    if (customProps[i].p === "payload") {
                        payload = customProps[i].v;
                        payloadType = customProps[i].vt;
                    } else if (customProps[i].p === "topic") {
                        topic = customProps[i].v;
                    }
                }
            } else {
                payload = this.payload || "";
                payloadType = this.payloadType || "str";
                topic = this.topic || "";
            }
            if (payloadType === "string" ||
                    payloadType === "str" ||
                    payloadType === "num" ||
                    payloadType === "bool" ||
                    payloadType === "json") {
                if ((topic !== "") && ((topic.length + payload.length) <= 32)) {
                    return topic + ":" + payload+suffix;
                } else if (payload.length > 0 && payload.length < 24) {
                    return payload+suffix;
                } else {
                    return this._("inject.inject")+suffix;
                }
            } else if (payloadType === 'date' || payloadType === 'bin' || payloadType === 'env') {
                if ((topic !== "") && (topic.length <= 16)) {
                    return topic + ":" + this._('inject.label.'+payloadType)+suffix;
                } else {
                    return this._('inject.label.'+payloadType)+suffix;
                }
            } else if (payloadType === 'flow' || payloadType === 'global') {
                var key = RED.utils.parseContextKey(payload);
                return payloadType+"."+key.key+suffix;
            } else {
                return this._("inject.inject")+suffix;
            }
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            var node = this;
            var payloadType = node.payloadType;

            if (node.payloadType == null) {
                if (node.payload == "") {
                    payloadType = "date";
                } else {
                    payloadType = "str";
                }
            } else if (node.payloadType === 'string' || node.payloadType === 'none') {
                payloadType = "str";
            }

            $("#inject-time-type-select").on("change", function() {
                $("#node-input-crontab").val('');
                var id = $("#inject-time-type-select").val();
                $(".inject-time-row").hide();
                $("#inject-time-row-"+id).show();

                // Scroll down
                var scrollDiv = $("#dialog-form").parent();
                scrollDiv.scrollTop(scrollDiv.prop('scrollHeight'));
                resizeDialog();
            });

            $("#node-input-once").on("change", function() {
                $("#node-input-onceDelay").attr('disabled', !$("#node-input-once").prop('checked'));
            })

            $(".inject-time-times").each(function() {
                for (var i=0; i<24; i++) {
                    var l = (i<10?"0":"")+i+":00";
                    $(this).append($("<option></option>").val(i).text(l));
                }
            });
            $("<option></option>").val(24).text("00:00").appendTo("#inject-time-interval-time-end");
            $("#inject-time-interval-time-start").on("change", function() {
                var start = Number($("#inject-time-interval-time-start").val());
                var end = Number($("#inject-time-interval-time-end").val());
                $("#inject-time-interval-time-end option").remove();
                for (var i=start+1; i<25; i++) {
                    var l = (i<10?"0":"")+i+":00";
                    if (i==24) {
                        l = "00:00";
                    }
                    var opt = $("<option></option>").val(i).text(l).appendTo("#inject-time-interval-time-end");
                    if (i === end) {
                        opt.attr("selected","selected");
                    }
                }
            });

            $(".inject-time-count").spinner({
                //max:60,
                min:1
            });

            var repeattype = "none";
            if (node.repeat != "" && node.repeat != 0) {
                repeattype = "interval";
                var r = "s";
                var c = node.repeat;
                if (node.repeat % 60 === 0) { r = "m"; c = c/60; }
                if (node.repeat % 1440 === 0) { r = "h"; c = c/60; }
                $("#inject-time-interval-count").val(c);
                $("#inject-time-interval-units").val(r);
                $("#inject-time-interval-days").prop("disabled","disabled");
            } else if (node.crontab) {
                var cronparts = node.crontab.split(" ");
                var days = cronparts[4];
                if (!isNaN(cronparts[0]) && !isNaN(cronparts[1])) {
                    repeattype = "time";
                    // Fixed time
                    var time = cronparts[1]+":"+cronparts[0];
                    $("#inject-time-time").val(time);
                    $("#inject-time-type-select").val("s");
                    if (days == "*") {
                        $("#inject-time-time-days input[type=checkbox]").prop("checked",true);
                    } else {
                        $("#inject-time-time-days input[type=checkbox]").removeAttr("checked");
                        days.split(",").forEach(function(v) {
                            $("#inject-time-time-days [value=" + v + "]").prop("checked", true);
                        });
                    }
                } else {
                    repeattype = "interval-time";
                    // interval - time period
                    var minutes = cronparts[0].slice(2);
                    if (minutes === "") { minutes = "0"; }
                    $("#inject-time-interval-time-units").val(minutes);
                    if (days == "*") {
                        $("#inject-time-interval-time-days input[type=checkbox]").prop("checked",true);
                    } else {
                        $("#inject-time-interval-time-days input[type=checkbox]").removeAttr("checked");
                        days.split(",").forEach(function(v) {
                            $("#inject-time-interval-time-days [value=" + v + "]").prop("checked", true);
                        });
                    }
                    var time = cronparts[1];
                    var timeparts = time.split(",");
                    var start;
                    var end;
                    if (timeparts.length == 1) {
                        // 0 or 0-10
                        var hours = timeparts[0].split("-");
                        if (hours.length == 1) {
                            if (hours[0] === "") {
                                start = "0";
                                end = "0";
                            }
                            else {
                                start = hours[0];
                                end = Number(hours[0])+1;
                            }
                        } else {
                            start = hours[0];
                            end = Number(hours[1])+1;
                        }
                    } else {
                        // 23,0 or 17-23,0-10 or 23,0-2 or 17-23,0
                        var startparts = timeparts[0].split("-");
                        start = startparts[0];

                        var endparts = timeparts[1].split("-");
                        if (endparts.length == 1) {
                            end = Number(endparts[0])+1;
                        } else {
                            end = Number(endparts[1])+1;
                        }
                    }
                    $("#inject-time-interval-time-end").val(end);
                    $("#inject-time-interval-time-start").val(start);

                }
            } else {
                $("#inject-time-type-select").val("none");
            }

            $(".inject-time-row").hide();
            $("#inject-time-type-select").val(repeattype);
            $("#inject-time-row-"+repeattype).show();

            /* */

            var eList = $('#node-input-property-container').css('min-height','120px').css('min-width','450px');

            eList.editableList({
                buttons: [
                    {
                        id: "node-inject-test-inject-button",
                        label: node._("inject.injectNow"),
                        click: function(e) {
                            var items = eList.editableList('items');
                            var props = getProps(items);
                            var m = {__user_inject_props__: props.props};
                            doInject(node, m);
                        }
                    }
                ],
                addItem: function(container,i,opt) {
                    var prop = opt;
                    if (!prop.hasOwnProperty('p')) {
                        prop = {p:"",v:"",vt:"str"};
                    }
                    container.css({
                        overflow: 'hidden',
                        whiteSpace: 'nowrap'
                    });
                    var row = $('<div/>').appendTo(container);

                    var propertyName = $('<input/>',{class:"node-input-prop-property-name",type:"text"})
                        .css("width","30%")
                        .appendTo(row)
                        .typedInput({types:['msg']});

                    $('<div/>',{style: 'display:inline-block; padding:0px 6px;'})
                        .text('=')
                        .appendTo(row);

                    var propertyValue = $('<input/>',{class:"node-input-prop-property-value",type:"text"})
                        .css("width","calc(70% - 30px)")
                        .appendTo(row)
                        .typedInput({default:prop.vt || 'str',types:['flow','global','str','num','bool','json','bin','date','jsonata','env','msg']});

                    propertyName.typedInput('value',prop.p);
                    propertyValue.typedInput('value',prop.v);
                },
                removable: true,
                sortable: true
            });
            $('#node-inject-test-inject-button').css("float", "right").css("margin-right", "unset");

            if (RED.nodes.subflow(node.z)) {
                $('#node-inject-test-inject-button').attr("disabled",true);
            }

            if (!node.props) {
                var payload = {
                    p:'payload',
                    v: node.payload ? node.payload : '',
                    vt:payloadType ? payloadType : 'date'
                };
                var topic = {
                    p:'topic',
                    v: node.topic ? node.topic : '',
                    vt:'str'
                }
                node.props = [payload,topic];
            }

            for (var i=0; i<node.props.length; i++) {
                var prop = node.props[i];
                var newProp = { p: prop.p, v: prop.v, vt: prop.vt };
                if (newProp.v === undefined) {
                    if (prop.p === 'payload') {
                        newProp.v = node.payload ? node.payload : '';
                        newProp.vt = payloadType ? payloadType : 'date';
                    } else if (prop.p === 'topic' && prop.vt === "str") {
                        newProp.v =  node.topic ? node.topic : '';
                    }
                }
                if (newProp.vt === "string") {
                    // Fix bug in pre 2.1 where an old Inject node might have
                    // a migrated rule with type 'string' not 'str'
                    newProp.vt = "str";
                }
                eList.editableList('addItem',newProp);
            }

            $("#inject-time-type-select").trigger("change");
            $("#inject-time-interval-time-start").trigger("change");

        },
        oneditsave: function() {
            var repeat = "";
            var crontab = "";
            var type = $("#inject-time-type-select").val();
            if (type == "none") {
                // nothing
            } else if (type == "interval") {
                var count = $("#inject-time-interval-count").val();
                var units = $("#inject-time-interval-units").val();
                if (units == "s") {
                    repeat = count;
                } else {
                    if (units == "m") {
                        //crontab = "*/"+count+" * * * "+days;
                        repeat = count * 60;
                    } else if (units == "h") {
                        //crontab = "0 */"+count+" * * "+days;
                        repeat = count * 60 * 60;
                    }
                }
            } else if (type == "interval-time") {
                repeat = "";
                var count = $("#inject-time-interval-time-units").val();
                var startTime = Number($("#inject-time-interval-time-start").val());
                var endTime = Number($("#inject-time-interval-time-end").val());
                var days = $('#inject-time-interval-time-days input[type=checkbox]:checked').map(function(_, el) {
                    return $(el).val()
                }).get();
                if (days.length == 0) {
                    crontab = "";
                } else {
                    if (days.length == 7) {
                        days="*";
                    } else {
                        days = days.join(",");
                    }
                    var timerange = "";
                    if (endTime == 0) {
                        timerange = startTime+"-23";
                    } else if (startTime+1 < endTime) {
                        timerange = startTime+"-"+(endTime-1);
                    } else if (startTime+1 == endTime) {
                        timerange = startTime;
                    } else {
                        var startpart = "";
                        var endpart = "";
                        if (startTime == 23) {
                            startpart = "23";
                        } else {
                            startpart = startTime+"-23";
                        }
                        if (endTime == 1) {
                            endpart = "0";
                        } else {
                            endpart = "0-"+(endTime-1);
                        }
                        timerange = startpart+","+endpart;
                    }
                    if (count === "0") {
                        crontab = count+" "+timerange+" * * "+days;
                    } else {
                        crontab = "*/"+count+" "+timerange+" * * "+days;
                    }
                }
            } else if (type == "time") {
                var time = $("#inject-time-time").val();
                var days = $('#inject-time-time-days  input[type=checkbox]:checked').map(function(_, el) {
                    return $(el).val()
                }).get();
                if (days.length == 0) {
                    crontab = "";
                } else {
                    if (days.length == 7) {
                        days="*";
                    } else {
                        days = days.join(",");
                    }
                    var parts = time.split(":");
                    if (parts.length === 2) {
                        repeat = "";
                        parts[1] = ("00" + (parseInt(parts[1]) % 60)).substr(-2);
                        parts[0] = ("00" + (parseInt(parts[0]) % 24)).substr(-2);
                        crontab = parts[1]+" "+parts[0]+" * * "+days;
                    }
                    else { crontab = ""; }
                }
            }

            $("#node-input-repeat").val(repeat);
            $("#node-input-crontab").val(crontab);

            /* Gather the properties */
            var items = $("#node-input-property-container").editableList('items');
            delete this.payloadType;
            delete this.payload;
            this.topic = "";
            var result = getProps(items, true);
            this.props = result.props;
            if(result.hasOwnProperty('payloadType')) { this.payloadType = result.payloadType; };
            if(result.hasOwnProperty('payload')) { this.payload = result.payload; };
            if(result.hasOwnProperty('topic')) { this.topic = result.topic; };
        },
        button: {
            enabled: function() {
                return !this.changed
            },
            onclick: function () {
                if (this.changed) {
                    return RED.notify(RED._("notification.warning", { message: RED._("notification.warnings.undeployedChanges") }), "warning");
                }
                doInject(this);
            }
        },
        oneditresize: resizeDialog
    });
})();
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="inject">
<p>Injects a message into a flow either manually or at regular intervals. The message
payload can be a variety of types, including strings, JavaScript objects or the current time.</p>
<h3>Outputs</h3>
<dl class="message-properties">
    <dt>payload<span class="property-type">various</span></dt>
    <dd>The configured payload of the message.</dd>
    <dt class="optional">topic <span class="property-type">string</span></dt>
    <dd>An optional property that can be configured in the node.</dd>
</dl>
<h3>Details</h3>
<p>The Inject node can initiate a flow with a specific payload value.
The default payload is a timestamp of the current time in millisecs since January 1st, 1970.</p>
<p>The node also supports injecting strings, numbers, booleans, JavaScript objects, or flow/global context values.</p>
<p>By default, the node is triggered manually by clicking on its button within the editor. It can also be set to
inject at regular intervals or according to a schedule.</p>
<p>It can also be configured to inject once each time the flows are started.</p>
<p>The maximum <i>Interval</i> that can be specified is about 596 hours / 24 days. However if you are looking at intervals
greater than one day you should consider using a scheduler node that can cope with power outages and restarts.</p>
<p><b>Note</b>: The <i>"Interval between times"</i> and <i>"at a specific time"</i> options use the standard cron system.
This means that 20 minutes will be at the next hour, 20 minutes past and 40 minutes past - not in 20 minutes time.
If you want every 20 minutes from now - use the <i>"interval"</i> option.</p>
<p><b>Note</b>: To include a newline in a string you must use the Function or Template node to create the payload.</p>
</script>

<!-- --- [red-module:node-red/debug] --- -->

<script type="text/html" data-template-name="debug">
    <div class="form-row">
        <label for="node-input-typed-complete"><i class="fa fa-list"></i> <span data-i18n="debug.output"></span></label>
        <input id="node-input-typed-complete" type="text" style="width: 70%">
        <input id="node-input-complete" type="hidden">
        <input id="node-input-targetType" type="hidden">
    </div>
    <div class="form-row">
        <label for="node-input-tosidebar"><i class="fa fa-random"></i> <span data-i18n="debug.to"></span></label>
        <label for="node-input-tosidebar" style="width:70%">
        <input type="checkbox" id="node-input-tosidebar" style="display:inline-block; width:22px; vertical-align:top;"><span data-i18n="debug.toSidebar"></span>
        </label>
    </div>
    <div class="form-row">
        <label for="node-input-console"> </label>
        <label for="node-input-console" style="width:70%">
        <input type="checkbox" id="node-input-console" style="display:inline-block; width:22px; vertical-align:top;"><span data-i18n="debug.toConsole"></span>
        </label>
    </div>
    <div class="form-row">
    <label for="node-input-tostatus"> </label>
    <label for="node-input-tostatus" style="width:70%">
        <input type="checkbox" id="node-input-tostatus" style="display:inline-block; width:22px; vertical-align:top;"><span data-i18n="debug.toStatus"></span>
    </label>
    </div>
    <div class="form-row" id="node-tostatus-line">
        <label for="node-input-typed-status"></label>
        <input id="node-input-typed-status" type="text" style="width: 70%">
        <input id="node-input-statusVal" type="hidden">
        <input id="node-input-statusType" type="hidden">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
</script>

<script src="debug/view/debug-utils.js"></script>

<script type="text/javascript">
(function() {
    var subWindow = null;

    function activateAjaxCall(node, active, successCallback) {
        var url;
        var body;

        if (Array.isArray(node)) {
            url = "debug/"+(active?"enable":"disable");
            body = {nodes: node.map(function(n) { return n.id})}
            node = node[0];
        } else {
            url = "debug/"+node.id+"/"+(active?"enable":"disable");
        }
        $.ajax({
            url: url,
            type: "POST",
            data: body,
            success: successCallback,
            error: function(jqXHR,textStatus,errorThrown) {
                if (jqXHR.status == 404) {
                    RED.notify(node._("common.notification.error", {message: node._("common.notification.errors.not-deployed")}),"error");
                } else if (jqXHR.status === 0) {
                    RED.notify(node._("common.notification.error", {message: node._("common.notification.errors.no-response")}),"error");
                } else {
                    // TODO where is the err.status comming from?
                    RED.notify(node._("common.notification.error",{message:node._("common.notification.errors.unexpected",{status:err.status,message:err.response})}),"error");
                }
            }
        });
    }

    RED.nodes.registerType('debug',{
        category: 'common',
        defaults: {
            name: {value:"_DEFAULT_"},
            active: {value:true},
            tosidebar: {value:true},
            console: {value:false},
            tostatus: {value:false},
            complete: {value:"false", required:true},
            targetType: {value:undefined},
            statusVal: {value:""},
            statusType: {value:"auto"}
        },
        label: function() {
            var suffix = "";
            if (this.console === true || this.console === "true") { suffix = "\t⇲"; }
            if (this.targetType === "jsonata") {
                return (this.name || "JSONata") + suffix;
            }
            if (this.complete === true || this.complete === "true") {
                return (this.name||"msg") + suffix;
            } else {
                return (this.name || "msg." + ((!this.complete || this.complete === "false") ? "payload" : this.complete)) + suffix;
            }
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        color:"#87a980",
        inputs:1,
        outputs:0,
        icon: "debug.svg",
        align: "right",
        button: {
            toggle: "active",
            visible: function() { return this.tosidebar; },
            onclick: function() {
                var label = RED.utils.sanitize(this.name||"debug");
                var node = this;
                activateAjaxCall(node, node.active, function(resp, textStatus, xhr) {
                    var historyEvent = {
                        t:'edit',
                        node:node,
                        changes:{
                            active:!node.active
                        },
                        dirty:node.dirty,
                        changed:node.changed,
                        callback: function(ev) {
                            activateAjaxCall(ev.node, ev.node.active);
                        }
                    };
                    node.changed = true;
                    node.dirty = true;
                    RED.nodes.dirty(true);
                    RED.history.push(historyEvent);
                    RED.view.redraw();
                    if (xhr.status == 200) {
                        RED.notify(node._("debug.notification.activated",{label:label}),{type: "success", timeout: 2000});
                    } else if (xhr.status == 201) {
                        RED.notify(node._("debug.notification.deactivated",{label:label}),{type: "success", timeout: 2000});
                    }
                });
            }
        },
        onpaletteadd: function() {
            var options = {
                messageMouseEnter: function(sourceId) {
                    if (sourceId) {
                        var n = RED.nodes.node(sourceId);
                        if (n) {
                            n.highlighted = true;
                            n.dirty = true;
                        }
                        RED.view.redraw();
                    }
                },
                messageMouseLeave: function(sourceId) {
                    if (sourceId) {
                        var n = RED.nodes.node(sourceId);
                        if (n) {
                            n.highlighted = false;
                            n.dirty = true;
                        }
                        RED.view.redraw();
                    }
                },
                messageSourceClick: function(sourceId, aliasId, path) {
                    // Get all of the nodes that could have logged this message
                    if (RED.nodes.workspace(sourceId)) {
                        RED.view.reveal(sourceId);
                        return
                    }
                    var candidateNodes = [RED.nodes.node(sourceId)]
                    if (path) {
                        for (var i=2;i<path.length;i++) {
                            candidateNodes.push(RED.nodes.node(path[i]))
                        }
                    }
                    if (aliasId) {
                        candidateNodes.push(RED.nodes.node(aliasId));
                    }
                    if (candidateNodes.length > 1) {
                        // The node is in a subflow. Check to see if the active
                        // workspace is a subflow in the node's parentage. If
                        // so, reveal the relevant subflow instance node.
                        var ws = RED.workspaces.active();
                        for (var i=0;i<candidateNodes.length;i++) {
                            if (candidateNodes[i].z === ws) {
                                RED.view.reveal(candidateNodes[i].id);
                                return
                            }
                        }
                        // The active workspace is unrelated to the node. So
                        // fall back to revealing the top most node
                    }
                    RED.view.reveal(candidateNodes[0].id);
                },
                clear: function() {
                    RED.nodes.eachNode(function(node) {
                        node.highlighted = false;
                        node.dirty = true;
                    });
                    RED.view.redraw();
                },
                requestDebugNodeList: function(filteredNodes) {
                    var workspaceOrder = RED.nodes.getWorkspaceOrder();
                    var workspaceOrderMap = {};
                    workspaceOrder.forEach(function(ws,i) {
                        workspaceOrderMap[ws] = i;
                    });

                    var candidateNodes = [];
                    var candidateSFs = [];
                    var subflows = {};
                    RED.nodes.eachNode(function (n) {
                        var nt = n.type;
                        if (nt === "debug") {
                            if (n.z in workspaceOrderMap) {
                                candidateNodes.push(n);
                            }
                            else {
                                var sf = RED.nodes.subflow(n.z);
                                if (sf) {
                                    subflows[sf.id] = {
                                        debug: true,
                                        subflows: {}
                                    };
                                }
                            }
                        }
                        else if(nt.substring(0, 8) === "subflow:") {
                            if (n.z in workspaceOrderMap) {
                                candidateSFs.push(n);
                            }
                            else {
                                var psf = RED.nodes.subflow(n.z);
                                if (psf) {
                                    var sid = nt.substring(8);
                                    var item = subflows[psf.id];
                                    if (!item) {
                                        item = {
                                            debug: undefined,
                                            subflows: {}
                                        };
                                        subflows[psf.id] = item;
                                    }
                                    item.subflows[sid] = true;
                                }
                            }
                        }
                    });
                    candidateSFs.forEach(function (sf) {
                        var sid = sf.type.substring(8);
                        if (containsDebug(sid, subflows)) {
                            candidateNodes.push(sf);
                        }
                    });

                    candidateNodes.sort(function(A,B) {
                        var wsA = workspaceOrderMap[A.z];
                        var wsB = workspaceOrderMap[B.z];
                        if (wsA !== wsB) {
                            return wsA-wsB;
                        }
                        var labelA = RED.utils.getNodeLabel(A,A.id);
                        var labelB = RED.utils.getNodeLabel(B,B.id);
                        return labelA.localeCompare(labelB);
                    });
                    var currentWs = null;
                    var data = [];
                    var currentFlow;
                    var currentSelectedCount = 0;
                    candidateNodes.forEach(function(node) {
                        if (currentWs !== node.z) {
                            if (currentFlow && currentFlow.checkbox) {
                                currentFlow.selected = currentSelectedCount === currentFlow.children.length
                            }
                            currentSelectedCount = 0;
                            currentWs = node.z;
                            var parent = RED.nodes.workspace(currentWs) || RED.nodes.subflow(currentWs);
                            currentFlow = {
                                label: RED.utils.getNodeLabel(parent, currentWs),
                            }
                            if (!parent.disabled) {
                                currentFlow.children = [];
                                currentFlow.checkbox = true;
                            } else {
                                currentFlow.class = "disabled"
                            }
                            data.push(currentFlow);
                        }
                        if (currentFlow.children) {
                            if (!filteredNodes[node.id]) {
                                currentSelectedCount++;
                            }
                            currentFlow.children.push({
                                label: RED.utils.getNodeLabel(node,node.id),
                                node: {
                                    id: node.id
                                },
                                checkbox: true,
                                selected: !filteredNodes[node.id]
                            });
                        }
                    });
                    if (currentFlow && currentFlow.checkbox) {
                        currentFlow.selected = currentSelectedCount === currentFlow.children.length
                    }
                    if (subWindow) {
                        try {
                            subWindow.postMessage({event:"refreshDebugNodeList", nodes:data},"*");
                        } catch(err) {
                            console.log(err);
                        }
                    }
                    RED.debug.refreshDebugNodeList(data)
                }
            };

            var uiComponents = RED.debug.init(options);
/*
            RED.sidebar.addTab({
                id: "debug",
                label: this._("debug.sidebar.label"),
                name: this._("debug.sidebar.name"),
                content: uiComponents.content,
                toolbar: uiComponents.footer,
                enableOnEdit: true,
                pinned: true,
                iconClass: "fa fa-bug",
                action: "core:show-debug-tab"
            });
*/
            RED.actions.add("core:show-debug-tab",function() { RED.sidebar.show('debug'); });

            var that = this;
            RED._debug = function(msg) {
                that.handleDebugMessage("", {
                    name:"debug",
                    msg:msg
                });
            };

            this.refreshMessageList = function() {
                RED.debug.refreshMessageList(RED.workspaces.active());
                if (subWindow) {
                    try {
                        subWindow.postMessage({event:"workspaceChange",activeWorkspace:RED.workspaces.active()},"*");
                    } catch(err) {
                        console.log(err);
                    }
                }
            };
            RED.events.on("workspace:change", this.refreshMessageList);

            this.handleDebugMessage = function(t,o) {
                // console.log("->",o.id,o.z,o._alias);
                //
                // sourceNode should be the top-level node - one that is on a flow.
                var sourceNode;
                var pathParts;
                var pathHierarchy;
                if (o.path) {
                    // Path is a `/`-separated list of ids that identifies the
                    // complete parentage of the node that generated this message.
                    //    flow-id/subflow-A-instance/subflow-B-instance

                    // If it has one id, that is a top level flow or config node/global
                    // each subsequent id is the instance id of a subflow node
                    //
                    pathParts = o.path.split("/");
                    if (pathParts.length === 1) {
                        // The source node is on a flow or is a global/config - so can use its id to find
                        sourceNode = RED.nodes.node(o.id);
                    } else if (pathParts.length > 1) {
                        // Highlight the subflow instance node.
                        sourceNode = RED.nodes.node(pathParts[1]);
                    }
                    const getNodeLabel = (n) => n.name || (typeof n.label === "function" && n.label())  || (typeof n.label === "string" && n.label) || (n.type + ":" + n.id);
                    pathHierarchy = pathParts.map((id,index) => {
                        if (index === 0) {
                            if (id === "global") {
                                return { id: sourceNode.id, label: getNodeLabel(sourceNode) }
                            } 
                            return { id: id, label: RED.nodes.workspace(id).label } //flow id + name
                        } else {
                            const instanceNode = RED.nodes.node(id)
                            const pathLabel = (instanceNode.name || RED.nodes.subflow(instanceNode.type.substring(8))?.name || instanceNode.type)
                            return { id: id, label: pathLabel }
                        }
                    })
                    if (pathParts.length === 1 && pathParts[0] !== "global") {
                        pathHierarchy.push({ id: o.id, label: getNodeLabel(sourceNode) })
                    }
                    if (o._alias) {
                        let aliasNode = RED.nodes.node(o._alias)
                        if (aliasNode) {
                            pathHierarchy.push({ id: o._alias, label: getNodeLabel(aliasNode) })
                        }
                    }
                } else {
                    // This is probably redundant...
                    sourceNode = RED.nodes.node(o.id) || RED.nodes.node(o.z);
                }
                if (sourceNode) {
                    var sourceFlow = RED.nodes.workspace(sourceNode.z)
                    o._source = {
                        id:sourceNode.id,
                        z:sourceNode.z,
                        name:sourceNode.name,
                        type:sourceNode.type,
                        // _alias identifies the actual logging node. This is
                        // not necessarily the same as sourceNode, which will be
                        // the top-level subflow instance node.
                        // This means the node's name is displayed in the sidebar.
                        _alias:o._alias,
                        flowName: sourceFlow?(sourceFlow.label||sourceNode.z):sourceNode.z,
                        path: pathParts,
                        pathHierarchy: pathHierarchy
                    };
                }
                RED.debug.handleDebugMessage(o);
                if (subWindow) {
                    try {
                        subWindow.postMessage({event:"message",msg:o},"*");
                    } catch(err) {
                        console.log(err);
                    }
                }
            };
            RED.comms.subscribe("debug",this.handleDebugMessage);

            this.clearMessageList = function() {
                RED.debug.clearMessageList(true);
                if (subWindow) {
                    try {
                        subWindow.postMessage({event:"projectChange"},"*");
                    } catch(err) {
                        console.log(err);
                    }
                }
            };
            RED.events.on("project:change", this.clearMessageList);
            RED.actions.add("core:clear-debug-messages", function() { RED.debug.clearMessageList(true) });
            RED.actions.add("core:clear-filtered-debug-messages", function() { RED.debug.clearMessageList(true, true) });

            RED.actions.add("core:activate-selected-debug-nodes", function() { setDebugNodeState(getSelectedDebugNodes(true), true); });
            RED.actions.add("core:activate-all-debug-nodes", function() { setDebugNodeState(getMatchingDebugNodes(true, true),true); });
            RED.actions.add("core:activate-all-flow-debug-nodes", function() { setDebugNodeState(getMatchingDebugNodes(true, false),true); });

            RED.actions.add("core:deactivate-selected-debug-nodes", function() { setDebugNodeState(getSelectedDebugNodes(false), false); });
            RED.actions.add("core:deactivate-all-debug-nodes", function() { setDebugNodeState(getMatchingDebugNodes(false, true),false); });
            RED.actions.add("core:deactivate-all-flow-debug-nodes", function() { setDebugNodeState(getMatchingDebugNodes(false, false),false); });

            function getSelectedDebugNodes(state) {
                var nodes = [];
                var selection = RED.view.selection();
                if (selection.nodes) {
                    selection.nodes.forEach(function(n) {
                        if (RED.nodes.subflow(n.z)) {
                            return;
                        }
                        if (n.type === 'debug' && n.active !== state) {
                            nodes.push(n);
                        } else if (n.type === 'group') {
                            nodes = nodes.concat( RED.group.getNodes(n,true).filter(function(n) {
                                return n.type === 'debug' && n.active !== state
                            }));
                        }
                    });
                }
                return nodes;

            }
            function getMatchingDebugNodes(state,globally) {
                var nodes = [];
                var filter = {type:"debug"};
                if (!globally) {
                    filter.z = RED.workspaces.active();
                }
                var candidateNodes = RED.nodes.filterNodes(filter);
                nodes = candidateNodes.filter(function(n) {
                    return n.active !== state && !RED.nodes.subflow(n.z)
                })
                return nodes;
            }

            function setDebugNodeState(nodes,state) {
                var historyEvents = [];
                if (nodes.length > 0) {
                    activateAjaxCall(nodes,false, function(resp, textStatus, xhr) {
                        nodes.forEach(function(n) {
                            historyEvents.push({
                                t: "edit",
                                node: n,
                                changed: n.changed,
                                changes: {
                                    active: n.active
                                }
                            });
                            n.active = state;
                            n.changed = true;
                            n.dirty = true;
                        })
                        RED.history.push({
                            t: "multi",
                            events: historyEvents,
                            dirty: RED.nodes.dirty(),
                            callback: function() {
                                activateAjaxCall(nodes,nodes[0].active);
                            }
                        });
                        RED.nodes.dirty(true);
                        RED.view.redraw();
                    });
                }
            }

            function containsDebug(sid, map) {
                var item = map[sid];
                if (item) {
                    if (item.debug === undefined) {
                        var sfs = Object.keys(item.subflows);
                        var contain = false;
                        for (var i = 0; i < sfs.length; i++) {
                            var sf = sfs[i];
                            if (containsDebug(sf, map)) {
                                contain = true;
                                break;
                            }
                        }
                        item.debug = contain;
                    }
                    return item.debug;
                }
                return false;
            }

            $("#red-ui-sidebar-debug-open").on("click", function(e) {
                e.preventDefault();
                subWindow = window.open(document.location.toString().replace(/[?#].*$/,"")+"debug/view/view.html"+document.location.search,"nodeREDDebugView","menubar=no,location=no,toolbar=no,chrome,height=500,width=600");
                subWindow.onload = function() {
                    subWindow.postMessage({event:"workspaceChange",activeWorkspace:RED.workspaces.active()},"*");
                };
            });
            RED.popover.tooltip($("#red-ui-sidebar-debug-open"),RED._('node-red:debug.sidebar.openWindow'));



            $(window).on('beforeunload',function() {
                if (subWindow) {
                    try {
                        subWindow.close();
                    } catch(err) {
                        console.log(err);
                    }
                }
            });

            this.handleWindowMessage = function(evt) {
                var msg = evt.data;
                if (msg.event === "mouseEnter") {
                    options.messageMouseEnter(msg.id);
                } else if (msg.event === "mouseLeave") {
                    options.messageMouseLeave(msg.id);
                } else if (msg.event === "mouseClick") {
                    options.messageSourceClick(msg.id,msg._alias,msg.path);
                } else if (msg.event === "clear") {
                    options.clear();
                } else if (msg.event === "requestDebugNodeList") {
                    options.requestDebugNodeList(msg.filteredNodes)
                }
            };
            window.addEventListener('message',this.handleWindowMessage);
        },
        onpaletteremove: function() {
            RED.comms.unsubscribe("debug",this.handleDebugMessage);
            RED.sidebar.removeTab("debug");
            RED.events.off("workspace:change", this.refreshMessageList);
            window.removeEventListener("message",this.handleWindowMessage);
            RED.actions.remove("core:show-debug-tab");
            RED.actions.remove("core:clear-debug-messages");
            delete RED._debug;
        },
        oneditprepare: function() {
            var autoType = {
                value: "auto",
                label: RED._("node-red:debug.autostatus"),
                hasValue: false
            };

            var counter = {
                value: "counter",
                label: RED._("node-red:debug.messageCount"),
                hasValue: false
            };

            $("#node-input-typed-status").typedInput({
                default: "auto",
                types:[autoType, "msg", "jsonata", counter],
                typeField: $("#node-input-statusType")
            });
            var that = this;
            var none = {
                value: "none",
                label: RED._("node-red:debug.none"),
                hasValue: false
            };
            if (this.tosidebar === undefined) {
                this.tosidebar = true;
                $("#node-input-tosidebar").prop('checked', true);
            }
            if (this.statusVal === undefined) {
                this.statusVal = (this.complete === "false") ? "payload" : ((this.complete === "true") ? "payload" : this.complete+"");
                $("#node-input-typed-status").typedInput('value',this.statusVal || "");
            }
            if (this.statusType === undefined) {
                this.statusType = "auto";
                $("#node-input-typed-status").typedInput('type',this.statusType || "auto");
            }
            if (typeof this.console === "string") {
                this.console = (this.console == 'true');
                $("#node-input-console").prop('checked', this.console);
                $("#node-input-tosidebar").prop('checked', true);
            }
            var fullType = {
                value: "full",
                label: RED._("node-red:debug.msgobj"),
                hasValue: false
            };

            $("#node-input-typed-complete").typedInput({
                default: "msg",
                types:['msg', fullType, "jsonata"],
                typeField: $("#node-input-targetType")
            });
            if (this.targetType === "jsonata") {
                var property = this.complete || "";
                $("#node-input-typed-complete").typedInput('type','jsonata');
                $("#node-input-typed-complete").typedInput('value',property);
            } else if ((this.targetType === "full") || this.complete === "true" || this.complete === true) {
                // show complete message object
                $("#node-input-typed-complete").typedInput('type','full');
            } else {
                var property = (!this.complete||(this.complete === "false")) ? "payload" : this.complete+"";
                $("#node-input-typed-complete").typedInput('type','msg');
                $("#node-input-typed-complete").typedInput('value',property);
            }
            $("#node-input-typed-complete").on('change',function() {
                if ($("#node-input-typed-complete").typedInput('type') === 'msg' &&
                    $("#node-input-typed-complete").typedInput('value') === ''
                ) {
                    $("#node-input-typed-complete").typedInput('value','payload');
                }
            });

            $("#node-input-tostatus").on('change',function() {
                if ($(this).is(":checked")) {
                    if (that.statusType === "counter") {
                        that.statusVal = "";
                    }
                    else if (!that.hasOwnProperty("statusVal") || that.statusVal === "") {
                        var type = $("#node-input-typed-complete").typedInput('type');
                        var comp = "payload";
                        if (type !== 'full') {
                            comp = $("#node-input-typed-complete").typedInput('value');
                        }
                        that.statusType = "auto";
                        that.statusVal = comp;
                    }
                    $("#node-input-typed-status").typedInput('type',that.statusType);
                    $("#node-input-typed-status").typedInput('value',that.statusVal);
                    $("#node-tostatus-line").show();
                }
                else {
                    $("#node-tostatus-line").hide();
                    that.statusType = "auto";
                    that.statusVal = "";
                    $("#node-input-typed-status").typedInput('type',that.statusType);
                    $("#node-input-typed-status").typedInput('value',that.statusVal);
                }
            });
        },
        oneditsave: function() {
            var type = $("#node-input-typed-complete").typedInput('type');
            if (type === 'full') {
                $("#node-input-complete").val("true");
            } else {
                $("#node-input-complete").val($("#node-input-typed-complete").typedInput('value'));
            }
            $("#node-input-statusVal").val($("#node-input-typed-status").typedInput('value'));
        },
        onadd: function() {
            if (this.name === '_DEFAULT_') {
                this.name = ''
                RED.actions.invoke("core:generate-node-names", this, {generateHistory: false})
            }
        }
    });
})();
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="debug">
    <p>Displays selected message properties in the debug sidebar tab and optionally the runtime log. By default it displays <code>msg.payload</code>, but can be configured to display any property, the full message or the result of a JSONata expression.</p>
    <h3>Details</h3>
    <p>The debug sidebar provides a structured view of the messages it is sent, making it easier to understand their structure.</p>
    <p>JavaScript objects and arrays can be collapsed and expanded as required. Buffer objects can be displayed as raw data or as a string if possible.</p>
    <p>Alongside each message, the debug sidebar includes information about the time the message was received, the node that sent it and the type of the message.
       Clicking on the source node id will reveal that node within the workspace.</p>
    <p>The button on the node can be used to enable or disable its output. It is recommended to disable or remove any Debug nodes that are not being used.</p>
    <p>The node can also be configured to send all messages to the runtime log, or to send short (32 characters) to the status text under the debug node.</p>
</script>

<!-- --- [red-module:node-red/catch] --- -->

<script type="text/html" data-template-name="catch">
    <div class="form-row">
        <label style="width: auto" for="node-input-scope" data-i18n="catch.label.source"></label>
        <select id="node-input-scope-select">
            <option value="all" data-i18n="catch.scope.all"></option>
            <option value="group" data-i18n="catch.scope.group"></option>
            <option value="target" data-i18n="catch.scope.selected"></option>
        </select>
    </div>
    <div class="form-row node-input-uncaught-row">
        <input type="checkbox" id="node-input-uncaught" style="display: inline-block; width: auto; vertical-align: top; margin-left: 30px; margin-right: 5px;">
        <label for="node-input-uncaught" style="width: auto" data-i18n="catch.label.uncaught"></label>
    </div>
    <div class="form-row node-input-target-row">
        <button type="button" id="node-input-catch-target-select" class="red-ui-button" data-i18n="common.label.selectNodes"></button>
    </div>
    <div class="form-row node-input-target-row node-input-target-list-row" style="position: relative; min-height: 100px">
        <div style="position: absolute; top: -30px; right: 0;"><input type="text" id="node-input-catch-target-filter"></div>
        <div id="node-input-catch-target-container-div"></div>
    </div>

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
</script>
<script type="text/javascript">
    RED.nodes.registerType('catch',{
        category: 'common',
        color:"#e49191",
        defaults: {
            name: {value:""},
            scope: {value:null, type:"*[]"},
            uncaught: {value:false}
        },
        inputs:0,
        outputs:1,
        icon: "alert.svg",
        label: function() {
            if (this.name) {
                return this.name;
            }
            if (this.scope === "group") {
                return this._("catch.catchGroup");
            } else if (Array.isArray(this.scope)) {
                return this._("catch.catchNodes",{number:this.scope.length});
            }
            return this.uncaught?this._("catch.catchUncaught"):this._("catch.catch")
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            var node = this;
            var scope = node.scope || [];

            this._resize = function() {
                var rows = $("#dialog-form>div:not(.node-input-target-list-row)");
                var height = $("#dialog-form").height();
                for (var i=0;i<rows.length;i++) {
                    height -= $(rows[i]).outerHeight(true);
                }
                var editorRow = $("#dialog-form>div.node-input-target-list-row");
                editorRow.css("height",height+"px");
            };
            var search = $("#node-input-catch-target-filter").searchBox({
                style: "compact",
                delay: 300,
                change: function() {
                    var val = $(this).val().trim().toLowerCase();
                    if (val === "") {
                        dirList.treeList("filter", null);
                        search.searchBox("count","");
                    } else {
                        var count = dirList.treeList("filter", function(item) {
                            return item.label.toLowerCase().indexOf(val) > -1 || item.node.type.toLowerCase().indexOf(val) > -1
                        });
                        search.searchBox("count",count+" / "+candidateNodes.length);
                    }
                }
            });
            var dirList = $("#node-input-catch-target-container-div").css({width: "100%", height: "100%"})
                .treeList({multi:true}).on("treelistitemmouseover", function(e, item) {
                    item.node.highlighted = true;
                    item.node.dirty = true;
                    RED.view.redraw();
                }).on("treelistitemmouseout", function(e, item) {
                    item.node.highlighted = false;
                    item.node.dirty = true;
                    RED.view.redraw();
                })
            var candidateNodes = RED.nodes.filterNodes({z:node.z});
            var allChecked = true;
            var items = [];
            var nodeItemMap = {};

            candidateNodes.forEach(function(n) {
                if (n.id === node.id) {
                    return;
                }
                var isChecked = scope.indexOf(n.id) !== -1;

                allChecked = allChecked && isChecked;

                var nodeDef = RED.nodes.getType(n.type);
                var label;
                var sublabel;
                if (nodeDef) {
                    var l = nodeDef.label;
                    label = (typeof l === "function" ? l.call(n) : l)||"";
                    sublabel = n.type;
                    if (sublabel.indexOf("subflow:") === 0) {
                        var subflowId = sublabel.substring(8);
                        var subflow = RED.nodes.subflow(subflowId);
                        sublabel = "subflow : "+subflow.name;
                    }
                }
                if (!nodeDef || !label) {
                    label = n.type;
                }
                nodeItemMap[n.id] = {
                    node: n,
                    label: label,
                    sublabel: sublabel,
                    selected: isChecked,
                    checkbox: true
                };
                items.push(nodeItemMap[n.id]);
            });
            dirList.treeList('data',items);

            $("#node-input-catch-target-select").on("click", function(e) {
                e.preventDefault();
                var preselected = dirList.treeList('selected').map(function(n) {return n.node.id});
                RED.tray.hide();
                RED.view.selectNodes({
                    selected: preselected,
                    onselect: function(selection) {
                        RED.tray.show();
                        var newlySelected = {};
                        selection.forEach(function(n) {
                            newlySelected[n.id] = true;
                            if (nodeItemMap[n.id]) {
                                nodeItemMap[n.id].treeList.select(true);
                            }
                        })
                        preselected.forEach(function(id) {
                            if (!newlySelected[id]) {
                                nodeItemMap[id].treeList.select(false);
                            }
                        })
                    },
                    oncancel: function() {
                        RED.tray.show();
                    },
                    filter: function(n) {
                        return n.id !== node.id;
                    }
                });
            })

            $("#node-input-scope-select").on("change", function(e) {
                var scope = $(this).val();
                if (scope === "target") {
                    $(".node-input-target-row").show();
                    $(".node-input-uncaught-row").hide();
                } else {
                    $(".node-input-target-row").hide();
                    $(".node-input-uncaught-row").show();
                }
                node._resize();
            });
            if (this.scope === null) {
                $("#node-input-scope-select").val("all");
            } else if(this.scope === "group"){
                $("#node-input-scope-select").val("group");
            } else {
                $("#node-input-scope-select").val("target");
            }
            $("#node-input-scope-select").trigger("change");
        },
        oneditsave: function() {
            var scope = $("#node-input-scope-select").val();
            if (scope === 'all') {
                this.scope = null;
            } else if(scope === 'group') {
                this.scope = "group";
            } else {
                $("#node-input-uncaught").prop("checked",false);
                this.scope = $("#node-input-catch-target-container-div").treeList('selected').map(function(i) { return i.node.id})
            }
        },
        oneditresize: function(size) {
            this._resize();
        }
    });
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="catch">
    <p>Catch errors thrown by nodes on the same tab.</p>
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>error.message <span class="property-type">string</span></dt>
        <dd>the error message.</dd>
        <dt>error.source.id <span class="property-type">string</span></dt>
        <dd>the id of the node that threw the error.</dd>
        <dt>error.source.type <span class="property-type">string</span></dt>
        <dd>the type of the node that threw the error.</dd>
        <dt>error.source.name <span class="property-type">string</span></dt>
        <dd>the name, if set, of the node that threw the error.</dd>
    </dl>
    <h3>Details</h3>
    <p>If a node throws an error whilst handling a message, the flow will typically
       halt. This node can be used to catch those errors and handle them with a
       dedicated flow.</p>
    <p>By default, the node will catch errors thrown by any node on the same tab. Alternatively
    it can be targetted at specific nodes, or configured to only catch errors that
    have not already been caught by a 'targeted' catch node.</p>
    <p>When an error is thrown, all matching catch nodes will receive the message.</p>
    <p>If an error is thrown within a subflow, the error will get handled by any
       catch nodes within the subflow. If none exists, the error will be propagated
       up to the tab the subflow instance is on.</p>
   <p>If the message already has a <code>error</code> property, it is copied to <code>_error</code>.</p>
</script>

<!-- --- [red-module:node-red/link] --- -->
<script type="text/html" data-template-name="link in">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
    <div style="position:relative; height: 30px; text-align: right;"><div style="display:inline-block"><input type="text" id="node-input-link-target-filter"></div></div>
    <div class="form-row node-input-link-row"></div>
</script>
<script type="text/html" data-template-name="link out">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
    <div class="form-row">
        <label for="node-input-mode"><span data-i18n="link.outMode"></span></label>
        <select id="node-input-mode" style="width: 70%">
            <option value="link" selected data-i18n="link.sendToAll"></option>
            <option value="return" data-i18n="link.returnToCaller"></option>
        </select>
    </div>
    <div class="node-input-link-rows" style="position:relative; height: 30px; text-align: right;"><div style="display:inline-block"><input type="text" id="node-input-link-target-filter"></div></div>
    <div class="form-row node-input-link-row node-input-link-rows"></div>
</script>

<script type="text/html" data-template-name="link call">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
    <div class="form-row">
        <label for="node-input-timeout"><i class="fa fa-clock-o"></i> <span data-i18n="exec.label.timeout"></span></label>
        <input type="text" id="node-input-timeout" placeholder="30" style="width: 70px; margin-right: 5px;"><span data-i18n="inject.seconds"></span>
    </div>
    <div class="form-row">
        <label for="node-input-linkType" data-i18n="link.linkCallType"></label>
        <select id="node-input-linkType" style="width: 70%">
            <option value="static" data-i18n="link.staticLinkCall"></option>
            <option value="dynamic" data-i18n="link.dynamicLinkCall"></option>
        </select>
    </div>
    <div class="link-call-target-tree" style="position:relative; height: 30px; text-align: right;">
        <div style="display:inline-block"><input type="text" id="node-input-link-target-filter"></div>
    </div>
    <div class="form-row node-input-link-row link-call-target-tree"></div>
</script>

<script type="text/javascript">
(function() {

    let treeList;

    function onEditPrepare(node,targetType) {
        if (!node.links) {
            node.links = [];
        }
        node.oldLinks = [];

        const activeSubflow = RED.nodes.subflow(node.z);

        treeList = $("<div>")
            .css({width: "100%", height: "100%"})
            .appendTo(".node-input-link-row")
            .treeList({autoSelect:false})
            .on('treelistitemmouseover',function(e,item) {
                if (item.node) {
                    item.node.highlighted = true;
                    item.node.dirty = true;
                    RED.view.redraw();
                }
            })
            .on('treelistitemmouseout',function(e,item) {
                if (item.node) {
                    item.node.highlighted = false;
                    item.node.dirty = true;
                    RED.view.redraw();
                }
            });
        const candidateNodes = RED.nodes.filterNodes({type:targetType});
        let candidateNodesCount = 0;

        const search = $("#node-input-link-target-filter").searchBox({
            style: "compact",
            delay: 300,
            change: function() {
                var val = $(this).val().trim().toLowerCase();
                if (val === "") {
                    treeList.treeList("filter", null);
                    search.searchBox("count","");
                } else {
                    const count = treeList.treeList("filter", function(item) {
                        return item.label.toLowerCase().indexOf(val) > -1 || (item.node && item.node.type.toLowerCase().indexOf(val) > -1)
                    });
                    search.searchBox("count",count+" / "+candidateNodesCount);
                }
            }
        });

        const flows = [];
        const flowMap = {};

        if (activeSubflow) {
            flowMap[activeSubflow.id] = {
                id: activeSubflow.id,
                class: 'red-ui-palette-header',
                label: "Subflow : " + (activeSubflow.name || activeSubflow.id),
                expanded: true,
                children: []
            };
            flows.push(flowMap[activeSubflow.id])
        }
        if (!activeSubflow || node.type === "link call") {
            // Only "Link Call" can look outside of its own subflow
            // Link In and Link Out nodes outside of a subflow should be ignored
            RED.nodes.eachWorkspace(function (ws) {
                flowMap[ws.id] = {
                    id: ws.id,
                    class: 'red-ui-palette-header',
                    label: (ws.label || ws.id) + (node.z === ws.id ? " *" : ""),
                    expanded: true,
                    children: []
                }
                flows.push(flowMap[ws.id])
            })
        }

        candidateNodes.forEach(function (n) {
            if (flowMap[n.z]) {
                if (targetType === "link out" && n.mode === 'return') {
                    // Link In nodes looking for Link Out nodes should not
                    // include return-mode nodes.
                    return;
                }
                const isChecked = (node.links.indexOf(n.id) !== -1) || (n.links || []).indexOf(node.id) !== -1;
                if (isChecked) {
                    node.oldLinks.push(n.id);
                }
                flowMap[n.z].children.push({
                    id: n.id,
                    node: n,
                    label: n.name || n.id,
                    selected: isChecked,
                    checkbox: node.type !== "link call",
                    radio: node.type === "link call"
                })
                candidateNodesCount++;
            }
        });
        const flowsFiltered = flows.filter(function(f) { return f.children.length > 0 })
        treeList.treeList('data',flowsFiltered);
        setTimeout(function() {
            treeList.treeList('show',node.z);
        },100);
    }

    function resizeNodeList() {
        var rows = $("#dialog-form>div:not(.node-input-link-row)");
        var height = $("#dialog-form").height();
        for (var i=0;i<rows.length;i++) {
            height -= $(rows[i]).outerHeight(true);
        }
        var editorRow = $("#dialog-form>div.node-input-link-row");
        height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));
        $(".node-input-link-row").css("height",height+"px");
    }

    function onEditSave(node) {
        var flows = treeList.treeList('data');
        node.links = [];
        if (node.type !== "link out" || $("#node-input-mode").val() === 'link') {
            flows.forEach(function(f) {
                f.children.forEach(function(n) {
                    if (n.selected) {
                        node.links.push(n.id);
                    }
                })
            })
        }
        node.oldLinks.sort();
        node.links.sort();

        if (node.type === "link call") {
            return
        }

        var nodeMap = {};
        var length = Math.max(node.oldLinks.length,node.links.length);
        for (var i=0;i<length;i++) {
            if (i<node.oldLinks.length) {
                nodeMap[node.oldLinks[i]] = nodeMap[node.oldLinks[i]]||{};
                nodeMap[node.oldLinks[i]].old = true;
            }
            if (i<node.links.length) {
                nodeMap[node.links[i]] = nodeMap[node.links[i]]||{};
                nodeMap[node.links[i]].new = true;
            }
        }

        let editHistories = []
        let n;
        for (let id in nodeMap) {
            if (nodeMap.hasOwnProperty(id)) {
                n = RED.nodes.node(id);
                if (n) {
                    editHistories.push({
                        t:'edit',
                        node: n,
                        changes: {
                            links: [...n.links]
                        },
                        changed: n.changed
                    })
                    if (nodeMap[id].old && !nodeMap[id].new) {
                        // Removed id
                        i = n.links.indexOf(node.id);
                        if (i > -1) {
                            n.links.splice(i,1);
                            n.changed = true
                            n.dirty = true
                        }
                    } else if (!nodeMap[id].old && nodeMap[id].new) {
                        // Added id
                        i = n.links.indexOf(id);
                        if (i === -1) {
                            n.links.push(node.id);
                            n.changed = true
                            n.dirty = true
                        }
                    }
                }
            }
        }
        if (editHistories.length > 0) {
            return {
                history: editHistories
            }
        }
    }

    function onAdd() {
        if (this.name === '_DEFAULT_') {
            this.name = ''
            RED.actions.invoke("core:generate-node-names", this, {generateHistory: false})
        }
        for (var i=0;i<this.links.length;i++) {
            var n = RED.nodes.node(this.links[i]);
            if (n && n.links.indexOf(this.id) === -1) {
                n.links.push(this.id);
            }
        }
    }

    RED.nodes.registerType('link in',{
        category: 'common',
        color:"#ddd",//"#87D8CF",
        defaults: {
            name: { value: "_DEFAULT_" },
            links: { value: [], type:"link out[]" }
        },
        inputs:0,
        outputs:1,
        icon: "link-out.svg",
        outputLabels: function(i) {
            return this.name||this._("link.linkIn");
        },
        showLabel: false,
        label: function() {
            return this.name||this._("link.linkIn");
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            onEditPrepare(this,"link out");
        },
        oneditsave: function() {
            const result = onEditSave(this);
            // In case the name has changed, ensure any link call nodes on this
            // tab are redrawn with the updated name
            var localCallNodes = RED.nodes.filterNodes({z:RED.workspaces.active(), type:"link call"});
            localCallNodes.forEach(function(node) {
                node.dirty = true;
            });
            return result
        },
        onadd: onAdd,
        oneditresize: resizeNodeList
    });

    RED.nodes.registerType('link call',{
        category: 'common',
        color:"#ddd",//"#87D8CF",
        defaults: {
            name: { value: "" },
            links: {
                value: [],
                type: "link in[]",
                validate: function (v, opt) {
                    if (((this.linkType || "static") === "static" && v.length > 0)
                      || this.linkType === "dynamic") {
                        return true;
                    }
                    return RED._("node-red:link.errors.linkUndefined");
                }
            },
            linkType: { value:"static" },
            timeout: {
                value: "30",
                label: RED._("node-red:link.timeout"),
                validate:RED.validators.number(true)
            }
        },
        inputs: 1,
        outputs: 1,
        icon: "link-call.svg",
        inputLabels: function(i) {
            return this.name||this._("link.linkCall");
        },
        label: function() {
            if (this.name) {
                return this.name;
            }
            if (this.linkType === "dynamic") {
                return this._("link.dynamicLinkLabel");
            } else if (this.links.length > 0) {
                var targetNode = RED.nodes.node(this.links[0]);
                return targetNode && (targetNode.name || this._("link.linkCall"));
            }
            return this._("inject.none");
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            const updateVisibility = function() {
                const static = $('#node-input-linkType').val() !== "dynamic";
                if(static) {
                    $("div.link-call-target-tree").show();
                } else {
                    $("div.link-call-target-tree").hide();
                }
            }
            $("#node-input-linkType").on("change",function(d){
                updateVisibility();
            });
            if (["static","dynamic"].indexOf(this.linkType) < 0) {
                $("#node-input-linkType").val('static');
            }
            updateVisibility();
            onEditPrepare(this,"link in");
        },
        oneditsave: function() {
            return onEditSave(this);
        },
        oneditresize: resizeNodeList
    });

    RED.nodes.registerType('link out',{
        category: 'common',
        color:"#ddd",//"#87D8CF",
        defaults: {
            name: { value:"_DEFAULT_" },
            mode: { value: "link" },// link || return
            links: { value: [], type:"link in[]" }
        },
        align:"right",
        inputs:1,
        outputs:0,
        icon: function() {
            if (this.mode === "return") {
                return "link-return.svg";
            } else {
                return "link-out.svg";
            }
        },
        inputLabels: function(i) {
            return this.name||(this.mode === "return" ?this._("link.linkOutReturn"):this._("link.linkOut"));
        },
        showLabel: false,
        label: function() {
            return this.name||(this.mode === "return" ?this._("link.linkOutReturn"):this._("link.linkOut"));
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            onEditPrepare(this,"link in");
            $("#node-input-mode").on("change", function() {
                $(".node-input-link-rows").toggle(this.value === "link")
            })
            if (!this.mode) {
                $("#node-input-mode").val('link').trigger("change");
            }

        },
        oneditsave: function() {
            return onEditSave(this);
        },
        onadd: onAdd,
        oneditresize: resizeNodeList
    });



})();
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="link in">
    <p>Create virtual wires between flows.</p>
    <h3>Details</h3>
    <p>The node can be connected to any <code>link out</code> node that exists on any tab.
       Once connected, they behave as if they were wired together.</p>
    <p>The wires between link nodes are only displayed when a link node is selected.
       If there are any wires to other tabs, a virtual node is shown that can be clicked
       on to jump to the appropriate tab.</p>
    <p><b>Note: </b>Links cannot be created going into, or out of, a subflow.</p>
</script>

<script type="text/html" data-help-name="link out">
    <p>Create virtual wires between flows.</p>
    <h3>Details</h3>
    <p>This node can be configured to either send messages to all <code>link in</code>
       nodes it is connected to, or to send a response back to the <code>link call</code>
       node that triggered the flow.</p>
    <p>When in 'send to all' mode, the wires between link nodes are only displayed when
       the node is selected. If there are any wires to other tabs, a virtual node
       is shown that can be clicked on to jump to the appropriate tab.</p>
    <p><b>Note: </b>Links cannot be created going into, or out of, a subflow.</p>
</script>

<script type="text/html" data-help-name="link call">
    <p>Calls a flow that starts with a <code>link in</code> node and passes on the response.</p>
    <h3>Inputs</h3>
    <dl class="message-properties">
      <dt class="optional">target<span class="property-type">string</span></dt>
      <dd>When the option <b>Link Type</b> is set to "Dynamic target", set <code>msg.target</code> to the name of the
          <code>link in</code> node you wish to call.</dd>
    </dl>
    <h3>Details</h3>
    <p>This node can be connected to a <code>link in</code> node that exists on any tab.
       The flow connected to that node must end with a <code>link out</code> node configured
       in 'return' mode.</p>
    <p>When this node receives a message, it is passed to the connected <code>link in</code> node.
       It then waits for a response which it then sends on.</p>
    <p>If no response is received within the configured timeout, default 30 seconds, the node
       will log an error that can be caught using the <code>catch</code> node.</p>
    <p>When the option <b>Link Type</b> is set to "Dynamic target" <code>msg.target</code> can be used to call a
       <code>link in</code> by name or id. 
    <ul>
      <li>If there is a <code>link in</code> nodes with the same id, it will be called</li>
      <li>If there are two or more <code>link in</code> nodes with the same name, an error will be raised</li>
      <li>A <code>link call</code> cannot call a <code>link in</code> node inside a subflow</li>
    </ul>
    </p>
    The flow connected to that node must end with a <code>link out</code> node configured
    in 'return' mode.</p>
</script>

<!-- --- [red-module:node-red/function] --- -->
<script type="text/html" data-template-name="function">
    <style>
        .func-tabs-row {
            margin-bottom: 0;
        }
        #node-input-libs-container-row .red-ui-editableList-container {
            padding: 0px;
        }
        #node-input-libs-container-row .red-ui-editableList-container li {
            padding:0px;
        }
        #node-input-libs-container-row .red-ui-editableList-item-remove {
            right: 5px;
        }

        #node-input-libs-container-row .red-ui-editableList-header {
            display: flex;
            background: var(--red-ui-tertiary-background);
            padding-right: 75px;
            border-top-left-radius: 3px;
            border-top-right-radius: 3px;
        }
        #node-input-libs-container-row .red-ui-editableList-header > div {
            flex-grow: 1;
        }

        .node-libs-entry {
            display: flex;
        }

        .node-libs-entry .red-ui-typedInput-container {
            border-radius: 0;
            border: none;
        }
        .node-libs-entry .red-ui-typedInput-type-select {
            border-radius: 0 !important;
            height: 34px;
        }
        .node-libs-entry > span > input[type=text] {
            border-radius: 0;
            border-top-color: var(--red-ui-form-background);
            border-bottom-color: var(--red-ui-form-background);
            border-right-color: var(--red-ui-form-background);
        }
        .node-libs-entry > span > input[type=text].input-error {
        }
        .node-libs-entry > span {
            flex-grow: 1;
            width: 50%;
            position: relative;
        }
        .node-libs-entry span .node-input-libs-var, .node-libs-entry span .red-ui-typedInput-container {
            width: 100%;
        }
        .node-libs-entry > span > span > i {
            display: none;
        }
        .node-libs-entry > span > span.input-error > i {
            display: inline;
        }

    </style>
    <input type="hidden" id="node-input-func">
    <input type="hidden" id="node-input-noerr">
    <input type="hidden" id="node-input-finalize">
    <input type="hidden" id="node-input-initialize">

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <div style="display: inline-block; width: calc(100% - 105px)"><input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name"></div>
    </div>


    <div class="form-row func-tabs-row">
        <ul style="min-width: 600px; margin-bottom: 20px;" id="func-tabs"></ul>
    </div>
    <div id="func-tabs-content" style="min-height: calc(100% - 95px);">

        <div id="func-tab-config" style="display:none">
            <div>
                <div class="form-row" style="display: inline-block; margin-right: 50px;">
                    <label for="node-input-outputs"><i class="fa fa-random"></i> <span data-i18n="function.label.outputs"></span></label>
                    <input id="node-input-outputs" style="width: 60px;" value="1">
                </div>
                <div class="form-row" style="display: inline-block;">
                    <label for="node-input-timeout"><i class="fa fa-clock-o"></i> <span data-i18n="function.label.timeout"></span></label>
                    <input id="node-input-timeout" style="width: 60px;" data-i18n="[placeholder]join.seconds">
                </div>
            </div>

            <div class="form-row node-input-libs-row hide" style="margin-bottom: 0px;">
                <label><i class="fa fa-cubes"></i> <span data-i18n="function.label.modules"></span></label>
            </div>
            <div class="form-row node-input-libs-row hide" id="node-input-libs-container-row">
                <ol id="node-input-libs-container"></ol>
            </div>
        </div>

        <div id="func-tab-init" style="display:none">
            <div class="form-row node-text-editor-row" style="position:relative">
                <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-init-editor" ></div>
                <div style="position: absolute; right:0; bottom: calc(100% - 20px); z-Index: 10;"><button type="button" id="node-init-expand-js" class="red-ui-button red-ui-button-small"><i class="fa fa-expand"></i></button></div>
            </div>
        </div>

        <div id="func-tab-body" style="display:none">
            <div class="form-row node-text-editor-row" style="position:relative">
                <div style="height: 220px; min-height:150px;" class="node-text-editor" id="node-input-func-editor" ></div>
                <div style="position: absolute; right:0; bottom: calc(100% - 20px); z-Index: 10;"><button type="button" id="node-function-expand-js" class="red-ui-button red-ui-button-small"><i class="fa fa-expand"></i></button></div>
            </div>
        </div>

        <div id="func-tab-finalize" style="display:none">
            <div class="form-row node-text-editor-row" style="position:relative">
                <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-finalize-editor" ></div>
                <div style="position: absolute; right:0; bottom: calc(100% - 20px); z-Index: 10;"><button type="button" id="node-finalize-expand-js" class="red-ui-button red-ui-button-small"><i class="fa fa-expand"></i></button></div>
            </div>
        </div>

    </div>
</script>

<script type="text/javascript">

(function() {

    var invalidModuleVNames = [
        'console',
        'util',
        'Buffer',
        'Date',
        'RED',
        'node',
        '__node__',
        'context',
        'flow',
        'global',
        'env',
        'setTimeout',
        'clearTimeout',
        'setInterval',
        'clearInterval',
        'promisify'
    ]

    var knownFunctionNodes = {};
    RED.events.on("nodes:add", function(n) {
        if (n.type === "function") {
            knownFunctionNodes[n.id] = n;
        }
    })
    RED.events.on("nodes:remove", function(n) {
        if (n.type === "function") {
            delete knownFunctionNodes[n.id];
        }
    })

    var missingModules = [];
    var missingModuleReasons = {};
    RED.events.on("runtime-state", function(event) {
        if (event.error === "missing-modules") {
            missingModules = event.modules.map(function(m) { missingModuleReasons[m.module] = m.error; return m.module });
            for (var id in knownFunctionNodes) {
                if (knownFunctionNodes.hasOwnProperty(id) && knownFunctionNodes[id].libs && knownFunctionNodes[id].libs.length > 0) {
                    RED.editor.validateNode(knownFunctionNodes[id])
                }
            }
        } else if (!event.text) {
            missingModuleReasons = {};
            missingModules = [];
            for (var id in knownFunctionNodes) {
                if (knownFunctionNodes.hasOwnProperty(id) && knownFunctionNodes[id].libs && knownFunctionNodes[id].libs.length > 0) {
                    RED.editor.validateNode(knownFunctionNodes[id])
                }
            }
        }
        RED.view.redraw();
    });

    var installAllowList = ['*'];
    var installDenyList = [];

    var modulesEnabled = true;
    if (RED.settings.get('externalModules.modules.allowInstall', true) === false) {
        modulesEnabled = false;
    }
    var settingsAllowList = RED.settings.get("externalModules.modules.allowList")
    var settingsDenyList = RED.settings.get("externalModules.modules.denyList")
    if (settingsAllowList || settingsDenyList) {
        installAllowList = settingsAllowList;
        installDenyList = settingsDenyList
    }
    installAllowList = RED.utils.parseModuleList(installAllowList);
    installDenyList = RED.utils.parseModuleList(installDenyList);


    // object that maps from library name to its descriptor
    var allLibs = [];

    function moduleName(module) {
        var match = /^([^@]+)@(.+)/.exec(module);
        if (match) {
            return [match[1], match[2]];
        }
        return [module, undefined];
    }

    function getAllUsedModules() {
        var moduleSet = new Set();
        for (var id in knownFunctionNodes) {
            if (knownFunctionNodes.hasOwnProperty(id)) {
                if (knownFunctionNodes[id].libs) {
                    for (var i=0, l=knownFunctionNodes[id].libs.length; i<l; i++) {
                        if (RED.utils.checkModuleAllowed(knownFunctionNodes[id].libs[i].module,null,installAllowList,installDenyList)) {
                            moduleSet.add(knownFunctionNodes[id].libs[i].module);
                        }
                    }
                }
            }
        }
        var modules = Array.from(moduleSet);
        modules.sort();
        return modules;
    }

    function prepareLibraryConfig(node) {
        $(".node-input-libs-row").show();
        var usedModules = getAllUsedModules();
        var typedModules = usedModules.map(function(l) {
            return {icon:"fa fa-cube", value:l,label:l,hasValue:false}
        })
        typedModules.push({
            value:"_custom_", label:RED._("editor:subflow.licenseOther"), icon:"red/images/typedInput/az.svg"
        })

        var libList = $("#node-input-libs-container").css('min-height','100px').css('min-width','450px').editableList({
            header: $('<div><div data-i18n="node-red:function.require.moduleName"></div><div data-i18n="node-red:function.require.importAs"></div></div>'),
            addItem: function(container,i,opt) {
                var parent = container.parent();
                var row0 = $("<div/>").addClass("node-libs-entry").appendTo(container);
                var fmoduleSpan = $("<span>").appendTo(row0);
                var fmodule = $("<input/>", {
                    class: "node-input-libs-val",
                    placeholder: RED._("node-red:function.require.module"),
                    type: "text"
                }).css({
                }).appendTo(fmoduleSpan).typedInput({
                    types: typedModules,
                    default: usedModules.indexOf(opt.module) > -1 ? opt.module : "_custom_"
                });
                if (usedModules.indexOf(opt.module) === -1) {
                    fmodule.typedInput('value', opt.module);
                }
                var moduleWarning = $('<span style="position: absolute;right:2px;top:7px; display:inline-block; width: 16px;"><i class="fa fa-warning"></i></span>').appendTo(fmoduleSpan);
                RED.popover.tooltip(moduleWarning.find("i"),function() {
                    var val = fmodule.typedInput("type");
                    if (val === "_custom_") {
                        val = fmodule.val();
                    }
                    var errors = [];

                    if (!RED.utils.checkModuleAllowed(val,null,installAllowList,installDenyList)) {
                        return RED._("node-red:function.error.moduleNotAllowed",{module:val});
                    } else {
                        return RED._("node-red:function.error.moduleLoadError",{module:val,error:missingModuleReasons[val]});
                    }
                })

                var fvarSpan = $("<span>").appendTo(row0);

                var fvar = $("<input/>", {
                    class: "node-input-libs-var red-ui-font-code",
                    placeholder: RED._("node-red:function.require.var"),
                    type: "text"
                }).css({
                }).appendTo(fvarSpan).val(opt.var);
                var vnameWarning = $('<span style="position: absolute; right:2px;top:7px;display:inline-block; width: 16px;"><i class="fa fa-warning"></i></span>').appendTo(fvarSpan);
                RED.popover.tooltip(vnameWarning.find("i"),function() {
                    var val = fvar.val();
                    if (invalidModuleVNames.indexOf(val) !== -1) {
                        return RED._("node-red:function.error.moduleNameReserved",{name:val})
                    } else {
                        return RED._("node-red:function.error.moduleNameError",{name:val})
                    }
                })



                fvar.on("change keyup paste", function (e) {
                    var v = $(this).val().trim();
                    if (v === "" || / /.test(v) || invalidModuleVNames.indexOf(v) !== -1) {
                        fvar.addClass("input-error");
                        vnameWarning.addClass("input-error");
                    } else {
                        fvar.removeClass("input-error");
                        vnameWarning.removeClass("input-error");
                    }
                });

                fmodule.on("change keyup paste", function (e) {
                    var val = $(this).typedInput("type");
                    if (val === "_custom_") {
                        val = $(this).val();
                    }
                    var varName = val.trim().replace(/^@/,"").replace(/@.*$/,"").replace(/[-_/\.].?/g, function(v) { return v[1]?v[1].toUpperCase():"" });
                    fvar.val(varName);
                    fvar.trigger("change");

                    if (RED.utils.checkModuleAllowed(val,null,installAllowList,installDenyList) && (missingModules.indexOf(val) === -1)) {
                        fmodule.removeClass("input-error");
                        moduleWarning.removeClass("input-error");
                    } else {
                        fmodule.addClass("input-error");
                        moduleWarning.addClass("input-error");
                    }
                });
                if (RED.utils.checkModuleAllowed(opt.module,null,installAllowList,installDenyList) && (missingModules.indexOf(opt.module) === -1)) {
                    fmodule.removeClass("input-error");
                    moduleWarning.removeClass("input-error");
                } else {
                    fmodule.addClass("input-error");
                    moduleWarning.addClass("input-error");
                }
                if (opt.var) {
                    fvar.trigger("change");
                }
            },
            removable: true
        });

        var libs = node.libs || [];
        for (var i=0,l=libs.length;i<l; i++) {
            libList.editableList('addItem',libs[i])
        }

    }

    function getLibsList() {
        var _libs = [];
        if (RED.settings.functionExternalModules !== false) {
            var libs = $("#node-input-libs-container").editableList("items");
            libs.each(function(i) {
                var item = $(this);
                var v = item.find(".node-input-libs-var").val();
                var n = item.find(".node-input-libs-val").typedInput("type");
                if (n === "_custom_") {
                    n = item.find(".node-input-libs-val").val();
                }
                if ((!v || (v === "")) ||
                    (!n || (n === ""))) {
                    return;
                }
                _libs.push({
                    var: v,
                    module: n
                });
            });
        }
        return _libs;
    }

    RED.nodes.registerType('function',{
        color:"#fdd0a2",
        category: 'function',
        defaults: {
            name: {value:"_DEFAULT_"},
            func: {value:"\nreturn msg;"},
            outputs: {value:1},
            timeout:{value:RED.settings.functionTimeout || 0},
            noerr: {value:0,required:true,
                    validate: function(v, opt) {
                        if (!v) {
                            return true;
                        }
                        return RED._("node-red:function.error.invalid-js");
                    }},
            initialize: {value:""},
            finalize: {value:""},
            libs: {value: [], validate: function(v, opt) {
                if (!v) { return true; }
                for (var i=0,l=v.length;i<l;i++) {
                    var m = v[i];
                    if (!RED.utils.checkModuleAllowed(m.module,null,installAllowList,installDenyList)) {
                        return RED._("node-red:function.error.moduleNotAllowed", {
                            module: m.module
                        });
                    }
                    if (m.var === "" || / /.test(m.var)) {
                        return RED._("node-red:function.error.moduleNameError", {
                            name: m.var
                        });
                    }
                    if (missingModules.indexOf(m.module) > -1) {
                        return RED._("node-red:function.error.missing-module", {
                            module: m.module
                        });
                    }
                    if (invalidModuleVNames.indexOf(m.var) !== -1){
                        return RED._("node-red:function.error.moduleNameError", {
                            name: m.var
                        });
                    }
                }
                return true;
            }}
        },
        inputs:1,
        outputs:1,
        icon: "function.svg",
        label: function() {
            return this.name||this._("function.function");
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            var that = this;

            var tabs = RED.tabs.create({
                id: "func-tabs",
                onchange: function(tab) {
                    $("#func-tabs-content").children().hide();
                    $("#" + tab.id).show();
                    let editor = $("#" + tab.id).find('.monaco-editor').first();
                    if(editor.length) {
                        if(that.editor.nodered && that.editor.type == "monaco") {
                            that.editor.nodered.refreshModuleLibs(getLibsList());
                        }
                        RED.tray.resize();
                        //auto focus editor on tab switch
                        if (that.initEditor.getDomNode() == editor[0]) {
                            that.initEditor.focus();
                        } else if (that.editor.getDomNode() == editor[0]) {
                            that.editor.focus();
                        } else if (that.finalizeEditor.getDomNode() == editor[0]) {
                            that.finalizeEditor.focus();
                        }
                    }
                }
            });
            tabs.addTab({
                id: "func-tab-config",
                iconClass: "fa fa-cog",
                label: that._("function.label.setup")
            });

            tabs.addTab({
                id: "func-tab-init",
                label: that._("function.label.initialize")
            });
            tabs.addTab({
                id: "func-tab-body",
                label: that._("function.label.function")
            });
            tabs.addTab({
                id: "func-tab-finalize",
                label: that._("function.label.finalize")
            });

            tabs.activateTab("func-tab-body");

            $( "#node-input-outputs" ).spinner({
                min: 0,
                max: 500,
                change: function(event, ui) {
                    var value = parseInt(this.value);
                    value = isNaN(value) ? 1 : value;
                    value = Math.max(value, parseInt($(this).attr("aria-valuemin")));
                    value = Math.min(value, parseInt($(this).attr("aria-valuemax")));
                    if (value !== this.value) { $(this).spinner("value", value); }
                }
            });

            // 4294967 is max in node.js timeout.
            $( "#node-input-timeout" ).spinner({
                min: 0,
                max: 4294967,
                change: function(event, ui) {
                    var value = this.value;
                    if(value == ""){
                        value = 0;
                    }
                    else
                    {
                        value = parseInt(value);
                    }
                    value = isNaN(value) ? 1 : value;
                    value = Math.max(value, parseInt($(this).attr("aria-valuemin")));
                    value = Math.min(value, parseInt($(this).attr("aria-valuemax")));
                    if (value !== this.value) { $(this).spinner("value", value); }
                }
            });

            var buildEditor = function(id, stateId, focus, value, defaultValue, extraLibs, offset) {
                var editor = RED.editor.createEditor({
                    id: id,
                    mode: 'ace/mode/nrjavascript',
                    value: value || defaultValue || "",
                    stateId: stateId,
                    focus: true,
                    globals: {
                        msg:true,
                        context:true,
                        RED: true,
                        util: true,
                        flow: true,
                        global: true,
                        console: true,
                        Buffer: true,
                        setTimeout: true,
                        clearTimeout: true,
                        setInterval: true,
                        clearInterval: true
                    },
                    extraLibs: extraLibs
                });
                if (defaultValue && value === "") {
                    editor.moveCursorTo(defaultValue.split("\n").length +offset, 0);
                }
                editor.__stateId = stateId;
                return editor;
            }
            this.initEditor = buildEditor('node-input-init-editor', this.id + "/" + "initEditor", false, $("#node-input-initialize").val(), RED._("node-red:function.text.initialize"), undefined, 0);
            this.editor = buildEditor('node-input-func-editor', this.id + "/" + "editor", true, $("#node-input-func").val(), undefined, that.libs || [], undefined, -1);
            this.finalizeEditor = buildEditor('node-input-finalize-editor', this.id + "/" + "finalizeEditor", false, $("#node-input-finalize").val(), RED._("node-red:function.text.finalize"), undefined, 0);

            RED.library.create({
                url:"functions", // where to get the data from
                type:"function", // the type of object the library is for
                editor:this.editor, // the field name the main text body goes to
                mode:"ace/mode/nrjavascript",
                fields:[
                    'name', 'outputs', 'timeout',
                    {
                        name: 'initialize',
                        get: function() {
                            return that.initEditor.getValue();
                        },
                        set: function(v) {
                            that.initEditor.setValue(v||RED._("node-red:function.text.initialize"), -1);
                        }
                    },
                    {
                        name: 'finalize',
                        get: function() {
                            return that.finalizeEditor.getValue();
                        },
                        set: function(v) {
                            that.finalizeEditor.setValue(v||RED._("node-red:function.text.finalize"), -1);
                        }
                    },
                    {
                        name: 'info',
                        get: function() {
                            return that.infoEditor.getValue();
                        },
                        set: function(v) {
                            that.infoEditor.setValue(v||"", -1);
                        }
                    }
                ],
                ext:"js"
            });

            var expandButtonClickHandler = function(editor) {
                return function (e) {
                    e.preventDefault();
                    var value = editor.getValue();
                    editor.saveView(`inside function-expandButtonClickHandler ${editor.__stateId}`);
                    var extraLibs = that.libs || [];
                    RED.editor.editJavaScript({
                        value: value,
                        width: "Infinity",
                        stateId: editor.__stateId,
                        mode: "ace/mode/nrjavascript",
                        focus: true,
                        cancel: function () {
                            setTimeout(function () {
                                editor.focus();
                            }, 250);
                        },
                        complete: function (v, cursor) {
                            editor.setValue(v, -1);
                            setTimeout(function () {
                                editor.restoreView();
                                editor.focus();
                            }, 250);
                        },
                        extraLibs: extraLibs
                    });
                }
            }
            $("#node-init-expand-js").on("click", expandButtonClickHandler(this.initEditor));
            $("#node-function-expand-js").on("click", expandButtonClickHandler(this.editor));
            $("#node-finalize-expand-js").on("click", expandButtonClickHandler(this.finalizeEditor));

            RED.popover.tooltip($("#node-init-expand-js"), RED._("node-red:common.label.expand"));
            RED.popover.tooltip($("#node-function-expand-js"), RED._("node-red:common.label.expand"));
            RED.popover.tooltip($("#node-finalize-expand-js"), RED._("node-red:common.label.expand"));

            if (RED.settings.functionExternalModules !== false) {
                prepareLibraryConfig(that);
            }
        },
        oneditsave: function() {
            var node = this;
            var noerr = 0;
            $("#node-input-noerr").val(0);

            var disposeEditor = function(editorName,targetName,defaultValue) {
                var editor = node[editorName];
                var annot = editor.getSession().getAnnotations();
                for (var k=0; k < annot.length; k++) {
                    if (annot[k].type === "error") {
                        noerr += annot.length;
                        break;
                    }
                }
                var val = editor.getValue();
                if (defaultValue) {
                    if (val.trim() == defaultValue.trim()) {
                        val = "";
                    }
                }
                editor.destroy();
                delete node[editorName];
                $("#"+targetName).val(val);
            }
            disposeEditor("editor","node-input-func");
            disposeEditor("initEditor","node-input-initialize", RED._("node-red:function.text.initialize"));
            disposeEditor("finalizeEditor","node-input-finalize", RED._("node-red:function.text.finalize"));

            $("#node-input-noerr").val(noerr);
            this.noerr = noerr;
            node.libs = getLibsList();
        },
        oneditcancel: function() {
            var node = this;

            node.editor.destroy();
            delete node.editor;

            node.initEditor.destroy();
            delete node.initEditor;

            node.finalizeEditor.destroy();
            delete node.finalizeEditor;
        },
        oneditresize: function(size) {
            var rows = $("#dialog-form>div:not(.node-text-editor-row)");
            var height = $("#dialog-form").height();
            for (var i=0; i<rows.length; i++) {
                height -= $(rows[i]).outerHeight(true);
            }
            var editorRow = $("#dialog-form>div.node-text-editor-row");
            height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));
            $("#dialog-form .node-text-editor").css("height",height+"px");

            var height = size.height;
            $("#node-input-init-editor").css("height", (height - 83)+"px");
            $("#node-input-func-editor").css("height", (height - 83)+"px");
            $("#node-input-finalize-editor").css("height", (height - 83)+"px");

            this.initEditor.resize();
            this.editor.resize();
            this.finalizeEditor.resize();

            $("#node-input-libs-container").css("height", (height - 192)+"px");
        },
        onadd: function() {
            if (this.name === '_DEFAULT_') {
                this.name = ''
                RED.actions.invoke("core:generate-node-names", this, {generateHistory: false})
            }
        }
    });
})();
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="function">
    <p>A JavaScript function to run against the messages being received by the node.</p>
    <p>The messages are passed in as a JavaScript object called <code>msg</code>.</p>
    <p>By convention it will have a <code>msg.payload</code> property containing
       the body of the message.</p>
    <p>The function is expected to return a message object (or multiple message objects), but can choose
       to return nothing in order to halt a flow.</p>
    <p>The <b>On Start</b> tab contains code that will be run whenever the node is started.
        The <b>On Stop</b> tab contains code that will be run when the node is stopped.</p>
    <p>If the On Start code returns a Promise object, the node will not start handling messages
        until the promise is resolved.</p>
    <h3>Details</h3>
    <p>See the <a target="_blank" href="https://nodered.org/docs/writing-functions.html">online documentation</a>
    for more information on writing functions.</p>
    <h4>Sending messages</h4>
    <p>The function can either return the messages it wants to pass on to the next nodes
    in the flow, or can call <code>node.send(messages)</code>.</p>
    <p>It can return/send:</p>
    <ul>
      <li>a single message object - passed to nodes connected to the first output</li>
      <li>an array of message objects - passed to nodes connected to the corresponding outputs</li>
    </ul>
    <p>Note: The setup code is executed during the initialization of nodes. Therefore, if <code>node.send</code> is called in the setup tab, subsequent nodes may not be able to receive the message.</p>
    <p>If any element of the array is itself an array of messages, multiple
          messages are sent to the corresponding output.</p>
    <p>If null is returned, either by itself or as an element of the array, no
          message is passed on.</p>
    <h4>Logging and Error Handling</h4>
    <p>To log any information, or report an error, the following functions are available:</p>
      <ul>
          <li><code>node.log("Log message")</code></li>
          <li><code>node.warn("Warning")</code></li>
          <li><code>node.error("Error")</code></li>
      </ul>
    </p>
    <p>The Catch node can also be used to handle errors. To invoke a Catch node,
    pass <code>msg</code> as a second argument to <code>node.error</code>:</p>
    <pre>node.error("Error",msg);</pre>
    <h4>Accessing Node Information</h4>
    <p>The following properties are available to access information about the node:</p>
    <ul>
        <li><code>node.id</code> - id of the node</li>
        <li><code>node.name</code> - name of the node</li>
        <li><code>node.outputCount</code> - number of node outputs</li>
    </ul>
    <h4>Using environment variables</h4>
    <p>Environment variables can be accessed using <code>env.get("MY_ENV_VAR")</code>.</p>
</script>

<!-- --- [red-module:node-red/switch] --- -->
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-template-name="switch">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" style="width: calc(100% - 105px)" data-i18n="[placeholder]common.label.name">
    </div>
    <div class="form-row">
        <label for="node-input-property"><i class="fa fa-ellipsis-h"></i> <span data-i18n="switch.label.property"></span></label>
        <input type="text" id="node-input-property" style="width: calc(100% - 105px)"/>
        <input type="hidden" id="node-input-outputs"/>
    </div>
    <div class="form-row node-input-rule-container-row">
        <ol id="node-input-rule-container"></ol>
    </div>
    <div class="form-row">
        <select id="node-input-checkall" style="width:100%; margin-right:5px;">
            <option value="true" data-i18n="switch.checkall"></option>
            <option value="false" data-i18n="switch.stopfirst"></option>
        </select>
    </div>
    <div class="form-row">
        <input type="checkbox" id="node-input-repair" style="display: inline-block; width: auto; vertical-align: top;">
        <label style="width: auto;" for="node-input-repair"><span data-i18n="switch.label.repair"></span></label></input>
    </div>
</script>

<script type="text/javascript">
(function() {
    var operators = [
        {v:"eq",t:"==",kind:'V'},
        {v:"neq",t:"!=",kind:'V'},
        {v:"lt",t:"<",kind:'V'},
        {v:"lte",t:"<=",kind:'V'},
        {v:"gt",t:">",kind:'V'},
        {v:"gte",t:">=",kind:'V'},
        {v:"hask",t:"switch.rules.hask",kind:'V'},
        {v:"btwn",t:"switch.rules.btwn",kind:'V'},
        {v:"cont",t:"switch.rules.cont",kind:'V'},
        {v:"regex",t:"switch.rules.regex",kind:'V'},
        {v:"true",t:"switch.rules.true",kind:'V'},
        {v:"false",t:"switch.rules.false",kind:'V'},
        {v:"null",t:"switch.rules.null",kind:'V'},
        {v:"nnull",t:"switch.rules.nnull",kind:'V'},
        {v:"istype",t:"switch.rules.istype",kind:'V'},
        {v:"empty",t:"switch.rules.empty",kind:'V'},
        {v:"nempty",t:"switch.rules.nempty",kind:'V'},
        {v:"head",t:"switch.rules.head",kind:'S'},
        {v:"index",t:"switch.rules.index",kind:'S'},
        {v:"tail",t:"switch.rules.tail",kind:'S'},
        {v:"jsonata_exp",t:"switch.rules.exp",kind:'O'},
        {v:"else",t:"switch.rules.else",kind:'O'}
    ];

    var previousValueType = {value:"prev",label:RED._("node-red:switch.previous"),hasValue:false};
    function clipValueLength(v) {
        if (v.length > 15) {
            return v.substring(0,15)+"...";
        }
        return v;
    }
    function prop2name(key) {
        var result = RED.utils.parseContextKey(key);
        return result.key;
    }
    function getValueLabel(t,v) {
        if (t === 'str') {
            return '"'+clipValueLength(v)+'"';
        } else if (t === 'msg') {
            return t+"."+clipValueLength(v);
        } else if (t === 'flow' || t === 'global') {
            return t+"."+clipValueLength(prop2name(v));
        }
        return clipValueLength(v);
    }

    function exportRule(rule) {
        var type = rule.find("select").val();
        var r = {t:type};
        if (!(type === "true" || type === "false" || type === "null" || type === "nnull" || type === "empty" || type === "nempty" || type === "else")) {
            if ((type === "btwn") || (type === "index")) {
                r.v = rule.find(".node-input-rule-btwn-value").typedInput('value');
                r.vt = rule.find(".node-input-rule-btwn-value").typedInput('type');
                r.v2 = rule.find(".node-input-rule-btwn-value2").typedInput('value');
                r.v2t = rule.find(".node-input-rule-btwn-value2").typedInput('type');
            } else if ((type === "head") || (type === "tail")) {
                r.v = rule.find(".node-input-rule-num-value").typedInput('value');
                r.vt = rule.find(".node-input-rule-num-value").typedInput('type');
            } else if (type === "istype") {
                r.v = rule.find(".node-input-rule-type-value").typedInput('type');
                r.vt = rule.find(".node-input-rule-type-value").typedInput('type');
            } else if (type === "jsonata_exp") {
                r.v = rule.find(".node-input-rule-exp-value").typedInput('value');
                r.vt = rule.find(".node-input-rule-exp-value").typedInput('type');
            } else {
                r.v = rule.find(".node-input-rule-value").typedInput('value');
                r.vt = rule.find(".node-input-rule-value").typedInput('type');
            }
            if (type === "regex") {
                r.case = rule.find(".node-input-rule-case").prop("checked");
            }
        }
        return r;
    }

    function createValueField(row, defaultType){
        return $('<input/>',{class:"node-input-rule-value",type:"text",style:"width: 100%;"}).appendTo(row)
            .typedInput({default:defaultType||'str',types:['msg','flow','global','str','num','jsonata','env',previousValueType]});
    }

    function createNumValueField(row, defaultType){
        return $('<input/>',{class:"node-input-rule-num-value",type:"text",style:"width: 100%;"}).appendTo(row)
            .typedInput({default:defaultType||'num',types:['flow','global','num','jsonata','env']});
    }

    function createExpValueField(row){
        return $('<input/>',{class:"node-input-rule-exp-value",type:"text",style:"width: 100%;"}).appendTo(row)
            .typedInput({default:'jsonata',types:['jsonata']});
    }

    function createBtwnValueField(row, defaultType){
        return $('<input/>',{class:"node-input-rule-btwn-value",type:"text",style:"width: 100%;"}).appendTo(row)
                .typedInput({default:defaultType||'num',types:['msg','flow','global','str','num','jsonata','env',previousValueType]});
    }

    function createBtwnValue2Field(row3, andLabel, defaultType){
        $('<div/>',{class:"node-input-rule-btwn-label", style:"width: 120px; text-align: right;"}).text(" "+andLabel+" ").appendTo(row3);
        var row3InputCell = $('<div/>',{style:"flex-grow:1; margin-left: 5px;"}).appendTo(row3);
        return $('<input/>',{class:"node-input-rule-btwn-value2",type:"text",style:"width: 100%"}).appendTo(row3InputCell)
            .typedInput({default:defaultType||'num',types:['msg','flow','global','str','num','jsonata','env',previousValueType]});
    }

    function createTypeValueField(row, defaultType){
        return $('<input/>',{class:"node-input-rule-type-value",type:"text",style:"width: 100%;"}).appendTo(row).typedInput({default:defaultType || 'string',types:[
            {value:"string",label:RED._("common.type.string"),hasValue:false,icon:"red/images/typedInput/az.svg"},
            {value:"number",label:RED._("common.type.number"),hasValue:false,icon:"red/images/typedInput/09.svg"},
            {value:"boolean",label:RED._("common.type.boolean"),hasValue:false,icon:"red/images/typedInput/bool.svg"},
            {value:"array",label:RED._("common.type.array"),hasValue:false,icon:"red/images/typedInput/json.svg"},
            {value:"buffer",label:RED._("common.type.buffer"),hasValue:false,icon:"red/images/typedInput/bin.svg"},
            {value:"object",label:RED._("common.type.object"),hasValue:false,icon:"red/images/typedInput/json.svg"},
            {value:"json",label:RED._("common.type.jsonString"),hasValue:false,icon:"red/images/typedInput/json.svg"},
            {value:"undefined",label:RED._("common.type.undefined"),hasValue:false},
            {value:"null",label:RED._("common.type.null"),hasValue:false}
        ]});
    }

    RED.nodes.registerType('switch', {
        color: "#E2D96E",
        category: 'function',
        defaults: {
            name: {value:""},
            property: {value:"payload", required:true,
                       label:RED._("node-red:common.label.payload"),
                       validate: RED.validators.typedInput("propertyType", false)},
            propertyType: { value:"msg" },
            rules: {
                value:[{t:"eq", v:"", vt:"str"}],
                validate: function (rules, opt) {
                    let msg;
                    const errors = []
                    if (!rules || rules.length === 0) { return true }
                    for (var i=0;i<rules.length;i++) {
                        const opt = { label: RED._('node-red:switch.label.rule')+' '+(i+1) }
                        const r = rules[i];
                        if (r.t !== 'istype') {
                            if (r.hasOwnProperty('v')) {
                                if ((msg = RED.utils.validateTypedProperty(r.v,r.vt,opt)) !== true) {
                                    errors.push(msg)
                                }
                            }
                            if (r.hasOwnProperty('v2')) {
                                if ((msg = RED.utils.validateTypedProperty(r.v2,r.v2t,opt)) !== true) {
                                    errors.push(msg)
                                }
                            }
                        }
                    }
                    if (errors.length) {
                        console.log(errors)
                        return errors
                    }
                    return true;
                }
            },
            checkall: {value:"true", required:true},
            repair: {value:false},
            outputs: {value:1}
        },
        inputs: 1,
        outputs: 1,
        outputLabels: function(index) {
            var rule = this.rules[index];
            var label = "";
            if (rule) {
                for (var i=0;i<operators.length;i++) {
                    if (operators[i].v === rule.t) {
                        label = /^switch/.test(operators[i].t)?this._(operators[i].t):operators[i].t;
                        break;
                    }
                }
                if ((rule.t === 'btwn') || (rule.t === 'index')) {
                    label += " "+getValueLabel(rule.vt,rule.v)+" & "+getValueLabel(rule.v2t,rule.v2);
                } else if (rule.t !== 'true' && rule.t !== 'false' && rule.t !== 'null' && rule.t !== 'nnull' && rule.t !== 'empty' && rule.t !== 'nempty' && rule.t !== 'else' ) {
                    label += " "+getValueLabel(rule.vt,rule.v);
                }
                return label;
            }
        },
        icon: "switch.svg",
        label: function() {
            return this.name||this._("switch.switch");
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            var node = this;


            $("#node-input-property").typedInput({default:this.propertyType||'msg',types:['msg','flow','global','jsonata','env']});
            var outputCount = $("#node-input-outputs").val("{}");

            var andLabel = this._("switch.and");
            var caseLabel = this._("switch.ignorecase");

            $("#node-input-rule-container").css('min-height','150px').css('min-width','450px').editableList({
                addItem: function(container,i,opt) {
                    var focusValueField = false;
                    if (!opt.hasOwnProperty('r')) {
                        opt.r = {};
                        if (i > 0) {
                            var lastRule = $("#node-input-rule-container").editableList('getItemAt',i-1);
                            var exportedRule = exportRule(lastRule.element);
                            if (exportedRule.t === "istype") {
                                opt.r.vt = (exportedRule.vt === "number") ? "num" : "str";
                            } else {
                                opt.r.vt = exportedRule.vt;
                            }
                            opt.r.v = "";
                            // We could copy the value over as well and preselect it (see the 'activeElement' code below)
                            // But not sure that feels right. Is copying over the last value 'expected' behaviour?
                            // It would make sense for an explicit 'copy' action, but not sure where the copy button would
                            // go for each rule without being wasted space for most users.
                            // opt.r.v = exportedRule.v;
                            focusValueField = true;
                        }
                    }

                    opt.element = container;
                    var rule = opt.r;
                    if (!rule.hasOwnProperty('t')) {
                        rule.t = 'eq';
                    }
                    if (!opt.hasOwnProperty('i')) {
                        opt._i = Math.floor((0x99999-0x10000)*Math.random()).toString();
                    }
                    container.css({
                        overflow: 'hidden',
                        whiteSpace: 'nowrap',
                        display: "flex",
                        "align-items":"center"
                    });
                    var inputRows = $('<div></div>',{style:"flex-grow:1"}).appendTo(container);
                    var row = $('<div></div>',{style:"display: flex;"}).appendTo(inputRows);
                    var row2 = $('<div/>',{style:"display: flex; padding-top: 5px; padding-left: 175px;"}).appendTo(inputRows);
                    var row3 = $('<div/>',{style:"display: flex; padding-top: 5px; align-items: center"}).appendTo(inputRows);

                    var row4 = $('<div/>',{style:"visibility: hidden; height: 0px;"}).appendTo(inputRows);
                    var textSpan = $("<span/>").appendTo(row4);
                    var selectField = $('<select/>',{style:"width:120px; text-align: center;"}).appendTo(row);
                    var group0 = $('<optgroup/>', { label: RED._("node-red:switch.label.value-rules") }).appendTo(selectField);
                    for (var d in operators) {
                        if(operators[d].kind === 'V') {
                            group0.append($("<option></option>").val(operators[d].v).text(/^switch/.test(operators[d].t)?node._(operators[d].t):operators[d].t));
                        }
                    }
                    var group1 = $('<optgroup/>', { label: RED._("node-red:switch.label.sequence-rules") }).appendTo(selectField);
                    for (var d in operators) {
                        if(operators[d].kind === 'S') {
                            group1.append($("<option></option>").val(operators[d].v).text(/^switch/.test(operators[d].t)?node._(operators[d].t):operators[d].t));
                        }
                    }
                    for (var d in operators) {
                        if(operators[d].kind === 'O') {
                            selectField.append($("<option></option>").val(operators[d].v).text(/^switch/.test(operators[d].t)?node._(operators[d].t):operators[d].t));
                        }
                    }

                    var rowInputCell = $('<div>',{style:"flex-grow:1; margin-left: 5px;"}).appendTo(row);


                    var valueField = null;
                    var numValueField = null;
                    var expValueField = null;
                    var btwnAndLabel = null;
                    var btwnValueField = null;
                    var btwnValue2Field = null;
                    var typeValueField = null;

                    var finalspan = $('<span/>',{style:"margin-left: 5px;"}).appendTo(container);
                    finalspan.append(' &#8594; <span class="node-input-rule-index">'+(i+1)+'</span> ');

                    var caseSensitive = $('<input/>',{id:"node-input-rule-case-"+i,class:"node-input-rule-case",type:"checkbox",style:"width:auto;vertical-align:top"}).appendTo(row2);
                    $('<label/>',{for:"node-input-rule-case-"+i,style:"margin-left: 3px;"}).text(caseLabel).appendTo(row2);

                    selectField.on("change", function() {
                        var fieldToFocus;
                        var type = selectField.val();
                        if (valueField) { valueField.typedInput('hide'); }
                        if (expValueField) { expValueField.typedInput('hide'); }
                        if (numValueField) { numValueField.typedInput('hide'); }
                        if (typeValueField) { typeValueField.typedInput('hide'); }
                        if (btwnValueField) { btwnValueField.typedInput('hide'); }
                        if (btwnValue2Field) { btwnValue2Field.typedInput('hide'); }

                        if ((type === "btwn") || (type === "index")) {
                            if (!btwnValueField){
                                btwnValueField = createBtwnValueField(rowInputCell);
                            }
                            btwnValueField.typedInput('show');
                            fieldToFocus = btwnValueField;
                        } else if ((type === "head") || (type === "tail")) {
                            if (!numValueField){
                                numValueField = createNumValueField(rowInputCell);
                            }
                            numValueField.typedInput('show');
                            fieldToFocus = numValueField;
                        } else if (type === "jsonata_exp") {
                            if (!expValueField){
                                expValueField = createExpValueField(rowInputCell);
                            }
                            expValueField.typedInput('show');
                            fieldToFocus = expValueField;

                        } else if (type === "istype") {
                            if (!typeValueField){
                                typeValueField = createTypeValueField(rowInputCell);
                            }
                            typeValueField.typedInput('show');
                            fieldToFocus = typeValueField;
                        } else if (! (type === "true" || type === "false" || type === "null" || type === "nnull" || type === "empty" || type === "nempty" || type === "else" )) {
                                if (!valueField){
                                    valueField = createValueField(rowInputCell);
                                }
                                valueField.typedInput('show');
                                fieldToFocus = valueField;
                        }
                        if (type === "regex") {
                            row2.show();
                            row3.hide();
                        } else if ((type === "btwn") || (type === "index")) {
                            row2.hide();
                            row3.show();
                            if (!btwnValue2Field){
                                btwnValue2Field = createBtwnValue2Field(row3, andLabel);
                            }
                            btwnValue2Field.typedInput('show');
                        } else {
                            row2.hide();
                            row3.hide();
                        }
                        var selectedLabel = selectField.find("option:selected").text();

                        textSpan.text(selectedLabel);
                        var width = textSpan.width();
                        if (width <= 30) {
                            selectField.outerWidth(60);
                        } else if (width <= 85) {
                            selectField.outerWidth(120);
                        } else {
                            selectField.width("auto")
                        }
                        if (fieldToFocus) {
                            fieldToFocus.typedInput("focus");
                        }
                        // Preselect the contents of the element
                        // if (focusValueField && document.activeElement) {
                        //     document.activeElement.selectionStart = 0;
                        //     document.activeElement.selectionEnd = document.activeElement.value.length;
                        // }
                    });
                    selectField.val(rule.t);

                    if ((rule.t == "btwn") || (rule.t == "index")) {
                        btwnValueField = createBtwnValueField(rowInputCell,rule.vt||'num');
                        btwnValueField.typedInput('value',rule.v);
                        btwnValue2Field = createBtwnValue2Field(row3, andLabel,rule.v2t||'num');
                        btwnValue2Field.typedInput('value',rule.v2);
                    } else if ((rule.t === "head") || (rule.t === "tail")) {
                        numValueField = createNumValueField(rowInputCell,rule.vt||'num');
                        numValueField.typedInput('value',rule.v);
                    } else if (rule.t === "istype") {
                        typeValueField = createTypeValueField(rowInputCell,rule.vt);
                        typeValueField.typedInput('value',rule.vt);
                    } else if (rule.t === "jsonata_exp") {
                        expValueField = createExpValueField(rowInputCell,rule.vt||'jsonata');
                        expValueField.typedInput('value',rule.v);
                    } else if (typeof rule.v != "undefined") {
                        valueField = createValueField(rowInputCell,rule.vt||'str');
                        valueField.typedInput('value',rule.v);
                    }
                    caseSensitive.prop('checked',!!rule.case);
                    selectField.change();

                    var currentOutputs = JSON.parse(outputCount.val()||"{}");
                    currentOutputs[opt.hasOwnProperty('i')?opt.i:opt._i] = i;
                    outputCount.val(JSON.stringify(currentOutputs));
                },
                removeItem: function(opt) {
                    var currentOutputs = JSON.parse(outputCount.val()||"{}");
                    if (opt.hasOwnProperty('i')) {
                        currentOutputs[opt.i] = -1;
                    } else {
                        delete currentOutputs[opt._i];
                    }
                    var rules = $("#node-input-rule-container").editableList('items');
                    rules.each(function(i) {
                        $(this).find(".node-input-rule-index").html(i+1);
                        var data = $(this).data('data');
                        currentOutputs[data.hasOwnProperty('i')?data.i:data._i] = i;
                    });
                    outputCount.val(JSON.stringify(currentOutputs));
                },
                sortItems: function(rules) {
                    var currentOutputs = JSON.parse(outputCount.val()||"{}");
                    var rules = $("#node-input-rule-container").editableList('items');
                    rules.each(function(i) {
                        $(this).find(".node-input-rule-index").html(i+1);
                        var data = $(this).data('data');
                        currentOutputs[data.hasOwnProperty('i')?data.i:data._i] = i;
                    });
                    outputCount.val(JSON.stringify(currentOutputs));
                },
                sortable: true,
                removable: true
            });

            for (var i=0;i<this.rules.length;i++) {
                var rule = this.rules[i];
                $("#node-input-rule-container").editableList('addItem',{r:rule,i:i});
            }
        },
        oneditsave: function() {
            var rules = $("#node-input-rule-container").editableList('items');
            var node = this;
            node.rules = [];
            rules.each(function(i) {
                node.rules.push(exportRule($(this)));
            });
            this.propertyType = $("#node-input-property").typedInput('type');
        },
        oneditresize: function(size) {
            var rows = $("#dialog-form>div:not(.node-input-rule-container-row)");
            var height = size.height;
            for (var i=0;i<rows.length;i++) {
                height -= $(rows[i]).outerHeight(true);
            }
            var editorRow = $("#dialog-form>div.node-input-rule-container-row");
            height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));
            height += 16;
            $("#node-input-rule-container").editableList('height',height);
        }
    });
})();
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="switch">
    <p>Route messages based on their property values or sequence position.</p>
    <h3>Details</h3>
    <p>When a message arrives, the node will evaluate each of the defined rules
    and forward the message to the corresponding outputs of any matching rules.</p>
    <p>Optionally, the node can be set to stop evaluating rules once it finds one
    that matches.</p>
    <p>The rules can be evaluated against an individual message property, a flow or global
    context property, environment variable or the result of a JSONata expression.</p>
    <h4>Rules</h4>
    <p>There are four types of rule:</p>
    <ol>
        <li><b>Value</b> rules are evaluated against the configured property</li>
        <li><b>Sequence</b> rules can be used on message sequences, such as those
            generated by the Split node</li>
        <li>A JSONata <b>Expression</b> can be provided that will be evaluated
            against the whole message and will match if the expression returns
            a true value.</li>
        <li>An <b>Otherwise</b> rule can be used to match if none of the preceeding
            rules have matched.</li>
    </ol>
    <h4>Notes</h4>
    <p>The <code>is true/false</code> and <code>is null</code> rules perform strict
       comparisons against those types. They do not convert between types.</p>
    <p>The <code>is empty</code> and <code>is not empty</code> rules can be used to test the length of Strings, Arrays and Buffers, or the number of properties an Object has. Neither rule will pass if the property being tested has a <code>boolean</code>, <code>null</code> 
       or <code>undefined</code> value.</p>
    <h4>Handling message sequences</h4>
    <p>By default, the node does not modify the <code>msg.parts</code> property of messages
       that are part of a sequence.</p>
    <p>The <b>recreate message sequences</b> option can be enabled to generate new message sequences
       for each rule that matches. In this mode, the node will buffer the entire incoming
       sequence before sending the new sequences on. The runtime setting <code>nodeMessageBufferMaxLength</code>
       can be used to limit how many messages nodes will buffer.</p>
</script>

<!-- --- [red-module:node-red/change] --- -->

<script type="text/html" data-template-name="change">
    <style>
        ol#node-input-rule-container .red-ui-typedInput-container {
            flex:1;
        }
    </style>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" style="width: calc(100% - 105px)"  data-i18n="[placeholder]common.label.name">
    </div>
    <div class="form-row" style="margin-bottom:0;">
        <label><i class="fa fa-list"></i> <span data-i18n="change.label.rules"></span></label>
    </div>
    <div class="form-row node-input-rule-container-row">
        <ol id="node-input-rule-container"></ol>
    </div>
</script>

<script type="text/javascript">
(function() {
    RED.nodes.registerType('change', {
        color: "#E2D96E",
        category: 'function',
        defaults: {
            name: {value:""},
            rules:{
                value:[{t:"set",p:"payload",pt:"msg",to:"",tot:"str"}],
                validate: function(rules, opt) {
                    let msg;
                    const errors = []
                    if (!rules || rules.length === 0) { return true }
                    for (var i=0;i<rules.length;i++) {
                        const opt = { label: RED._('node-red:change.label.rule')+' '+(i+1) }
                        const r = rules[i];
                        if (r.t === 'set' || r.t === 'change' || r.t === 'delete' || r.t === 'move') {
                            if ((msg = RED.utils.validateTypedProperty(r.p,r.pt,opt)) !== true) {
                                errors.push(msg)
                            }
                        }
                        if (r.t === 'set' || r.t === 'change' || r.t === 'move') {
                            if ((msg = RED.utils.validateTypedProperty(r.to,r.tot,opt)) !== true) {
                                errors.push(msg)
                            }
                        }
                        if (r.t === 'change') {
                            if ((msg = RED.utils.validateTypedProperty(r.from,r.fromt,opt)) !== true) {
                                errors.push(msg)
                            }
                        }
                    }
                    if (errors.length) {
                        return errors
                    }
                    return true;
                }
            },
            // legacy
            action: {value:""},
            property: {value:""},
            from: {value:""},
            to: {value:""},
            reg: {value:false}
        },
        inputs: 1,
        outputs: 1,
        icon: "swap.svg",
        label: function() {
            function prop2name(type, key) {
                var result = RED.utils.parseContextKey(key);
                return type +"." +result.key;
            }
            if (this.name) {
                return this.name;
            }
            if (!this.rules) {
                if (this.action === "replace") {
                    return this._("change.label.set",{property:"msg."+this.property});
                } else if (this.action === "change") {
                    return this._("change.label.change",{property:"msg."+this.property});
                } else if (this.action === "move") {
                    return this._("change.label.move",{property:"msg."+this.property});
                } else {
                    return this._("change.label.delete",{property:"msg."+this.property});
                }
            } else {
                if (this.rules.length == 1) {
                    if (this.rules[0].t === "set") {
                        return this._("change.label.set",{property:prop2name((this.rules[0].pt||"msg"), this.rules[0].p)});
                    } else if (this.rules[0].t === "change") {
                        return this._("change.label.change",{property:prop2name((this.rules[0].pt||"msg"), this.rules[0].p)});
                    } else if (this.rules[0].t === "move") {
                        return this._("change.label.move",{property:prop2name((this.rules[0].pt||"msg"), this.rules[0].p)});
                    } else {
                        return this._("change.label.delete",{property:prop2name((this.rules[0].pt||"msg"), this.rules[0].p)});
                    }
                } else {
                    return this._("change.label.changeCount",{count:this.rules.length});
                }
            }
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function() {
            var set = this._("change.action.set");
            var change = this._("change.action.change");
            var del = this._("change.action.delete");
            var move = this._("change.action.move");
            var to = this._("change.action.to");
            var toValueLabel = this._("change.action.toValue",to);
            var search = this._("change.action.search");
            var replace = this._("change.action.replace");
            var regex = this._("change.label.regex");
            var deepCopyLabel = this._("change.label.deepCopy");

            function createPropertyValue(row2_1, row2_2, defaultType) {
                var propValInput = $('<input/>',{class:"node-input-rule-property-value",type:"text"})
                    .appendTo(row2_1)
                    .typedInput({default:defaultType||'str',types:['msg','flow','global','str','num','bool','json','bin','date','jsonata','env']});

                var dcLabel = $('<label style="padding-left: 130px;"></label>').appendTo(row2_2);
                var deepCopy = $('<input type="checkbox" class="node-input-rule-property-deepCopy" style="width: auto; margin: 0 6px 0 0">').appendTo(dcLabel)
                $('<span>').text(deepCopyLabel).appendTo(dcLabel)

                propValInput.on("change", function(evt,type,val) {
                    row2_2.toggle(type === "msg" || type === "flow" || type === "global" || type === "env");
                })
                return [propValInput, deepCopy];
            }
            function createFromValue(row3_1, defaultType) {
                return $('<input/>',{class:"node-input-rule-property-search-value",type:"text"})
                .appendTo(row3_1)
                .typedInput({default:defaultType||'str',types:['msg','flow','global','str','re','num','bool','env']});
            }
            function createToValue(row3_2, defaultType) {
                return $('<input/>',{class:"node-input-rule-property-replace-value",type:"text"})
                .appendTo(row3_2)
                .typedInput({default:defaultType||'str',types:['msg','flow','global','str','num','bool','json','bin','env']});
            }
            function createMoveValue(row4, defaultType) {
                return $('<input/>',{class:"node-input-rule-property-move-value",type:"text"})
                .appendTo(row4)
                .typedInput({default:defaultType||'msg',types:['msg','flow','global']});
            }

            $('#node-input-rule-container').css('min-height','150px').css('min-width','450px').editableList({
                addItem: function(container,i,opt) {
                    var rule = opt;
                    if (!rule.hasOwnProperty('t')) {
                        rule = {t:"set",p:"payload",to:"",tot:"str"};
                    }
                    if (rule.t === "change" && rule.re) {
                        rule.fromt = 're';
                        delete rule.re;
                    }
                    if (rule.t === "set" && !rule.tot) {
                        if (rule.to.indexOf("msg.") === 0 && !rule.tot) {
                            rule.to = rule.to.substring(4);
                            rule.tot = "msg";
                        } else {
                            rule.tot = "str";
                        }
                    }
                    if (rule.t === "move" && !rule.tot) {
                        rule.tot = "msg";
                    }
                    container.css({
                        overflow: 'hidden',
                        whiteSpace: 'nowrap'
                    });
                    let fragment = document.createDocumentFragment();
                    var row1 = $('<div/>',{style:"display:flex; align-items: baseline"}).appendTo(fragment);
                    var row2 = $('<div/>',{style:"margin-top:8px;"}).appendTo(fragment);
                    var row3 = $('<div/>',{style:"margin-top:8px;"}).appendTo(fragment);
                    var row4 = $('<div/>',{style:"display:flex;margin-top:8px;align-items: baseline"}).appendTo(fragment);

                    var selectField = $('<select/>',{class:"node-input-rule-type",style:"width:110px; margin-right:10px;"}).appendTo(row1);
                    var selectOptions = [{v:"set",l:set},{v:"change",l:change},{v:"delete",l:del},{v:"move",l:move}];
                    for (var i=0; i<4; i++) {
                        selectField.append($("<option></option>").val(selectOptions[i].v).text(selectOptions[i].l));
                    }

                    var propertyName = $('<input/>',{class:"node-input-rule-property-name",type:"text"})
                        .appendTo(row1)
                        .typedInput({types:['msg','flow','global']});

                    var row2_1 = $('<div/>', {style:"display:flex;align-items: baseline"}).appendTo(row2);
                    $('<div/>',{style:"display:inline-block;text-align:right; width:120px; padding-right:10px; box-sizing:border-box;"})
                        .text(toValueLabel)
                        .appendTo(row2_1);

                    var row2_2 = $('<div/>', {style:"margin-top: 4px;"}).appendTo(row2);

                    var row3_1 = $('<div/>', {style:"display:flex;align-items: baseline"}).appendTo(row3);
                    $('<div/>',{style:"display:inline-block;text-align:right; width:120px; padding-right:10px; box-sizing:border-box;"})
                        .text(search)
                        .appendTo(row3_1);

                    var row3_2 = $('<div/>',{style:"display:flex;margin-top:8px;align-items: baseline"}).appendTo(row3);
                    $('<div/>',{style:"display:inline-block;text-align:right; width:120px; padding-right:10px; box-sizing:border-box;"})
                        .text(replace)
                        .appendTo(row3_2);

                    $('<div/>',{style:"display:inline-block;text-align:right; width:120px; padding-right:10px; box-sizing:border-box;"})
                        .text(to)
                        .appendTo(row4);

                    let propertyValue = null;
                    let fromValue = null;
                    let toValue = null;
                    let moveValue = null;

                    selectField.on("change", function() {
                        var type = $(this).val();
                        if (propertyValue) {
                            propertyValue.typedInput('hide');
                        }
                        if (fromValue) {
                            fromValue.typedInput('hide');
                        }
                        if (toValue) {
                            toValue.typedInput('hide');
                        }
                        if (moveValue) {
                            moveValue.typedInput('hide');
                        }

                        if (type == "set") {
                            if(!propertyValue) {
                                var parts = createPropertyValue(row2_1, row2_2);
                                propertyValue = parts[0];
                                deepCopy = parts[1];
                            }
                            propertyValue.typedInput('show');
                            row2.show();
                            row3.hide();
                            row4.hide();
                        } else if (type == "change") {
                            if(!fromValue) {
                                fromValue = createFromValue(row3_1);
                            }
                            fromValue.typedInput('show');
                            if(!toValue) {
                                toValue = createToValue(row3_2);
                            }
                            toValue.typedInput('show');
                            row2.hide();
                            row3.show();
                            row4.hide();
                        } else if (type == "delete") {
                            row2.hide();
                            row3.hide();
                            row4.hide();
                        } else if (type == "move") {
                            if(!moveValue) {
                                moveValue = createMoveValue(row4);
                            }
                            moveValue.typedInput('show');
                            row2.hide();
                            row3.hide();
                            row4.show();
                        }
                    });

                    selectField.val(rule.t);
                    propertyName.typedInput('value',rule.p);
                    propertyName.typedInput('type',rule.pt);
                    if (rule.t == "set") {
                        var parts = createPropertyValue(row2_1, row2_2, rule.tot);
                        propertyValue = parts[0];
                        deepCopy = parts[1];
                        propertyValue.typedInput('value',rule.to);
                        deepCopy.prop("checked", !!rule.dc);
                    }
                    if (rule.t == "move") {
                        moveValue = createMoveValue(row4,rule.tot);
                        moveValue.typedInput('value',rule.to);
                    }
                    if (rule.t == "change") {
                        fromValue = createFromValue(row3_1, rule.fromt);
                        fromValue.typedInput('value',rule.from);

                        toValue = createToValue(row3_2,rule.tot);
                        toValue.typedInput('value',rule.to);
                    }
                    selectField.change();
                    container[0].appendChild(fragment);
                },
                removable: true,
                sortable: true
            });

            if (!this.rules) {
                var rule = {
                    t:(this.action=="replace"?"set":this.action),
                    p:this.property,
                    pt:"msg"
                };

                if ((rule.t === "set")||(rule.t === "move")) {
                    rule.to = this.to;
                } else if (rule.t === "change") {
                    rule.from = this.from;
                    rule.to = this.to;
                    rule.re = this.reg;
                }

                delete this.to;
                delete this.from;
                delete this.reg;
                delete this.action;
                delete this.property;

                this.rules = [rule];
            }

            for (var i=0; i<this.rules.length; i++) {
                var rule = this.rules[i];
                $("#node-input-rule-container").editableList('addItem',rule);
            }
        },
        oneditsave: function() {
            var rules = $("#node-input-rule-container").editableList('items');
            var node = this;
            node.rules= [];
            rules.each(function(i) {
                var rule = $(this);
                var type = rule.find(".node-input-rule-type").val();
                var r = {
                    t:type,
                    p:rule.find(".node-input-rule-property-name").typedInput('value'),
                    pt:rule.find(".node-input-rule-property-name").typedInput('type')
                };
                if (type === "set") {
                    r.to = rule.find(".node-input-rule-property-value").typedInput('value');
                    r.tot = rule.find(".node-input-rule-property-value").typedInput('type');
                    if (rule.find(".node-input-rule-property-deepCopy").prop("checked")) {
                        r.dc = true;
                    }
                } else if (type === "move") {
                    r.to = rule.find(".node-input-rule-property-move-value").typedInput('value');
                    r.tot = rule.find(".node-input-rule-property-move-value").typedInput('type');
                } else if (type === "change") {
                    r.from = rule.find(".node-input-rule-property-search-value").typedInput('value');
                    r.fromt = rule.find(".node-input-rule-property-search-value").typedInput('type');
                    r.to = rule.find(".node-input-rule-property-replace-value").typedInput('value');
                    r.tot = rule.find(".node-input-rule-property-replace-value").typedInput('type');
                }
                node.rules.push(r);
            });
        },
        oneditresize: function(size) {
            var rows = $("#dialog-form>div:not(.node-input-rule-container-row)");
            var height = size.height;
            for (var i=0; i<rows.length; i++) {
                height -= $(rows[i]).outerHeight(true);
            }
            var editorRow = $("#dialog-form>div.node-input-rule-container-row");
            height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));
            height += 16;
            $("#node-input-rule-container").editableList('height',height);
        }
    });
})();
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="change">
    <p>Set, change, delete or move properties of a message, flow context or global context.</p>
    <p>The node can specify multiple rules that will be applied in the order they are defined.</p>
    <h3>Details</h3>
    <p>The available operations are:</p>
    <dl class="message-properties">
    <dt>Set</dt>
    <dd>set a property. The value can be a variety of different types, or
            can be taken from an existing message or context property.</dd>
    <dt>Change</dt>
    <dd>search &amp; replace parts of the property. If regular expressions
        are enabled, the "replace with" property can include capture groups, for
        example <code>$1</code>. Replace will only change the type if there
        is a complete match.</dd>
    <dt>Delete</dt>
    <dd>delete a property.</dd>
    <dt>Move</dt>
    <dd>move or rename a property.</dd>
    </dl>
    <p>The "expression" type uses the <a href="http://jsonata.org/" target="_new">JSONata</a>
    query and expression language.
    </p>
</script>

<!-- --- [red-module:node-red/template] --- -->

<script type="text/html" data-template-name="template">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <div style="display: inline-block; width: calc(100% - 105px)"><input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name"></div>
    </div>
    <div class="form-row">
        <label for="node-input-field"><i class="fa fa-ellipsis-h"></i> <span data-i18n="template.label.property"></span></label>
        <input type="text" id="node-input-field" placeholder="payload" style="width:250px;">
        <input type="hidden" id="node-input-fieldType">
    </div>
    <div class="form-row" style="position: relative; margin-bottom: 0px;">
        <label for="node-input-template"><i class="fa fa-file-code-o"></i> <span data-i18n="template.label.template"></span></label>
        <input type="hidden" id="node-input-template" autofocus="autofocus">
        <div style="position: absolute; right:0;display:inline-block; text-align: right; font-size: 0.8em;">
            <span data-i18n="template.label.format"></span>:
            <select id="node-input-format" style="width:110px; font-size: 10px !important;  height: 24px; padding:0;">
                <option value="handlebars">mustache</option>
                <option value="html">HTML</option>
                <option value="json">JSON</option>
                <option value="javascript">JavaScript</option>
                <option value="css">CSS</option>
                <option value="markdown">Markdown</option>
                <option value="php">PHP</option>
                <option value="python">Python</option>
                <option value="sql">SQL</option>
                <option value="yaml">YAML</option>
                <option value="text" data-i18n="template.label.none"></option>
            </select>
            <button type="button" id="node-template-expand-editor" class="red-ui-button red-ui-button-small"><i class="fa fa-expand"></i></button>
        </div>
    </div>
    <div class="form-row node-text-editor-row">
        <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-template-editor" ></div>
    </div>
    <div class="form-row">
        <label for="node-input-syntax"><i class="fa fa-code"></i> <span data-i18n="template.label.syntax"></span></label>
        <select id="node-input-syntax" style="width:180px;">
            <option value="mustache" data-i18n="template.label.mustache"></option>
            <option value="plain" data-i18n="template.label.plain"></option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-output"><i class="fa fa-long-arrow-right"></i> <span data-i18n="template.label.output"></span></label>
        <select id="node-input-output" style="width:180px;">
            <option value="str" data-i18n="template.label.plain"></option>
            <option value="json" data-i18n="template.label.json"></option>
            <option value="yaml" data-i18n="template.label.yaml"></option>
        </select>
    </div>

</script>

<script type="text/javascript">
    RED.nodes.registerType('template',{
        color:"rgb(243, 181, 103)",
        category: 'function',
        defaults: {
            name: {value:""},
            field: {value:"payload",
                    label:"payload",
                    validate:RED.validators.typedInput("fieldType", false)},
            fieldType: {value:"msg"},
            format: {value:"handlebars"},
            syntax: {value:"mustache"},
            template: {value:"This is the payload: {{payload}} !"},
            output: {value:"str"}
        },
        inputs:1,
        outputs:1,
        icon: "template.svg",
        label: function() {
            return this.name||this._("template.template");;
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            const that = this;
            const stateId = RED.editor.generateViewStateId("node", this, "");
            if (!this.field) {
                this.field = 'payload';
                $("#node-input-field").val("payload");
            }
            if (!this.fieldType) {
                this.fieldType = 'msg';
            }
            if (!this.syntax) {
                this.syntax = 'mustache';
                $("#node-input-syntax").val(this.syntax);
            }
            $("#node-input-field").typedInput({
                default: 'msg',
                types: ['msg','flow','global'],
                typeField: $("#node-input-fieldType")
            });
            this.editor = RED.editor.createEditor({
                id: 'node-input-template-editor',
                mode: 'ace/mode/html',
                stateId: stateId,
                value: $("#node-input-template").val()
            });
            RED.library.create({
                url:"templates", // where to get the data from
                type:"template", // the type of object the library is for
                editor:that.editor, // the field name the main text body goes to
                fields:['name','format','output','syntax'],
                ext: "txt"
            });

            $("#node-input-format").on("change", function() {
                var mod = "ace/mode/"+$("#node-input-format").val();
                that.editor.getSession().setMode({
                    path: mod,
                    v: Date.now()
                });
            });
            RED.popover.tooltip($("#node-template-expand-editor"), RED._("node-red:common.label.expand"));
            $("#node-template-expand-editor").on("click", function (e) {
                e.preventDefault();
                const value = that.editor.getValue();
                that.editor.saveView();
                RED.editor.editText({
                    mode: $("#node-input-format").val(),
                    value: value,
                    stateId: stateId,
                    width: "Infinity",
                    focus: true,
                    complete: function (v, cursor) {
                        that.editor.setValue(v, -1);
                        setTimeout(function () {
                            that.editor.restoreView();
                            that.editor.focus();
                        }, 250);
                    }
                })
            })
        },
        oneditsave: function() {
            $("#node-input-template").val(this.editor.getValue());
            this.editor.destroy();
            delete this.editor;
        },
        oneditcancel: function() {
            this.editor.destroy();
            delete this.editor;
        },
        oneditresize: function(size) {
            var rows = $("#dialog-form>div:not(.node-text-editor-row)");
            var height = $("#dialog-form").height();
            for (var i=0; i<rows.length; i++) {
                height -= $(rows[i]).outerHeight(true);
            }
            var editorRow = $("#dialog-form>div.node-text-editor-row");
            height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));
            $("#dialog-form .node-text-editor").css("height",height+"px");
            this.editor.resize();
        }
    });
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-help-name="template">
    <p>Sets a property based on the provided template.</p>
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>msg <span class="property-type">object</span></dt>
        <dd>A msg object containing information to populate the template.</dd>
        <dt class="optional">template <span class="property-type">string</span></dt>
        <dd>A template to be populated from <code>msg.payload</code>. If not configured in the edit panel,
         this can be set as a property of msg.</dd>
    </dl>
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>msg <span class="property-type">object</span></dt>
        <dd>a msg with a property set by populating the configured template with properties from the incoming msg.</dd>
    </dl>
    <h3>Details</h3>
    <p>By default this uses the <i><a href="http://mustache.github.io/mustache.5.html" target="_blank">mustache</a></i>
    format, but this can be switched off if required.</p>
    <p>For example, when a template of:
    <pre>Hello {{payload.name}}. Today is {{date}}</pre>
    <p>receives a message containing:
    <pre>{
  date: "Monday",
  payload: {
    name: "Fred"
  }
}</pre>
    <p>The resulting property will be:
    <pre>Hello Fred. Today is Monday</pre>
    <p>It is possible to use a property from the flow context or global context. Just use <code>{{flow.name}}</code> or
    <code>{{global.name}}</code>, or for persistable store <code>store</code> use <code>{{flow[store].name}}</code> or
    <code>{{global[store].name}}</code>.
    <p><b>Note: </b>By default, <i>mustache</i> will escape any non-alphanumeric or HTML entities in the values it substitutes.
       To prevent this, use <code>{{{triple}}}</code> braces.</p>
    <p>If you need to use <code>{{ }}</code> within your content, you can change the characters
       used to mark the templated sections. For example, to use <code>[[ ]]</code>
       instead, add the following line to the top of the template:</p>
    <pre>{{=[[ ]]=}}</pre>
    <h4>Using environment variables</h4>
    <p>The template node can access environment variables using the syntax:</p>
    <pre>My favourite colour is {{env.COLOUR}}.</pre>
</script>

<!-- --- [red-module:@gorenje/node-red-mindmap/base] --- -->
<script type="text/javascript">

  window.latestImages = {};
  
  /*
   * ~~Can use https://colordesigner.io/gradient-generator to generate gradient
   * steps~~
   * 
   * Use https://online-free-tools.com/en/css_color_hex_gradient instead, gradient 
   * generator is broken shit.
   */
  window.wmPaletteColours = {
    "50-topic":         '#d0c9f6',
    
    "30-observation":   '#f4adf3',
    "32-question":      '#e0a4f3',
    "35-thought":       '#cb9cf3',
    
    "25-idea":          '#88baff',
    "26-dream":         '#86BDFF',
    "41-metaphor":      '#85C0FF',
    "45-aphorism":      '#84C3FF',
    "20-poesie":        '#82C6FF',
    "22-humour":        '#81C9FF',
    "23-treasure":      '#80CCFF',

    "37-consequence":   '#f6c1cc',
    "38-advantage":     '#efacbf',
    "39-disadvantage":  '#e796b1',
    
    "05-text":          '#c8ffb5',
    "10-blog-post":     '#CDFEBC',
    "12-image":         '#CDFEBC',
    "15-comment":       '#D2FDC3',
    "55-code-base":     '#D7FCCB',
    "57-art":           '#DCFBD2',
    "47-learning":      '#e1fbda',

    "60-inspiration":   '#dfdfb6',
    "62-keyword":       '#E2E2BB',
    "65-quote":         '#E3E3BE',
    "70-definition":    '#E7E8C6',
    "74-bookmark":      '#ECECCE',
    "75-book":          '#F0F1D6',
    "80-author":        '#f5f6de',
  };

  window.mmDefaults = {
    category: 'mindmap',
    _collection: 'writermap',
    defaults: {
      name: {
        value:""
      },
      info: {
        value:""
      },

      sumPass: {
        value: false
      },
      sumPassPrio: {
        value: 0,
      },
      sumPassNodeId: {
        value: ""
      },

      /* createdAt and updatedAt are "internal" attributes that track just
         that: when the node was created and the last time it was updated.
         These aren't shown in the edit window because they are maintained
         internally. These are managed by event handling in the sidebar JS
         code.
      */
      createdAt: {
        value: "",
      },
      updatedAt: {
        value: "",
      },
    },

    inputs:1,
    outputs:1,

    labelStyle: function() {
      return (this.name || this.info) ? "node_label_italic" : "";
    },

    info: function() {
      return this.name ? "# "+this.name+"\n\n---\n\n" : "";
    },

    label: function() {
      return ( (this.name ||
                this.info.replace(/(.{40,60})([ \n\t])/g,"$1\\n$2")) ||
               this._def.paletteLabel || this.type) +
        (this.sumPassPrio && parseInt(this.sumPassPrio) != 0 ? " (" + this.sumPassPrio + ")" : "") +
        (this.sumPass ? " ⭄" : "");
    },

    oneditprepare: function() {
      var that = this;

      this.editor = RED.editor.createEditor({
        id: 'node-input-info-editor',
        mode: 'ace/mode/markdown',
        value: $("#node-input-info").val()
      });
      this.editor.focus();

      writerMapUtils.fillSumPassPrioSelection(that);

      if ( $('#node-input-sumPass').is(":checked") ) {
        writerMapUtils.fillSumPassNodeSelection(that);
        $('#sumpass-node-selection').show()
        $('#node-input-sumPassNodeId').val(that.sumPassNodeId);
      } else {
        $('#sumpass-node-selection').hide()
      }

      $('#node-input-sumPass').on( 'change', function() {
        if ( $('#node-input-sumPass').is(":checked") ) {
          writerMapUtils.fillSumPassNodeSelection(that);
          $('#sumpass-node-selection').show()
          $('#node-input-sumPassNodeId').val(that.sumPassNodeId);
        } else {
          $('#sumpass-node-selection').hide()
        }
      });

      $('#node-input-wordCount').html(
        that.info ? that.info.split(/\s+/).filter(word => word !== '').length : 0
      )

      writerMapUtils.fillTypeDropDown(that);

      $('#node-input-typeDropdown').on('change', (e) => {
        if (e) { e.preventDefault() }

        if ($('#node-input-typeDropdown').val() == "Image" && (that.editor.getValue() || "").trim().match(/^https?:\/\/[^\t\s ]+$/)) {
          that.editor.setValue(`![img](${that.editor.getValue().trim()})`)
        }
      })      
    },

    oneditsave: function() {
      $("#node-input-info").val(this.editor.getValue());
      this.editor.destroy();
      delete this.editor;

      var newType = $('#node-input-typeDropdown').val();
      if ( newType && newType != this.type ) {
        var nde = RED.nodes.node(this.id);
        nde.type = newType;

        this.changed = true;
        nde.dirty = true;

        RED.nodes.dirty(true)
        RED.view.redraw()
      }
    },

    oneditcancel: function() {
      this.editor.destroy();
      delete this.editor;
    },

    oneditresize: function(size) {
      var rows = $("#dialog-form>div:not(.node-text-editor-row)");
      var height = $("#dialog-form").height();
      for (var i=0; i<rows.length; i++) {
        height -= $(rows[i]).outerHeight(true);
      }
      var editorRow = $("#dialog-form>div.node-text-editor-row");
      height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));
      $(".node-text-editor").css("height",height+"px");
      this.editor.resize();
    }
  };

  let writerMapUtils={one:void 0,createPreviewAllImageNodesEventHandler:()=>{setTimeout(()=>{writerMapUtils.createPreviewAllImageNodes()},400)},createPreviewAllImageNodes:()=>{function a(e){var t=document.getElementById("image-output-img-"+e),i=document.getElementById("image-output-bubble-"+e);t&&t.remove(),i&&i.remove(),delete n[e]}let l=160,n=window.latestImages;let t=function(e,t){let i=e.id,n=$("#"+i)[0].getBBox().width,r=new Image,o=document.getElementById("image-output-img-"+i);if(!o){e=document.getElementById(i);if(!e)return;var s=document.createElementNS("http://www.w3.org/2000/svg","polyline"),s=(s.setAttribute("id","image-output-bubble-"+i),s.setAttribute("class","mindmap-image-preview-element"),s.setAttribute("style","fill: #999999; stroke: #999999; stroke-width: 5px;"),e.insertBefore(s,e.lastChild.nextSibling),document.createElementNS("http://www.w3.org/2000/svg","image"));s.setAttribute("id","image-output-img-"+i),s.setAttribute("class","mindmap-image-preview-element"),s.setAttribute("x","0"),s.setAttribute("y","45"),s.setAttribute("width",n||l),s.addEventListener("click",function(){a(i)},{once:!0}),e.insertBefore(s,e.lastChild.nextSibling),o=s}r.onload=function(){o.setAttribute("height",n*r.height/r.width);var e=o.getAttribute("id").replace("img","bubble"),e=document.getElementById(e),t=-2+(n||l)+2,i=45+parseInt(n*r.height/r.width);e.setAttribute("points","-2,45 "+t+",45 "+t+","+i+" "+-2+","+i+" ")},t.startsWith("http")||-1<t.indexOf("/writermap/")?(o.setAttribute("href",t),r.src=t):(o.setAttribute("href","data:image/png;base64,"+t),r.src="data:image/png;base64,"+t)};0<RED.utils.getBrowserInfo().mobile||window.matchMedia("only screen and (max-width: 890px)").matches||RED.nodes.eachNode(e=>{"Image"==e.type&&"writermap"==e._def._collection&&(e.info||"").match(/\!\[.+\]\(([^\s\t\n ]+)\)/)&&0<$("#"+e.id).length&&t(e,(e.info||"").match(/\!\[.+\]\(([^\s\t\n ]+)\)/)[1])})},fillSumPassPrioSelection:e=>{var t=$("#node-input-sumPassPrio");t.html("");for(var i=20;-21<i;i--)t.append($("<option></option>").val(i).html(i));t.val(e.sumPassPrio||0)},fillSumPassNodeSelection:t=>{var i=$("#node-input-sumPassNodeId");i.html(""),i.append($("<option></option>").val("").html(" -- All -- ")),RED.nodes.eachLink(function(e){e.source.id==t.id&&1!=e.target.d&&i.append($("<option></option>").val(e.target.id).html("function"==typeof e.target._def.label?e.target._def.label.call(e.target):"NO LABEL FOR "+e.target.id))})},addTargetToExternalLinks:function(e){return $(e).find("a").each(function(e){var t=$(this).attr("href");/^https?:/.test(t)&&$(this).attr("target","_blank")}),e},setInfoText:function(e,t){e=writerMapUtils.addTargetToExternalLinks($('<div class="red-ui-help"><span class="red-ui-text-bidi-aware" dir="'+RED.text.bidi.resolveBaseTextDir(e)+'">'+e+"</span></div>")).appendTo(t);e.find(".red-ui-text-bidi-aware").contents().filter(function(){return 3===this.nodeType&&""!==this.textContent.trim()}).wrap("<span></span>");e.find("H3").wrapInner('<a class="red-ui-help-info-header expanded" href="#"></a>').find("a").prepend('<i class="fa fa-angle-right">').on("click",function(e){e.preventDefault();for(var t=$(this).hasClass("expanded"),i=$(this).parent().next();1===i.length&&"H3"!==i[0].nodeName;)i.toggle(!t),i=i.next();$(this).toggleClass("expanded",!t)})},allWriterMapTypes:function(){var t=[];return RED.nodes.registry.getNodeList().forEach(e=>{e.types.forEach(e=>{"writermap"==(RED.nodes.registry.getNodeType(e)||{})._collection&&t.push(e)})}),t},fillTypeDropDown:function(e){var t=$("#node-input-typeDropdown");t.html(""),writerMapUtils.allWriterMapTypes().sort((e,t)=>t<e).forEach(e=>{t.append($("<option></option>").val(e).html(e))}),t.val(e.type)}};setTimeout(function(){$(".red-ui-sidebar-info").hasClass("show-tips")&&RED.actions.invoke("core:toggle-show-tips")},1250),RED.events.on("workspace:change",writerMapUtils.createPreviewAllImageNodesEventHandler),RED.events.on("view:selection-changed",function(e){var t,i,n,r,o;writerMapUtils.one&&(document.getElementById(writerMapUtils.one).remove(),delete writerMapUtils.one),e.nodes&&1==e.nodes.length&&e.nodes[0]._def&&"writermap"==e.nodes[0]._def._collection&&(0<RED.utils.getBrowserInfo().mobile||window.matchMedia("only screen and (max-width: 890px)").matches?(e=e.nodes[0],(t=document.getElementById(e.id))&&(r=t.getBoundingClientRect(),i=document.createElement("div"),writerMapUtils.one="writermap-info-box-"+e.id,i.setAttribute("class","red-ui-editor red-ui-panel"),i.setAttribute("style","flex: 1 1 auto; overflow-y: scroll;"),i.setAttribute("xmlns","http://www.w3.org/1999/xhtml"),i.setAttribute("pointer-events","all"),$(i).css("display","flex"),$(i).css("height","290"),$(i).css("color","rgb(85,85,85)"),$(i).css("border","1px solid rgb(85,85,85)"),$(i).css("background-color","white"),$(i).css("border-radius","6px"),$(i).css("padding-bottom","3px"),$(i).css("padding-left","6px"),$(i).css("padding-right","3px"),$(i).css("padding-top","3px"),(n=document.createElementNS("http://www.w3.org/2000/svg","foreignObject")).setAttribute("id",writerMapUtils.one),n.setAttribute("x","0"),n.setAttribute("y",r.height+2),n.setAttribute("width",r.width),n.setAttribute("height","300"),n.setAttribute("pointer-events","all"),r="",e._def&&e._def.info&&(o="function"==typeof(o=e._def.info)?o.call(e):o,r+=RED.utils.renderMarkdown(o)),e.info&&(r+=RED.utils.renderMarkdown(e.info||"")),writerMapUtils.setInfoText(r,i),n.appendChild(i),t.insertBefore(n,t.lastChild.nextSibling),RED.actions.invoke("core:move-selection-to-front"))):$($(".red-ui-sidebar-info-stack > .red-ui-panel")[0]).css("height","150px"))});
</script>

<!-- --- [red-module:@gorenje/node-red-mindmap/topic] --- -->
<script type="text/javascript">
  RED.nodes.registerType('Topic',{ ...window.mmDefaults, ...{
    color: window.wmPaletteColours["50-topic"],
    icon: "font-awesome/fa-text-width",
  }});
</script>

<script type="text/html" data-template-name="Topic">
<div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
</div>

<div class="form-row">
    <label style="display: inline-block; width: 40%;"
           for="node-input-sumPass">
      <i class="fa fa-filter"></i>
      <span>Summaries subnodes?</span>
    </label>
    <input type="checkbox" id="node-input-sumPass"
           style="display:inline-block; width:35px; vertical-align:baseline;">

    <label style="display: inline-block; width: 10%; padding-left: 100px;"
           for="node-input-sumPassPrio">
      <span>Priority: </span>
    </label>
    <select id="node-input-sumPassPrio" style="width: 50px;"></select>
</div>

<div id="sumpass-node-selection" class="hide">
    <div class="form-row">
        <select id="node-input-sumPassNodeId" style="width: 100%">
      </select>
    </div>
</div>

<div class="form-row node-text-editor-row">
    <input type="hidden" id="node-input-info" autofocus="autofocus">
    <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-info-editor"></div>
</div>

<div class="form-row">
    <label for="node-input-typeDropdown">Change Type</label>
    <select id="node-input-typeDropdown"></select>
    
    <label for="node-input-wordCount" style="float: right;">Words:
        <span id="node-input-wordCount"></span>
    </label>
</div>
</script>


<script type="text/html" data-help-name="Topic">
  <p>A writermap node.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-mindmap/observation] --- -->
<script type="text/javascript">
  RED.nodes.registerType('Observation',{ ...window.mmDefaults, ...{
    color: window.wmPaletteColours["30-observation"],
    icon: "font-awesome/fa-binoculars",
  }});
</script>

<script type="text/html" data-template-name="Observation">
<div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
</div>

<div class="form-row">
    <label style="display: inline-block; width: 40%;"
           for="node-input-sumPass">
      <i class="fa fa-filter"></i>
      <span>Summaries subnodes?</span>
    </label>
    <input type="checkbox" id="node-input-sumPass"
           style="display:inline-block; width:35px; vertical-align:baseline;">

    <label style="display: inline-block; width: 10%; padding-left: 100px;"
           for="node-input-sumPassPrio">
      <span>Priority: </span>
    </label>
    <select id="node-input-sumPassPrio" style="width: 50px;"></select>
</div>

<div id="sumpass-node-selection" class="hide">
    <div class="form-row">
        <select id="node-input-sumPassNodeId" style="width: 100%">
      </select>
    </div>
</div>

<div class="form-row node-text-editor-row">
    <input type="hidden" id="node-input-info" autofocus="autofocus">
    <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-info-editor"></div>
</div>

<div class="form-row">
    <label for="node-input-typeDropdown">Change Type</label>
    <select id="node-input-typeDropdown"></select>
    
    <label for="node-input-wordCount" style="float: right;">Words:
        <span id="node-input-wordCount"></span>
    </label>
</div>
</script>


<script type="text/html" data-help-name="Observation">
  <p>A writermap node.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-mindmap/question] --- -->
<script type="text/javascript">
  RED.nodes.registerType('Question',{ ...window.mmDefaults, ...{
    color: window.wmPaletteColours["32-question"],
    icon: "font-awesome/fa-question",
  }});
</script>

<script type="text/html" data-template-name="Question">
<div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
</div>

<div class="form-row">
    <label style="display: inline-block; width: 40%;"
           for="node-input-sumPass">
      <i class="fa fa-filter"></i>
      <span>Summaries subnodes?</span>
    </label>
    <input type="checkbox" id="node-input-sumPass"
           style="display:inline-block; width:35px; vertical-align:baseline;">

    <label style="display: inline-block; width: 10%; padding-left: 100px;"
           for="node-input-sumPassPrio">
      <span>Priority: </span>
    </label>
    <select id="node-input-sumPassPrio" style="width: 50px;"></select>
</div>

<div id="sumpass-node-selection" class="hide">
    <div class="form-row">
        <select id="node-input-sumPassNodeId" style="width: 100%">
      </select>
    </div>
</div>

<div class="form-row node-text-editor-row">
    <input type="hidden" id="node-input-info" autofocus="autofocus">
    <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-info-editor"></div>
</div>

<div class="form-row">
    <label for="node-input-typeDropdown">Change Type</label>
    <select id="node-input-typeDropdown"></select>
    
    <label for="node-input-wordCount" style="float: right;">Words:
        <span id="node-input-wordCount"></span>
    </label>
</div>
</script>


<script type="text/html" data-help-name="Question">
  <p>A writermap node.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-mindmap/thought] --- -->
<script type="text/javascript">
  RED.nodes.registerType('Thought',{ ...window.mmDefaults, ...{
    color: window.wmPaletteColours["35-thought"],
    icon: "node-red/alert.svg",
  }});
</script>

<script type="text/html" data-template-name="Thought">
<div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
</div>

<div class="form-row">
    <label style="display: inline-block; width: 40%;"
           for="node-input-sumPass">
      <i class="fa fa-filter"></i>
      <span>Summaries subnodes?</span>
    </label>
    <input type="checkbox" id="node-input-sumPass"
           style="display:inline-block; width:35px; vertical-align:baseline;">

    <label style="display: inline-block; width: 10%; padding-left: 100px;"
           for="node-input-sumPassPrio">
      <span>Priority: </span>
    </label>
    <select id="node-input-sumPassPrio" style="width: 50px;"></select>
</div>

<div id="sumpass-node-selection" class="hide">
    <div class="form-row">
        <select id="node-input-sumPassNodeId" style="width: 100%">
      </select>
    </div>
</div>

<div class="form-row node-text-editor-row">
    <input type="hidden" id="node-input-info" autofocus="autofocus">
    <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-info-editor"></div>
</div>

<div class="form-row">
    <label for="node-input-typeDropdown">Change Type</label>
    <select id="node-input-typeDropdown"></select>
    
    <label for="node-input-wordCount" style="float: right;">Words:
        <span id="node-input-wordCount"></span>
    </label>
</div>
</script>


<script type="text/html" data-help-name="Thought">
  <p>A writermap node.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-mindmap/idea] --- -->
<script type="text/javascript">
  RED.nodes.registerType('Idea',{ ...window.mmDefaults, ...{
    color: window.wmPaletteColours["25-idea"],
    icon: "node-red/light.svg",
  }});
</script>

<script type="text/html" data-template-name="Idea">
<div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
</div>

<div class="form-row">
    <label style="display: inline-block; width: 40%;"
           for="node-input-sumPass">
      <i class="fa fa-filter"></i>
      <span>Summaries subnodes?</span>
    </label>
    <input type="checkbox" id="node-input-sumPass"
           style="display:inline-block; width:35px; vertical-align:baseline;">

    <label style="display: inline-block; width: 10%; padding-left: 100px;"
           for="node-input-sumPassPrio">
      <span>Priority: </span>
    </label>
    <select id="node-input-sumPassPrio" style="width: 50px;"></select>
</div>

<div id="sumpass-node-selection" class="hide">
    <div class="form-row">
        <select id="node-input-sumPassNodeId" style="width: 100%">
      </select>
    </div>
</div>

<div class="form-row node-text-editor-row">
    <input type="hidden" id="node-input-info" autofocus="autofocus">
    <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-info-editor"></div>
</div>

<div class="form-row">
    <label for="node-input-typeDropdown">Change Type</label>
    <select id="node-input-typeDropdown"></select>
    
    <label for="node-input-wordCount" style="float: right;">Words:
        <span id="node-input-wordCount"></span>
    </label>
</div>
</script>


<script type="text/html" data-help-name="Idea">
  <p>A mindmap Idea node.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-mindmap/dream] --- -->
<script type="text/javascript">
  RED.nodes.registerType('Dream',{ ...window.mmDefaults, ...{
    color: window.wmPaletteColours["26-dream"],
    icon: "font-awesome/fa-bed",
  }});
</script>

<script type="text/html" data-template-name="Dream">
<div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
</div>

<div class="form-row">
    <label style="display: inline-block; width: 40%;"
           for="node-input-sumPass">
      <i class="fa fa-filter"></i>
      <span>Summaries subnodes?</span>
    </label>
    <input type="checkbox" id="node-input-sumPass"
           style="display:inline-block; width:35px; vertical-align:baseline;">

    <label style="display: inline-block; width: 10%; padding-left: 100px;"
           for="node-input-sumPassPrio">
      <span>Priority: </span>
    </label>
    <select id="node-input-sumPassPrio" style="width: 50px;"></select>
</div>

<div id="sumpass-node-selection" class="hide">
    <div class="form-row">
        <select id="node-input-sumPassNodeId" style="width: 100%">
      </select>
    </div>
</div>

<div class="form-row node-text-editor-row">
    <input type="hidden" id="node-input-info" autofocus="autofocus">
    <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-info-editor"></div>
</div>

<div class="form-row">
    <label for="node-input-typeDropdown">Change Type</label>
    <select id="node-input-typeDropdown"></select>
    
    <label for="node-input-wordCount" style="float: right;">Words:
        <span id="node-input-wordCount"></span>
    </label>
</div>
</script>


<script type="text/html" data-help-name="Dream">
  <p>A mindmap Dream node.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-mindmap/metaphor] --- -->
<script type="text/javascript">
  RED.nodes.registerType('Metaphor',{ ...window.mmDefaults, ...{
    color: window.wmPaletteColours["41-metaphor"],
    icon: "font-awesome/fa-balance-scale",
  }});
</script>

<script type="text/html" data-template-name="Metaphor">
<div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
</div>

<div class="form-row">
    <label style="display: inline-block; width: 40%;"
           for="node-input-sumPass">
      <i class="fa fa-filter"></i>
      <span>Summaries subnodes?</span>
    </label>
    <input type="checkbox" id="node-input-sumPass"
           style="display:inline-block; width:35px; vertical-align:baseline;">

    <label style="display: inline-block; width: 10%; padding-left: 100px;"
           for="node-input-sumPassPrio">
      <span>Priority: </span>
    </label>
    <select id="node-input-sumPassPrio" style="width: 50px;"></select>
</div>

<div id="sumpass-node-selection" class="hide">
    <div class="form-row">
        <select id="node-input-sumPassNodeId" style="width: 100%">
      </select>
    </div>
</div>

<div class="form-row node-text-editor-row">
    <input type="hidden" id="node-input-info" autofocus="autofocus">
    <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-info-editor"></div>
</div>

<div class="form-row">
    <label for="node-input-typeDropdown">Change Type</label>
    <select id="node-input-typeDropdown"></select>
    
    <label for="node-input-wordCount" style="float: right;">Words:
        <span id="node-input-wordCount"></span>
    </label>
</div>
</script>


<script type="text/html" data-help-name="Metaphor">
  <p>A writermap Metaphor node.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-mindmap/aphorism] --- -->
<script type="text/javascript">
  RED.nodes.registerType('Aphorism',{ ...window.mmDefaults, ...{
    color: window.wmPaletteColours["45-aphorism"],
    icon: "font-awesome/fa-window-minimize",
  }});
</script>

<script type="text/html" data-template-name="Aphorism">
<div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
</div>

<div class="form-row">
    <label style="display: inline-block; width: 40%;"
           for="node-input-sumPass">
      <i class="fa fa-filter"></i>
      <span>Summaries subnodes?</span>
    </label>
    <input type="checkbox" id="node-input-sumPass"
           style="display:inline-block; width:35px; vertical-align:baseline;">

    <label style="display: inline-block; width: 10%; padding-left: 100px;"
           for="node-input-sumPassPrio">
      <span>Priority: </span>
    </label>
    <select id="node-input-sumPassPrio" style="width: 50px;"></select>
</div>

<div id="sumpass-node-selection" class="hide">
    <div class="form-row">
        <select id="node-input-sumPassNodeId" style="width: 100%">
      </select>
    </div>
</div>

<div class="form-row node-text-editor-row">
    <input type="hidden" id="node-input-info" autofocus="autofocus">
    <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-info-editor"></div>
</div>

<div class="form-row">
    <label for="node-input-typeDropdown">Change Type</label>
    <select id="node-input-typeDropdown"></select>
    
    <label for="node-input-wordCount" style="float: right;">Words:
        <span id="node-input-wordCount"></span>
    </label>
</div>
</script>


<script type="text/html" data-help-name="Aphorism">
  <p>A writermap node.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-mindmap/poesie] --- -->
<script type="text/javascript">
  RED.nodes.registerType('Poesie',{ ...window.mmDefaults, ...{
    color: window.wmPaletteColours["20-poesie"],
    icon: "font-awesome/fa-file-powerpoint-o",
  }});
</script>

<script type="text/html" data-template-name="Poesie">
<div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
</div>

<div class="form-row">
    <label style="display: inline-block; width: 40%;"
           for="node-input-sumPass">
      <i class="fa fa-filter"></i>
      <span>Summaries subnodes?</span>
    </label>
    <input type="checkbox" id="node-input-sumPass"
           style="display:inline-block; width:35px; vertical-align:baseline;">

    <label style="display: inline-block; width: 10%; padding-left: 100px;"
           for="node-input-sumPassPrio">
      <span>Priority: </span>
    </label>
    <select id="node-input-sumPassPrio" style="width: 50px;"></select>
</div>

<div id="sumpass-node-selection" class="hide">
    <div class="form-row">
        <select id="node-input-sumPassNodeId" style="width: 100%">
      </select>
    </div>
</div>

<div class="form-row node-text-editor-row">
    <input type="hidden" id="node-input-info" autofocus="autofocus">
    <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-info-editor"></div>
</div>

<div class="form-row">
    <label for="node-input-typeDropdown">Change Type</label>
    <select id="node-input-typeDropdown"></select>
    
    <label for="node-input-wordCount" style="float: right;">Words:
        <span id="node-input-wordCount"></span>
    </label>
</div>
</script>


<script type="text/html" data-help-name="Poesie">
  <p>A writermap node.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-mindmap/humour] --- -->
<script type="text/javascript">
  RED.nodes.registerType('Humour',{ ...window.mmDefaults, ...{
    color: window.wmPaletteColours["22-humour"],
    icon: "font-awesome/fa-smile-o",
  }});
</script>

<script type="text/html" data-template-name="Humour">
<div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
</div>

<div class="form-row">
    <label style="display: inline-block; width: 40%;"
           for="node-input-sumPass">
      <i class="fa fa-filter"></i>
      <span>Summaries subnodes?</span>
    </label>
    <input type="checkbox" id="node-input-sumPass"
           style="display:inline-block; width:35px; vertical-align:baseline;">

    <label style="display: inline-block; width: 10%; padding-left: 100px;"
           for="node-input-sumPassPrio">
      <span>Priority: </span>
    </label>
    <select id="node-input-sumPassPrio" style="width: 50px;"></select>
</div>

<div id="sumpass-node-selection" class="hide">
    <div class="form-row">
        <select id="node-input-sumPassNodeId" style="width: 100%">
      </select>
    </div>
</div>

<div class="form-row node-text-editor-row">
    <input type="hidden" id="node-input-info" autofocus="autofocus">
    <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-info-editor"></div>
</div>

<div class="form-row">
    <label for="node-input-typeDropdown">Change Type</label>
    <select id="node-input-typeDropdown"></select>
    
    <label for="node-input-wordCount" style="float: right;">Words:
        <span id="node-input-wordCount"></span>
    </label>
</div>
</script>


<script type="text/html" data-help-name="Humour">
  <p>A writermap node.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-mindmap/treasure] --- -->
<script type="text/javascript">
  RED.nodes.registerType('Treasure',{ ...window.mmDefaults, ...{
    color: window.wmPaletteColours["23-treasure"],
    icon: "font-awesome/fa-heart-o",
  }});
</script>

<script type="text/html" data-template-name="Treasure">
<div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
</div>

<div class="form-row">
    <label style="display: inline-block; width: 40%;"
           for="node-input-sumPass">
      <i class="fa fa-filter"></i>
      <span>Summaries subnodes?</span>
    </label>
    <input type="checkbox" id="node-input-sumPass"
           style="display:inline-block; width:35px; vertical-align:baseline;">

    <label style="display: inline-block; width: 10%; padding-left: 100px;"
           for="node-input-sumPassPrio">
      <span>Priority: </span>
    </label>
    <select id="node-input-sumPassPrio" style="width: 50px;"></select>
</div>

<div id="sumpass-node-selection" class="hide">
    <div class="form-row">
        <select id="node-input-sumPassNodeId" style="width: 100%">
      </select>
    </div>
</div>

<div class="form-row node-text-editor-row">
    <input type="hidden" id="node-input-info" autofocus="autofocus">
    <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-info-editor"></div>
</div>

<div class="form-row">
    <label for="node-input-typeDropdown">Change Type</label>
    <select id="node-input-typeDropdown"></select>
    
    <label for="node-input-wordCount" style="float: right;">Words:
        <span id="node-input-wordCount"></span>
    </label>
</div>
</script>


<script type="text/html" data-help-name="Treasure">
  <p>A writermap node.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-mindmap/consequence] --- -->
<script type="text/javascript">
  RED.nodes.registerType('Consequence',{ ...window.mmDefaults, ...{
    color: window.wmPaletteColours["37-consequence"],
    icon: "font-awesome/fa-gavel",
  }});
</script>

<script type="text/html" data-template-name="Consequence">
<div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
</div>

<div class="form-row">
    <label style="display: inline-block; width: 40%;"
           for="node-input-sumPass">
      <i class="fa fa-filter"></i>
      <span>Summaries subnodes?</span>
    </label>
    <input type="checkbox" id="node-input-sumPass"
           style="display:inline-block; width:35px; vertical-align:baseline;">

    <label style="display: inline-block; width: 10%; padding-left: 100px;"
           for="node-input-sumPassPrio">
      <span>Priority: </span>
    </label>
    <select id="node-input-sumPassPrio" style="width: 50px;"></select>
</div>

<div id="sumpass-node-selection" class="hide">
    <div class="form-row">
        <select id="node-input-sumPassNodeId" style="width: 100%">
      </select>
    </div>
</div>

<div class="form-row node-text-editor-row">
    <input type="hidden" id="node-input-info" autofocus="autofocus">
    <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-info-editor"></div>
</div>

<div class="form-row">
    <label for="node-input-typeDropdown">Change Type</label>
    <select id="node-input-typeDropdown"></select>
    
    <label for="node-input-wordCount" style="float: right;">Words:
        <span id="node-input-wordCount"></span>
    </label>
</div>
</script>


<script type="text/html" data-help-name="Consequence">
  <p>A writermap node.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-mindmap/advantage] --- -->
<script type="text/javascript">
  RED.nodes.registerType('Advantage',{ ...window.mmDefaults, ...{
    color: window.wmPaletteColours["38-advantage"],
    icon: "font-awesome/fa-thumbs-o-up",
  }});
</script>

<script type="text/html" data-template-name="Advantage">
<div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
</div>

<div class="form-row">
    <label style="display: inline-block; width: 40%;"
           for="node-input-sumPass">
      <i class="fa fa-filter"></i>
      <span>Summaries subnodes?</span>
    </label>
    <input type="checkbox" id="node-input-sumPass"
           style="display:inline-block; width:35px; vertical-align:baseline;">

    <label style="display: inline-block; width: 10%; padding-left: 100px;"
           for="node-input-sumPassPrio">
      <span>Priority: </span>
    </label>
    <select id="node-input-sumPassPrio" style="width: 50px;"></select>
</div>

<div id="sumpass-node-selection" class="hide">
    <div class="form-row">
        <select id="node-input-sumPassNodeId" style="width: 100%">
      </select>
    </div>
</div>

<div class="form-row node-text-editor-row">
    <input type="hidden" id="node-input-info" autofocus="autofocus">
    <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-info-editor"></div>
</div>

<div class="form-row">
    <label for="node-input-typeDropdown">Change Type</label>
    <select id="node-input-typeDropdown"></select>
    
    <label for="node-input-wordCount" style="float: right;">Words:
        <span id="node-input-wordCount"></span>
    </label>
</div>
</script>


<script type="text/html" data-help-name="Advantage">
  <p>A writermap node.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-mindmap/disadvantage] --- -->
<script type="text/javascript">
  RED.nodes.registerType('Disadvantage',{ ...window.mmDefaults, ...{
    color: window.wmPaletteColours["39-disadvantage"],
    icon: "font-awesome/fa-thumbs-o-down",
  }});
</script>

<script type="text/html" data-template-name="Disadvantage">
<div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
</div>

<div class="form-row">
    <label style="display: inline-block; width: 40%;"
           for="node-input-sumPass">
      <i class="fa fa-filter"></i>
      <span>Summaries subnodes?</span>
    </label>
    <input type="checkbox" id="node-input-sumPass"
           style="display:inline-block; width:35px; vertical-align:baseline;">

    <label style="display: inline-block; width: 10%; padding-left: 100px;"
           for="node-input-sumPassPrio">
      <span>Priority: </span>
    </label>
    <select id="node-input-sumPassPrio" style="width: 50px;"></select>
</div>

<div id="sumpass-node-selection" class="hide">
    <div class="form-row">
        <select id="node-input-sumPassNodeId" style="width: 100%">
      </select>
    </div>
</div>

<div class="form-row node-text-editor-row">
    <input type="hidden" id="node-input-info" autofocus="autofocus">
    <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-info-editor"></div>
</div>

<div class="form-row">
    <label for="node-input-typeDropdown">Change Type</label>
    <select id="node-input-typeDropdown"></select>
    
    <label for="node-input-wordCount" style="float: right;">Words:
        <span id="node-input-wordCount"></span>
    </label>
</div>
</script>


<script type="text/html" data-help-name="Disadvantage">
  <p>A writermap node.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-mindmap/text] --- -->
<script type="text/javascript">
  RED.nodes.registerType('Text',{ ...window.mmDefaults, ...{
    color: window.wmPaletteColours["05-text"],
    icon: "font-awesome/fa-file-text-o"
  }});
</script>

<script type="text/html" data-template-name="Text">
<div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
</div>

<div class="form-row">
    <label style="display: inline-block; width: 40%;"
           for="node-input-sumPass">
      <i class="fa fa-filter"></i>
      <span>Summaries subnodes?</span>
    </label>
    <input type="checkbox" id="node-input-sumPass"
           style="display:inline-block; width:35px; vertical-align:baseline;">

    <label style="display: inline-block; width: 10%; padding-left: 100px;"
           for="node-input-sumPassPrio">
      <span>Priority: </span>
    </label>
    <select id="node-input-sumPassPrio" style="width: 50px;"></select>
</div>

<div id="sumpass-node-selection" class="hide">
    <div class="form-row">
        <select id="node-input-sumPassNodeId" style="width: 100%">
      </select>
    </div>
</div>

<div class="form-row node-text-editor-row">
    <input type="hidden" id="node-input-info" autofocus="autofocus">
    <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-info-editor"></div>
</div>

<div class="form-row">
    <label for="node-input-typeDropdown">Change Type</label>
    <select id="node-input-typeDropdown"></select>
    
    <label for="node-input-wordCount" style="float: right;">Words:
        <span id="node-input-wordCount"></span>
    </label>
</div>
</script>


<script type="text/html" data-help-name="Text">
    <p>A writermap node.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-mindmap/blog-post] --- -->
<script type="text/javascript">
  RED.nodes.registerType('Blog-Post',{ ...window.mmDefaults, ...{
    color: window.wmPaletteColours["10-blog-post"],
    icon: "font-awesome/fa-external-link",
    paletteLabel: "Post"
  }});
</script>

<script type="text/html" data-template-name="Blog-Post">
<div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
</div>

<div class="form-row">
    <label style="display: inline-block; width: 40%;"
           for="node-input-sumPass">
      <i class="fa fa-filter"></i>
      <span>Summaries subnodes?</span>
    </label>
    <input type="checkbox" id="node-input-sumPass"
           style="display:inline-block; width:35px; vertical-align:baseline;">

    <label style="display: inline-block; width: 10%; padding-left: 100px;"
           for="node-input-sumPassPrio">
      <span>Priority: </span>
    </label>
    <select id="node-input-sumPassPrio" style="width: 50px;"></select>
</div>

<div id="sumpass-node-selection" class="hide">
    <div class="form-row">
        <select id="node-input-sumPassNodeId" style="width: 100%">
      </select>
    </div>
</div>

<div class="form-row node-text-editor-row">
    <input type="hidden" id="node-input-info" autofocus="autofocus">
    <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-info-editor"></div>
</div>

<div class="form-row">
    <label for="node-input-typeDropdown">Change Type</label>
    <select id="node-input-typeDropdown"></select>
    
    <label for="node-input-wordCount" style="float: right;">Words:
        <span id="node-input-wordCount"></span>
    </label>
</div>
</script>


<script type="text/html" data-help-name="Blog-Post">
  <p>A writermap node.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-mindmap/image] --- -->
<script type="text/javascript">
  RED.nodes.registerType('Image',{ ...window.mmDefaults, ...{
    color: window.wmPaletteColours["12-image"],
    icon: "font-awesome/fa-file-image-o",
  }});
</script>

<script type="text/html" data-template-name="Image">
<div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
</div>

<div class="form-row">
    <label style="display: inline-block; width: 40%;"
           for="node-input-sumPass">
      <i class="fa fa-filter"></i>
      <span>Summaries subnodes?</span>
    </label>
    <input type="checkbox" id="node-input-sumPass"
           style="display:inline-block; width:35px; vertical-align:baseline;">

    <label style="display: inline-block; width: 10%; padding-left: 100px;"
           for="node-input-sumPassPrio">
      <span>Priority: </span>
    </label>
    <select id="node-input-sumPassPrio" style="width: 50px;"></select>
</div>

<div id="sumpass-node-selection" class="hide">
    <div class="form-row">
        <select id="node-input-sumPassNodeId" style="width: 100%">
      </select>
    </div>
</div>

<div class="form-row node-text-editor-row">
    <input type="hidden" id="node-input-info" autofocus="autofocus">
    <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-info-editor"></div>
</div>

<div class="form-row">
    <label for="node-input-typeDropdown">Change Type</label>
    <select id="node-input-typeDropdown"></select>
    
    <label for="node-input-wordCount" style="float: right;">Words:
        <span id="node-input-wordCount"></span>
    </label>
</div>
</script>


<script type="text/html" data-help-name="Image">
  <p>A writermap Image node.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-mindmap/comment] --- -->
<script type="text/javascript">
  RED.nodes.registerType('Comment',{ ...window.mmDefaults, ...{
    color: window.wmPaletteColours["15-comment"],
    icon: "font-awesome/fa-commenting-o",
  }});
</script>

<script type="text/html" data-template-name="Comment">
<div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
</div>

<div class="form-row">
    <label style="display: inline-block; width: 40%;"
           for="node-input-sumPass">
      <i class="fa fa-filter"></i>
      <span>Summaries subnodes?</span>
    </label>
    <input type="checkbox" id="node-input-sumPass"
           style="display:inline-block; width:35px; vertical-align:baseline;">

    <label style="display: inline-block; width: 10%; padding-left: 100px;"
           for="node-input-sumPassPrio">
      <span>Priority: </span>
    </label>
    <select id="node-input-sumPassPrio" style="width: 50px;"></select>
</div>

<div id="sumpass-node-selection" class="hide">
    <div class="form-row">
        <select id="node-input-sumPassNodeId" style="width: 100%">
      </select>
    </div>
</div>

<div class="form-row node-text-editor-row">
    <input type="hidden" id="node-input-info" autofocus="autofocus">
    <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-info-editor"></div>
</div>

<div class="form-row">
    <label for="node-input-typeDropdown">Change Type</label>
    <select id="node-input-typeDropdown"></select>
    
    <label for="node-input-wordCount" style="float: right;">Words:
        <span id="node-input-wordCount"></span>
    </label>
</div>
</script>


<script type="text/html" data-help-name="Comment">
  <p>A writermap node.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-mindmap/codebase] --- -->
<script type="text/javascript">
  RED.nodes.registerType('Code-Base',{ ...window.mmDefaults, ...{
    color: window.wmPaletteColours["55-code-base"],
    icon: "font-awesome/fa-code",
    paletteLabel: 'Code'
  }});
</script>

<script type="text/html" data-template-name="Code-Base">
<div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
</div>

<div class="form-row">
    <label style="display: inline-block; width: 40%;"
           for="node-input-sumPass">
      <i class="fa fa-filter"></i>
      <span>Summaries subnodes?</span>
    </label>
    <input type="checkbox" id="node-input-sumPass"
           style="display:inline-block; width:35px; vertical-align:baseline;">

    <label style="display: inline-block; width: 10%; padding-left: 100px;"
           for="node-input-sumPassPrio">
      <span>Priority: </span>
    </label>
    <select id="node-input-sumPassPrio" style="width: 50px;"></select>
</div>

<div id="sumpass-node-selection" class="hide">
    <div class="form-row">
        <select id="node-input-sumPassNodeId" style="width: 100%">
      </select>
    </div>
</div>

<div class="form-row node-text-editor-row">
    <input type="hidden" id="node-input-info" autofocus="autofocus">
    <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-info-editor"></div>
</div>

<div class="form-row">
    <label for="node-input-typeDropdown">Change Type</label>
    <select id="node-input-typeDropdown"></select>
    
    <label for="node-input-wordCount" style="float: right;">Words:
        <span id="node-input-wordCount"></span>
    </label>
</div>
</script>


<script type="text/html" data-help-name="Code-Base">
  <p>A writermap node.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-mindmap/art] --- -->
<script type="text/javascript">
  RED.nodes.registerType('Art',{ ...window.mmDefaults, ...{
    color: window.wmPaletteColours["57-art"],
    icon: "font-awesome/fa-image",
  }});
</script>

<script type="text/html" data-template-name="Art">
<div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
</div>

<div class="form-row">
    <label style="display: inline-block; width: 40%;"
           for="node-input-sumPass">
      <i class="fa fa-filter"></i>
      <span>Summaries subnodes?</span>
    </label>
    <input type="checkbox" id="node-input-sumPass"
           style="display:inline-block; width:35px; vertical-align:baseline;">

    <label style="display: inline-block; width: 10%; padding-left: 100px;"
           for="node-input-sumPassPrio">
      <span>Priority: </span>
    </label>
    <select id="node-input-sumPassPrio" style="width: 50px;"></select>
</div>

<div id="sumpass-node-selection" class="hide">
    <div class="form-row">
        <select id="node-input-sumPassNodeId" style="width: 100%">
      </select>
    </div>
</div>

<div class="form-row node-text-editor-row">
    <input type="hidden" id="node-input-info" autofocus="autofocus">
    <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-info-editor"></div>
</div>

<div class="form-row">
    <label for="node-input-typeDropdown">Change Type</label>
    <select id="node-input-typeDropdown"></select>
    
    <label for="node-input-wordCount" style="float: right;">Words:
        <span id="node-input-wordCount"></span>
    </label>
</div>
</script>


<script type="text/html" data-help-name="Art">
  <p>A writermap Art node.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-mindmap/learning] --- -->
<script type="text/javascript">
  RED.nodes.registerType('Learning',{ ...window.mmDefaults, ...{
    color: window.wmPaletteColours["47-learning"],
    icon: "font-awesome/fa-bolt",
  }});
</script>

<script type="text/html" data-template-name="Learning">
<div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
</div>

<div class="form-row">
    <label style="display: inline-block; width: 40%;"
           for="node-input-sumPass">
      <i class="fa fa-filter"></i>
      <span>Summaries subnodes?</span>
    </label>
    <input type="checkbox" id="node-input-sumPass"
           style="display:inline-block; width:35px; vertical-align:baseline;">

    <label style="display: inline-block; width: 10%; padding-left: 100px;"
           for="node-input-sumPassPrio">
      <span>Priority: </span>
    </label>
    <select id="node-input-sumPassPrio" style="width: 50px;"></select>
</div>

<div id="sumpass-node-selection" class="hide">
    <div class="form-row">
        <select id="node-input-sumPassNodeId" style="width: 100%">
      </select>
    </div>
</div>

<div class="form-row node-text-editor-row">
    <input type="hidden" id="node-input-info" autofocus="autofocus">
    <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-info-editor"></div>
</div>

<div class="form-row">
    <label for="node-input-typeDropdown">Change Type</label>
    <select id="node-input-typeDropdown"></select>
    
    <label for="node-input-wordCount" style="float: right;">Words:
        <span id="node-input-wordCount"></span>
    </label>
</div>
</script>


<script type="text/html" data-help-name="Learning">
  <p>A mindmap Learning node.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-mindmap/inspiration] --- -->
<script type="text/javascript">
  RED.nodes.registerType('Inspiration',{ ...window.mmDefaults, ...{
    color: window.wmPaletteColours["60-inspiration"],
    icon: "font-awesome/fa-info",
  }});
</script>

<script type="text/html" data-template-name="Inspiration">
<div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
</div>

<div class="form-row">
    <label style="display: inline-block; width: 40%;"
           for="node-input-sumPass">
      <i class="fa fa-filter"></i>
      <span>Summaries subnodes?</span>
    </label>
    <input type="checkbox" id="node-input-sumPass"
           style="display:inline-block; width:35px; vertical-align:baseline;">

    <label style="display: inline-block; width: 10%; padding-left: 100px;"
           for="node-input-sumPassPrio">
      <span>Priority: </span>
    </label>
    <select id="node-input-sumPassPrio" style="width: 50px;"></select>
</div>

<div id="sumpass-node-selection" class="hide">
    <div class="form-row">
        <select id="node-input-sumPassNodeId" style="width: 100%">
      </select>
    </div>
</div>

<div class="form-row node-text-editor-row">
    <input type="hidden" id="node-input-info" autofocus="autofocus">
    <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-info-editor"></div>
</div>

<div class="form-row">
    <label for="node-input-typeDropdown">Change Type</label>
    <select id="node-input-typeDropdown"></select>
    
    <label for="node-input-wordCount" style="float: right;">Words:
        <span id="node-input-wordCount"></span>
    </label>
</div>
</script>


<script type="text/html" data-help-name="Inspiration">
  <p>A writermap node.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-mindmap/keyword] --- -->
<script type="text/javascript">
  RED.nodes.registerType('Keyword',{ ...window.mmDefaults, ...{
    color: window.wmPaletteColours["62-keyword"],
    icon: "font-awesome/fa-key",
  }});
</script>

<script type="text/html" data-template-name="Keyword">
<div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
</div>

<div class="form-row">
    <label style="display: inline-block; width: 40%;"
           for="node-input-sumPass">
      <i class="fa fa-filter"></i>
      <span>Summaries subnodes?</span>
    </label>
    <input type="checkbox" id="node-input-sumPass"
           style="display:inline-block; width:35px; vertical-align:baseline;">

    <label style="display: inline-block; width: 10%; padding-left: 100px;"
           for="node-input-sumPassPrio">
      <span>Priority: </span>
    </label>
    <select id="node-input-sumPassPrio" style="width: 50px;"></select>
</div>

<div id="sumpass-node-selection" class="hide">
    <div class="form-row">
        <select id="node-input-sumPassNodeId" style="width: 100%">
      </select>
    </div>
</div>

<div class="form-row node-text-editor-row">
    <input type="hidden" id="node-input-info" autofocus="autofocus">
    <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-info-editor"></div>
</div>

<div class="form-row">
    <label for="node-input-typeDropdown">Change Type</label>
    <select id="node-input-typeDropdown"></select>
    
    <label for="node-input-wordCount" style="float: right;">Words:
        <span id="node-input-wordCount"></span>
    </label>
</div>
</script>


<script type="text/html" data-help-name="Keyword">
  <p>A writermap node.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-mindmap/quote] --- -->
<script type="text/javascript">
  RED.nodes.registerType('Quote',{ ...window.mmDefaults, ...{
    color: window.wmPaletteColours["65-quote"],
    icon: "font-awesome/fa-quote-left",
  }});
</script>

<script type="text/html" data-template-name="Quote">
<div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
</div>

<div class="form-row">
    <label style="display: inline-block; width: 40%;"
           for="node-input-sumPass">
      <i class="fa fa-filter"></i>
      <span>Summaries subnodes?</span>
    </label>
    <input type="checkbox" id="node-input-sumPass"
           style="display:inline-block; width:35px; vertical-align:baseline;">

    <label style="display: inline-block; width: 10%; padding-left: 100px;"
           for="node-input-sumPassPrio">
      <span>Priority: </span>
    </label>
    <select id="node-input-sumPassPrio" style="width: 50px;"></select>
</div>

<div id="sumpass-node-selection" class="hide">
    <div class="form-row">
        <select id="node-input-sumPassNodeId" style="width: 100%">
      </select>
    </div>
</div>

<div class="form-row node-text-editor-row">
    <input type="hidden" id="node-input-info" autofocus="autofocus">
    <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-info-editor"></div>
</div>

<div class="form-row">
    <label for="node-input-typeDropdown">Change Type</label>
    <select id="node-input-typeDropdown"></select>
    
    <label for="node-input-wordCount" style="float: right;">Words:
        <span id="node-input-wordCount"></span>
    </label>
</div>
</script>


<script type="text/html" data-help-name="Quote">
  <p>A writermap node.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-mindmap/definition] --- -->
<script type="text/javascript">
  RED.nodes.registerType('Definition',{ ...window.mmDefaults, ...{
    color: window.wmPaletteColours["70-definition"],
    icon: "font-awesome/fa-file-text-o",
  }});
</script>

<script type="text/html" data-template-name="Definition">
<div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
</div>

<div class="form-row">
    <label style="display: inline-block; width: 40%;"
           for="node-input-sumPass">
      <i class="fa fa-filter"></i>
      <span>Summaries subnodes?</span>
    </label>
    <input type="checkbox" id="node-input-sumPass"
           style="display:inline-block; width:35px; vertical-align:baseline;">

    <label style="display: inline-block; width: 10%; padding-left: 100px;"
           for="node-input-sumPassPrio">
      <span>Priority: </span>
    </label>
    <select id="node-input-sumPassPrio" style="width: 50px;"></select>
</div>

<div id="sumpass-node-selection" class="hide">
    <div class="form-row">
        <select id="node-input-sumPassNodeId" style="width: 100%">
      </select>
    </div>
</div>

<div class="form-row node-text-editor-row">
    <input type="hidden" id="node-input-info" autofocus="autofocus">
    <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-info-editor"></div>
</div>

<div class="form-row">
    <label for="node-input-typeDropdown">Change Type</label>
    <select id="node-input-typeDropdown"></select>
    
    <label for="node-input-wordCount" style="float: right;">Words:
        <span id="node-input-wordCount"></span>
    </label>
</div>
</script>


<script type="text/html" data-help-name="Definition">
  <p>A writermap node.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-mindmap/bookmark] --- -->
<script type="text/javascript">
  RED.nodes.registerType('Bookmark',{ ...window.mmDefaults, ...{
    color: window.wmPaletteColours["74-bookmark"],
    icon: "font-awesome/fa-bookmark-o",
  }});
</script>

<script type="text/html" data-template-name="Bookmark">
<div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
</div>

<div class="form-row">
    <label style="display: inline-block; width: 40%;"
           for="node-input-sumPass">
      <i class="fa fa-filter"></i>
      <span>Summaries subnodes?</span>
    </label>
    <input type="checkbox" id="node-input-sumPass"
           style="display:inline-block; width:35px; vertical-align:baseline;">

    <label style="display: inline-block; width: 10%; padding-left: 100px;"
           for="node-input-sumPassPrio">
      <span>Priority: </span>
    </label>
    <select id="node-input-sumPassPrio" style="width: 50px;"></select>
</div>

<div id="sumpass-node-selection" class="hide">
    <div class="form-row">
        <select id="node-input-sumPassNodeId" style="width: 100%">
      </select>
    </div>
</div>

<div class="form-row node-text-editor-row">
    <input type="hidden" id="node-input-info" autofocus="autofocus">
    <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-info-editor"></div>
</div>

<div class="form-row">
    <label for="node-input-typeDropdown">Change Type</label>
    <select id="node-input-typeDropdown"></select>
    
    <label for="node-input-wordCount" style="float: right;">Words:
        <span id="node-input-wordCount"></span>
    </label>
</div>
</script>


<script type="text/html" data-help-name="Bookmark">
  <p>A writermap Bookmark node.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-mindmap/book] --- -->
<script type="text/javascript">
  RED.nodes.registerType('Book',{ ...window.mmDefaults, ...{
    color: window.wmPaletteColours["75-book"],
    icon: "font-awesome/fa-book",
  }});
</script>

<script type="text/html" data-template-name="Book">
<div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
</div>

<div class="form-row">
    <label style="display: inline-block; width: 40%;"
           for="node-input-sumPass">
      <i class="fa fa-filter"></i>
      <span>Summaries subnodes?</span>
    </label>
    <input type="checkbox" id="node-input-sumPass"
           style="display:inline-block; width:35px; vertical-align:baseline;">

    <label style="display: inline-block; width: 10%; padding-left: 100px;"
           for="node-input-sumPassPrio">
      <span>Priority: </span>
    </label>
    <select id="node-input-sumPassPrio" style="width: 50px;"></select>
</div>

<div id="sumpass-node-selection" class="hide">
    <div class="form-row">
        <select id="node-input-sumPassNodeId" style="width: 100%">
      </select>
    </div>
</div>

<div class="form-row node-text-editor-row">
    <input type="hidden" id="node-input-info" autofocus="autofocus">
    <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-info-editor"></div>
</div>

<div class="form-row">
    <label for="node-input-typeDropdown">Change Type</label>
    <select id="node-input-typeDropdown"></select>
    
    <label for="node-input-wordCount" style="float: right;">Words:
        <span id="node-input-wordCount"></span>
    </label>
</div>
</script>


<script type="text/html" data-help-name="Book">
  <p>A writermap node.</p>
</script>
<!-- --- [red-module:@gorenje/node-red-mindmap/author] --- -->
<script type="text/javascript">
  RED.nodes.registerType('Author',{ ...window.mmDefaults, ...{
    color: window.wmPaletteColours["80-author"],
    icon: "font-awesome/fa-pencil",
  }});
</script>

<script type="text/html" data-template-name="Author">
<div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
</div>

<div class="form-row">
    <label style="display: inline-block; width: 40%;"
           for="node-input-sumPass">
      <i class="fa fa-filter"></i>
      <span>Summaries subnodes?</span>
    </label>
    <input type="checkbox" id="node-input-sumPass"
           style="display:inline-block; width:35px; vertical-align:baseline;">

    <label style="display: inline-block; width: 10%; padding-left: 100px;"
           for="node-input-sumPassPrio">
      <span>Priority: </span>
    </label>
    <select id="node-input-sumPassPrio" style="width: 50px;"></select>
</div>

<div id="sumpass-node-selection" class="hide">
    <div class="form-row">
        <select id="node-input-sumPassNodeId" style="width: 100%">
      </select>
    </div>
</div>

<div class="form-row node-text-editor-row">
    <input type="hidden" id="node-input-info" autofocus="autofocus">
    <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-info-editor"></div>
</div>

<div class="form-row">
    <label for="node-input-typeDropdown">Change Type</label>
    <select id="node-input-typeDropdown"></select>
    
    <label for="node-input-wordCount" style="float: right;">Words:
        <span id="node-input-wordCount"></span>
    </label>
</div>
</script>


<script type="text/html" data-help-name="Author">
  <p>A writermap node.</p>
</script>
<!-- --- [red-module:@gregoriusrippenstein/node-red-contacts/contact] --- -->
<script type="text/javascript">
  (function () {

  RED.nodes.registerType('Contact', {
    color: '#e5e4ef',
    icon: "font-awesome/fa-address-card-o",
    category: 'mindmap',
    defaults: {
      name: {
        value: "",
      },
      base64image: {
        value: ""
      },
      base64Type: {
        value: ""
      },
      rawJsonData: {
        value: "[\"vcard\", [[\"version\",{},\"text\",\"3.0\"], [\"prodid\",{},\"text\",\"-//Node-RED//vCard Node//EN\"], [\"fn\",{},\"text\",\"\"]]]"
      },
      
      /* createdAt and updatedAt are "internal" attributes that track just
         that: when the node was created and the last time it was updated.
         These aren't shown in the edit window because they are maintained
         internally. These are managed by the mindmap package.
      */
      createdAt: {
        value: "",
      },
      updatedAt: {
        value: "",
      }
    },

    inputs: 1,

    outputs: 1,

    label: function () {
      return (this.name || this._def.paletteLabel);
    },

    labelStyle: function () {
      return this.name ? "node_label_italic" : "";
    },

    onpaletteadd: function () {
    },

    onpaletteremove: function () {
    },

    oneditprepare: function () {
      if (this.base64image) {
        $('#contact-image').attr('src', 'data:image/' + this.base64Type + ';base64,' + this.base64image)
      } else {
        $('#contact-image').attr('src', 'data:image/jpeg;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAEeDAABHgwGWlmvoAAAAB3RJTUUH6AgWDBk2LmG1KAAAB4JJREFUWMOVVmtsVMcV/s7cu2/vrtdeGwM1FIwNuKVKgKTB2JBQESXwoyShRLShFEJQGyqllZqW5tGgJhVBtFUblSSqIIH0ETURTYVa5UerpMaBIgIFQcGADcYPwI9dr3e9u/fu3jtz+uMasONd4xxppHs1M+f75pzvzBnCJM04txeZfx6GCPihzDxYMQAemSWQIAivGypjIPDgUvjqt07KL000aduHkdz7R2gBD6xEGiwVhjuTCNeUBZgRAuC7yY8IqeSVRCY4IwQSAq6yEsiMifCWddD1lZ+fwODb25DvTUALeCANG5rPVQVGI5gfYOYFYK4Csx9ggEQWRL1EdBZEH4PwiTStXs2rQ2ZzcFdGULZ5z+QJxF7fAhICMpuDcGmVrHgDK/4227l6zhk6WybYtgBWI14ESHeDXB6Qx2eT7jlPgt4B0R/Ylv2a3wOWCtFte+9MILZnCwAg2z0I39TSFczqZc6ZDSozBJXLANIek3vHRv1rOoQ3AOEvBXm8R4jEz8z+5Ee+qREAjOj39xUnEHtjK6AUPOVBMvuS32Fp71TpoSkynQCUdSfJjDIGhAtaSQSipLSPNH27pzJ0ID+YZpBA9Onfjycw+M4PwKaJTNs1+L5QsYlt6zcyORBS2WQB/+wMGvkGATQyPmPCH4YWrkiR7nrGvBHf7581FcLrQWTjb515R+0fI9/TB5k24KuuXMHS3lkUHAQOlkPNa4Rs3AB192pw9ZfAJWUjZMaayiYhkwMhlvar3mnRFTJjInd9AJZ16nYEYnufBhs5EFGlsuUHKhVrkKnYeGyhQc1thFq8BhysAHQ3oBQgc6BYJ7Tm/aD+jlGauG1aqAIiVH5E6NqjzNxPXg+iT73uREAES6DSBljxBs5lG2Q6URBc3rcOctkmcOk0QGiAkg6Y5gZX1UGu/hHUvKaCkZDpQXDOWMpKbVAZAyIUcIjtf20r5hhZkMddxbb9S5WKT+F8dqzgmAFfEKrhm0Cw/Hb5fdZ8QZA5DNFxsoBunD3kCVQJn+dvnDHSs5ffBbFKA2DZYKWa2MrVKzM9Xu1EgJ0DjNTE4lcKSMeLECQoMwO2cvWsuBG2xGNBF8SwJhA90wow3895Q3fCWsAsExS7iglLUdqgWFfBFDgEbXDe0MH8QPRKJ1JCQLgtGz0LFwRYqa9w3iwoICeEDomizgGA5YguipFkcN4EK7Wgp7Ym4LEsCJIKpFQYrKpYWsWdEwDdM/FdRMKpDBQnydICWFVBqTAphgAzlIIfzP4J2SsF0XUGyJtFwAk0HAP1tjlEip1CKYDZz8x+MENIEpAg3PGaFRroWitE5+nCAMwQ5z8CDccK3ohjcwmSiiEVQ+RYg8nCZCIDQkwYPuSzoGvnC6whwDKcOaWK7wcDQgODsqatDFMqiD5TIp5TSSbRR5pr4iiQAHWdAQ32jD0lAaL7LCjeDYiJI0maC4pEX8ywUv1ZC+LQmU40/rQ5bYPOkds7cSqIQIlroI6TY9MgbdCFFiCXxR1UCnJ7IUHnmna8m/7gbDfE7nf/BX7rQc5ashluv4TQikSPnRITGuAtGRcZeIPOt1LF0yg0wO2zszY381vb+NcHP4EeLPHiRE8Cw6Z1uKTMf1F4A/VOF6TbwADgD0NNrQPPXgw1+56xuSYBdc+j4Mg0iKv/dRrSzeucbj9ahDcAqbkv9QzlWlKWQiDgcVCW1Ffj6LkuXHr1iRfDwv65jF8DlA0wwKVTwHVLoWq+Ci6bPtIBefwpaaSS8llQ/2WIi0cgrnzqXN8kAKFBK5+OJLwv1v14/yv3LqjFp/9rdwhcfeO7SAwkcDU2PHNRdflf3cbQQplOQM1dCrVoDTgyzXHOEyl8tCIJkBJ04wK0Y++BrrdCC1Ug7y87cfz68GOzosGuyPRpmL1x51jFsPUX/GfHe2u+WOrbx9VfLrMWPwK4fJMELpxzSvbC1XIAyAzFO4btzQ3Pf/0QedbfWnJLcffWTsWpv5/E9w78u239qvuNQNPjTeQLu7lYc5qMMUMESoGSaObGxdMv3bfjz3/qOd7JLAR6B53OequWjrfdwPolc7HnpWfk4wdb3+xOpF+AkoO6roNoso/R0ZIg6LoOVna8y/a8sG5/y5u/++ET8luN9Tjd1nNrnT5607KX3wczQ0Z+lWtY0rDnww//0V1bW/e81+u7m5mhlAJP1A1HgIUQICIYhnGqvf3SLx5+ePWh1155ztq2bR0octeY9XohB319XWg5ctR66KFVB3fv3nVm2bLlGysqKr/h8bhrANKYGTfHzT03B8Ayl8tfHhjof//w4eYDzz77k7a1ax/B2s1PgSKzxhMudpKaObNwub0DyWQc4XC5vmvXzjkLFy5aXlFR2eT3++fpul4hhPACgFLKtG17IJvNXhgY6G85efJE8/btz7UPDcXt0tJy1NTMwuXLHYUjNpl8RqPlOHbsKGpq6kBEvief3FRaW1sXCYVCAYCRSg1n2touJfbte3uImY329otYsqQBsdjgHX3rk8BHLBbHnDlzAQAzZ84wqqurjZUrv3Zj/vz5AIDW1laYZhYzZ8743IL9P5c7p9Z2Q/lhAAAAJXRFWHRkYXRlOmNyZWF0ZQAyMDI0LTA4LTIyVDEwOjI1OjU0KzAyOjAwP+ws3AAAACV0RVh0ZGF0ZTptb2RpZnkAMjAyNC0wOC0yMlQxMDoyNTo1NCswMjowME6xlGAAAAAASUVORK5CYII=')
      }

      // label string for a URL 
      let nameForUrl = (url) => {
        if (url.match(/(www.)?linkedin[.]com/i)) { return "LinkedIn"}
        if (url.match(/(www.)?github[.]com/i)) { return "GitHub"}
        if (url.match(/(www.)?x[.]com/i)) { return "Twitter"}
        if (url.match(/(www.)?facebook[.]com/i)) { return "Facebook" }
        if (url.match(/(www.)?instagram[.]com/i)) { return "Insta" }
        if (url.match(/news[.]ycombinator[.]com/i)) { return "HckNws" }
        if (url.match(/[.]wikipedia[.]/i)) { return "Wikipedia" }
        
        return "Url"
      }

      let data = JSON.parse(this.rawJsonData)
      let unhandled = data[1].map((entry, idx) => {
        if (["prodid", "version", "n", "fn", "xAbLabel", "xAim", "xJabber", "xAbadr", "xIcq"].indexOf(entry[0]) > -1) return null

        // photos encoded in base64 (type 'b') are handled, all others aren't.
        if (entry[0] == "photo" && entry[1].encoding == "b") return null

        let idStr = " id=\"contact-details-input-" + idx + "\" "

        if (entry[0] == "title") {
          if ( entry[3] == "") return null

          $('#contact-details > .cd-title').append(
            "<div class=\"form-row\">"+
            "<label><i class=\"fa fa-trophy\"></i> <span>Title</span></label>"+
            "<input " + idStr + " type=text value=\"" + entry[3].replace("\"", "&quot;") + "\">"+
            "<a href='#' style='margin-left: 10px; colour: blue;' class='search-for'><i class='fa fa-search'></i></a>" +
            "</div>"
          )
          return null
        }

        if (entry[0] == "org" ) {
          if (entry[3] == "") return null

          $('#contact-details > .cd-org').append(
            "<div class=\"form-row\">"+
            "<label><i class=\"fa fa-industry\"></i> <span>Company</span></label>"+
            "<input " + idStr + " type=text value=\"" + entry[3].replace("\"", "&quot;") + "\">"+
            "<a href='#' style='margin-left: 10px; colour: blue;' class='search-for'><i class='fa fa-search'></i></a>" +
            "</div>")
          return null
        }

        if (entry[0] == "url") {
          let url = entry[3].replace("\"", "&quot;")
          if ( url != "" ) {
            $('#contact-details > .cd-url').append(
              "<div class=\"form-row\">"+
              "<label><i class=\"fa fa-link\"></i> <span>" + nameForUrl(url) + "</span></label>" +
              "<input " + idStr + " type=text value=\"" + url + "\">" +
              "<a style=\"color: blue; margin-left: 10px;\" target=_blank href='"+url+"'><i class='fa fa-external-link'></i></a>" +
              "</div>"
            )
          }
          return null
        }

        if (entry[0] == "email") {
          let email = entry[3].replace("\"", "&quot;")
          if ( email != '') {
            $('#contact-details > .cd-email').append(
              "<div class=\"form-row\">"+
              "<label><i class=\"fa fa-envelope\"></i> <span>Email</span></label>"+
              "<input " + idStr + " type=text value=\"" + email + "\">"+
              "<a style=\"color: blue; margin-left: 10px;\" target=_blank href='mailto:" + email + "'><i class='fa fa-external-link'></i></a>" +
              "</div>"
            )
          }
          return null
        }

        if (entry[0] == "tel" ) {
          if (entry[3] == "") return null

          $('#contact-details > .cd-tel').append(
            "<div class=\"form-row\">"+
            "<label><i class=\"fa fa-phone\"></i> <span>Tel</span></label>"+
            "<input " + idStr + " type=text value=\"" + entry[3].replace("\"", "&quot;") + "\">"+
            "<a href='#' style='margin-left: 10px; colour: blue;' class='search-for'><i class='fa fa-search'></i></a>" +
            "</div>")
          return null
        }

        if (entry[0] == "bday" ) {
          if (entry[3] == "") return null

          $('#contact-details > .cd-bday').append(
            "<div class=\"form-row\">"+
            "<label><i class=\"fa fa-birthday-cake\"></i> <span>Birthday</span></label>"+
            "<input " + idStr + " type=text value=\"" + entry[3].replace("\"", "&quot;") + "\">"+
            "<a href='#' style='margin-left: 10px; colour: blue;' class='search-for'><i class='fa fa-search'></i></a>" +
            "</div>")
          return null
        }

        if (entry[0] == "dday") {
          if (entry[3] == "") return null

          $('#contact-details > .cd-dday').append(
            "<div class=\"form-row\">" +
            "<label><i class=\"fa fa-anchor\"></i> <span>Deathday</span></label>" +
            "<input " + idStr + " type=text value=\"" + entry[3].replace("\"", "&quot;") + "\">" +
            "<a href='#' style='margin-left: 10px; colour: blue;' class='search-for'><i class='fa fa-search'></i></a>" +
            "</div>")
          return null
        }


        if (entry[0] == "impp" && entry[1].xServiceType == "Skype") {
          $('#contact-details > .cd-impp').append("<div class=\"form-row\"><label><i class=\"fa fa-paper-plane-o\"></i> <span>Skype</span></label><input " + idStr + " type=text value=\"" + entry[3].replace("\"", "&quot;") + "\"></div>")
          return null
        }

        if (entry[0] == "impp" && entry[1].xServiceType == "AIM") {
          $('#contact-details > .cd-impp').append("<div class=\"form-row\"><label><i class=\"fa fa-paper-plane-o\"></i> <span>Aim</span></label><input " + idStr + " type=text value=\"" + entry[3].replace("\"", "&quot;") + "\"></div>")
          return null
        }

        if (entry[0] == "impp" && entry[1].xServiceType == "Jabber") {
          $('#contact-details > .cd-impp').append("<div class=\"form-row\"><label><i class=\"fa fa-paper-plane-o\"></i> <span>Jabber</span></label><input " + idStr + " type=text value=\"" + entry[3].replace("\"", "&quot;") + "\"></div>")
          return null
        }
        
        if (entry[0] == "impp" && entry[1].xServiceType == "ICQ") {
          $('#contact-details > .cd-impp').append("<div class=\"form-row\"><label><i class=\"fa fa-paper-plane-o\"></i> <span>ICQ</span></label><input " + idStr + " type=text value=\"" + entry[3].replace("\"", "&quot;") + "\"></div>")
          return null
        }

        if (entry[0] == "note") {
          if (entry[3] == "") return null
          
          $('#contact-details > .cd-note').append("<div class=\"form-row\"><label><i class=\"fa fa-sticky-note-o\"></i> <span>Note</span></label><textarea " + idStr + " >" + entry[3].replace("\"", "&quot;") + "</textarea></div>")
          return null
        }

        if (entry[0] == "adr") {
          $('#contact-details > .cd-adr').append("<div class=\"form-row\"><label><i class=\"fa fa-map-pin\"></i> <span>Adr</span></label><textarea placeholder='post office box; the extended address; the street address; the locality(e.g., city); the region(e.g., state or province); the postal code; the country name' " + idStr + " >" + entry[3].join(";").replace(">", "&qt;").replace("<", "&lt;") + "</textarea><input style='margin-left: 4px; width: 10%;' class='addr-type' type='text' value='" + entry[1]["type"] + "'/></div>")
          return null
        }

        return entry
      }).filter(v => v != null)

      if (unhandled.length > 0) {
        $('#raw-json-data').val(JSON.stringify(unhandled, null, 2))
      } else {
        $('#raw-json-data').hide()
      }

      //
      // Search buttons
      //
      $('.search-for').click( e => {
        if (e) { e.preventDefault() }
        
        let searchFor = $($(e.target)[0]).parent().parent().find('input').val()

        $('#node-dialog-ok').trigger('click')

        setTimeout( () => {

          RED.search.show()

          setTimeout( () => {
            $('#red-ui-search .red-ui-searchBox-form > .red-ui-searchBox-input').val("flow:current " + searchFor).trigger('keyup') 
          },300)
        }, 300)
      })

      //
      // Buttons to add content
      //
      $('#new-content > .nc-buttons').append(
        "<button id='new-image-button'>+ Pic</button>" +
        "<button id='new-url-button'>+ Url</button>" +
        "<button id='new-email-button'>+ Email</button>" +
        "<button id='new-tel-button'>+ Tel</button>" +
        "<button id='new-note-button'>+ Note</button>" +
        "<button id='new-org-button'>+ Org</button>" +
        "<button id='new-title-button'>+ Title</button>" +
        "<button id='new-bday-button'>+ Birthday</button>" +
        "<button id='new-adr-button'>+ Adr</button>" +
        "<button id='new-dday-button'>+ Deathday</button>"
      )

      $('#new-url-button').click((e) => {
        $('#new-content').prepend("<div class=\"form-row\"><label><i class=\"fa fa-link\"></i> <span>Url</span></label><input class='new-content-field' data-type='url' type=text value=''></div>")
      })
      $('#new-email-button').click((e) => {
        $('#new-content').prepend("<div class=\"form-row\"><label><i class=\"fa fa-envelope\"></i> <span>Email</span></label><input class='new-content-field' data-type='email' type=text value=''></div>")
      })
      $('#new-tel-button').click((e) => {
        $('#new-content').prepend("<div class=\"form-row\"><label><i class=\"fa fa-phone\"></i> <span>Tel</span></label><input class='new-content-field' data-type='tel' type=text value=''></div>")
      })
      $('#new-bday-button').click((e) => {
        $('#new-content').prepend("<div class=\"form-row\"><label><i class=\"fa fa-birthday-cake\"></i> <span>Birthday</span></label><input class='new-content-field' data-type='bday' type=text placeholder='YYYY-MM-DD' value=''></div>")
      })
      $('#new-dday-button').click((e) => {
        $('#new-content').prepend("<div class=\"form-row\"><label><i class=\"fa fa-anchor\"></i> <span>Deathday</span></label><input class='new-content-field' data-type='dday' type=text placeholder='YYYY-MM-DD' value=''></div>")
      })
      $('#new-note-button').click((e) => {
        $('#new-content').prepend("<div class=\"form-row\"><label><i class=\"fa fa-sticky-note-o\"></i> <span>Note</span></label><textarea class='new-content-field' data-type='note'></textarea></div>")
      })

      $('#new-image-button').click((e) => {
        $('#new-content').prepend("<div class=\"form-row\"><label><i class=\"fa fa-user\"></i> <span>Pic</span></label><textarea placeholder='Base64 Content' id='pic-content'></textarea></div>")
        $('#pic-content').on('change', () => {
          $('#contact-image').attr('src', 'data:image/jpeg;base64,' + $('#pic-content').val())
        })
        $('#new-image-button').prop('disabled', true)
      })

      $('#new-adr-button').click((e) => {
        $('#new-content').prepend("<div class=\"form-row\"><label><i class=\"fa fa-map-pin\"></i> <span>Addr</span></label><textarea placeholder='post office box; the extended address; the street address; the locality(e.g., city); the region(e.g., state or province); the postal code; the country name' class='new-content-field' data-type='adr'></textarea><select class='addr-type' style='margin-left: 4px; width=10%;'><option value='other'>Other</option><option value='holiday'>Holiday</option><option value='home'>Home</option><option value='work'>Work</option></select></div>")
      })

      $('#new-org-button').click((e) => {
        $('#new-content').prepend("<div class=\"form-row\"><label><i class=\"fa fa-industry\"></i> <span>Org</span></label><input class='new-content-field' data-type='org' type=text value=''></div>")
      })
      $('#new-title-button').click((e) => {
        $('#new-content').prepend("<div class=\"form-row\"><label><i class=\"fa fa-trophy\"></i> <span>Title</span></label><input class='new-content-field' data-type='title' type=text value=''></div>")
      })

      //
      // Buttons to add content
      //
      $('#task-area > .ta-buttons').append(
        "<button id='ta-select-duplicates' data-node-id='" + this.id + "'>Select Duplicates</button>&nbsp;" +
        "<button id='ta-move-duplicates' data-node-id='" + this.id + "'>Duplicates to here</button>&nbsp;" +
        "<button id='ta-move-original' data-node-id='" + this.id + "'>Move to Duplicate</button>"
      )

      $('#ta-select-duplicates').click((e) => {
        if (e) { e.preventDefault() }

        let srchResults = RED.search.search($('#node-input-name').val()).filter(n => { return n.node.z == RED.workspaces.active() })

        $('#node-dialog-ok').trigger('click')

        if ( srchResults.length < 2 ) {
          return RED.notify(RED._("notification.warning", {
            message: "No other nodes found."
          }), "warning");
        }

        RED.notify("Found " + (srchResults.length - 1) + " duplicates", {
          timeout: 2000
        });

        setTimeout( () => {
          RED.view.select({ nodes: srchResults.map(n => n.node) }) 
        },400)
      })

      $('#ta-move-original').click((e) => {
        if (e) { e.preventDefault() }

        let srchResults = RED.search.search($('#node-input-name').val()).filter(n => { return n.node.z == RED.workspaces.active() })

        if (srchResults.length == 1) {
          $('#node-dialog-ok').trigger('click')
          return RED.notify(RED._("notification.warning", {
            message: "No duplicate found."
          }), "warning");
        }

        if (srchResults.length != 2) {
          return RED.notify(RED._("notification.warning", {
            message: "Not exactly one duplicate found, doing nothing."
          }), "warning");          
        }

        RED.notify("Found " + (srchResults.length - 1) + " duplicate", {
          timeout: 2000
        });

        let baseNodeId = $(e.target).data("node-id")

        setTimeout(() => {
          let baseNode = RED.nodes.node(baseNodeId)
          let duplNode = srchResults.filter(n => { return n.node.id != baseNodeId })[0].node

          let changedNodes = [];

          changedNodes.push({
            n: baseNode,
            ox: baseNode.x,
            oy: baseNode.y,
            moved: baseNode.moved
          });

          baseNode.x = duplNode.x - parseInt(Math.random() * 20);
          baseNode.y = duplNode.y + parseInt(Math.random() * 20);
          baseNode.dirty = true;
          
          $('#node-dialog-ok').trigger('click')

          RED.history.push({ t: "move", nodes: changedNodes, dirty: RED.nodes.dirty() });
          RED.nodes.dirty(true);
          RED.view.redraw(true);
          setTimeout(() => { RED.view.select({ nodes: [baseNode, duplNode] }) }, 300)
        }, 400)
      })

      $('#ta-move-duplicates').click((e) => {
        if (e) { e.preventDefault() }

        let srchResults = RED.search.search($('#node-input-name').val()).filter(n => { return n.node.z == RED.workspaces.active() })

        $('#node-dialog-ok').trigger('click')

        if (srchResults.length < 2) {
          return RED.notify(RED._("notification.warning", {
            message: "No other nodes found."
          }), "warning");
        }

        RED.notify("Found " + (srchResults.length - 1) + " duplicates", {
          timeout: 2000
        });

        let baseNodeId = $(e.target).data("node-id")
        
        setTimeout(() => {
          let baseNode = RED.nodes.node( baseNodeId )
          let changedNodes = [];
          let children = srchResults.filter(n => { return n.node.id != baseNodeId })

          children.forEach((c) => {
            let nd = RED.nodes.node(c.node.id);

            changedNodes.push({
              n: nd,
              ox: nd.x,
              oy: nd.y,
              moved: nd.moved
            });

            nd.x = baseNode.x - parseInt(Math.random() * 20);
            nd.y = baseNode.y + parseInt(Math.random() * 20);
            nd.dirty = true;
          });

          RED.history.push({ t: "move", nodes: changedNodes, dirty: RED.nodes.dirty() });
          RED.nodes.dirty(true);
          RED.view.redraw(true);
          setTimeout( () => { RED.view.select({ nodes: children.map(n => n.node) }) }, 300 )
        }, 400)
      })
    },

    oneditcancel: function () {
    },

    oneditsave: function () {
      let data = JSON.parse(this.rawJsonData)

      // check for profile image data
      if ( $('#pic-content').length > 0 ) {
        let haveReplacedPhoto = false

        this.base64image = $('#pic-content').val()
        this.base64Type = "jpeg"

        data[1].forEach(entry => {
          if ( entry[0] == "photo" ) {
            haveReplacedPhoto = true
            entry[1] = { encoding: 'b', type: "jpeg" }
            entry[3] = $('#pic-content').val()
          } 
        })

        if ( !haveReplacedPhoto ) {
          data[1].push([
            "photo",
            { encoding: 'b', type: "jpeg" },
            "text",
            $('#pic-content').val()
          ])
        }
      }

      data[1].forEach((entry, idx) => {
        if ($('#contact-details-input-' + idx).length > 0 && entry.length > 3 && entry[3] && entry[3] != $('#contact-details-input-' + idx).val() )  {
          if (entry[0] != "adr") {
            entry[3] = $('#contact-details-input-' + idx).val()
          } else {
            entry[3] = $('#contact-details-input-' + idx).val().split(";")
            entry[1].type = $($('#contact-details-input-' + idx).parent().find('input.addr-type')).val()
          }
        }

        if (entry[0] == "fn" && entry[3] != $('#node-input-name').val()) {
          entry[3] = $('#node-input-name').val()
        }
      })

      $('.new-content-field').each((idx, elem) => {
        if ($(elem).val() == "") return;

        if ( ["adr"].indexOf( $(elem).data('type') ) > -1 ) {
          data[1].push([
            $(elem).data('type'),
            {
              "type": $($(elem).parent().find('select.addr-type')).val()
            },
            "text",
            $(elem).val().split(";")
          ])
        }

        if (["email", "tel", "url"].indexOf($(elem).data('type')) > -1) {
          data[1].push([
            $(elem).data('type'),
            {
              "type": ["internet", "home"]
            },
            "text",
            $(elem).val()
          ])
        }

        if (["bday", "note", "org", "title", "dday"].indexOf($(elem).data('type')) > -1) {
          data[1].push([
            $(elem).data('type'),
            {},
            "text",
            $(elem).val()
          ])
        }
      })

      this.rawJsonData = JSON.stringify(data)
    },

    oneditresize: function (size) {
    },


  });
})();

</script>

<script type="text/html" data-template-name="Contact">
  <div class="form-row">
    <center>
     <img id="contact-image" src="" width="200"/>
    </center>
  </div>

  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
    <input type="text" id="node-input-name" data-i18n="[placeholder]node-red:common.label.name">
    <a href='#' style="margin-left: 10px; colour: blue;" class='search-for'><i class="fa fa-search"></i></a>
  </div>

  <div id="contact-details" class="form-row">
    <div class="cd-title"></div>
    <div class="cd-org"></div>
    <div class="cd-tel"></div>
    <div class="cd-email"></div>
    <div class="cd-impp"></div>
    <div class="cd-url"></div>
    <div class="cd-bday"></div>
    <div class="cd-dday"></div>
    <div class="cd-adr"></div>
    <div class="cd-note"></div>
 </div>

  <div class="form-row">
    <textarea id='raw-json-data'></textarea>
  </div>

  <div id="new-content" class="form-row">
    <div class="nc-buttons"></div>
  </div>

  <div id="task-area" class="form-row">
    <div class="ta-buttons"></div>
  </div>
  
</script>
<script type="text/html" data-help-name="Contact">
  <p>This represents a human in a contact book.</p>
  Empty
</script>

<!-- --- [red-module:@gregoriusrippenstein/node-red-contrib-flowhub/flowhubcfg] --- -->
<script type="text/javascript">
(function ($) {
   RED.nodes.registerType('FlowHubCfg', {
      category: 'config',
      hasUsers: false,
      defaults: {
        apiToken: { value: "" },      
        apiTokenType: { value: "" },
        fullname: { value: "" },
        email: { value: "" },
        flowid: { value: "" },
        flowrevision: { value: "" },
        notab: { value: false },
        pushcomment: { value: "" },
        pushnewflows: { value: false },
        forcepush: { value: false },
        tokens: { value: [] },
        flowrevisions: { value: {} }
      },
      label: 'FlowHubCfg',
  });
})(jQuery);
</script>

<!-- The html for the config node info panel (in right sidebar) -->
<script type="text/x-red" data-template-name="FlowHubCfg">
This page is intentional left blank.
</script>

<!-- --- [red-module:@gregoriusrippenstein/node-red-contrib-introspection/seeker] --- -->
<script type="text/javascript">
RED.nodes.registerType("Seeker",{color:"#e5e4ef",icon:"font-awesome/fa-ship",category:"pathways",paletteLabel:"Seeker",defaults:{name:{value:""}},inputs:0,outputs:1,label:function(){return this.name||this._def.paletteLabel},labelStyle:function(){return this.name?"node_label_italic":""},oneditprepare:function(){var n=this;window._introSpectionSeekerStack=[],window._introWorker=void 0;let i=e=>{var t=RED.nodes.node(e[e.length-1]);let n=[];return e.forEach(function(e){var t,e=RED.nodes.node(e)||RED.nodes.junction(e);void 0!==e&&(t=RED.nodes.workspace(e.z)||RED.nodes.subflow(e.z),n.push({label:"",_label:RED.utils.getNodeLabel(e),node:e,sublabel:t&&RED.utils.getNodeLabel(t)||e.z,icon:RED.utils.createNodeIcon(e,!0),class:"intro-remove-top-left"}))}),{node:t,label:RED.utils.getNodeLabel(t),_label:RED.utils.getNodeLabel(t),_pathlen:e.length,sublabel:"Length: "+e.length,selected:!1,checkbox:!1,children:n}};var o=$("#node-input-seeker-target-filter").searchBox({style:"compact",delay:300,change:function(){let t=$(this).val().trim().toLowerCase();var e,n=$("#node-input-seeker-target-container-div").treeList("data");""===t?($("#node-input-seeker-target-container-div").treeList("filter",null),o.searchBox("count","")):(e=$("#node-input-seeker-target-container-div").treeList("filter",function(e){return-1<e._label.toLowerCase().indexOf(t)||-1<e.node.type.toLowerCase().indexOf(t)||e.sublabel.toLowerCase().indexOf(t)}),o.searchBox("count",e+" / "+n.length))}}),r=((e=>{let n=`#node-input-${e}-target-container-div`,o=`#node-input-${e}-extract-pathway-but`,i=`#node-input-${e}-show-pathway-but`;$(n).css({width:"100%",height:"calc(100%)"}).treeList({multi:!1}).on("treelistitemmouseover",function(e,t){}).on("treelistitemmouseout",function(e,t){}).on("treelistconfirm",function(e,t){t.node&&!t.children&&(RED.view.reveal(t.node.id),RED.view.select(t.node.id),setTimeout(()=>{RED.editor.edit(t.node)},100))}).on("treelistselect",function(e,t){t.node&&!t.children&&(RED.workspaces.show(t.node.z,!1,!1,!0),RED.view.reveal(t.node.id,!0),RED.view.redraw()),1==$(n).treeList("data").filter(e=>e.expanded).length?($(o).prop("disabled",!1),$(i).prop("disabled",!1)):($(o).prop("disabled",!0),$(i).prop("disabled",!0))})})("seeker"),function(t,n){if(n.indexOf(t.id)<0&&!t.d)switch(t.type){case"link call":RED.nodes.getNodeLinks(t).forEach(e=>{r(e.target,[...n,t.id])}),t.links.forEach(e=>{e=RED.nodes.node(e);e&&r(e,[...n,t.id])});break;case"link out":t.links.forEach(e=>{e=RED.nodes.node(e);e&&r(e,[...n,t.id])});break;case"Sink":n.push(t.id),window._introSpectionSeekerStack=[n,...window._introSpectionSeekerStack];break;default:RED.nodes.getNodeLinks(t).forEach(e=>{r(e.target,[...n,t.id])})}});let a=e=>{e&&e.preventDefault();let t=window._introSpectionSeekerStack.length,n=25,o=("-"!=$("#node-input-seeker-show-percent").val()&&(n=parseInt(t*(parseInt($("#node-input-seeker-show-percent").val())/100))),e=$("#node-input-seeker-show-ordering").val(),{1:(e,t)=>e.length<t.length?-1:1,2:(e,t)=>e.length>t.length?-1:1,3:(e,t)=>RED.utils.getNodeLabel(RED.nodes.node(e[e.length-1]))<RED.utils.getNodeLabel(RED.nodes.node(t[t.length-1]))?-1:1,4:(e,t)=>{e=RED.utils.getNodeLabel(RED.nodes.node(e[e.length-1]));return RED.utils.getNodeLabel(RED.nodes.node(t[t.length-1]))<e?-1:1},5:(e,t)=>.5<Math.random()?-1:1}[parseInt(e)]||((e,t)=>e.length<t.length?-1:1));setTimeout(()=>{setTimeout(()=>{$("#node-input-seeker-totalPaths").html(n>t?""+t:n+" / "+t)},10),setTimeout(()=>{$("#node-input-seeker-target-container-div").treeList("data",window._introSpectionSeekerStack.sort(o).slice(0,n).map(e=>i(e)))},20)},100)},d=()=>{let e=window._introSpectionSeekerStack.length;setTimeout(()=>{$("#node-input-seeker-start-but").prop("disabled",!1),$("#node-input-seeker-totalPaths").html(e),$("#node-input-seeker-spinner").hide()},10);var t="seeker",n=e;$(`#node-input-${t}-show-percent`).show(),$(`#node-input-${t}-show-ordering`).show();var o,i=$(`#node-input-${t}-show-percent`),r=(i.html(""),i.append($("<option></option>").val("-").html("Show..")),[5,10,20,30,40,50,75].forEach(e=>{var t=parseInt(e*n/100);0!=t&&i.append($("<option></option>").val(e).html(t+" paths"))}),i.append($("<option></option>").val(100).html("All")),i.val("-"),(i=$(`#node-input-${t}-show-ordering`)).html(""),{"Count Asc":1,"Count Desc":2,"Name Asc":3,"Name Desc":4,Random:5});for(o in r)i.append($("<option></option>").val(r[o]).html(o));i.val(1),$("#node-input-seeker-show-ordering").on("change",a),$("#node-input-seeker-show-percent").on("change",a),$("#node-input-seeker-show-percent").trigger("change")};$("#node-input-seeker-show-pathway-but").on("click",e=>{e&&e.preventDefault();var e=$("#node-input-seeker-target-container-div").treeList("data").filter(e=>e.expanded);1==(e=e).length?(e=e[0].children.filter(e=>e.node.z==RED.workspaces.active()).map(e=>e.node.id),RED.tray.hide(),RED.view.selectNodes({selected:e,onselect:()=>{RED.tray.show()},oncancel:()=>{RED.tray.show()}})):RED.notify("Only one expanded pathway can be shown.",{type:"warning"})}),$("#node-input-seeker-extract-pathway-but").on("click",e=>{e&&e.preventDefault(),(e=>{if(1==e.length){e=e[0].children.map(e=>e.node).filter(e=>["link in","link out","Seeker","Sink","junction"].indexOf(e.type)<0);let o=RED.nodes.createExportableNodeSet(e).map(e=>(e.id=RED.nodes.id(),e)),i=0;o=o.map((e,t)=>{try{var n;e._def=e._def||RED.nodes.getType(e.type),e._def&&e._def._&&e._?(n=RED.utils.getNodeLabel(e,e.info).split("\\n").length,i+=30*n+30):i+=50}catch(e){i+=50}return delete e.z,e.y=i,e.x=0,e.wires=[[]],t!=o.length-1&&(e.wires=[[o[t+1].id]]),e}),RED.clipboard.copyText(JSON.stringify(o))&&RED.notify("Pathway copied to clipboard",{type:"success"})}else RED.notify("Only one expanded pathway can be extracted.",{type:"warning"})})($("#node-input-seeker-target-container-div").treeList("data").filter(e=>e.expanded))}),$("#node-input-seeker-start-but").on("click",e=>{if(e&&e.preventDefault(),setTimeout(()=>{$("#node-input-seeker-start-but").prop("disabled",!0),$("#node-input-seeker-totalPaths").html(""),$("#node-input-seeker-spinner").show(),$("#node-input-seeker-show-percent").hide(),$("#node-input-seeker-show-ordering").hide()},10),window._introSpectionSeekerStack=[],"undefined"!=typeof Worker){let t=new Worker("data:text/javascript;base64,bGV0IGludHJvU3BlY3Rpb25TdGFjaz1bXSxncmFwaD1bXSxncmFwaEluZGV4PXt9LFJFRD17bm9kZXM6e25vZGU6ZT0+Z3JhcGhbZ3JhcGhJbmRleFtlXV0sZ2V0Tm9kZUxpbmtzOmE9PmEuZmxhdHdpcmVzLm1hcChlPT4oe3RhcmdldDpSRUQubm9kZXMubm9kZShlKSxzb3VyY2U6YX0pKX19LHRyYXZlcnNlPWZ1bmN0aW9uKGEscyl7aWYocy5pbmRleE9mKGEuaWQpPDAmJiFhLmQpc3dpdGNoKGEudHlwZSl7Y2FzZSJsaW5rIGNhbGwiOlJFRC5ub2Rlcy5nZXROb2RlTGlua3MoYSkuZm9yRWFjaChlPT57dHJhdmVyc2UoZS50YXJnZXQsWy4uLnMsYS5pZF0pfSksYS5saW5rcy5mb3JFYWNoKGU9PntlPVJFRC5ub2Rlcy5ub2RlKGUpO2UmJnRyYXZlcnNlKGUsWy4uLnMsYS5pZF0pfSk7YnJlYWs7Y2FzZSJsaW5rIG91dCI6YS5saW5rcy5mb3JFYWNoKGU9PntlPVJFRC5ub2Rlcy5ub2RlKGUpO2UmJnRyYXZlcnNlKGUsWy4uLnMsYS5pZF0pfSk7YnJlYWs7Y2FzZSJTaW5rIjpzLnB1c2goYS5pZCkscG9zdE1lc3NhZ2Uocyk7YnJlYWs7ZGVmYXVsdDpSRUQubm9kZXMuZ2V0Tm9kZUxpbmtzKGEpLmZvckVhY2goZT0+e3RyYXZlcnNlKGUudGFyZ2V0LFsuLi5zLGEuaWRdKX0pfX07b25tZXNzYWdlPWZ1bmN0aW9uKGUpe2xldCBhPWUuZGF0YS5zZWVrZXJJZDsoZ3JhcGg9ZS5kYXRhLm5vZGVzLm1hcChlPT4oe3dpcmVzOmUud2lyZXMsbGlua3M6ZS5saW5rcyxkOmUuZGlzYWJsZWR8fGUuZCxpZDplLmlkLHR5cGU6ZS50eXBlfSkpLmZpbHRlcihlPT4hIWUud2lyZXMpLm1hcChlPT4oZS5mbGF0d2lyZXM9ZS53aXJlcy5mbGF0KCksZSkpKS5mb3JFYWNoKChlLGEpPT5ncmFwaEluZGV4W2UuaWRdPWEpLFJFRC5ub2Rlcy5nZXROb2RlTGlua3MoUkVELm5vZGVzLm5vZGUoYSkpLmZvckVhY2goZT0+e3RyYXZlcnNlKGUudGFyZ2V0LFthXSl9KSxwb3N0TWVzc2FnZSgiZG9uZSIpfTs=");(window._introWorker=t).onmessage=function(e){"done"==e.data?(t.terminate(),delete window._introWorker,d()):(window._introSpectionSeekerStack.push(e.data),$("#node-input-seeker-totalPaths").html(window._introSpectionSeekerStack.length),26==window._introSpectionSeekerStack.length&&$("#node-input-seeker-target-container-div").treeList("data",window._introSpectionSeekerStack.sort((e,t)=>e.length<t.length?-1:1).slice(0,25).map(e=>i(e))))},setTimeout(()=>{t.postMessage({seekerId:n.id,nodes:RED.nodes.createCompleteNodeSet({credentials:!1})})},10)}else setTimeout(()=>{RED.nodes.getNodeLinks(n).forEach(e=>{r(e.target,[n.id])}),d()},300)})},oneditsave:function(){window._introWorker&&(window._introWorker.terminate(),delete window._introWorker),delete window._introSpectionSeekerStack},oneditcancel:function(){window._introWorker&&(window._introWorker.terminate(),delete window._introWorker),delete window._introSpectionSeekerStack},oneditresize:function(e){for(var t=$("#dialog-form>div:not(.node-input-target-list-row)"),n=$("#dialog-form").height(),o=0;o<t.length;o++)n-=$(t[o]).outerHeight(!0);$("#dialog-form>div.node-input-target-list-row").css("height",n+"px")}});
</script>

<script type="text/html" data-template-name="Seeker">

  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name">Name</span></label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>

  <div class="form-row node-input-target-row">
    <button id="node-input-seeker-start-but" class="red-ui-button"><span><i class="fa fa-refresh"></i> Find Pathways</span></button>
    <select class='hide' style="width:100px;" id="node-input-seeker-show-percent"></select>
    <select class='hide' style="width:100px;" id="node-input-seeker-show-ordering"></select>
    <button id="node-input-seeker-show-pathway-but" class="red-ui-button">Show Pathway</button>
  </div>

  <div class="form-row node-input-target-row node-input-target-list-row" style="margin-top: 40px; position: relative; min-height: 100px">
    <div style="position: absolute; top: -30px; right: 0;"><input type="text" id="node-input-seeker-target-filter"></div>

    <div id="node-input-seeker-target-container-div"></div>
  </div>

  <div class="form-row" style="margin-top: 0px; margin-bottom: 20px;">
    <label>Total Paths: 
        <span id="node-input-seeker-totalPaths"></span><img class='hide' id="node-input-seeker-spinner" src='red/images/spin.svg'/>
    </label>
    <button id="node-input-seeker-extract-pathway-but" style="float: right" class="red-ui-button">Extract Pathway to Clipboard</button>
  </div>

</script>

<style>
  .intro-remove-top-left i.red-ui-palette-icon-fa {
    top: -2px !important;
    left: 0px !important;
  }
</style>


<script type="text/html" data-help-name="Seeker">
  <p>The Seeker seeks in the sink and presents all (max 25) paths that lead to the sink.</p>
</script>
<!-- --- [red-module:@gregoriusrippenstein/node-red-contrib-introspection/sink] --- -->
<script type="text/javascript">
RED.nodes.registerType("Sink",{color:"#e5e4ef",icon:"font-awesome/fa-anchor",category:"pathways",paletteLabel:"Sink",defaults:{name:{value:""}},inputs:1,outputs:0,label:function(){return this.name||this._def.paletteLabel},labelStyle:function(){return this.name?"node_label_italic":""},oneditprepare:function(){var n=this;let o=1,i=(window._introSpectionsinkStack=[],window._introWorker=void 0,e=>{var t=RED.nodes.node(e[e.length-1]);let n=[];return e.forEach(function(e){var t,e=RED.nodes.node(e)||RED.nodes.junction(e);void 0!==e&&(t=RED.nodes.workspace(e.z)||RED.nodes.subflow(e.z),n.push({label:"",_label:RED.utils.getNodeLabel(e),node:e,sublabel:t&&RED.utils.getNodeLabel(t)||e.z,icon:RED.utils.createNodeIcon(e,!0),class:"intro-remove-top-left"}))}),{node:t,label:RED.utils.getNodeLabel(t),_label:RED.utils.getNodeLabel(t),_pathlen:e.length,sublabel:"Length: "+e.length,selected:!1,checkbox:!1,children:n}});var a=$("#node-input-sink-target-filter").searchBox({style:"compact",delay:300,change:function(){let t=$(this).val().trim().toLowerCase();var e,n=$("#node-input-sink-target-container-div").treeList("data");""===t?($("#node-input-sink-target-container-div").treeList("filter",null),a.searchBox("count","")):(e=$("#node-input-sink-target-container-div").treeList("filter",function(e){return-1<e._label.toLowerCase().indexOf(t)||-1<e.node.type.toLowerCase().indexOf(t)||e.sublabel.toLowerCase().indexOf(t)}),a.searchBox("count",e+" / "+n.length))}}),d=((e=>{let n=`#node-input-${e}-target-container-div`,o=`#node-input-${e}-extract-pathway-but`,i=`#node-input-${e}-show-pathway-but`;$(n).css({width:"100%",height:"calc(100%)"}).treeList({multi:!1}).on("treelistitemmouseover",function(e,t){}).on("treelistitemmouseout",function(e,t){}).on("treelistconfirm",function(e,t){t.node&&!t.children&&(RED.view.reveal(t.node.id),RED.view.select(t.node.id),setTimeout(()=>{RED.editor.edit(t.node)},100))}).on("treelistselect",function(e,t){t.node&&!t.children&&(RED.workspaces.show(t.node.z,!1,!1,!0),RED.view.reveal(t.node.id,!0),RED.view.redraw()),1==$(n).treeList("data").filter(e=>e.expanded).length?($(o).prop("disabled",!1),$(i).prop("disabled",!1)):($(o).prop("disabled",!0),$(i).prop("disabled",!0))})})("sink"),function(t,n){if(n.indexOf(t.id)<0&&!t.d)switch(t.type){case"link in":t.links.forEach(e=>{e=RED.nodes.node(e);e&&d(e,[...n,t.id])});break;case"Seeker":n.push(t.id),window._introSpectionsinkStack=[n,...window._introSpectionsinkStack];break;default:RED.nodes.getNodeLinks(t,o).forEach(e=>{d(e.source,[...n,t.id])})}});let l=e=>{e&&e.preventDefault();let t=window._introSpectionsinkStack.length,n=25,o=("-"!=$("#node-input-sink-show-percent").val()&&(n=parseInt(t*(parseInt($("#node-input-sink-show-percent").val())/100))),e=$("#node-input-sink-show-ordering").val(),{1:(e,t)=>e.length<t.length?-1:1,2:(e,t)=>e.length>t.length?-1:1,3:(e,t)=>RED.utils.getNodeLabel(RED.nodes.node(e[e.length-1]))<RED.utils.getNodeLabel(RED.nodes.node(t[t.length-1]))?-1:1,4:(e,t)=>{e=RED.utils.getNodeLabel(RED.nodes.node(e[e.length-1]));return RED.utils.getNodeLabel(RED.nodes.node(t[t.length-1]))<e?-1:1},5:(e,t)=>.5<Math.random()?-1:1}[parseInt(e)]||((e,t)=>e.length<t.length?-1:1));setTimeout(()=>{setTimeout(()=>{$("#node-input-sink-totalPaths").html(n>t?""+t:n+" / "+t)},10),setTimeout(()=>{$("#node-input-sink-target-container-div").treeList("data",window._introSpectionsinkStack.sort(o).slice(0,n).map(e=>i(e)))},20)},100)},s=()=>{let e=window._introSpectionsinkStack.length;setTimeout(()=>{$("#node-input-sink-start-but").prop("disabled",!1),$("#node-input-sink-totalPaths").html(e),$("#node-input-sink-spinner").hide()},10);var t="sink",n=e;$(`#node-input-${t}-show-percent`).show(),$(`#node-input-${t}-show-ordering`).show();var o,i=$(`#node-input-${t}-show-percent`),a=(i.html(""),i.append($("<option></option>").val("-").html("Show..")),[5,10,20,30,40,50,75].forEach(e=>{var t=parseInt(e*n/100);0!=t&&i.append($("<option></option>").val(e).html(t+" paths"))}),i.append($("<option></option>").val(100).html("All")),i.val("-"),(i=$(`#node-input-${t}-show-ordering`)).html(""),{"Count Asc":1,"Count Desc":2,"Name Asc":3,"Name Desc":4,Random:5});for(o in a)i.append($("<option></option>").val(a[o]).html(o));i.val(1),$("#node-input-sink-show-ordering").on("change",l),$("#node-input-sink-show-percent").on("change",l),$("#node-input-sink-show-percent").trigger("change")};$("#node-input-sink-show-pathway-but").on("click",e=>{e&&e.preventDefault();var e=$("#node-input-sink-target-container-div").treeList("data").filter(e=>e.expanded);1==(e=e).length?(e=e[0].children.filter(e=>e.node.z==RED.workspaces.active()).map(e=>e.node.id),RED.tray.hide(),RED.view.selectNodes({selected:e,onselect:()=>{RED.tray.show()},oncancel:()=>{RED.tray.show()}})):RED.notify("Only one expanded pathway can be shown.",{type:"warning"})}),$("#node-input-sink-extract-pathway-but").on("click",e=>{e&&e.preventDefault(),(e=>{if(1==e.length){e=e[0].children.map(e=>e.node).filter(e=>["link in","link out","Seeker","Sink","junction"].indexOf(e.type)<0);let o=RED.nodes.createExportableNodeSet(e).map(e=>(e.id=RED.nodes.id(),e)),i=0;o=o.map((e,t)=>{try{var n;e._def=e._def||RED.nodes.getType(e.type),e._def&&e._def._&&e._?(n=RED.utils.getNodeLabel(e,e.info).split("\\n").length,i+=30*n+30):i+=50}catch(e){i+=50}return delete e.z,e.y=i,e.x=0,e.wires=[[]],t!=o.length-1&&(e.wires=[[o[t+1].id]]),e}),RED.clipboard.copyText(JSON.stringify(o))&&RED.notify("Pathway copied to clipboard",{type:"success"})}else RED.notify("Only one expanded pathway can be extracted.",{type:"warning"})})($("#node-input-sink-target-container-div").treeList("data").filter(e=>e.expanded))}),$("#node-input-sink-start-but").on("click",e=>{if(e&&e.preventDefault(),setTimeout(()=>{$("#node-input-sink-start-but").prop("disabled",!0),$("#node-input-sink-totalPaths").html(""),$("#node-input-sink-spinner").show(),$("#node-input-sink-show-percent").hide(),$("#node-input-sink-show-ordering").hide()},10),window._introSpectionsinkStack=[],"undefined"!=typeof Worker){let t=new Worker("data:text/javascript;base64,bGV0IGludHJvU3BlY3Rpb25TdGFjaz1bXSxncmFwaD1bXSxncmFwaEluZGV4PXt9LFJFRD17bm9kZXM6e25vZGU6ZT0+Z3JhcGhbZ3JhcGhJbmRleFtlXV0sZ2V0Tm9kZUxpbmtzOnM9PnMuaW53aXJlcy5tYXAoZT0+KHt0YXJnZXQ6cyxzb3VyY2U6UkVELm5vZGVzLm5vZGUoZSl9KSl9fTt2YXIgdHJhdmVyc2U9ZnVuY3Rpb24ocyxhKXtpZihhLmluZGV4T2Yocy5pZCk8MCYmIXMuZClzd2l0Y2gocy50eXBlKXtjYXNlImxpbmsgaW4iOnMubGlua3MuZm9yRWFjaChlPT57ZT1SRUQubm9kZXMubm9kZShlKTtlJiZ0cmF2ZXJzZShlLFsuLi5hLHMuaWRdKX0pO2JyZWFrO2Nhc2UiU2Vla2VyIjphLnB1c2gocy5pZCkscG9zdE1lc3NhZ2UoYSk7YnJlYWs7ZGVmYXVsdDpSRUQubm9kZXMuZ2V0Tm9kZUxpbmtzKHMpLmZvckVhY2goZT0+e3RyYXZlcnNlKGUuc291cmNlLFsuLi5hLHMuaWRdKX0pfX07b25tZXNzYWdlPWZ1bmN0aW9uKGUpe2xldCBzPWUuZGF0YS5zaW5rSWQ7KGdyYXBoPShncmFwaD1lLmRhdGEubm9kZXMubWFwKGU9Pih7d2lyZXM6ZS53aXJlcyxsaW5rczplLmxpbmtzLGQ6ZS5kaXNhYmxlZHx8ZS5kLGlkOmUuaWQsdHlwZTplLnR5cGV9KSkuZmlsdGVyKGU9PiEhZS53aXJlcykubWFwKGU9PihlLmZsYXR3aXJlcz1lLndpcmVzLmZsYXQoKSxlKSkpLm1hcChzPT4ocy5pbndpcmVzPWdyYXBoLmZpbHRlcihlPT4tMTxlLmZsYXR3aXJlcy5pbmRleE9mKHMuaWQpKS5tYXAoZT0+ZS5pZCkscykpKS5mb3JFYWNoKChlLHMpPT5ncmFwaEluZGV4W2UuaWRdPXMpLFJFRC5ub2Rlcy5nZXROb2RlTGlua3MoUkVELm5vZGVzLm5vZGUocykpLmZvckVhY2goZT0+e3RyYXZlcnNlKGUuc291cmNlLFtzXSl9KSxwb3N0TWVzc2FnZSgiZG9uZSIpfTs=");(window._introWorker=t).onmessage=function(e){"done"==e.data?(t.terminate(),delete window._introWorker,s()):(window._introSpectionsinkStack.push(e.data),$("#node-input-sink-totalPaths").html(window._introSpectionsinkStack.length),26==window._introSpectionsinkStack.length&&$("#node-input-sink-target-container-div").treeList("data",window._introSpectionsinkStack.sort((e,t)=>e.length<t.length?-1:1).slice(0,25).map(e=>i(e))))},setTimeout(()=>{t.postMessage({sinkId:n.id,nodes:RED.nodes.createCompleteNodeSet({credentials:!1})})},10)}else setTimeout(()=>{RED.nodes.getNodeLinks(n,o).forEach(e=>{d(e.source,[n.id])}),s()},300)})},oneditsave:function(){window._introWorker&&(window._introWorker.terminate(),delete window._introWorker),delete window._introSpectionsinkStack},oneditcancel:function(){window._introWorker&&(window._introWorker.terminate(),delete window._introWorker),delete window._introSpectionsinkStack},oneditresize:function(e){for(var t=$("#dialog-form>div:not(.node-input-target-list-row)"),n=$("#dialog-form").height(),o=0;o<t.length;o++)n-=$(t[o]).outerHeight(!0);$("#dialog-form>div.node-input-target-list-row").css("height",n+"px")}});
</script>

<script type="text/html" data-template-name="Sink">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name">Name</span></label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>

  <div class="form-row node-input-target-row">
    <button id="node-input-sink-start-but" class="red-ui-button"><i class="fa fa-refresh"></i> Find Pathways</button>
    <select class='hide' style="width:100px;" id="node-input-sink-show-percent"></select>
    <select class='hide' style="width:100px;" id="node-input-sink-show-ordering"></select>
    <button id="node-input-sink-show-pathway-but" class="red-ui-button">Show Pathway</button>
  </div>

  <div class="form-row node-input-target-row node-input-target-list-row" style="margin-top: 40px; position: relative; min-height: 100px">
    <div style="position: absolute; top: -30px; right: 0;"><input type="text" id="node-input-sink-target-filter"></div>

    <div id="node-input-sink-target-container-div"></div>
  </div>

  <div class="form-row" style="margin-top: 0px; margin-bottom: 20px;">
    <label>Total Paths: 
        <span id="node-input-sink-totalPaths"></span><img id="node-input-sink-spinner" class="hide" src='red/images/spin.svg'/>
     </label>
     <button id="node-input-sink-extract-pathway-but" class="red-ui-button" style="float: right">Extract Pathway to Clipboard</button>
  </div>
</script>

<style>
  .intro-remove-top-left i.red-ui-palette-icon-fa {
    top: -2px !important;
    left: 0px !important;
  }
</style>


<script type="text/html" data-help-name="Sink">
  <p>Sink is the end of a chain of nodes to complete a full text.</p>
</script>
<!-- --- [red-module:@gregoriusrippenstein/node-red-contrib-introspection/clientcode] --- -->
<script type="text/javascript">

function handleMsgTracePacket(e,r){if(r.nodeid){let a=RED.nodes.node(r.nodeid);if(a){var s,r=$("#node-input-msgtracer-trace-treelist").treeList("data");let t=!1;r.forEach(e=>{e.id==a.id&&(t=!0,e.seenCounter+=1,e.sublabel=e.seenCounter+" @ "+e.workspaceLabel)}),t?$("#node-input-msgtracer-trace-treelist").treeList("data",r):(s={id:a.id,label:"",_label:RED.utils.getNodeLabel(a),seenCounter:1,workspaceLabel:(RED.nodes.workspace(a.z)||{label:a.z}).label,sublabel:"1 @ "+(RED.nodes.workspace(a.z)||{label:a.z}).label,selected:!1,checkbox:!1,node:a,icon:RED.utils.createNodeIcon(a,!0)},$("#node-input-msgtracer-trace-treelist").treeList("data",[s,...r]))}}}RED.comms.subscribe("msgtracer:node-received",(e,t)=>{try{handleMsgTracePacket(e,t)}catch(e){console.error(e)}});
 
function handleClientCodeFrontend(event,data){var doSend,doStatus,doError,nodeid,_msg,msg,node,payload,topic;"execfunc"==data.msg&&(doSend=(o,d,e)=>{"object"==typeof o&&(o={...e,...o}),$.ajax({url:"ClientCode/"+d,type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify(o),success:function(o){},error:function(o,e,t){RED.notify("ClientCode Communcation Failure: "+d+": "+e,{type:"error",id:d,timeout:3e3})}})},doStatus=(o,d,e)=>{$.ajax({url:"ClientCode/"+d+"/status",type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify(o),success:function(o){},error:function(o,e,t){RED.notify("ClientCode Communcation Failure: "+d+": "+e,{type:"error",id:d,timeout:3e3})}})},doError=(o,e,t)=>{RED.notify("ClientCode Failed: "+e+": "+o,{type:"error",id:e,timeout:3e3}),console.log("ClientCode: Error with node: "+e+": "+o)},nodeid=data.nodeid,_msg=data._msg,msg=data._msg,node={id:data.nodeid,send:o=>{doSend(o,nodeid,_msg)},error:o=>{doError(o,nodeid,_msg)},status:o=>{doStatus(o,nodeid,_msg)}},payload=data.payload,topic=data.topic,eval(data.func))}RED.comms.subscribe("introspect:client-code-perform",(o,e)=>{try{handleClientCodeFrontend(o,e)}catch(o){console.error(o)}});

  RED.nodes.registerType('ClientCode',{
    color: '#e5e4ef',
    icon: "introspesubflow.svg",
    category: 'function',
    paletteLabel: "ClientCode",
    defaults: {
      name: {
        value:"",
      },
      clientcode: {
        value: "node.send(msg)"
      },
      format: {
        value: "javascript"
      }
    },
    inputs:1,
    outputs:1,

    label: function() {
      return (this.name || this._def.paletteLabel);
    },

    labelStyle: function() {
      return this.name?"node_label_italic":"";
    },

    oneditsave: function() {
      $('#node-input-clientcode').val(this.editor.getValue());
      this.editor.destroy();
      delete this.editor;
    },

    oneditcancel: function() {
      this.editor.destroy();
      delete this.editor;
    },

    oneditprepare: function() {
      const that = this;
      const stateId = RED.editor.generateViewStateId("node", this, "");

      this.editor = RED.editor.createEditor({
        id: 'node-input-clientcode-editor',
        mode: 'ace/mode/nrjavascript',
        stateId: stateId,
        globals: {
          msg:true,          
          RED: true,
          node: true,
          alert: true,
          console: true,
          Buffer: true,
          setTimeout: true,
          clearTimeout: true,
          setInterval: true,
          clearInterval: true
        },
        value: $("#node-input-clientcode").val()
      });

      $("#node-input-format").on("change", function() {
        var mod = "ace/mode/"+$("#node-input-format").val();
        that.editor.getSession().setMode({
          path: mod,
          v: Date.now()
        });
      });

      RED.popover.tooltip($("#node-clientcode-expand-editor"), RED._("node-red:common.label.expand"));
      $("#node-clientcode-expand-editor").on("click", function (e) {
        e.preventDefault();
        const value = that.editor.getValue();
        that.editor.saveView();
        RED.editor.editText({
          mode: $("#node-input-format").val(),
          value: value,
          stateId: stateId,
          width: "Infinity",
          focus: true,
          complete: function (v, cursor) {
            that.editor.setValue(v, -1);
            setTimeout(function () {
              that.editor.restoreView();
              that.editor.focus();
            }, 250);
          }
        })
      })

    },

    oneditresize: function(size) {
      var rows = $("#dialog-form>div:not(.node-text-editor-row)");
      var height = $("#dialog-form").height();
      for (var i=0; i<rows.length; i++) {
        height -= $(rows[i]).outerHeight(true);
      }
      var editorRow = $("#dialog-form>div.node-text-editor-row");
      height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));
      $(".node-text-editor").css("height",height+"px");
      this.editor.resize();
    }
  });
</script>

<script type="text/html" data-template-name="ClientCode">
  <div class="form-row">
      <label for="node-input-name">
          <i class="fa fa-tag"></i>
          <span data-i18n="common.label.name">Name</span>
      </label>
      <input type="text" id="node-input-name" placeholder="Name">
  </div>

  <div class="form-row" style="position: relative; margin-bottom: 0px;">
      <label for="node-input-clientcode">
          <i class="fa fa-file-code-o"></i> Client Code
      </label>

      <div style="position: absolute; right:0;display:inline-block; text-align: right; font-size: 0.8em;">
          Syntax:
          <select id="node-input-format" style="width:110px; font-size: 10px !important;  height: 24px; padding:0;">
              <option value="handlebars">mustache</option>
              <option value="html">HTML</option>
              <option value="json">JSON</option>
              <option value="javascript">JavaScript</option>
              <option value="css">CSS</option>
              <option value="markdown">Markdown</option>
              <option value="php">PHP</option>
              <option value="python">Python</option>
              <option value="sql">SQL</option>
              <option value="yaml">YAML</option>
              <option value="text">None</option>
          </select>
          <button type="button" id="node-clientcode-expand-editor"
                  class="red-ui-button red-ui-button-small">
              <i class="fa fa-expand"></i>
          </button>
      </div>
  </div>

  <div class="form-row node-text-editor-row">
      <div style="height: 250px; min-height:150px;"
           class="node-text-editor"
           id="node-input-clientcode-editor" ></div>
  </div>

  <input type="hidden" id="node-input-clientcode" autofocus="autofocus">
</script>


<script type="text/html" data-help-name="ClientCode">
  <p>Execute Javascript code in the Node-RED frontend, triggered from the server.</p>
  
  The code is executed in the users browser and has the following enviornment defined:
  <pre>
  <code>
Variables:
  nodeid - id of this node
  _msg - a reference to the msg object passed to this node
  msg - alias for _msg
  node.id - id of this node, same as `nodeid` above
  payload - a reference to msg.payload as it was received by this node
  topic - a reference to the msg.topic as it was recieved by this node

Functionality:
  node.send({..}) - send data to the output port of this node
  node.error("msg") - generate an error for the node
  node.status( { fill: 'red', shape: 'dot', text: 'hello world'}) - generate a status for the node.
    </code>
   </pre>

    <p>
    This might be confusing since the code in the node <b>is not</b> 
    executed on the Node-RED server, rather it is executed in the client
    browser.
    <p>
    This of course makes no sense for flows that are executed "head less"
    on the server in the backgrond on some dark and stormy night. The ClientCode
    node is intended for immediate, frontend-only use.
    <p>
    An example flow with some use cases is included and can be accessed either via 
    the Import Flow dialog or accessed online <a style="color: blue" href="https://flowhub.org/f/e02ba6e534f7a0f4" target="_blank">at here <i class="fa fa-external-link"></i></a>.
    <p>
    The code to be executed by the client can also be passed in via the `msg` object using the
    `clientcode` attribute on the `msg` object. If this attribute is set, it will take precendence
    over the code defined in the node itself.
</script>
<!-- --- [red-module:@gregoriusrippenstein/node-red-scratchpad/scratchpad] --- -->
<script type="text/javascript">
(function ($) {
   RED.nodes.registerType('ScratchPadCfg', {
      category: 'config',
      hasUsers: false,
      defaults: {
         name: { value: "" },
         scratches: { value: [] }
      },
      paletteLabel: 'ScratchPadCfg',
      label: function () {
         return this.name;
      }
  });
})(jQuery);
</script>

<!-- The html for the config node info panel (in right sidebar) -->
<script type="text/x-red" data-template-name="ScratchPadCfg">
   <p>Scratch input for development.</p>
</script>
