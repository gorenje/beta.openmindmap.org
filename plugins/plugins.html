
<!-- --- [red-plugin:@gregoriusrippenstein/node-red-contrib-flowhub/flowhub_sidebar] --- -->
<script src="FlowHubLib/jslib/diff.min.js"></script>

<script type="text/javascript">
(function() {
   var globalYourConfigNode = null;
      
   function escapeHtml(e){return String(e).replace(/[&<>"'`=\/]/g,function(e){return entityMap[e]})}function checkToken(e){$("#flowhubpush-check-token-result-content").fadeOut(300,()=>{$.get({url:"https://flowhub.org/integration/token/check?format=json&t="+e}).done(e=>{if(!e.data)return RED.notify("Check failed: "+e.msg,{type:"error",id:"FlowHubTokenCheck",timeout:2e3});RED.notify("FlowHub token is good!",{type:"success",id:"FlowHubTokenCheck",timeout:2e3}),$("#flowhubpush-check-token-result-content").find(".user").attr("href","mailto:"+e.data.email).html(e.data.name),$("#flowhubpush-check-token-result-content").find(".email").html(e.data.email),$("#flowhubpush-check-token-result-content").find(".repo").attr("href",e.data.repo_url).html(e.data.repo),$("#flowhubpush-check-token-result-content").find(".permission").html(e.data.permission),$("#flowhubpush-check-token-result-content").find(".branch").html(e.data.branch),$("#flowhubpush-check-token-result-content").fadeIn(300)}).fail(e=>{RED.notify("Check failed: "+e.msg,{type:"error",id:"FlowHubTokenCheck",timeout:2e3})})})}var entityMap={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"},descMap={z:"Flow Tab Id",g:"Group Id",d:"Disabled"},setOldToNewForNode=(e,t,o)=>{e[t]=o,e.dirty=!0,RED.nodes.dirty(!0),RED.view.redraw()},defaultRevertHandler=(e,t,o)=>{e=RED.nodes.node(e)||RED.nodes.junction(e);e&&setOldToNewForNode(e,t,o)},revertableAttributes={},revertableAttributesNames=(["x","y","template","name","info","func","label","tooltip","timeout","repeat"].forEach(function(e){revertableAttributes[e]=defaultRevertHandler}),Object.keys(revertableAttributes));function attrDesc(e){return descMap[e]?" <i style='font-size: 80%;'>("+descMap[e]+")</i>":""}function clickBaitDiff(){$("th.revertable").on("click",e=>{e.preventDefault();var t,o=$($(e.target).parent()).data("attr");confirm('Really revert changes to attribute "'+o+'"?')&&(t=revertableAttributes[o])&&t($($(e.target).parent()).data("id"),o,JSON.parse(atob($($(e.target).parent()).data("oldval"))))})}function createDiff(r,s){var c=[],f=[];try{if(Object.keys(s).forEach(function(e){var t;Object.keys(r).indexOf(e)<0&&(t="object"==typeof s[e]?JSON.stringify(s[e]):s[e],c.push("<tr class='dv-removed'><th>"+e+attrDesc(e)+"</th><td><i>MISSING</i></td><td><code>"+escapeHtml(t)+"</code></td></tr>"),f.push(e))}),Object.keys(r).forEach(function(e){var t;Object.keys(s).indexOf(e)<0&&(t="object"==typeof r[e]?JSON.stringify(r[e]):r[e],c.push("<tr class='dv-added'><th>"+e+attrDesc(e)+"</th><td><code>"+escapeHtml(t)+"</code></td><td><i>ADDED</i></td></tr>"),f.push(e))}),Object.keys(r).forEach(function(i){if(-1<Object.keys(s).indexOf(i))if(JSON.stringify(r[i])!==JSON.stringify(s[i]))try{let o=null,t=void 0;f.push(i);try{t=Diff.diffLines(s[i],r[i])}catch(e){t=Diff.diffLines(JSON.stringify(s[i],void 0,1),JSON.stringify(r[i],void 0,1))}let n=document.createDocumentFragment();t.forEach(e=>{var t=e.added?"green":e.removed?"red":"#040506";(o=document.createElement("pre")).setAttribute("class","dv-pre-elem"),o.style.color=t,o.appendChild(document.createTextNode(e.value)),o.appendChild(document.createElement("br")),n.appendChild(o)});var a=-1<revertableAttributesNames.indexOf(i)?" revertable":"",e=document.createElement("tr");e.setAttribute("class","dv-differ"),e.setAttribute("data-id",r.id),e.setAttribute("data-attr",i);try{e.setAttribute("data-oldval",btoa(JSON.stringify(s[i])))}catch(e){a=""}var d,l=document.createElement("th");l.setAttribute("class",a),l.appendChild(document.createTextNode(i)),descMap[i]&&((d=document.createElement("i")).style["font-size"]="80%",d.appendChild(document.createTextNode("("+descMap[i]+")")),l.appendChild(d)),e.append(l),(l=document.createElement("td")).setAttribute("colspan","2"),l.append(n),e.append(l),c.push(e.outerHTML)}catch(e){console.log("--Exceeption",e),c.push("<tr><th class='dv-error'>"+i+" CAUSED EXCEP</th><td><code>"+escapeHtml(r[i])+"</code></td><td><code>"+escapeHtml(s[i])+"</code></td></tr>")}else c.push("<tr><th>"+i+"</th><td><code>"+escapeHtml(r[i])+"</code></td><td><code>"+escapeHtml(s[i])+"</code></td></tr>")}),0==f.length){let o=null;var e="OBJ",t=Diff.diffJson(s,r);let n=document.createDocumentFragment();t.forEach(e=>{var t=e.added?"green":e.removed?"red":"#040506";(o=document.createElement("pre")).setAttribute("class","dv-pre-elem"),o.style.color=t,o.appendChild(document.createTextNode(e.value)),o.appendChild(document.createElement("br")),n.appendChild(o)});var i,a=document.createElement("tr"),d=(a.setAttribute("class","dv-differ"),document.createElement("th"));return d.appendChild(document.createTextNode(e)),descMap[e]&&((i=document.createElement("i")).style["font-size"]="80%",i.appendChild(document.createTextNode("("+descMap[e]+")")),d.appendChild(i)),a.append(d),(d=document.createElement("td")).setAttribute("colspan","2"),d.append(n),a.append(d),{html:a.outerHTML,icon:"fa-question"}}}catch(e){console.log("Exception",e)}var o=["x","y","w","h","g"];return{html:c.join(""),icon:0==f.filter(e=>o.indexOf(e)<0).length?"fa-eye":"fa-pencil"}}function getInstalledNodeDetails(e){$.ajax({url:"nodes",headers:{Accept:"application/json"},success:e,error:()=>{e(["error"])}})}function doTokenCheck(e,t){$.ajax({url:"FlowHubTokenCheck",type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify({cfgnode:e}),success:function(e){t(e)},error:function(e,t,o){RED.notify("Check failed: "+t,{type:"error",id:"FlowHubTokenCheck",timeout:2e3})}})}function doPushSubmission(e,t,o,n){var i=RED.workspaces.active();let a=e.map(e=>e.type);n=n.filter(e=>-1<a.indexOf(e.types[0])),$.ajax({url:"FlowHubPush",type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify({flowid:i,flowdata:e||{},flowlabel:RED.nodes.workspace(i).label,cfgnode:t,svgdata:o,nodedetails:n}),success:function(e){RED.notify("Submission triggered",{type:"warning",id:"FlowHubPush",timeout:2e3}),obtainFhbToken(obtainConfigNode(),e=>{""!==e&&(e=e&&"?t="+tokenToUrl(e)),$("#flowhubpush-view-flow-link").attr("href","https://flowhub.org/f/"+i+e).show()})},error:function(e,t,o){RED.notify("Submission failed: "+t,{type:"error",id:"FlowHubPush",timeout:2e3}),console.log(t,o)}})}function getFlowDataFromCurrentWorkspace(e){var e=e||RED.workspaces.active(),t=RED.nodes.groups(e),e=(t=(t=t.concat(RED.nodes.junctions(e))).concat(RED.nodes.filterNodes({z:e})),RED.nodes.eachConfig(function(e){e.z===RED.workspaces.active()&&!1===e._def.hasUsers&&t.push(e)}),RED.nodes.workspace(e)||RED.nodes.subflow(e));return t.unshift(e),RED.nodes.createExportableNodeSet(t)}function iframeRemoveHighlight(){document.getElementById("flowhubdiff-svgimageiframe").contentWindow.postMessage({msg:"removehighlight"},"*")}function iframeHighlightItem(e){iframeRemoveHighlight(),document.getElementById("flowhubdiff-svgimageiframe").contentWindow.postMessage({item:{label:e.label,icon:e.icon,class:e.class,sublabel:e.sublabel,objid:e.objid},msg:"highlightitem"},"*")}function iframeHasBeenLoaded(e){let t=$(e).data("flowid");var o=getFlowDataFromCurrentWorkspace(t);setTimeout(()=>{e.contentWindow&&e.contentWindow.postMessage({nodes:o,msg:"renderlocalflow",flowid:t||RED.workspaces.active()},"*")},345)}function doComparison(e,t){var n=RED.workspaces.active();if(RED.nodes.workspace(n))RED.notify("Flow Comparison Triggered",{type:"warning",id:"FlowHubDiff",timeout:2e3}),$.ajax({url:"FlowHubDiff",type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify({flowid:n,flowhub:"submission from ",flowdata:e||{},flowlabel:RED.nodes.workspace(n).label,cfgnode:t}),success:function(t){var e,d=[],l={};if("failed"==t.status){RED.notify(t.msg||"This does not seem to be a FlowHub flow id: "+n,{type:"error",timeout:2e3}),$("#flowhubdiff-view-flow-link").hide();try{$("#node-input-flowhubdiff-diffcontainer").html(""),$("#node-input-flowhubdiff-svgcontainer").html(""),$("#node-input-flowhubdiff-target-container-div").treeList("empty")}catch(e){}}else if(t.revision&&""!=t.revision&&(e=ensureYourConfigNodeExists()).flowrevisions&&e.flowrevisions[t.flowid]&&e.flowrevisions[t.flowid].substr(0,8)!=t.revision.substr(0,8)&&RED.notify(`WARNING: Revision mismatch: Local: ${e.flowrevisions[t.flowid].substr(0,8)}, Remote: `+t.revision.substr(0,8),{type:"warning",timeout:4e3}),obtainFhbToken(obtainConfigNode(),e=>{(""!==e&&e?$("#flowhubdiff-view-flow-link").attr("href","https://flowhub.org/f/"+t.flowid+"?t="+tokenToUrl(e)):$("#flowhubdiff-view-flow-link").attr("href","https://flowhub.org/f/"+t.flowid)).show()}),t.changes.forEach(function(e){var t,o,n,i,a=e.id;"deleted"==e.type?(l[a]={label:e.oldObj.name||e.oldObj.type,icon:"fa fa-trash",class:"",diffcontent:createDiff({},e.oldObj).html,sublabel:e.oldObj.type,selected:!1,checkbox:!1,children:void 0,objid:a},d.push(l[a])):"added"==e.type?(l[a]={objid:a,label:e.newObj.name||e.newObj.type,icon:"fa fa-plus-square",class:"",diffcontent:createDiff(e.newObj,{}).html,sublabel:e.newObj.type,selected:!1,checkbox:!1,children:void 0},d.push(l[a])):"tab"==e.oldObj.type||"group"==e.oldObj.type||"junction"==e.oldObj.type?(i=createDiff(e.newObj,e.oldObj),l[a]={objid:a,label:e.oldObj.name||e.oldObj.type,icon:"fa "+i.icon,class:"",diffcontent:i.html,sublabel:e.type+" - "+e.oldObj.type,selected:!1,checkbox:!1,children:void 0},d.push(l[a])):(t=RED.nodes.node(a))?((o=RED.nodes.getType(t.type))&&(n=("function"==typeof(n=o.label)?n.call(t):n)||""),o&&n||(n=t.type),i=createDiff(e.newObj,e.oldObj),l[t.id]={node:t,objid:a,label:n,icon:"fa "+i.icon,class:"",diffcontent:i.html,sublabel:e.oldObj.type,selected:!1,checkbox:!1,children:void 0},d.push(l[t.id])):console.log("Node ignore, Type: "+e.type,e)}),t.ifurl&&$("#node-input-flowhubdiff-svgcontainer").html('<iframe id="flowhubdiff-svgimageiframe" width="100%" height="100%" src="'+t.ifurl+'" onload="window.iframeHasBeenLoaded(this)" style="border: none; min-height: 300px;" data-flowid="'+n+'"></iframe>'),0==d.length){RED.notify("No Flow Changes",{type:"warning",timeout:2e3});try{$("#node-input-flowhubdiff-diffcontainer").html(""),$("#node-input-flowhubdiff-target-container-div").treeList("empty")}catch(e){}}else{try{$("#node-input-flowhubdiff-target-container-div").treeList("empty")}catch(e){$("#node-input-flowhubdiff-target-container-div").css({width:"100%",height:"200px"}).treeList({multi:!1}).on("treelistitemmouseover",function(e,t){t.objid&&iframeHighlightItem(t)}).on("treelistitemmouseout",function(e,t){}).on("treelistselect",function(e,t){t.objid&&(RED.view.reveal(t.objid,!0),RED.view.redraw()),t.diffcontent?($("#node-input-flowhubdiff-diffcontainer").html(t.diffcontent),clickBaitDiff()):$("#node-input-flowhubdiff-diffcontainer").html("")}).on("treelistconfirm",function(e,t){var o;t.objid&&(o=t.objid,setTimeout(()=>{var e=RED.nodes.node(o);e&&(RED.view.reveal(e.id),RED.view.select(e.id),RED.editor.edit(e)),o==RED.workspaces.active()&&RED.workspaces.edit()},50))}),$("#node-input-flowhubdiff-target-filter").show();var o=$("#node-input-flowhubdiff-target-filter").searchBox({style:"compact",delay:300,change:function(){var e,t=$(this).val().trim().toLowerCase();""===t?($("#node-input-flowhubdiff-target-container-div").treeList("filter",null),o.searchBox("count","")):(e=$("#node-input-flowhubdiff-target-container-div").treeList("filter",function(e){return-1<e.label.toLowerCase().indexOf(t)||-1<e.node.type.toLowerCase().indexOf(t)}),o.searchBox("count",e+" / "+$("#node-input-flowhubdiff-target-container-div").treeList("data").length))}})}$("#node-input-flowhubdiff-target-container-div").treeList("data",d.sort((e,t)=>e.icon==t.icon?e.label.toLowerCase()>t.label.toLowerCase():e.icon>t.icon))}},error:function(e,t,o){$("#flowhubdiff-view-flow-link").hide();try{$("#node-input-flowhubdiff-diffcontainer").html(""),$("#node-input-flowhubdiff-svgcontainer").html(""),$("#node-input-flowhubdiff-target-container-div").treeList("empty")}catch(e){}404==e.status?RED.notify("Node has not yet been deployed, please deploy.","error"):405==e.status?RED.notify("Not Allowed.","error"):500==e.status?RED.notify("Not Allowed - 500.","error"):0==e.status?RED.notify("Not Allowed - 0.","error"):RED.notify("Not Allowed - Unexpected.","error")}});else{RED.notify("Comparing subflows not supported.",{type:"error",id:"FlowHubDiff",timeout:2e3}),$("#flowhubdiff-view-flow-link").hide();try{$("#node-input-flowhubdiff-diffcontainer").html(""),$("#node-input-flowhubdiff-svgcontainer").html(""),$("#node-input-flowhubdiff-target-container-div").treeList("empty")}catch(e){}}}function addTokenToList(e,t){$("#node-input-flowhubpush-token-list").append(`<tr class='${e}' data-type='${t.type}' data-name='${t.name}' data-token='${t.val}'>`+`<td><a class='flowhubpush-token-select-link' href='#'>${t.name}</a></td>`+"<td><a class='flowhubpush-token-select-link button' href='#'>Use</a></td><td><a class='flowhubpush-token-remove-link button' href='#'>Remove</a></td><td><a class='flowhubpush-token-hide-link button' href='#'>Hide</a></td><td><a class='flowhubpush-token-check-link button' href='#'>Check</a></td><td><a class='flowhubpush-token-copy-link button' href='#'>Copy</a></td></tr>")}function addEventHandlersToTokenList(n){$(".flowhubpush-token-copy-link").off("click"),$(".flowhubpush-token-copy-link").on("click",e=>{RED.clipboard.copyText($($(e.target).closest("tr")).data("token"))&&RED.notify("Token copied","success")}),$(".flowhubpush-token-check-link").off("click"),$(".flowhubpush-token-check-link").on("click",e=>{checkToken($($(e.target).closest("tr")).data("token"))}),$(".flowhubpush-token-hide-link").off("click"),$(".flowhubpush-token-hide-link").on("click",e=>{e&&e.preventDefault();let t=$($(e.target).closest("tr"));$($(e.target).closest("tr")).fadeOut(300,()=>{RED.notify("Hidden token <b>"+t.data("name")+"</b>, will reappear with reload","success")})}),$(".flowhubpush-token-remove-link").off("click"),$(".flowhubpush-token-remove-link").on("click",e=>{e&&e.preventDefault();let t=$($(e.target).closest("tr")),o=n;confirm(`Remove token "${t.data("name")}"?`)&&$($(e.target).closest("tr")).fadeOut(300,()=>{o.tokens=o.tokens.filter(e=>!(e.name==t.data("name")&&e.val==t.data("token")&&e.type==t.data("type"))),RED.nodes.dirty(!0),RED.notify("Removed token <b>"+t.data("name")+"</b>.","success")})}),$(".flowhubpush-token-select-link").off("click"),$(".flowhubpush-token-select-link").on("click",e=>{e&&e.preventDefault();e=$($(e.target).closest("tr"));$(".flowhub-token-selected").removeClass("flowhub-token-selected"),$("#node-input-flowhubpush-apiToken").typedInput("value",e.data("token")),$("#node-input-flowhubpush-apiToken").typedInput("type",e.data("type")),e.addClass("flowhub-token-selected"),RED.notify("Using token <b>"+e.data("name")+"</b>","success")})}window.iframeHasBeenLoaded=iframeHasBeenLoaded;

   function nr_intro_generate_svg_4_0(n){return t=>{try{handleSvgObject($($("#red-ui-workspace-chart").find("svg")[0]),t)}catch(e){var r="Error Generating SVG: "+JSON.stringify(e);n.notify(r,{type:"error"}),t('<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg width="1000" height="1000" viewBox="0 0 1000 1000" pointer-events="all" style="cursor: crosshair; touch-action: none;" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><style>.small { font: bold 20px sans-serif; fill: red;}</style><text x="10" y="30" class="small">'+r+"</text></svg>")}}}function nr_intro_generate_svg_3_1(n){return t=>{try{handleSvgObject($($("#red-ui-workspace-chart").find("svg")[0]),t)}catch(e){var r="Error Generating SVG: "+JSON.stringify(e);n.notify(r,{type:"error"}),t('<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg width="1000" height="1000" viewBox="0 0 1000 1000" pointer-events="all" style="cursor: crosshair; touch-action: none;" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><style>.small { font: bold 20px sans-serif; fill: red;}</style><text x="10" y="30" class="small">'+r+"</text></svg>")}}}function nr_intro_generate_svg_3_0(n){return t=>{try{handleSvgObject($($("svg")[0]),t)}catch(e){var r="Error Generating SVG: "+JSON.stringify(e);n.notify(r,{type:"error"}),t('<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg width="1000" height="1000" viewBox="0 0 1000 1000" pointer-events="all" style="cursor: crosshair; touch-action: none;" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><style>.small { font: bold 20px sans-serif; fill: red;}</style><text x="10" y="30" class="small">'+r+"</text></svg>")}}}function handleSvgObject(o,t){o.find("g.red-ui-flow-group-selected").removeClass("red-ui-flow-group-selected"),o.find("rect.red-ui-flow-group-outline-select").css("stroke-opacity","0"),o.find(".red-ui-flow-node-selected").removeClass("red-ui-flow-node-selected"),o.find(".red-ui-flow-link-selected").removeClass("red-ui-flow-link-selected");var e=o.clone(),r=(e.find("foreignObject").remove(),e.find("svg.__screenshot").remove(),'width="'+o.attr("width")+'" height="'+o.attr("height")+'"'),n=RED.settings.version.split("."),s=parseInt(n[0]),n=parseInt(n[1]);if(3==s&&1==n||4==s&&0==n){var i=$($($(o).children("g")[0]).children("g")[0]).children("g"),a={x:8e3,y:8e3,w:-1,h:-1};for(let e=1;e<i.length;e++){var l=i[e].getBBox();0==l.width&&0==l.height||(a.x=Math.min(l.x,a.x),a.y=Math.min(l.y,a.y),a.w=Math.max(l.width,a.w),a.h=Math.max(l.height,a.h))}r+=` viewBox='${a.x} ${a.y} ${a.w} ${a.h}'`}function g(e,t){for(var r=0;r<e.length;r++){var s=e.item(r),i=t[r];["stroke-width","fill-opacity","stroke-opacity","opacity","stroke-dasharray"].forEach(function(e){s.setAttribute(e,$(i).attr(e)||$(i).css(e))}),["fill","stroke"].forEach(function(e){var t,r,n=(t=$(i).attr(e)||$(i).css(e))&&null!==t&&"none"!=t?(r=t.match(/^#(.)(.)(.)$/))?"#"+r[1]+r[1]+r[2]+r[2]+r[3]+r[3]:(r=t.match(/^#......$/))?t:null===(r=t.match(/^rgb\(([0-9]+),\s+([0-9]+),\s+([0-9]+)/))?(n=t.match(/^rgba\(([0-9]+),\s+([0-9]+),\s+([0-9]+),\s+([0-9]+)/))?{clr:"#"+("0"+parseInt(n[1],10).toString(16)).slice(-2)+("0"+parseInt(n[2],10).toString(16)).slice(-2)+("0"+parseInt(n[3],10).toString(16)).slice(-2),opa:n[4]}:(console.log("Screenshot node: returned unknown color: "+t),t):"#"+("0"+parseInt(r[1],10).toString(16)).slice(-2)+("0"+parseInt(r[2],10).toString(16)).slice(-2)+("0"+parseInt(r[3],10).toString(16)).slice(-2):"none";"object"==typeof n?(s.setAttribute(e+"-opacity",n.opa),s.setAttribute(e,n.clr)):s.setAttribute(e,n)}),$(i).hasClass("hide")&&("g"==s.tagName&&s.setAttribute("opacity","0"),s.setAttribute("visibility","hidden"))}}var s='<?xml version="1.0" standalone="no"?>\r\n<svg '+r+' pointer-events="all" style="cursor: crosshair; touch-action: none;" xmlns="http://www.w3.org/2000/svg" class="__screenshot" xmlns:xlink="http://www.w3.org/1999/xlink">\r\n',n=e.html(),c=(new DOMParser).parseFromString(s+n+"\r\n</svg>","image/svg+xml"),h=t=>(["g","rect","line","path","circle","image","text"].forEach(e=>{$(t.getElementsByTagName(e)).each((e,t)=>{t.setAttribute("class",""),t.setAttribute("id","")})}),t),f=(["g","rect","line","path","circle","image"].forEach(function(e){g(c.getElementsByTagName(e),o.find(e))}),["text"].forEach(function(e){g(c.getElementsByTagName(e),o.find(e));for(var t=c.getElementsByTagName(e),r=o.find(e),n=0;n<t.length;n++){var s=t.item(n),i=r[n];["font-family","font-size","font-size-adjust","font-stretch","font-style","font-variant","font-weight","text-anchor","dominant-baseline"].forEach(function(e){s.setAttribute(e,$(i).attr(e)||$(i).css(e))})}}),c.getElementsByTagName("image")),v={},d=(r,n,s)=>{var i=r.getAttribute("xlink:href")||r.getAttribute("href");if(!i)return s(n-1);var o=i.substr(-4,4).toLowerCase(),a={".jpg":"jpeg",jpeg:"jpeg",".png":"png",".svg":"svg+xml"};if(v[i])return r.setAttribute("xlink:href","data:image/"+a[o]+";base64,"+v[i]),s(n-1);switch(o){case".jpg":case"jpeg":case".png":var l=new XMLHttpRequest;l.open("GET",i,!0),l.responseType="arraybuffer";l.onload=function(e){var t=l.response;t&&(t=(e=>{for(var t="",r=new Uint8Array(e),n=r.byteLength,s=0;s<n;s++)t+=String.fromCharCode(r[s]);return window.btoa(t)})(t),v[i]=t,r.setAttribute("xlink:href","data:image/"+a[o]+";base64,"+t)),s(n-1)},l.send(null);break;case".svg":$.get(i,function(e){var t=new XMLSerializer,t=btoa(t.serializeToString(e));v[i]=t,r.setAttribute("xlink:href","data:image/svg+xml;base64,"+t),s(n-1)})}},w=e=>{e<0?t((new XMLSerializer).serializeToString(h(c))):d(f.item(e),e,w)};0<f.length?d(f.item(f.length-1),f.length-1,w):t((new XMLSerializer).serializeToString(h(c)))}function svgGeneratorFunctionForVersion(e){var r,t=e.settings.version.split("."),n=t[0],t=t[1];if("3"==n){if("0"==t)return nr_intro_generate_svg_3_0(e);if("1"==t)return nr_intro_generate_svg_3_1(e)}return"4"==n&&"0"==t?nr_intro_generate_svg_4_0(e):(r=e,e=>{var t="Node-RED version ("+r.settings.version+") not supported";r.notify(t,{type:"error"}),e&&e('<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg width="1000" height="1000" viewBox="0 0 1000 1000" pointer-events="all" style="cursor: crosshair; touch-action: none;" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><style>.small { font: bold 20px sans-serif; fill: red;}</style><text x="10" y="30" class="small">'+t+"</text></svg>")})}
   
   function ensureYourConfigNodeExists() {
      // If we had found it previously, check if it has been deleted by the user behind our back
      if (globalYourConfigNode !== null) {
         var configNode = RED.nodes.node(globalYourConfigNode.id);
         if (configNode === null) { globalYourConfigNode = null; }
      }

      // If not found previously, let's go find it
      if (globalYourConfigNode === null) {
         var configNodes = [];
         RED.nodes.eachConfig(function(configNode) {
             if (configNode.type === 'FlowHubCfg') { 
                 configNodes.push(configNode); 
             }
         });

         // Make sure we only have 1 config node
         while (configNodes.length > 1) {
             var configNode = configNodes.pop();
             RED.nodes.remove(configNode.id);
             RED.nodes.dirty(true);
         }

         // When we found a config node, let's use that one
         if (configNodes.length === 1) { globalYourConfigNode = configNodes[0]; }
      }

      // When it doesn't exist yet, create it if required
      if (globalYourConfigNode === null) {

         let typ = RED.nodes.getType("FlowHubCfg");
         
         globalYourConfigNode = {
            id: RED.nodes.id(), // on the server side, this is called RED.util.generateId()
            _def: typ,
            type: "FlowHubCfg",
            hasUsers: false, 
            users: [],
            name: "FlowHubCfg",
            label: function() { return this.name || "FlowHubCfg"},
            /* default data */
            apiToken: typ.defaults.apiToken.value,
            apiTokenType: typ.defaults.apiTokenType.value,
            email: "",
            fullname: "",
            flowid: "",
            flowrevision: "",
            notab: false,
            pushcomment: "",
            pushnewflows: false,
            tokens: typ.defaults.tokens.value,
            flowrevisions: typ.defaults.flowrevisions.value,
            forcepush: false
         }

         // Add the new config node to the collection of Node-RED nodes
         RED.nodes.add(globalYourConfigNode);

         // Make sure the "Deploy" button becomes active
         RED.nodes.dirty(true);
      }    
      
      return globalYourConfigNode
   }

   function flowHubPullUpdateFlows(e=null,o=null){let t=t=>{if("failed"==t.status)return RED.notify(t.msg,{type:"error",id:"FlowHubPull",timeout:4e3});let i=[],r={},l=[];Object.keys(t.data).forEach(function(e){var o=t.data[e].name.match(/^(\[.+\])/);o?r[o[0]]?r[o[0]].push(t.data[e]):r[o[0]]=[t.data[e]]:l.push(t.data[e])}),Object.keys(r).sort((e,o)=>e<o?-1:1).forEach(e=>{var o=r[e].map(e=>({label:e.name,icon:"fa "+(RED.nodes.workspace(e.id)?"fa-check-circle-o":""),flowid:e.id,sublabel:e.id,selected:$("#node-input-flowhubpull-flowid").val()==e.id,checkbox:!1,children:void 0}));i.push({label:e,icon:"",flowid:"",sublabel:"",selected:!1,checkbox:!1,children:o.sort((e,o)=>e.label<o.label?-1:1)})}),l.sort((e,o)=>e.name<o.name?-1:1).forEach(e=>{i.push({label:e.name,icon:"fa "+(RED.nodes.workspace(e.id)?"fa-check-circle-o":""),flowid:e.id,sublabel:e.id,selected:$("#node-input-flowhubpull-flowid").val()==e.id,checkbox:!1,children:void 0})}),e&&e(i)};$.get({url:"https://api.flowhub.org/v1/flows?cb="+(new Date).getTime(),headers:{"X-FHB-TOKEN":o}}).done(e=>{t(e)}).fail(e=>{var i="";"rejected"==e.state()?$.ajax({url:"FlowHubCatalogue",type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify({token:o}),success:function(e){t(e)},error:function(e,o,t){i="<p>Failed to retrieve FlowHub catalogue, request blocked.</p><p>Request: <b>https://api.flowhub.org/v1/flows</b></p><p>AdBlocker or uBlock might have prevented request.</p><p>Please check browser console for more details.</p>",console.log("Error",o),RED.notify(i,{type:"error",id:"FlowHubPull",timeout:4e3})}}):(i="<p>Failed to retrieve FlowHub catalogue.</p><p>Check browser console for more details.</p>",console.warn("Error loading https://api.flowhub.org/v1/flows:",e),RED.notify(i,{type:"error",id:"FlowHubPull",timeout:4e3}))})}function obtainConfigNode(){let o=[];return RED.nodes.eachConfig(function(e){"FlowHubCfg"===e.type&&o.push(e)}),o[0]}function tokenToUrl(e){e=e.substring(4);var o="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-_".split("");let t=Object.fromEntries(o.map((e,o)=>[e,o])),i=Object.fromEntries(o.map((e,o)=>[o,e]));return e.replaceAll(/./gi,(e,o)=>i[(t[e]+o+1)%64])}function obtainFhbToken(e,i){$.ajax({url:"FlowHubToken",type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify({cfgnode:e}),success:function(e){i(e.token)},error:function(e,o,t){i("")}})}function doFlowImportForSidebar(i,e){RED.notify("Pull triggered",{type:"warning",timeout:3e3}),$.get({url:"https://api.flowhub.org/v3/flows/"+$("#node-input-flowhubpull-flowid").val().trim()+"?cb="+(new Date).getTime()+"&v="+$("#node-input-flowhubpull-flowrevision").val().trim(),headers:{"X-FHB-TOKEN":e,"User-Agent":"FlowHub.org Sidebar"}}).done((o,e)=>{try{if(!o||!o.flowdata||!Array.isArray(JSON.parse(o.flowdata)))return RED.notify("Access denied or revision not found.",{type:"error",timeout:3e3})}catch(e){return RED.notify("Access Denied, parse error.",{type:"error",timeout:3e3})}var t;RED.nodes.workspace(o.flowid)||((t=ensureYourConfigNodeExists()).flowrevisions||={},t.flowrevisions[o.flowid]!=o.revision&&(t.flowrevisions[o.flowid]=o.revision,RED.nodes.dirty(!0))),RED.clipboard.import(),setTimeout(()=>{var e=JSON.parse(o.flowdata);i&&(e=e.filter(function(e){return"tab"!=e.type})),$("#red-ui-clipboard-dialog-import-text").val(JSON.stringify(e)).trigger("paste")},300)}).fail(e=>{var o="<p>Failed to retrieve flow data from FlowHub, request blocked.</p><p>Request: https://api.flowhub.org/v3/flows/"+$("#node-input-flowhubpull-flowid").val().trim()+"</p><p>AdBlocker or uBlock might have prevented request.</p><p>Please check browser console for more details.</p>";RED.notify(o,{type:"error",id:"FlowHubPull",timeout:4e3})})}function doFlowImportForPullNode(e,o){RED.notify("Pull triggered",{type:"warning",timeout:3e3});$.get({url:"https://api.flowhub.org/v3/flows/"+$("#node-input-flowid").val().trim()+"?cb="+(new Date).getTime()+"&v="+$("#node-input-flowrevision").val().trim(),headers:{"X-FHB-TOKEN":o,"User-Agent":"FlowHub.org Pull Node"}}).done((o,e)=>{try{if(!o||!o.flowdata||!Array.isArray(JSON.parse(o.flowdata)))return RED.notify("Access denied or revision not found.",{type:"error",timeout:3e3})}catch(e){return RED.notify("Access Denied, parse error.",{type:"error",timeout:3e3})}var t;RED.nodes.workspace(o.flowid)||(t=(()=>{let o=void 0;return RED.nodes.eachConfig(function(e){"FlowHubCfg"===e.type&&(o=e)}),o})())&&(t.flowrevisions||={},t.flowrevisions[o.flowid]!=o.revision)&&(t.flowrevisions[o.flowid]=o.revision,RED.nodes.dirty(!0)),RED.clipboard.import(),setTimeout(()=>{var e=JSON.parse(o.flowdata);$("#red-ui-clipboard-dialog-import-text").val(JSON.stringify(e)).trigger("paste")},300)}).fail(e=>{var o="<p>Failed to retrieve flow data from FlowHub, request blocked.</p><p>Request: https://api.flowhub.org/v3/flows/"+$("#node-input-flowhubpull-flowid").val().trim()+"</p><p>AdBlocker or uBlock might have prevented request.</p><p>Please check browser console for more details.</p>";RED.notify(o,{type:"error",id:"FlowHubPull",timeout:4e3})})}function checkForDuplication(e){$.get({url:"https://api.flowhub.org/v1/flows/"+$("#node-input-flowhubpull-flowid").val()+"?cb="+(new Date).getTime()+"&v="+$("#node-input-flowhubpull-flowrevision").val(),headers:{"X-FHB-TOKEN":e}},function(e,o){let t=[];if(!Array.isArray(e))return RED.notify("Access denied or revision not found.","error");if(e.forEach((e,o)=>{"tab"==e.type?RED.nodes.workspace(e.id)&&t.push(e):"junction"==e.type?RED.nodes.junction(e.id)&&t.push(e):"group"==e.type?RED.nodes.group(e.id)&&t.push(e):"subflow"==e.type?RED.nodes.subflow(e.id)&&t.push(e):RED.nodes.node(e.id)&&t.push(e)}),0==t.length){RED.notify("Found no duplication.","success");try{$("#node-input-flowhubpull-sb-duplication-container-div").treeList("empty")}catch(e){}}else{RED.notify("Found "+t.length+" items of duplication","warning");try{$("#node-input-flowhubpull-sb-duplication-container-div").treeList("empty")}catch(e){$("#node-input-flowhubpull-sb-duplication-container-div").css({width:"100%",height:"calc(100%)"}).treeList({multi:!1}).on("treelistitemmouseover",function(e,o){}).on("treelistitemmouseout",function(e,o){}).on("treelistselect",function(e,o){o.node&&(RED.workspaces.show(o.node.z,!1,!1,!0),RED.view.reveal(o.node.id,!0),RED.view.redraw())}).on("treelistconfirm",function(e,o){var t;o.node&&(t=o.node.id,setTimeout(()=>{var e=RED.nodes.node(t);e&&(RED.view.reveal(e.id),RED.view.select(e.id),RED.editor.edit(e)),t==RED.workspaces.active()&&RED.workspaces.edit()},50))})}t=t.map(e=>({node:e,label:e.id,sublabel:e.type,selected:!1,checkbox:!1})),$("#node-input-flowhubpull-sb-duplication-container-div").treeList("data",t)}})}

   // Add your plugin as a new tabsheet in the right sidebar AFTER the flow editor is completely started
   var initialiseConfigNodeOnce = () => {
      RED.events.off('runtime-state', initialiseConfigNodeOnce);

      // The html content of the sidebar has been specified below as a data-template, from where it can be loaded:
      var content = $($('script[type="text/x-red"][data-template-name="FlowHubDiff"]').i18n().html());
    
      // Add a "Your sidebar" tabsheet to the right sidebar panel, in which this sidebar panel can be displayed
      // --> more details: https://nodered.org/docs/api/ui/sidebar/
      RED.sidebar.addTab({
         id: "FlowHubDiff",
         label: "FlowHub", // short name for the tab
         name: "FlowHub.org", // long name for the menu
         content: content,
         enableOnEdit: true,
         iconClass: "fa fa-window-minimize",
         visible: true
      });
      
      let cfgNode = ensureYourConfigNodeExists();

      /* for older config nodes, add new parameters */
      if ( cfgNode.forcepush == undefined) {
        cfgNode.forcepush = false
        RED.nodes.dirty(true)
      }
      if ( cfgNode.pushnewflows == undefined) {
        cfgNode.pushnewflows = false
        RED.nodes.dirty(true)
      }
      if ( cfgNode.tokens == undefined) {
        cfgNode.tokens = []
        RED.nodes.dirty(true)
      }
      if ( cfgNode.flowrevisions == undefined ) {
        cfgNode.flowrevisions = {}
        RED.nodes.dirty(true)
      }

      var tabs = RED.tabs.create({
            id: 'func-flowhub-tabs',
            onchange: function(tab) {
               $('#func-flowhub-tabs-content').children().hide();
               $('#' + tab.id).show();
            }
      });
      
      // Add first tab, pull
      tabs.addTab({
            id: 'func-flowhub-tab-pull',
            iconClass: 'fa fa-arrow-down',
            label: 'Pull'
      });

      // Add first tab, compare
      tabs.addTab({
            id: 'func-flowhub-tab-compare',
            iconClass: 'fa fa-clone',
            label: 'Compare'
      });
      
      // Add tab, push
      tabs.addTab({
            id: 'func-flowhub-tab-push',
            iconClass: 'fa fa-arrow-up',
            label: 'Push'
      });
      
      tabs.activateTab("func-flowhub-tab-pull");

      $('#node-input-flowhubdiff-compare-btn').on('click', (e) => {
         e.preventDefault();
         ensureYourConfigNodeExists();
         doComparison( getFlowDataFromCurrentWorkspace(), globalYourConfigNode)
      })

      $('#node-input-flowhubpush-push-btn').on('click', (e) => {
         if ( e ) { e.preventDefault(); }
         ensureYourConfigNodeExists();

         RED.notify("Preparing Submission", {
            type: "warning",
            id: "FlowHubPush",
            timeout: 2000
         });

         globalYourConfigNode.pushcomment = $('#node-input-flowhubpush-comment').val();

         svgGeneratorFunctionForVersion(RED)( (svgdata) => {
            getInstalledNodeDetails( (nodedetails) => {
               doPushSubmission(getFlowDataFromCurrentWorkspace(), globalYourConfigNode, svgdata, nodedetails)
            })
         });
      });

      if ( !globalYourConfigNode.tokens ) {
        globalYourConfigNode.tokens = []
        RED.nodes.dirty()
      }

      globalYourConfigNode.tokens.forEach( tk => {
        addTokenToList((tk.val == globalYourConfigNode.apiToken ? "flowhub-token-selected" : ""), tk)
      })
      addEventHandlersToTokenList(globalYourConfigNode)

      $("#node-input-flowhubpush-apiToken").typedInput({
          types:["env", "global", "cred"],
          typeField: "#node-input-flowhubpush-apiTokenType"
      });

      $("#node-input-flowhubpush-apiToken").typedInput( 'value', globalYourConfigNode.apiToken || globalYourConfigNode._def.defaults.apiToken.value );
      $("#node-input-flowhubpush-apiToken").typedInput( 'type', globalYourConfigNode.apiTokenType || globalYourConfigNode._def.defaults.apiTokenType.value);

      $("#node-input-flowhubpush-apiToken").on('change', () => {
         ensureYourConfigNodeExists();
         
         var val = $("#node-input-flowhubpush-apiToken").typedInput('value');
         var typ = $("#node-input-flowhubpush-apiToken").typedInput('type');

         if ( val != globalYourConfigNode.apiToken ) {
            globalYourConfigNode.apiToken = val;
            RED.nodes.dirty(true);
         }

         if ( typ != globalYourConfigNode.apiTokenType ) {
            globalYourConfigNode.apiTokenType = typ;
            RED.nodes.dirty(true);
         }
      })

      $('#node-input-flowhubpush-email').on('change', (e) => {
         if ( e ) { e.preventDefault(); }
         ensureYourConfigNodeExists();

         let val = $('#node-input-flowhubpush-email').val();
         if ( val != globalYourConfigNode.email ) { 
            globalYourConfigNode.email = val;
            RED.nodes.dirty(true);
         }
      })
      $('#node-input-flowhubpush-email').val(globalYourConfigNode.email)

      $('#node-input-flowhubpush-fullname').on('change', (e) => {
         if ( e ) { e.preventDefault(); }
         ensureYourConfigNodeExists();

         let val = $('#node-input-flowhubpush-fullname').val();
         if ( val != globalYourConfigNode.fullname ) { 
            globalYourConfigNode.fullname = val;
            RED.nodes.dirty(true);
         }
      })
      $('#node-input-flowhubpush-fullname').val(globalYourConfigNode.fullname)

      $('#node-input-flowhubpush-comment').on('change', (e) => {
         if ( e ) { e.preventDefault(); }
         ensureYourConfigNodeExists();

         let val = $('#node-input-flowhubpush-comment').val();
         if ( val != globalYourConfigNode.pushcomment ) { 
            globalYourConfigNode.pushcomment = val;
            RED.nodes.dirty(true);
         }
      })
      $('#node-input-flowhubpush-comment').val(globalYourConfigNode.pushcomment)

      RED.comms.subscribe('flowhub:submission-result', (event,data) => {
        RED.notify("Submission status: " + data.status, {
          type: data.statusType,
          id: "FlowHubPushResult",
          timeout: data.statusType == "error" ? 3000 : 2000
        });

        /* update an existing revision of a flow, this happens after the 
          flow was successfully submitted and updated */
        if ( data.flowid && data.flowrevision ) {
          let cfgNode = ensureYourConfigNodeExists();
          cfgNode.flowrevisions ||= {}

          if ( cfgNode.flowrevisions[data.flowid] != data.flowrevision ) {
            cfgNode.flowrevisions[data.flowid] = data.flowrevision
            cfgNode.pushcomment = ""
            $('#node-input-flowhubpush-comment').val(cfgNode.pushcomment)
            RED.nodes.dirty(true)
          }
        }
      });

      if ( globalYourConfigNode.notab ) {
         $('#flowhubpull-dialog-import-opt-sb-current').addClass('selected')
         $('#flowhubpull-dialog-import-opt-sb-new').removeClass('selected')
        } else {
         $('#flowhubpull-dialog-import-opt-sb-new').addClass('selected')
         $('#flowhubpull-dialog-import-opt-sb-current').removeClass('selected')
       }
       
       $('#flowhubpull-dialog-import-opt-sb-current').on('click', (e) => {
         e.preventDefault();

         ensureYourConfigNodeExists();
         globalYourConfigNode.notab = true
         RED.nodes.dirty(true);

         $('#flowhubpull-dialog-import-opt-sb-new').removeClass('selected')
         $('#flowhubpull-dialog-import-opt-sb-current').addClass('selected')
       })

       $('#flowhubpull-dialog-import-opt-sb-new').on('click', (e) => {
         e.preventDefault();

         ensureYourConfigNodeExists();
         globalYourConfigNode.notab = false;
         RED.nodes.dirty(true);

         $('#flowhubpull-dialog-import-opt-sb-current').removeClass('selected')
         $('#flowhubpull-dialog-import-opt-sb-new').addClass('selected')
       })

      var dirList = $("#node-input-flowhubpull-sb-target-container-div").css({
        width: "100%",
        height: "100%"
       }).treeList(
         {
           multi:false
         }
       ).on('treelistselect', function(event, item) {
         if ( item.flowid ) {
           $('#node-input-flowhubpull-flowid').val(item.flowid);

           ensureYourConfigNodeExists();
           globalYourConfigNode.flowid = item.flowid;
           RED.nodes.dirty(true);

           obtainFhbToken(globalYourConfigNode, (token) => {
              if ( token !== "" && token ) {
                token = "?t=" + tokenToUrl(token)
              }
              $('#flowhubpull-sb-view-flow-link').attr(
                'href', 'https://flowhub.org/f/' + item.flowid + token
              ).show();              
           })
           
           $('#node-input-flowhubpull-sb-import-flow-but').prop('disabled',false)
         }
       }).on('treelistconfirm', function(event, item) {
         if ( item.flowid ) {
           $('#node-input-flowhubpull-flowid').val(item.flowid);

           ensureYourConfigNodeExists();
           globalYourConfigNode.flowid = item.flowid;
           RED.nodes.dirty(true);

           obtainFhbToken(globalYourConfigNode, (token) => {
              if ( token !== "" && token ) {
                token = "?t=" + tokenToUrl(token)
              }

              $('#flowhubpull-sb-view-flow-link').attr(
                'href', 'https://flowhub.org/f/' + item.flowid + token
              ).show();
           })

           $('#node-input-flowhubpull-sb-import-flow-but').prop('disabled',false)
           $("#node-input-flowhubpull-sb-import-flow-but").trigger('click');
         }
       });

       if ( globalYourConfigNode.flowrevision != "" ) {
         $('#node-input-flowhubpull-flowrevision').val(globalYourConfigNode.flowrevision)
       }

       if ( globalYourConfigNode.flowid ) {
         $('#node-input-flowhubpull-flowid').val(globalYourConfigNode.flowid);

         obtainFhbToken(globalYourConfigNode, (token) => {
          if ( token !== "" && token ) {
            token = "?t=" + tokenToUrl(token)
          }
          $('#flowhubpull-sb-view-flow-link').attr(
              'href', 'https://flowhub.org/f/' + globalYourConfigNode.flowid + token
          ).show();
         })
       } else {
        $('#node-input-flowhubpull-sb-import-flow-but').prop('disabled',true)
       }

       obtainFhbToken(globalYourConfigNode, (token) => {
           flowHubPullUpdateFlows( (lst) => { dirList.treeList('data', lst) }, token);
       })

       var search = $("#node-input-flowhubpull-sb-target-filter").searchBox({
         style: "compact",
         delay: 300,
         change: function() {
           var val = $(this).val().trim().toLowerCase();
           if (val === "") {
             dirList.treeList("filter", null);
             search.searchBox("count","");
           } else {
             var count = dirList.treeList("filter", function(item) {
               return item.label.toLowerCase().indexOf(val) > -1 || item.sublabel.toLowerCase().indexOf(val) > -1
             });
             search.searchBox("count",count + " / " + dirList.treeList("data").length);
           }
         }
       });

       $('#node-input-flowhubpull-sb-refresh-list-but').on('click', function(e) {
        e.preventDefault();

        setTimeout( () => {
          ensureYourConfigNodeExists();

          obtainFhbToken(globalYourConfigNode, (token) => {
            flowHubPullUpdateFlows( (lst) => { 
              dirList.treeList('empty') 
              $('#flowhubpull-sb-view-flow-link').hide()
              setTimeout( () => {
                dirList.treeList('data', lst) 
              },300)
            }, token);
          })
        }, 300);
       });

      $('#node-input-flowhubpush-new-token-field').on('change', e => {
        checkToken($('#node-input-flowhubpush-new-token-field').val())
      })

      $('#node-input-flowhubpush-clear-token-btn').on('click', e => {
        if ( e ) { e.preventDefault() }      
        $('#node-input-flowhubpush-new-token-name-field').val("")
        $('#node-input-flowhubpush-new-token-field').val("")
        $('#node-input-flowhubpush-new-token-field').trigger('change')
      })
      
      $('#node-input-flowhubpush-add-token-btn').on('click', e => {
        if ( e ) { e.preventDefault() }

        ensureYourConfigNodeExists();

        if ( !globalYourConfigNode.tokens ) {
          globalYourConfigNode.tokens = []
        }

        let tk = {
          name: $('#node-input-flowhubpush-new-token-name-field').val(),
          type: "cred",
          val: $('#node-input-flowhubpush-new-token-field').val()
        }

        globalYourConfigNode.tokens.push(tk)
        RED.nodes.dirty(true);

        addTokenToList("",tk)
        addEventHandlersToTokenList(globalYourConfigNode)
      })

      $("#node-input-flowhubpull-sb-check-duplicates-flow-but").on("click", function(e) {
        if ( e ) { e.preventDefault(); }

        if ( $('#node-input-flowhubpull-flowid').val().trim() == "" ||
            !$('#node-input-flowhubpull-flowid').val() ) {
          return RED.notify(RED._("notification.warning", {
            message: "FlowID not provided, doing nothing."
          }), "warning");
        }

        RED.notify("Checking for flow duplication.", "success");

        ensureYourConfigNodeExists();

        obtainFhbToken(globalYourConfigNode, (token) => {
          checkForDuplication(token)
        })
      })

      $("#node-input-flowhubpull-sb-import-flow-but").on("click", function(e) {
        if ( e ) { e.preventDefault(); }

        if ( $('#node-input-flowhubpull-flowid').val().trim() == "" ||
            !$('#node-input-flowhubpull-flowid').val() ) {
          return RED.notify(RED._("notification.warning", {
            message: "FlowID not provided, doing nothing."
          }), "warning");
        }

        ensureYourConfigNodeExists();
        var notab = globalYourConfigNode.notab;

        obtainFhbToken(globalYourConfigNode, (token) => {
          doFlowImportForSidebar(notab, token)
        })
      });

      $('#node-input-flowhubpush-pushnewflows').prop('checked', globalYourConfigNode.pushnewflows)

      $('#node-input-flowhubpush-pushnewflows').on('change', () => {
        ensureYourConfigNodeExists();
        globalYourConfigNode.pushnewflows = $('#node-input-flowhubpush-pushnewflows').is(":checked")
        RED.nodes.dirty(true);
      })

      $('#node-input-flowhubpush-forcepush').prop('checked', globalYourConfigNode.forcepush)

      $('#node-input-flowhubpush-forcepush').on('change', () => {
        ensureYourConfigNodeExists();
        globalYourConfigNode.forcepush = $('#node-input-flowhubpush-forcepush').is(":checked")
        RED.nodes.dirty(true);
      })

      $('#node-input-flowhubpull-flowrevision').on('change', () => {
        ensureYourConfigNodeExists();
        let val = $('#node-input-flowhubpull-flowrevision').val();
        
        if (globalYourConfigNode.flowrevision != val ) {
          globalYourConfigNode.flowrevision = val
          RED.nodes.dirty(true);
        }
      })
   };
   
   RED.events.on('runtime-state', initialiseConfigNodeOnce);
})();
</script>

<style>
.diff-viewer{overflow:scroll;background-color:#f4f4f4;border:1px solid #c4c4c4;height:80vh;padding:20px;max-width:90vw;border-radius:5px}.dv-differ{background-color:rgba(244,170,23,.476)!important}.dv-removed{background-color:#cbcb26!important}.dv-added{background-color:#56de78!important}.dv-error{background-color:#ff4b09!important}.dv-pre-elem{page-break-inside:avoid;font-family:monospace;max-width:100%;overflow:auto;display:block;word-wrap:break-word;margin:0!important}.flowhublogo{background-image:url("icons/@gregoriusrippenstein/node-red-contrib-flowhub/flowhublogo.svg");background-size:cover;background-repeat:no-repeat;background-position-x:center;background-position-y:top}th.revertable:after{content:" ⟲";color:"green"}.red-ui-tray-content #dialog-form{white-space:nowrap}.full-row .red-ui-typedInput-container{min-width:70%}.col input{min-width:100%}.sml-lbl{height:66px}.sml-lbl label{font-size:smaller;margin-bottom:0;display:block!important}.reg-lbl label{white-space:nowrap;margin-top:5px;height:0}.red-ui-editor .form-row label.full-lbl{white-space:normal;width:100%}.col{float:left;margin-right:5px;min-height:36px}.col .red-ui-typedInput-container{width:100%!important}.col-50{width:50%}.col-33{width:33%}.col-66{width:66%}.col-25{width:25%}.col-75{width:75%}.col-100 .red-ui-typedInput-container{width:70%!important}.col-100.no-label .red-ui-typedInput-container{width:100%!important}.txtarea{padding-bottom:26px}.txtarea label{vertical-align:top;margin-top:3px}.txtarea textarea{width:70%;margin-bottom:-28px!important}.btn-regular{margin-bottom:14px!important}.flowhub-token-selected{background-color:rgba(12,208,208,.709)}
</style>

<!-- The html for the right sidebar plugin screen -->
<script type="text/x-red" data-template-name="FlowHubDiff">
<div class="form-row func-flowhub-tabs-row">
   <ul style="min-width: 600px; margin-bottom: 20px;" id="func-flowhub-tabs"></ul>
</div>

<!--func-flowhub-tabs-row-->
<div id="func-flowhub-tabs-content" style="min-height: calc(100% - 95px);">

   <!--func-flowhub-tab-compare#-->
   <div id="func-flowhub-tab-compare" style="display:none">
      <div class="form-row">
         <div class="col-100">

            <div class="form-row" style="margin-left: 10px; margin-top: 30px;">
               <button id="node-input-flowhubdiff-compare-btn"
                                             class="red-ui-button"><i class="fa fa-balance-scale"></i> Compare Changes</button>
               <a id="flowhubdiff-view-flow-link" style="color: blue; display: none; margin-left: 40px;" target="_blank"
                  href="">Webiliser <i class="fa fa-external-link"></i></a>
            </div>

            <div class="form-row node-input-target-row node-input-target-list-row"
               style="min-height: 100px; margin-left: 10px; margin-right: 15px;">
               <div style="margin-right: 15px; margin-bottom: 5px; width: 35%; padding-left: 60%;">
                  <input type="text" id="node-input-flowhubdiff-target-filter" style="display: none;">
               </div>

               <div id="node-input-flowhubdiff-target-container-div" style="min-height: 100px"></div>
            </div>

            <div class="form-row" style="min-height: 300px; margin-left: 10px; margin-right: 15px;">
               <div id="node-input-flowhubdiff-svgcontainer"></div>
            </div>

            <div class="form-row" style="min-height: 100px; margin-left: 10px; margin-right: 15px;">
               <div id="node-input-flowhubdiff-diffcontainer" class="diff-viewer"></div>
            </div>

         </div>
      </div>
      <!--form-row-->
   </div>

   <!--func-flowhub-tab-pull#-->
   <div id="func-flowhub-tab-pull" style="display:none" style="min-height: calc(100% - 95px);">
      <div class="form-row">
         <div class="col-100">

            <div class="form-row" style="margin-left: 10px; margin-top: 30px;">
               <button id="node-input-flowhubpull-sb-refresh-list-but"
                        class="red-ui-button"><i class="fa fa-refresh"></i> Refresh Flow List</button>

               <a id="flowhubpull-sb-view-flow-link" style="color: blue; display: none; margin-left: 40px;"
                  target="_blank" href="">Webiliser <i class="fa fa-external-link"></i></a>
            </div>

            <div class="form-row node-input-target-row node-input-target-list-row"
               style="position: relative; min-height: 100px; height: 500px; margin-left: 10px; margin-right: 15px;">
               <div style="position: absolute; top: -30px; right: 0px;">
                  <input type="text" id="node-input-flowhubpull-sb-target-filter" placeholder="Name or Flow Id">
               </div>

               <div id="node-input-flowhubpull-sb-target-container-div" style="min-height: 500px;"></div>
            </div>

            <div class="form-row" style="margin-left: 10px; margin-top: 30px;">
               <label>
                 <span>Flow ID:</span>
               </label>
              <input type="text"
               disabled="disabled"
               id="node-input-flowhubpull-flowid"
               style="display:inline-block; width:40%; vertical-align:baseline;"
               placeholder="Flow ID to Import">
            </div>

            <div class="form-row" style="margin-left: 10px;">
               <label>
                <span>Import to:</span>
              </label>

              <span>
                 <a id="flowhubpull-dialog-import-opt-sb-current" class="red-ui-button toggle" href="#" data-i18n="clipboard.export.current">current flow tab</a>
                 <a id="flowhubpull-dialog-import-opt-sb-new" class="red-ui-button toggle" href="#" data-i18n="clipboard.import.newFlow">new flow tab</a>
              </span>
            </div>

            <div class="form-row" style="margin-left: 10px;">
               <label for="node-input-flowhubpull-flowrevision">Revision:</label>
               <input type="text" id="node-input-flowhubpull-flowrevision" placeholder="Revision"/>
            </div>

            <div class="form-row" style="margin-left: 10px;">
               <button id="node-input-flowhubpull-sb-import-flow-but"
                                             class="red-ui-button">Import Flow</button>
               <button id="node-input-flowhubpull-sb-check-duplicates-flow-but"
                                             class="red-ui-button">Duplication?</button>
            </div>


            <div class="form-row node-input-target-row node-input-target-list-row"
               style="position: relative; min-height: 100px; height: 300px; margin-left: 10px; margin-right: 15px;">            
               <div id="node-input-flowhubpull-sb-duplication-container-div" style="min-height: 300px;"></div>
            </div>
         </div>
      </div>
   </div>

   <!--func-flowhub-tab-push#-->
   <div id="func-flowhub-tab-push" style="display:none">
      <div class="form-row">
         <div class="col-100">

            <div class="form-row" style="margin-top: 30px; margin-left: 10px;">
               <input type="checkbox" id="node-input-flowhubpush-pushnewflows"
                  style="display:inline-block; width:15px; vertical-align:baseline;">
               <label for="node-input-flowhubpush-pushnewflows" style="width: 230px;">
                  <span>Create new flows when pushing?</span>
               </label>
            </div>

            <div class="form-row" style="margin-left: 10px;">
               <input type="checkbox" id="node-input-flowhubpush-forcepush"
                              style="display:inline-block; width:15px; vertical-align:baseline;">
               <label for="node-input-flowhubpush-forcepush" style="width: 230px;">
                  <span>Overwrite more recent changes?</span>
               </label>
            </div>

            <div class="form-row" style="margin-left: 10px;">
               <button id="node-input-flowhubpush-push-btn"
                                    class="red-ui-button"><i class="fa fa-share-square-o"></i> Push to GitHub</button>
               <a id="flowhubpush-view-flow-link" style="color: blue; display: none; margin-left: 80px;" target="_blank"
                  href="">Webiliser <i class="fa fa-external-link"></i></a>
            </div>

            <div class="form-row" style="margin-left: 10px;">
               <hr/>
            </div>
            
            <div class="form-row" style="margin-left: 10px;">
               <label for="node-input-flowhubpush-comment">
                  <i class="fa fa-tag"></i> Comment
               </label>
               <textarea id="node-input-flowhubpush-comment" placeholder="comment"></textarea>
            </div>

            <div class="form-row" style="margin-left: 10px;">
               Comment will be added to each push. Leave blank for a push to be commentless.
            </div>

            <div class="form-row" style="margin-left: 10px;">
               <hr />
            </div>

            <div class="form-row" style="margin-left: 10px; margin-top: 20px;">
               <label for="node-input-flowhubpush-apiToken">
                                    <i class="fa fa-key"></i>
                                    Current Token
                                 </label>
               <input type="text" id="node-input-flowhubpush-apiToken">
               <input type="hidden" id="node-input-flowhubpush-apiTokenType">
            </div>


            <div class="form-row" style="margin-left: 10px;">
               Check out the instructions for generating your own <a style="color: blue;" target="_blank"
                  href="https://flowhub.org/integration">FlowHub.org token <i class='fa fa-external-link'></i></a>. You will then be
               able to commit your Node-RED flows directly to your own GitHub repository - public or private. You will also be able
               to view those flows at FlowHub.org using the "View Flow" links.
            </div>

            <div class="form-row" style="margin-top: 30px; margin-left: 10px;">
               <input id="node-input-flowhubpush-new-token-field" placeholder="New token fhb_XXXX">
            </div>

            <div class="form-row" style="margin-left: 10px; display:none;" id="flowhubpush-check-token-result-content">
               Repo: <a target=_blank href="#" class="repo"></a> @ <span class="branch"></span><br>
               Permission: <span class="permission"></span><br>
               User: <a target=_blank href="#" class="user"></a>, <span class="email"></span>
            </div>

            <div class="form-row" style="margin-left: 10px;">
               <input id="node-input-flowhubpush-new-token-name-field" placeholder="Token Name" style="width: 250px;">
               <button id="node-input-flowhubpush-add-token-btn"
                                    class="red-ui-button"><i class="fa fa-plus"></i> Add</button>
               <button id="node-input-flowhubpush-clear-token-btn"
                                    class="red-ui-button"><i class="fa fa-times"></i> Clear</button>
            </div>

            <div class="form-row" style="margin-left: 10px;">
               <table border=0 id="node-input-flowhubpush-token-list" style="margin-left: 10px;">
              </table>
            </div>

         </div>
      </div>
      <!--form-row-->
   </div>
   <!--func-flowhub-tab-tab#-->
</div>
<!--func-flowhub-tabs-content-->
</script>

<!-- --- [red-plugin:@gregoriusrippenstein/node-red-contrib-introspection/screenshot] --- -->
<script type="text/javascript">
(function() {
   var globalRefToSvgData;

   let obfuscateHelpers={getFlowDataFromCurrentWorkspace:e=>{var e=e||RED.workspaces.active(),t=RED.nodes.groups(e),e=(t=(t=t.concat(RED.nodes.junctions(e))).concat(RED.nodes.filterNodes({z:e})),RED.nodes.eachConfig(function(e){e.z===RED.workspaces.active()&&!1===e._def.hasUsers&&t.push(e)}),RED.nodes.workspace(e)||RED.nodes.subflow(e));return t.unshift(e),RED.nodes.createExportableNodeSet(t)},openImportDialog:e=>{RED.clipboard.import();let t=e;setTimeout(()=>{$("#red-ui-clipboard-dialog-import-text").val(JSON.stringify(t)).trigger("paste")},300)}};function obfuscatieCurrentFlow(l){let p=obfuscateHelpers.getFlowDataFromCurrentWorkspace(),f=(l.remove_groups&&(p=p.filter(e=>"group"!=e.type)).forEach(e=>{delete e.g}),{}),t={},d={},c={},s=[],h={},r={};if(p.forEach(e=>{"subflow"==(f[e.id]=e).type&&(r[e.id]=e),"junction"==e.type&&(t[e.id]=e),"link out"==e.type&&(c[e.id]=e),"link in"==e.type&&(d[e.id]=e),"link call"==e.type&&s.push(e.id),"catch"==e.type&&(h[e.id]=(e.wires||[])[0]||[])}),l.remove_junctions&&(Object.keys(t).forEach(n=>{let s=t[n];r[s.z]||p.forEach(t=>{for(let e=0;e<(t.wires||[]).length;e++){var r=t.wires[e].indexOf(n);-1<r&&(t.wires[e].splice(r,1),t.wires[e].push(...s.wires[0]))}})}),p=p.filter(e=>!("junction"==e.type&&!r[e.z]))),l.remove_linkout_nodes||l.remove_linkcall_nodes){let r=[],n=[],i=[],a=(l.remove_linkout_nodes&&!l.copy_linkin_nodes&&Object.keys(c).forEach(n=>{var e=c[n];let s=e.links||[];s.reduce((e,t)=>e&&(!!d[t]||l.ignore_off_flow_links),!0)&&"return"!=e.mode&&(r.push(n),p.forEach(r=>{for(let t=0;t<(r.wires||[]).length;t++){var e=r.wires[t].indexOf(n);-1<e&&(r.wires[t].splice(e,1),s.forEach(e=>{d[e]&&r.wires[t].push(...d[e].wires[0])}))}}))}),(s,e)=>{if(!e)return!1;let t=[],o=[],r=[];function u(e){if(r.indexOf(e.id)<0)switch(r.push(e.id),t.push(e),e.type){case"link out":if("return"!=e.mode)throw"not handable";break;case"link call":throw"unhandled";default:RED.nodes.getNodeLinks(e).forEach(function(e){u(e.target)})}}try{RED.nodes.getNodeLinks(e).forEach(function(e){u(e.target),o.push(e.target.id)});if(Object.keys(h).forEach(e=>{((t,e)=>{try{return e.map(e=>e.id).forEach(e=>{if(t.includes(e))throw"yes"}),!1}catch(e){return!0}})(h[e],t)&&t.push(f[e])}),0==t.length)return!1;let r={};var i=t[0];let n={x:s.x-i.x,y:s.y-i.y};var a=t.map(e=>{var t=structuredClone(f[e.id]);return t||console.log("WARNING: nodeid not found",[e.id,f[e.id]]),t.id=RED.nodes.id(),t.x+=n.x,t.y+=n.y,r[e.id]=t});return a.forEach(e=>{"catch"==e.type&&Array.isArray(e.scope)&&(e.scope=e.scope.map(e=>{var t=r[e];return t&&t.id||e})),e.wires&&(e.wires=e.wires.map(e=>e.map(e=>{var t=r[e];return t&&"link out"==t.type?[...s.wires[0],(t||{}).id||e]:(t||{}).id||e}).flat()))}),{nodes:a.filter(e=>"link out"!=e.type),entryNodes:o.map(e=>r[e])}}catch(e){return!1}});l.remove_linkout_nodes&&l.copy_linkin_nodes&&Object.keys(c).forEach(s=>{let o=c[s],u=o.links||[];if("return"!=o.mode){let t=u.map(e=>{var t=d[e],t=a(o,t);return t?[e,t]:[void 0,void 0]});t.reduce((e,t)=>e&&(!!t[0]||l.ignore_off_flow_links),!0)&&(r.push(s),p.forEach(n=>{for(let r=0;r<(n.wires||[]).length;r++){var e=n.wires[r].indexOf(s);-1<e&&(n.wires[r].splice(e,1),(t=u.map(e=>{var t=d[e],t=a(o,t);return t?[e,t]:[void 0,void 0]})).forEach(([,e])=>{var t;e&&(t=e.entryNodes.map(e=>e.id),n.wires[r].push(...t),i.push(...e.nodes))}))}}))}}),l.remove_linkcall_nodes&&s.forEach(s=>{var e=f[s],t=d[e.links[0]];let o=a(e,t);t&&o&&(n.push(e.id),p.forEach(t=>{for(let e=0;e<(t.wires||[]).length;e++){var r,n=t.wires[e].indexOf(s);-1<n&&(r=o.entryNodes.map(e=>e.id),t.wires[e].splice(n,1),t.wires[e].push(...r),i.push(...o.nodes))}}))}),(p=p.filter(e=>r.indexOf(e.id)<0&&n.indexOf(e.id)<0)).push(...i)}if((p=l.remove_debugs?p.filter(e=>"debug"!=e.type&&"comment"!=e.type):p).forEach(e=>{l.name&&(e.name=RED.nodes.id()),l.shrink_node&&(e.l=!1),l.info&&(e.info="",delete e.outputLabels,delete e.inputLabels),l.add_license&&(l.append_license?e.info=(e.info||"")+"\n---\n\n"+l.license_text:e.info=l.license_text),l.position&&(e.x=150,e.y=150),l.remove_icons&&delete e.icon}),l.replace_switch){let n=(t,r)=>{for(let e=0;e<r.rules.length;e++){var n=r.rules[e];if("nnull"==n.t)t.push("if ( _propValue != null ) {  _returnValue.push(msg) ; return node.send(_returnValue) } else { _returnValue.push(undefined) }");else if("null"==n.t)t.push("if ( _propValue == null ) {  _returnValue.push(msg) ; return node.send(_returnValue) } else { _returnValue.push(undefined) }");else if("eq"==n.t&&"str"==n.vt){s=n.v;s=btoa(encodeURIComponent(s).replace(/%([0-9A-F]{2})/g,function(e,t){return String.fromCharCode("0x"+t)}));t.push("if ( _propValue === Buffer.from('"+s+"', 'base64').toString('utf-8') ) {  _returnValue.push(msg) ; return node.send(_returnValue) } else { _returnValue.push(undefined) }")}else if("gt"==n.t&&"num"==n.vt)t.push("if ( _propValue > "+n.v+" ) {  _returnValue.push(msg) ; return node.send(_returnValue) } else { _returnValue.push(undefined) }");else if("eq"==n.t&&"num"==n.vt)t.push("if ( _propValue == "+n.v+" ) {  _returnValue.push(msg) ; return node.send(_returnValue) } else { _returnValue.push(undefined) }");else if("empty"==n.t)t.push('let p = _propValue ;  if (  (Array.isArray(p) && p.length == 0) || ((typeof p === "object") && p != null && Object.keys(p).length == 0) || ((typeof p === "string") && p.length == 0) ) { _returnValue.push(msg) ; return node.send(_returnValue) } else {  _returnValue.push(undefined) }');else if("nempty"==n.t)t.push('let p = _propValue ;  if (  (Array.isArray(p) && p.length > 0) || ((typeof p === "object") && p != null && Object.keys(p).length > 0) || ((typeof p === "string") && p.length > 0) ) { _returnValue.push(msg) ; return node.send(_returnValue) } else {  _returnValue.push(undefined) }');else{if("else"!=n.t)throw"unhandled";t.push("_returnValue.push(msg)","return node.send(_returnValue)")}}var s};p=p.map(t=>{if("switch"!=t.type)return t;var e={id:t.id,name:t.name,type:"function",x:t.x,y:t.y,func:"",outputs:t.outputs,timeout:"",noerr:0,initialize:"",finalize:"",libs:[{var:"process",module:"process"},{var:"jsonata",module:"jsonata"}],wires:t.wires};t.hasOwnProperty("z")&&(e.z=t.z),t.hasOwnProperty("l")&&(e.l=t.l);try{var r=[];if(t.checkAll)throw"unhandled";if("msg"==t.propertyType)r.push("((msg,node) => {","let _propValue = undefined","try { _propValue = RED.util.getMessageProperty(msg, '"+t.property+"') } catch (ex) {}","let _returnValue = []"),n(r,t),r.push("})(msg,node);");else{if("jsonata"!=t.propertyType)throw"unhandled";r.push("jsonata('"+t.property+"').evaluate(msg).then(_propValue => {","let _returnValue = []"),n(r,t),r.push("})")}return e.func=r.join("\n"),e}catch(e){return t}})}if(l.replace_change){let s=e=>btoa(encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,function(e,t){return String.fromCharCode("0x"+t)}));p=p.map(t=>{if("change"!=t.type)return t;var e={id:t.id,name:t.name,type:"function",x:t.x,y:t.y,func:"",outputs:1,timeout:"",noerr:0,initialize:"",finalize:"",libs:[{var:"process",module:"process"},{var:"jsonata",module:"jsonata"}],wires:t.wires};t.hasOwnProperty("z")&&(e.z=t.z),t.hasOwnProperty("l")&&(e.l=t.l);try{var r=["(async (msg,node) => {","let __s = RED.util.setMessageProperty","let __g = RED.util.getMessageProperty"];for(let e=0;e<t.rules.length;e++){var n=t.rules[e];if("set"==n.t){if(n.dc)throw"unhandled";if("msg"==n.pt&&"str"==n.tot)r.push("__s(msg,'"+n.p+"', Buffer.from('"+s(n.to)+"', 'base64').toString('utf-8') )");else if("msg"==n.pt&&"bool"==n.tot)r.push("__s(msg,'"+n.p+"', "+n.to+")");else if("msg"==n.pt&&"num"==n.tot)r.push("__s(msg,'"+n.p+"', Number(Buffer.from('"+s(n.to)+"', 'base64').toString('utf-8')))");else if("msg"==n.pt&&"json"==n.tot)r.push("__s(msg,'"+n.p+"', JSON.parse(Buffer.from('"+s(n.to)+"', 'base64').toString('utf-8')))");else if("msg"==n.pt&&"msg"==n.tot)r.push("try { __s(msg,'"+n.p+"',  __g(msg, '"+n.to+"')) } catch (ex) {}");else if("msg"==n.pt&&"env"==n.tot)r.push("__s(msg,'"+n.p+"',  process.env['"+n.to+"'])");else{if("msg"!=n.pt||"jsonata"!=n.tot||!n.to.startsWith("/* @obfuscate-safe */"))throw"unhandlable";r.push("__s(msg,'"+n.p+"',  await jsonata(Buffer.from('"+s(n.to)+"', 'base64').toString('utf-8')).evaluate(msg) )")}}else{if("delete"!=n.t||"msg"!=n.pt)throw"unhandlable";r.push("delete msg."+n.p)}}return r.push("node.send(msg) })(msg,node);"),e.func=r.join("\n"),e}catch(e){return console.log(e),t}})}if(l.javascript){let r={},t=[];p.forEach(e=>{"javascript"!=(r[e.id]=e).format&&"function"!=e.type&&"css"!=e.format&&"json"!=e.format||t.push(e)});var e={parse:{bare_returns:!0,expression:!1},compress:{},mangle:{reserved:["$","export","require"]},output:null,sourceMap:null,nameCache:null,toplevel:!1,warnings:!1},o={compatibility:"*",level:2};$.ajax({url:"ClientCode/"+RED.nodes.id()+"/ugify",type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify({nodes:t,jscfg:e,csscfg:o}),success:function(e){e.forEach(e=>{var t=r[e.id];e._error&&console.log("ERROR NODE",e),"function"==t.type?t.func=e.func:"javascript"!=t.format&&"css"!=t.format&&"json"!=t.format||(t.template=e.template)}),obfuscateHelpers.openImportDialog(p)},error:function(e,t,r){RED.notify("ClientCode Communcation Failure: "+n.id+": "+t,{type:"error",timeout:3e3})}})}else obfuscateHelpers.openImportDialog(p)}
   
   function setupTreelist(){var e=collectOrphans();if(0==e.length){RED.notify("No Orphans Found",{type:"success",timeout:2e3});try{$("#node-input-orphan-target-container-div").treeList("empty")}catch(e){}}else{try{$("#node-input-orphan-target-container-div").treeList("empty")}catch(e){$("#node-input-orphan-target-container-div").css({width:"100%",height:"calc(100%)"}).treeList({multi:!1}).on("treelistitemmouseover",function(e,t){}).on("treelistitemmouseout",function(e,t){}).on("treelistselect",function(e,t){t.node&&(RED.workspaces.show(t.node.z,!1,!1,!0),RED.view.reveal(t.node.id,!0),RED.view.redraw())}).on("treelistconfirm",function(e,t){var n;t.node&&(n=t.node.id,setTimeout(()=>{var e=RED.nodes.node(n);e&&(RED.view.reveal(e.id),RED.view.select(e.id),RED.editor.edit(e)),n==RED.workspaces.active()&&RED.workspaces.edit()},50))}),$("#node-input-orphan-target-filter").show();var n=$("#node-input-orphan-target-filter").searchBox({style:"compact",delay:300,change:function(){var e,t=$(this).val().trim().toLowerCase();""===t?($("#node-input-orphan-target-container-div").treeList("filter",null),n.searchBox("count","")):(e=$("#node-input-orphan-target-container-div").treeList("filter",function(e){return-1<e.label.toLowerCase().indexOf(t)||-1<e.node.type.toLowerCase().indexOf(t)}),n.searchBox("count",e+" / "+$("#node-input-orphan-target-container-div").treeList("data").length))}})}$("#node-input-orphan-target-container-div").treeList("data",e.sort((e,t)=>e.node.z>t.node.z))}}function collectOrphans(){let t=new Set;var n=[],i=(RED.nodes.eachLink(e=>{t.add(e.source),t.add(e.target)}),RED.nodes.eachNode(e=>{(!t.has(e)||"link out"==e.type&&"link"==e.mode&&0==e.links.reduce((e,t)=>e||!!RED.nodes.node(t),!1))&&n.push(e)}),[]),r={};return n.forEach(function(e){var t=RED.nodes.getType(e.type);if(t){var n=t.label,n=("function"==typeof n?n.call(e):n)||"",o=e.type;if(0===o.indexOf("subflow:"))return}t&&n||(n=e.type),r[e.id]={node:e,label:n,sublabel:o,selected:!1,checkbox:!1},i.push(r[e.id])}),i}
   
   function nr_intro_generate_svg_4_0(r,t){return e=>{try{handleSvgObject($($("#red-ui-workspace-chart").find("svg")[0]),e,t)}catch(t){var n="Error Generating SVG: "+JSON.stringify(t);r.notify(n,{type:"error"}),e('<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg width="1000" height="1000" viewBox="0 0 1000 1000" pointer-events="all" style="cursor: crosshair; touch-action: none;" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><style>.small { font: bold 20px sans-serif; fill: red;}</style><text x="10" y="30" class="small">'+n+"</text></svg>")}}}function nr_intro_generate_svg_3_1(r,t){return e=>{try{handleSvgObject($($("#red-ui-workspace-chart").find("svg")[0]),e,t)}catch(t){var n="Error Generating SVG: "+JSON.stringify(t);r.notify(n,{type:"error"}),e('<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg width="1000" height="1000" viewBox="0 0 1000 1000" pointer-events="all" style="cursor: crosshair; touch-action: none;" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><style>.small { font: bold 20px sans-serif; fill: red;}</style><text x="10" y="30" class="small">'+n+"</text></svg>")}}}function nr_intro_generate_svg_3_0(r,t){return e=>{try{handleSvgObject($($("svg")[0]),e,t)}catch(t){var n="Error Generating SVG: "+JSON.stringify(t);r.notify(n,{type:"error"}),e('<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg width="1000" height="1000" viewBox="0 0 1000 1000" pointer-events="all" style="cursor: crosshair; touch-action: none;" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><style>.small { font: bold 20px sans-serif; fill: red;}</style><text x="10" y="30" class="small">'+n+"</text></svg>")}}}function handleSvgObject(a,e,t){var n=a.clone(),r=(n.find("foreignObject").remove(),n.find("svg.__screenshot").remove(),'width="'+a.attr("width")+'" height="'+a.attr("height")+'"'),s=RED.settings.version.split("."),i=parseInt(s[0]),s=parseInt(s[1]);if(3<=i&&1<=s){var o=$($($(a).children("g")[0]).children("g")[0]).children("g"),l={x:8e3,y:8e3,w:-1,h:-1};for(let t=1;t<o.length;t++){var g=o[t].getBBox();0==g.width&&0==g.height||(l.x=Math.min(g.x,l.x),l.y=Math.min(g.y,l.y),l.w=Math.max(g.width,l.w),l.h=Math.max(g.height,l.h))}r+=` viewBox='${l.x} ${l.y} ${l.w} ${l.h}'`}function c(t,e){for(var n=0;n<t.length;n++){var s=t.item(n),i=e[n];["stroke-width","fill-opacity","stroke-opacity","opacity","stroke-dasharray"].forEach(function(t){s.setAttribute(t,$(i).attr(t)||$(i).css(t))}),["fill","stroke"].forEach(function(t){var e,n,r=(e=$(i).attr(t)||$(i).css(t))&&null!==e&&"none"!=e?(n=e.match(/^#(.)(.)(.)$/))?"#"+n[1]+n[1]+n[2]+n[2]+n[3]+n[3]:(n=e.match(/^#......$/))?e:null===(n=e.match(/^rgb\(([0-9]+),\s+([0-9]+),\s+([0-9]+)/))?(r=e.match(/^rgba\(([0-9]+),\s+([0-9]+),\s+([0-9]+),\s+([0-9]+)/))?{clr:"#"+("0"+parseInt(r[1],10).toString(16)).slice(-2)+("0"+parseInt(r[2],10).toString(16)).slice(-2)+("0"+parseInt(r[3],10).toString(16)).slice(-2),opa:r[4]}:(console.log("Screenshot node: returned unknown color: "+e),e):"#"+("0"+parseInt(n[1],10).toString(16)).slice(-2)+("0"+parseInt(n[2],10).toString(16)).slice(-2)+("0"+parseInt(n[3],10).toString(16)).slice(-2):"none";"object"==typeof r?(s.setAttribute(t+"-opacity",r.opa),s.setAttribute(t,r.clr)):s.setAttribute(t,r)}),$(i).hasClass("hide")&&("g"==s.tagName&&s.setAttribute("opacity","0"),s.setAttribute("visibility","hidden"))}}var i='<?xml version="1.0" standalone="no"?>\r\n<svg '+r+' pointer-events="all" style="cursor: crosshair; touch-action: none;" xmlns="http://www.w3.org/2000/svg" class="__screenshot" xmlns:xlink="http://www.w3.org/1999/xlink">\r\n',s=n.html(),h=(new DOMParser).parseFromString(i+s+"\r\n</svg>","image/svg+xml"),v=t=>t,f=(t.rmidsandclasses&&(v=e=>(["g","rect","line","path","circle","image","text"].forEach(t=>{$(e.getElementsByTagName(t)).each((t,e)=>{e.setAttribute("class",""),e.setAttribute("id","")})}),e)),["g","rect","line","path","circle","image"].forEach(function(t){c(h.getElementsByTagName(t),a.find(t))}),["text"].forEach(function(t){c(h.getElementsByTagName(t),a.find(t));for(var e=h.getElementsByTagName(t),n=a.find(t),r=0;r<e.length;r++){var s=e.item(r),i=n[r];["font-family","font-size","font-size-adjust","font-stretch","font-style","font-variant","font-weight","text-anchor","dominant-baseline"].forEach(function(t){s.setAttribute(t,$(i).attr(t)||$(i).css(t))})}}),h.getElementsByTagName("image")),w={},m=(n,r,s)=>{var i=n.getAttribute("xlink:href")||n.getAttribute("href"),a=i.substr(-4,4).toLowerCase(),o={".jpg":"jpeg",jpeg:"jpeg",".png":"png",".svg":"svg+xml"};if(w[i])return n.setAttribute("xlink:href","data:image/"+o[a]+";base64,"+w[i]),s(r-1);switch(a){case".jpg":case"jpeg":case".png":var l=new XMLHttpRequest;l.open("GET",i,!0),l.responseType="arraybuffer";l.onload=function(t){var e=l.response;e&&(e=(t=>{for(var e="",n=new Uint8Array(t),r=n.byteLength,s=0;s<r;s++)e+=String.fromCharCode(n[s]);return window.btoa(e)})(e),w[i]=e,n.setAttribute("xlink:href","data:image/"+o[a]+";base64,"+e)),s(r-1)},l.send(null);break;case".svg":$.get(i,function(t){var e=new XMLSerializer,e=btoa(e.serializeToString(t));w[i]=e,n.setAttribute("xlink:href","data:image/svg+xml;base64,"+e),s(r-1)})}},d=t=>{t<0?e((new XMLSerializer).serializeToString(v(h))):m(f.item(t),t,d)};0<f.length?m(f.item(f.length-1),f.length-1,d):e((new XMLSerializer).serializeToString(v(h)))}function generatorFunctionForVersion(t,e){var n,r=t.settings.version.split("."),s=r[0],r=r[1];if("3"==s){if("0"==r)return nr_intro_generate_svg_3_0(t,e);if("1"==r)return nr_intro_generate_svg_3_1(t,e)}return"4"==s&&"0"==r?nr_intro_generate_svg_4_0(t,e):(n=t,t=>{var e="Node-RED version ("+n.settings.version+") not supported";n.notify(e,{type:"error"}),t&&t('<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg width="1000" height="1000" viewBox="0 0 1000 1000" pointer-events="all" style="cursor: crosshair; touch-action: none;" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><style>.small { font: bold 20px sans-serif; fill: red;}</style><text x="10" y="30" class="small">'+e+"</text></svg>")})}function addPanZoom(){var t=d3.select("#node-input-screenshot-svgcontainer svg"),e=(t.html("<g>"+t.html()+"</g>"),setTimeout(()=>{var t=$("#node-input-screenshot-svgcontainer svg"),e=$(t).attr("viewBox").split(" ");t.animate({height:parseInt(e[3]),width:parseInt(e[2])},800,"swing")},100),t.select("g")),n=d3.behavior.zoom().scaleExtent([.1,200]).on("zoom",function(t){e.attr({transform:"translate("+n.translate()+") scale("+n.scale()+")"})});t.call(n)}

   function setupTreelistInfoness(){var e=collectUndocumentedNodes();if(0==e.length){RED.notify("All nodes documented",{type:"success",timeout:2e3});try{$("#node-input-orphan-target-container-div").treeList("empty")}catch(e){}}else{try{$("#node-input-orphan-target-container-div").treeList("empty")}catch(e){$("#node-input-orphan-target-container-div").css({width:"100%",height:"calc(100%)"}).treeList({multi:!1}).on("treelistitemmouseover",function(e,t){}).on("treelistitemmouseout",function(e,t){}).on("treelistselect",function(e,t){t.node&&(RED.workspaces.show(t.node.z,!1,!1,!0),RED.view.reveal(t.node.id,!0),RED.view.redraw())}).on("treelistconfirm",function(e,t){var i;t.node&&(i=t.node.id,setTimeout(()=>{var e=RED.nodes.node(i);e&&(RED.view.reveal(e.id),RED.view.select(e.id),RED.editor.edit(e,"editor-tab-description")),i==RED.workspaces.active()&&RED.workspaces.edit()},50))}),$("#node-input-orphan-target-filter").show();var i=$("#node-input-orphan-target-filter").searchBox({style:"compact",delay:300,change:function(){var e,t=$(this).val().trim().toLowerCase();""===t?($("#node-input-orphan-target-container-div").treeList("filter",null),i.searchBox("count","")):(e=$("#node-input-orphan-target-container-div").treeList("filter",function(e){return-1<e.label.toLowerCase().indexOf(t)||-1<e.node.type.toLowerCase().indexOf(t)}),i.searchBox("count",e+" / "+$("#node-input-orphan-target-container-div").treeList("data").length))}})}$("#node-input-orphan-target-container-div").treeList("data",e.sort((e,t)=>e.node.z>t.node.z))}}function collectUndocumentedNodes(){let t=[];RED.nodes.eachNode(e=>{if($("#"+e.id).find(".red-ui-info-available-indicator").remove(),e.info&&e.info.trim()){var i=document.createElementNS("http://www.w3.org/2000/svg","g"),n=(i.setAttribute("class","red-ui-info-available-indicator"),document.createElementNS("http://www.w3.org/2000/svg","circle"));n.setAttribute("cx","5"),n.setAttribute("cy","5"),n.setAttribute("r","5"),n.setAttribute("fill","yellow"),n.setAttribute("id","infoclk-"+e.id),n.setAttribute("style","cursor: pointer;"),i.append(n),$(i).insertBefore($("#"+e.id).find(".red-ui-flow-node-changed"));let t=e.id;$("#infoclk-"+e.id).on("click",e=>{e&&e.preventDefault();e=RED.nodes.node(t);RED.editor.edit(e,"editor-tab-description"),RED.sidebar.show("info")})}else e.z==RED.workspaces.active()&&t.push(e)});var o=[],r={};return t.forEach(function(e){var t=RED.nodes.getType(e.type);if(t){var i,n=t.label,n=("function"==typeof n?n.call(e):n)||"";if(0===(i=e.type).indexOf("subflow:"))return}t&&n||(n=e.type),r[e.id]={node:e,label:n,sublabel:i,selected:!1,checkbox:!1},o.push(r[e.id])}),o}

   function highlightAllLinkCalls(){let e=[];RED.nodes.eachNode(t=>{t.z==RED.workspaces.active()&&"link call"==t.type&&e.push(t)}),e.forEach(t=>{$("#grplnkcallclk-"+t.id).remove();var e=document.createElementNS("http://www.w3.org/2000/svg","g"),l=(e.setAttribute("class","red-ui-linkcall-link-indicator"),e.setAttribute("transform","translate(12,0)"),e.setAttribute("id","grplnkcallclk-"+t.id),document.createElementNS("http://www.w3.org/2000/svg","circle")),i=(l.setAttribute("cx","5"),l.setAttribute("cy","5"),l.setAttribute("r","5"),l.setAttribute("id","lnkcallclk-"+t.id),l.setAttribute("style","cursor: pointer;"),t.links[0]);i?RED.nodes.node(i)?l.setAttribute("fill","green"):l.setAttribute("fill","red"):l.setAttribute("fill","orange"),e.append(l),$(e).insertBefore($("#"+t.id).find(".red-ui-flow-node-changed"));let r=t.id;$("#lnkcallclk-"+t.id).on("click",t=>{t&&t.preventDefault();t=RED.nodes.node(r);if(t){let l=t.links[0];1<t.links.length&&RED.notify("Multiple links, showing first","warning"),RED.nodes.node(l)?(RED.view.reveal(l),RED.view.select(l),setTimeout(()=>{$("#lnkcallclk-"+l).remove();var t=document.createElementNS("http://www.w3.org/2000/svg","g"),e=(t.setAttribute("class","red-ui-linkcall-link-indicator"),t.setAttribute("transform","translate(12,0)"),t.setAttribute("id","lnkcallclk-"+l),document.createElementNS("http://www.w3.org/2000/svg","circle"));e.setAttribute("cx","5"),e.setAttribute("cy","5"),e.setAttribute("r","5"),e.setAttribute("id","lnkcallclk-"+l),e.setAttribute("style","cursor: pointer;"),e.setAttribute("fill","green"),t.append(e),$(t).insertBefore($("#"+l).find(".red-ui-flow-node-changed")),$("#lnkcallclk-"+l).on("click",t=>{t&&t.preventDefault(),RED.view.reveal(r),RED.view.select(r),setTimeout(highlightAllLinkCalls,500)})},500)):RED.notify("Link in node not found","error")}else RED.notify("Node not found","error")})})}

   function setupTreelistAllLinksForLinkIn(e){e=collectAllLinksNodes(e);if(0==e.length){RED.notify("No links found",{type:"error",timeout:2e3});try{$("#node-input-orphan-target-container-div").treeList("empty")}catch(e){}}else{try{$("#node-input-orphan-target-container-div").treeList("empty")}catch(e){$("#node-input-orphan-target-container-div").css({width:"100%",height:"calc(100%)"}).treeList({multi:!1}).on("treelistitemmouseover",function(e,t){}).on("treelistitemmouseout",function(e,t){}).on("treelistselect",function(e,t){t.node&&(RED.workspaces.show(t.node.z,!1,!1,!0),RED.view.reveal(t.node.id,!0),RED.view.redraw())}).on("treelistconfirm",function(e,t){var n;t.node&&(n=t.node.id,setTimeout(()=>{var e=RED.nodes.node(n);e&&(RED.view.reveal(e.id),RED.view.select(e.id),RED.editor.edit(e,"editor-tab-description")),n==RED.workspaces.active()&&RED.workspaces.edit()},50))}),$("#node-input-orphan-target-filter").show();var n=$("#node-input-orphan-target-filter").searchBox({style:"compact",delay:300,change:function(){var e,t=$(this).val().trim().toLowerCase();""===t?($("#node-input-orphan-target-container-div").treeList("filter",null),n.searchBox("count","")):(e=$("#node-input-orphan-target-container-div").treeList("filter",function(e){return-1<e.label.toLowerCase().indexOf(t)||-1<e.node.type.toLowerCase().indexOf(t)}),n.searchBox("count",e+" / "+$("#node-input-orphan-target-container-div").treeList("data").length))}})}$("#node-input-orphan-target-container-div").treeList("data",e.sort((e,t)=>e.node.z>t.node.z))}}function collectAllLinksNodes(t){let n=[];RED.nodes.eachNode(e=>{"link call"!=e.type&&"link out"!=e.type||-1<e.links.indexOf(t)&&n.push(e)});var i=[],r={};return n.forEach(function(e){var t=RED.nodes.getType(e.type);if(t){var n,o=t.label,o=("function"==typeof o?o.call(e):o)||"";if(0===(n=e.type).indexOf("subflow:"))return}t&&o||(o=e.type),r[e.id]={node:e,label:o,sublabel:n,selected:!1,checkbox:!1},i.push(r[e.id])}),i}function collectNodeStats(){let t={},n=[],o={workspaces:0,junctions:0,subflows:0,configs:0,groups:0,wires:0,nodes:0},i=(RED.nodes.eachConfig(e=>{o.configs+=1}),RED.nodes.eachLink(e=>{o.wires+=1}),RED.nodes.eachJunction(e=>{o.junctions+=1}),RED.nodes.eachGroup(e=>{o.groups+=1}),RED.nodes.eachWorkspace(e=>{o.workspaces+=1}),RED.nodes.eachSubflow(e=>{o.subflows+=1}),RED.nodes.eachNode(e=>{o.nodes+=1,t[e.type]=(t[e.type]||0)+1}),Object.keys(t).forEach(e=>{n.push({label:e,sublabel:t[e],selected:!1,checkbox:!1})}),[]),r=0;return Object.keys(o).forEach(e=>{r+=o[e],i.push({label:e,sublabel:o[e],selected:!1,checkbox:!1})}),[{label:"__ TOTALS",sublabel:r,selected:!1,checkbox:!1,children:i}].concat(n.sort((e,t)=>e.label>t.label))}function setupTreeListForNodeStats(){var e=collectNodeStats();try{$("#node-input-orphan-target-container-div").treeList("empty")}catch(e){$("#node-input-orphan-target-container-div").css({width:"100%",height:"calc(100%)"}).treeList({multi:!1}).on("treelistitemmouseover",function(e,t){}).on("treelistitemmouseout",function(e,t){}).on("treelistselect",function(e,t){}).on("treelistconfirm",function(e,t){}),$("#node-input-orphan-target-filter").show();var n=$("#node-input-orphan-target-filter").searchBox({style:"compact",delay:300,change:function(){var e,t=$(this).val().trim().toLowerCase();""===t?($("#node-input-orphan-target-container-div").treeList("filter",null),n.searchBox("count","")):(e=$("#node-input-orphan-target-container-div").treeList("filter",function(e){return-1<e.label.toLowerCase().indexOf(t)}),n.searchBox("count",e+" / "+$("#node-input-orphan-target-container-div").treeList("data").length))}})}$("#node-input-orphan-target-container-div").treeList("data",e)}

   function setupTreeMsgTracerlist(){try{$("#node-input-msgtracer-trace-treelist").treeList("empty"),$("#node-input-msgtracer-trace-treelist").treeList("data",[])}catch(e){$("#node-input-msgtracer-trace-treelist").css({width:"100%",height:"calc(100%)"}).treeList({multi:!1}).on("treelistitemmouseover",function(e,t){}).on("treelistitemmouseout",function(e,t){}).on("treelistselect",function(e,t){t.node&&(RED.workspaces.show(t.node.z,!1,!1,!0),RED.view.reveal(t.node.id,!0),RED.view.redraw(),$("#node-input-msgtracer-toggle").is(":checked")||($(".red-ui-debug-msg").css("background-color",""),$(".red-ui-debug-msg-node-"+t.node.id).css("background-color","red")))}).on("treelistconfirm",function(e,t){var o;t.node&&(o=t.node.id,setTimeout(()=>{var e=RED.nodes.node(o);e&&(RED.view.reveal(e.id),RED.view.select(e.id),RED.editor.edit(e)),o==RED.workspaces.active()&&RED.workspaces.edit()},50))}),$("#node-input-msgtracer-trace-treelist-filter").show();var o=$("#node-input-msgtracer-trace-treelist-filter").searchBox({style:"compact",delay:300,change:function(){var e,t=$(this).val().trim().toLowerCase();""===t?($("#node-input-msgtracer-trace-treelist").treeList("filter",null),o.searchBox("count","")):(e=$("#node-input-msgtracer-trace-treelist").treeList("filter",function(e){return-1<e._label.toLowerCase().indexOf(t)||-1<e.node.type.toLowerCase().indexOf(t)||-1<e.node.id.toLowerCase().indexOf(t)||-1<e.sublabel.toLowerCase().indexOf(t)}),o.searchBox("count",e+" / "+$("#node-input-msgtracer-trace-treelist").treeList("data").length))}})}}function toggleDebugTracingInBackend(e){let t=$("#node-input-msgtracer-msgtodebug").is(":checked");var o=$("#node-input-msgtracer-msgtodebug-all").is(":checked"),r=RED.view.selection().nodes;r||o||!t?r&&0<r.length&&o&&t?($("#node-input-msgtracer-msgtodebug").prop("checked",!1),$("#node-input-msgtracer-msgtodebug-all").prop("checked",!1),RED.notify("Debug Messages not toggled, both nodes selected and all nodes is on.",{type:"error",timeout:3e3})):(t||$("#node-input-msgtracer-msgtodebug-all").prop("checked",!1),$.ajax({url:"MsgTracer/debug/"+(t?"on":"off"),type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify({nodesSelected:(RED.view.selection().nodes||[]).map(e=>e.id),allIsOn:o}),success:function(e){RED.notify("Message debugging is <b>"+(t?"on":"off")+"</b>",{type:"success",timeout:3e3})},error:function(e,t,o){RED.notify("Message tracing failed: "+t,{type:"error",timeout:3e3})}})):($("#node-input-msgtracer-msgtodebug").prop("checked",!1),RED.notify("Debug Messages not toggled, first select nodes to be debugged <b>or</b> toggle 'all nodes' to on.",{type:"error",timeout:3e3}))}function toggleMsgTracingInBackend(e){let t=$("#node-input-msgtracer-toggle").is(":checked");var o=$("#node-input-msgtracer-toggle-all").is(":checked"),r=RED.view.selection().nodes;r||o||!t?r&&0<r.length&&o&&t?($("#node-input-msgtracer-toggle-all").prop("checked",!1),$("#node-input-msgtracer-toggle").prop("checked",!1),RED.notify("Message tracing not toggled, nodes are selected <b>and</b> all nodes is checked.",{type:"error",timeout:3e3})):(t||$("#node-input-msgtracer-toggle-all").prop("checked",!1),t&&setupTreeMsgTracerlist(),$.ajax({url:"MsgTracer/msgtracing/"+(t?"on":"off"),type:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify({nodesSelected:(RED.view.selection().nodes||[]).map(e=>e.id),allIsOn:o}),success:function(e){RED.notify("Message tracing is <b>"+(t?"on":"off")+"</b>",{type:"success",timeout:3e3})},error:function(e,t,o){RED.notify("Message tracing failed: "+t,{type:"error",timeout:3e3})}})):($("#node-input-msgtracer-toggle").prop("checked",!1),RED.notify("Message tracing not toggled, first select nodes to be traced <b>or</b> toggle 'all nodes' to on.",{type:"error",timeout:3e3}))}

   function transformInjectToChangeNode(t){t&&t.preventDefault();t=[...(RED.view.selection().nodes||[]).filter(e=>"inject"==e.type),...(RED.view.selection().nodes||[]).filter(e=>"group"==e.type).map(e=>e.nodes.filter(e=>"inject"==e.type))].flat();if(0==(t=RED.nodes.createExportableNodeSet(t)).length)RED.notify("No inject nodes found in node selection",{type:"warning"});else{let e=t.map(o=>{var e={id:RED.nodes.id(),type:"change",name:o.name,action:"",property:"",from:"",to:"",reg:!1,x:0,y:0,wires:[[]]};return e.rules=o.props.map(e=>{var t={t:"set",p:e.p,pt:"msg",to:e.v,tot:e.vt};return"payload"==e.p?(t.to=o.payload,t.tot=o.payloadType):"topic"==e.p&&(t.to=o.topic),t}),e});setTimeout(()=>{RED.clipboard.import(),setTimeout(()=>{$("#red-ui-clipboard-dialog-import-text").val(JSON.stringify(e)).trigger("paste")},300)},400)}}

   // Add your plugin as a new tabsheet in the right sidebar AFTER the flow editor is completely started
   var initialiseConfigNodeOnce = () => {
      RED.events.off('runtime-state', initialiseConfigNodeOnce);

      // The html content of the sidebar has been specified below as a data-template, from where it can be loaded:
      var content = $($('script[type="text/x-red"][data-template-name="Screenshot"]').i18n().html());
    
      // Add a "Your sidebar" tabsheet to the right sidebar panel, in which this sidebar panel can be displayed
      // --> more details: https://nodered.org/docs/api/ui/sidebar/
      RED.sidebar.addTab({
         id: "Introspection",
         label: "Introspection", // short name for the tab
         name: "Introspection", // long name for the menu
         content: content,
         enableOnEdit: true,
         iconClass: "fa fa-camera" // your fontawesome icon
      });

      var tabs = RED.tabs.create({
            id: 'func-introspection-tabs',
            onchange: function(tab) {
               $('#func-introspection-tabs-content').children().hide();
               $('#' + tab.id).show();
            }
      });
      
      // Add first tab, screenshot
      tabs.addTab({
            id: 'func-introspection-tab-screenshot',
            iconClass: 'fa fa-photo',
            label: 'Screenshot'
      });
      
      // Add tab, orphans
      tabs.addTab({
            id: 'func-introspection-tab-lint',
            iconClass: 'fa fa-eyedropper',
            label: 'Lint'
      });

      // Add tab, obfuscation
      tabs.addTab({
            id: 'func-introspection-tab-obfuscation',
            iconClass: 'fa fa-user-secret',
            label: 'Obfuscation'
      });
      
      $('#node-input-obfuscation-generate-btn').on("click", function (e) {
         if ( e ) { e.preventDefault() }
         
         obfuscatieCurrentFlow({
            name: $('#node-input-obfuscate-name').is(":checked"),
            info: $('#node-input-obfuscate-info').is(":checked"),
            position: $('#node-input-obfuscate-position').is(":checked"),
            
            shrink_node: $('#node-input-obfuscate-shrink-size').is(":checked"),
            remove_groups: $('#node-input-obfuscate-remove-groups').is(":checked"),
            javascript: $('#node-input-obfuscate-javascript').is(":checked"),

            remove_junctions: $('#node-input-obfuscate-remove-junctions').is(":checked"),
            remove_icons: $('#node-input-obfuscate-remove-icons').is(":checked"),
            remove_debugs: $('#node-input-obfuscate-remove-debugs').is(":checked"),

            remove_linkout_nodes: $('#node-input-obfuscate-remove-linknodes').is(":checked"),
            copy_linkin_nodes: $('#node-input-obfuscate-copy-linkin-nodes').is(":checked"),
            ignore_off_flow_links: $('#node-input-obfuscate-ignore-off-flow-links').is(':checked'),
            remove_linkcall_nodes: $("#node-input-obfuscate-remove-linkcall-nodes").is(":checked"),

            replace_switch: $('#node-input-obfuscate-replace-switch').is(":checked"),
            replace_change: $('#node-input-obfuscate-replace-change').is(":checked"),

            add_license: $('#node-input-obfuscate-add-license-text').is(":checked"),
            append_license: $('#node-input-obfuscate-append-license-text').is(":checked"),
            license_text: $('#node-input-obfuscate-license-text').val(),
         })
      })

      $('#node-input-obfuscate-add-license-text').on('change', (e) => {
         if ( $('#node-input-obfuscate-add-license-text').is(":checked") ) {
            $('#node-input-obfuscate-add-license-text-row').fadeIn(300)
         } else {
            $('#node-input-obfuscate-add-license-text-row').fadeOut(300)
         }
      })

      $('#node-input-obfuscate-remove-linknodes').on('change', (e) => {
         if ( $('#node-input-obfuscate-remove-linknodes').is(":checked") ) {
            $('#node-input-obfuscate-coalesce-link-out-options').fadeIn(300)
         } else {
            $('#node-input-obfuscate-coalesce-link-out-options').fadeOut(300)
         }
      })

      $('#node-screenshot-capture-btn').on("click", function (e) {
         if ( e ) { e.preventDefault() }

         $('#node-input-screenshot-svgcontainer').html( "" );

         RED.notify(
            "Please wait, screenshot being prepared ...", {
            type: "success"
            }
         );

         let opts = {
            rmidsandclasses: $('#node-input-screenshot-remove-classes-and-ids').is('checked')
         }
         generatorFunctionForVersion(RED, opts)( (svgdata) => {
            $('#node-input-screenshot-svgcontainer').html(svgdata);
            globalRefToSvgData = svgdata;
            setTimeout(() => {
               addPanZoom()
            },150)
         });
      })

      $('#node-screenshot-post-svg-to-endpoint').on('click', (e) => {
         if (e) { e.preventDefault(); }
         let postEndpoint = $('#node-input-svgpost-endpoint').val() || "/screenshot"

         RED.notify(
            "Posting to endpoint ...", {
            type: "success"
            }
         );
         
         $.ajax({
            type: "POST",
            url: postEndpoint,
            dataType: "application/json;charset=utf-8",
            data: {
               d: globalRefToSvgData
            },
            complete: (obj) => {
               switch( obj.status ) {
               case 413:
               // apiMaxLength in the settings.js is set to 5mb by default,
               // if svg larger than that, need to increase the limit.
               // Provide a hint to that setting in the error message.
               RED.notify(
                  "Screenshot too large, increase apiMaxLength in settings.js.", {
                     type: "error"
                  }
               );
               break;
               case 404:
               // Http-in POST node is missing
               RED.notify(
                  "Missing http-in node: method: POST, path: " + postEndpoint, {
                     type: "error"
                  }
               );
               break;
               case 200:
                  RED.notify("Screenshot successfully posted", {
                     type: "success"
                  });
               break;
               default:
               RED.notify(
                  "Screenshot failed: " + obj.statusText + "  " + obj.status, {
                     type: "error"
                  }
               );
               };
            },
         });
         
      })

      // handle the download button under the editor window.
      $('#node-screenshot-download-svg').on("click", function (e) {
        if (e) { e.preventDefault(); }
        var svgBlob = new Blob([globalRefToSvgData], {type:"image/svg+xml;charset=utf-8"});
        var svgUrl = URL.createObjectURL(svgBlob);
        var downloadLink = document.createElement("a");
        downloadLink.href = svgUrl;
        downloadLink.download = "screenshot.svg";
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
      });

      $('#node-screenshot-copy-to-clipboard-svg').on("click", function (e) {
        if (e) { e.preventDefault(); }
        if ( RED.clipboard.copyText(globalRefToSvgData) ) {
          RED.notify("SVG copied to clipboard", { type: "success" });
        }
      });

      // When the user has entered new data in the sidebar, then store it into the config node
      $("#node-input-orphan-find-btn").on("click", function(e) {
         if ( e ) { e.preventDefault() }
         setupTreelist();
      })

      $('#node-input-documentation-find-btn').on('click', (e) => {
         if ( e ) { e.preventDefault() }
         setupTreelistInfoness();
      })

      $('#node-input-linkin-nodes-find-btn').on('click', (e) => {
         if ( e ) { e.preventDefault() }

         let linkNodes = (RED.view.selection().nodes || []).filter( (e) => {
            return e.type == "link in"
         }).map( e => e.id )

         if ( linkNodes.length == 0 ) {
            RED.notify(
               "No link in node selected, selected exactly one.", {
                  type: "error"
               }
            );
         } else {
            setupTreelistAllLinksForLinkIn(linkNodes[0])
         }
      })

      $('#node-input-orphan-clear-workspace-btn').on('click', (e) => {
         if ( e ) { e.preventDefault() }
         $('.red-ui-linkcall-link-indicator').remove()
      })

      $('#node-input-msgtrace-clear-debug-btn').on('click', (e) => {
         if ( e ) { e.preventDefault() }

         // remove any message highlights from the debug panel
         $('.red-ui-debug-msg').css("background-color", "")

         // from [debug node](https://github.com/node-red/node-red/blob/2854351909dee9f92597faba3f37239134294eec/packages/node_modules/%40node-red/nodes/core/common/21-debug.html#L437)
         RED.actions.invoke("core:clear-debug-messages")
      })

      $('#node-input-msgtrace-clear-trace-btn').on('click', (e) => {
         if ( e ) { e.preventDefault() }
         setupTreeMsgTracerlist()
         $("#node-input-msgtracer-trace-treelist").treeList('empty')
         $("#node-input-msgtracer-trace-treelist").treeList('data', [])
      })

      $('#node-input-msgtracer-msgtodebug').on("change", toggleDebugTracingInBackend)
      $('#node-input-msgtracer-toggle').on("change", toggleMsgTracingInBackend)

      RED.actions.add( "introspection:show-link-call-links", highlightAllLinkCalls)
      
      $('#node-input-linkcalls-find-btn').on('click', (e) => {
         if ( e ) { e.preventDefault() }
         highlightAllLinkCalls()
         
         /*
         try {
            $("#node-input-orphan-target-container-div").treeList('empty')
         } catch (ex) { }
         */
      })

      $('#node-input-transform-inject-to-change-btn').on( 'click', transformInjectToChangeNode)
      $('#node-input-statistics-btn').on('click', (e) => {
         if ( e ) { e.preventDefault() }
         setupTreeListForNodeStats()
      })
   };
   RED.events.on('runtime-state', initialiseConfigNodeOnce);
})();
</script>

<style>
   .col-100 .red-ui-typedInput-container {
   width: 70% !important;
   }
   
   .col-100.no-label .red-ui-typedInput-container {
   width: 100% !important;
   }
   .w-30 {
      width: 40% !important;
      margin-left: 10px;
   }   
   .w-25 {
      width: 25% !important;
      margin-left: 10px;
   }   
   .ml-30 {
      margin-left: 30px !important;
   }

</style>

<!-- The html for the right sidebar plugin screen -->
<script type="text/x-red" data-template-name="Screenshot">
<div class="form-row func-introspection-tabs-row">
   <ul style="min-width: 600px; margin-bottom: 20px;" id="func-introspection-tabs"></ul>
</div>

<div id="func-introspection-tabs-content" style="min-height: calc(100% - 95px);">

   <!-- Screenshot Tab in Sidebar -->

   <div id="func-introspection-tab-screenshot" style="display:none; min-height: calc(100%);">
      <div class="form-row">
         <div class="col-100">

            <div class="form-row" style="margin-left: 10px; margin-top: 30px;">
               <button type="button" id="node-screenshot-capture-btn"
                       class="red-ui-button red-ui-button-large"><i class="fa fa-camera"></i> Capture</button>

               <label for="node-input-screenshot-remove-classes-and-ids" class="ml-30" style="width: 200px">
                  <span>Remove Classes and Ids?</span>
               </label>
               <input type="checkbox" checked="checked" id="node-input-screenshot-remove-classes-and-ids"
                                             style="display:inline-block; width:15px; vertical-align:baseline;">                          
            </div>

            <div class="form-row" style="margin-left: 10px; margin-top: 30px;">
               Step 1: Capture a screen shot, Step 2: download it, copy it or post off.
            </div>


            <div class="form-row"
               style="min-height: 300px; height: 450px; overflow: hidden; margin-left: 10px; margin-right: 15px; border: 1px rgb(196, 196, 196) solid; border-radius: 5px;">
               <div id="node-input-screenshot-svgcontainer"></div>
            </div>

            <div class="form-row" style="margin-left: 10px; margin-top: 30px;">
               <button type="button" id="node-screenshot-download-svg"
                          class="red-ui-button red-ui-button-large"><i class="fa fa-download"></i> Download</button>
               <button type="button" id="node-screenshot-copy-to-clipboard-svg"
                           class="red-ui-button red-ui-button-large"><i class="fa fa-clipboard"></i> Copy to Clipboard</button>
            </div>

            <div class="form-row" style="margin-left: 10px; margin-top: 30px;">
               <input type="text" id="node-input-svgpost-endpoint" placeholder="/screenshot" style="width: 40% !important;">
               <button type="button" id="node-screenshot-post-svg-to-endpoint"
                       class="red-ui-button red-ui-button-large"><i class="fa fa-send-o"></i> Post to Endpoint</button>
            </div>

         </div>
      </div>
   </div>

   <!-- Lint Tab in Sidebar -->

   <div id="func-introspection-tab-lint" style="display:none; min-height: calc(100%);">
      <div class="form-row" style="margin-left: 10px; margin-top: 30px">
         <button id="node-input-orphan-find-btn"
                     class="red-ui-button"><i class="fa fa-life-ring"></i> Unconnected</button>
         <button id="node-input-documentation-find-btn"
                     class="red-ui-button"><i class="fa fa-cc"></i> Undocumented</button>
         <button id="node-input-linkin-nodes-find-btn"
                     class="red-ui-button"><i class="fa fa-link"></i> Link Ins</button>
         <button id="node-input-linkcalls-find-btn"
                     class="red-ui-button"><i class="fa fa-link"></i> Link Calls</button>
         <button id="node-input-orphan-clear-workspace-btn"
                     class="red-ui-button">Clear dots</button>
         <button id="node-input-transform-inject-to-change-btn"
                     class="red-ui-button"><i class="fa fa-retweet"></i> Inj-&gt;Chg</button>
         <button id="node-input-statistics-btn"
                    class="red-ui-button"><i class="fa fa-pie-chart"></i> Stats</button>
      </div>

      <div class="form-row"
         style="margin-left: 10px; position: relative; min-height: 200px; height: 430px; margin-right: 15px;">
         <div style="margin-bottom: 5px; width: 35%; padding-left: 60%;">
            <input type="text" id="node-input-orphan-target-filter" style="display: none;">
         </div>
         <div id="node-input-orphan-target-container-div"></div>
      </div>

      <!-- message tracing stuff -->

      <div class="form-row" style="margin-left: 10px; margin-top: 40px">
         <label for="node-input-msgtracer-toggle"  class="w-25">
            <i class="fa fa-stethoscope"></i>
            <span>Trace selected nodes?</span>
         </label>
         <input type="checkbox" id="node-input-msgtracer-toggle"
                style="display:inline-block; width:15px; vertical-align:baseline;">

         <label for="node-input-msgtracer-toggle-all"  class="w-25">
            <i class="fa fa-warning"></i>
            <span>All nodes?</span>
         </label>
         <input type="checkbox" id="node-input-msgtracer-toggle-all"
                style="display:inline-block; width:15px; vertical-align:baseline;">

         <button id="node-input-msgtrace-clear-trace-btn" style="margin-left: 10px;"
                       class="red-ui-button">Clear Trace</button>
      </div>

      <div class="form-row"
         style="margin-left: 10px; position: relative; min-height: 200px; height: 430px; margin-right: 15px;">
         <div style="margin-bottom: 5px; width: 35%; padding-left: 60%;">
            <input type="text" id="node-input-msgtracer-trace-treelist-filter" style="display: none;">
         </div>
         <div id="node-input-msgtracer-trace-treelist"></div>
      </div>

      <div class="form-row" style="margin-left: 10px; margin-top: 40px;">
         <label for="node-input-msgtracer-msgtodebug" class="w-25">
                     <i class="fa fa-bug"></i>
                     <span>Msgs from selected nodes to Debug?</span>
               </label>
         <input type="checkbox" id="node-input-msgtracer-msgtodebug"
                      style="display:inline-block; width:15px; vertical-align:baseline;">
      
         <label for="node-input-msgtracer-msgtodebug-all" class="w-25">
                     <i class="fa fa-warning"></i>
                     <span>All nodes?</span>
               </label>
         <input type="checkbox" id="node-input-msgtracer-msgtodebug-all"
                      style="display:inline-block; width:15px; vertical-align:baseline;">
      
         <button id="node-input-msgtrace-clear-debug-btn" style="margin-left: 10px;"
                                   class="red-ui-button">Clear Debug</button>
      </div>
   </div>

   <!-- Obfuscation Tab in Sidebar -->

   <div id="func-introspection-tab-obfuscation" style="display:none; min-height: calc(100%);">

      <div class="form-row">
         <label for="node-input-obfuscate-name" class="w-30">
               <i class="fa fa-tag"></i>
               <span>Obfuscate Name?</span>
            </label>
         <input type="checkbox" id="node-input-obfuscate-name"
                     style="display:inline-block; width:15px; vertical-align:baseline;">
      </div>

      <div class="form-row">
         <label for="node-input-obfuscate-position" class="w-30">
               <i class="fa fa-map-pin"></i>
               <span>Obfuscate Position?</span>
            </label>
         <input type="checkbox" id="node-input-obfuscate-position"
                   style="display:inline-block; width:15px; vertical-align:baseline;">
      </div>

      <div class="form-row">
         <label for="node-input-obfuscate-shrink-size" class="w-30">
                        <i class="fa fa-angle-down"></i>
                        <span>Shrink Nodes?</span>
                     </label>
         <input type="checkbox" id="node-input-obfuscate-shrink-size"
                            style="display:inline-block; width:15px; vertical-align:baseline;">
      </div>

      <div class="form-row">
         <label for="node-input-obfuscate-javascript" class="w-30">
               <i class="fa fa-code"></i>
               <span>Obfuscate Javascript?</span>
            </label>
         <input type="checkbox" id="node-input-obfuscate-javascript"
                              style="display:inline-block; width:15px; vertical-align:baseline;">
      </div>

      <div class="form-row col-100">
         <label for="node-input-obfuscate-remove-icons" class="w-30">
               <i class="fa fa-adjust"></i>
               <span>Remove Icon?</span>
            </label>
         <input type="checkbox" id="node-input-obfuscate-remove-icons"
                              style="display:inline-block; width:15px; vertical-align:baseline;">
      </div>

      <div class="form-row">
         <label for="node-input-obfuscate-info" class="w-30">
               <i class="fa fa-info"></i>
               <span>Remove Info?</span>
            </label>
         <input type="checkbox" id="node-input-obfuscate-info"
                              style="display:inline-block; width:15px; vertical-align:baseline;">
      </div>

      <div class="form-row">
         <label for="node-input-obfuscate-remove-groups" class="w-30">
               <i class="fa fa-object-group"></i>
               <span>Remove Groups?</span>
            </label>
         <input type="checkbox" id="node-input-obfuscate-remove-groups"
                              style="display:inline-block; width:15px; vertical-align:baseline;">
      </div>

      <div class="form-row">
         <label for="node-input-obfuscate-remove-debugs" class="w-30">
               <i class="fa fa-bug"></i>
               <span>Remove comment & debugs?</span>
            </label>
         <input type="checkbox" id="node-input-obfuscate-remove-debugs"
                                       style="display:inline-block; width:15px; vertical-align:baseline;">
      </div>

      <div class="form-row">
         <label for="node-input-obfuscate-remove-junctions" class="w-30">
                        <i class="fa fa-sitemap"></i>
                        <span>Coalesce Junctions?</span>
                     </label>
         <input type="checkbox" id="node-input-obfuscate-remove-junctions"
                                       style="display:inline-block; width:15px; vertical-align:baseline;">
      </div>

      <div class="form-row">
         <label for="node-input-obfuscate-remove-linkcall-nodes" class="w-30">
                        <i class="fa fa-unlink"></i>
                        <span>Coalesce Link Call Nodes?</span>
                     </label>
         <input type="checkbox" id="node-input-obfuscate-remove-linkcall-nodes" style="display:inline-block; width:15px; vertical-align:baseline;">
      </div>

      <div class="form-row">
         <label for="node-input-obfuscate-remove-linknodes" class="w-30">
               <i class="fa fa-unlink"></i>
               <span>Coalesce Link Out Nodes?</span>
         </label>
         <input type="checkbox" id="node-input-obfuscate-remove-linknodes"
                              style="display:inline-block; width:15px; vertical-align:baseline;">
      </div>

      <div id="node-input-obfuscate-coalesce-link-out-options" style="display: none;">
         <div class="form-row">
            <label for="node-input-obfuscate-copy-linkin-nodes" class="ml-30" style="width: 150px;">
                  <span>Copy Link-In Nodes?</span>
            </label>
            <input type="checkbox" id="node-input-obfuscate-copy-linkin-nodes" style="display:inline-block; width:15px; vertical-align:baseline;">
         </div>
         <div class="form-row">
            <label for="node-input-obfuscate-ignore-off-flow-links" class="ml-30" style="width: 150px;">
                  <span>Ignore off-flow links?</span>
            </label>
            <input type="checkbox" id="node-input-obfuscate-ignore-off-flow-links" style="display:inline-block; width:15px; vertical-align:baseline;">
         </div>
      </div>

      <div class="form-row">
         <label class='w-30'>
                        <i class="fa fa-refresh"></i>
                        <span>Replace Nodes:</span>
                     </label>
      </div>

      <div class="form-row">
         <label for="node-input-obfuscate-replace-switch" class="ml-30">
                        <span>Switch</span>
                     </label>
         <input type="checkbox" id="node-input-obfuscate-replace-switch"
                            style="display:inline-block; width:15px; vertical-align:baseline;">
      </div>

      <div class="form-row">
         <label for="node-input-obfuscate-replace-change" class="ml-30">
                       <span>Change</span>
                     </label>
         <input type="checkbox" id="node-input-obfuscate-replace-change"
                                        style="display:inline-block; width:15px; vertical-align:baseline;">
      </div>

      <div class="form-row">
         <label for="node-input-obfuscate-add-license-text" class="w-30">
            <i class="fa fa-gavel"></i>
            <span>Replace info with license?</span>
         </label>
         <input type="checkbox" id="node-input-obfuscate-add-license-text" style="display:inline-block; width:15px; vertical-align:baseline;">
      </div>
      
      <div id="node-input-obfuscate-add-license-text-row" style="display: none;">
         <div class="form-row ml-30">
            <label for="node-input-obfuscate-append-license-text" style="width: 150px">
               <span>Append to info?</span>
            </label>
            <input type="checkbox" id="node-input-obfuscate-append-license-text" style="display:inline-block; width:15px; vertical-align:baseline;">
         </div>
         <div class="form-row ml-30">
            <textarea id="node-input-obfuscate-license-text" placeholder="License Text"></textarea>
         </div>
      </div>

      <div class="form-row">
         <div class="col-100">
            <div class="form-row node-input-target-row" style="margin-left: 10px; margin-top: 30px">
               <button id="node-input-obfuscation-generate-btn"
                                         class="red-ui-button"><i class="fa fa-low-vision"></i> Obfuscate</button>
            </div>
         </div>
      </div>

      <div class="form-row" style="margin-left: 10px">
         <b>Warning</b>: No guarantee is made that the obfuscated flow still works. This has not be
         thoroughly tested. Ensure correctness by completely testing the resultant obfuscated flow.
         No warranty of success is provided, implied or expressed.
      </div>
   </div>
</script>
<!-- --- [red-plugin:@gorenje/node-red-mindmap/customdraganddrop] --- -->
<script type="text/javascript">
(function () {
    var initialiseConfigNodeOnce = () => {
        RED.events.off('runtime-state', initialiseConfigNodeOnce);

        let customDropHandler = (event) => {
            /* for debugging purposes - inspect the original Event to discover the type:
            * console> window.ddEvent.originalEvent.dataTransfer.items[0].type
            */
            window.ddEvent = event

            let itemPtr = event.originalEvent.dataTransfer.items
            let itemCount = itemPtr.length

            let nodesToBeImported = []
            let waitingOnNode = 0;

            let seenUrl = []

            for (let idx = 0; idx < itemCount; idx++) {
                let itm = itemPtr[idx]

                /* these are bookmarks that can be dragged onto the workspace */
                if (itm.type == "text/uri-list" || itm.type == "text/x-moz-url") {
                    waitingOnNode++;
                    let yPos = 40 * waitingOnNode
                    
                    itm.getAsString((url) => {
                        let urlAndTitle = url.split("\n")

                        let onSuccess = (resp) => {
                            let data = {
                                "id": RED.nodes.id(),
                                "type": "Inspiration",
                                "name": urlAndTitle[1] || "Web Bookmark",
                                "info": urlAndTitle[0] + "\n\n",
                                "sumPass": false,
                                "sumPassPrio": 0,
                                "sumPassNodeId": "",
                                "createdAt": new Date().toISOString(),
                                "updatedAt": new Date().toISOString(),
                                "x": 0,
                                "y": yPos,
                                "wires": [[]]
                            }

                            if ( resp.image_url ) {
                                data.info = `${urlAndTitle[0]}\n\n![img](${resp.image_url})\n\n`
                            }

                            let nodeCopy = nodesToBeImported.filter(d => d.info.indexOf(urlAndTitle[0]) > -1)[0]

                            if ( !nodeCopy ) {
                                nodesToBeImported.push(data)
                            } else {
                                if (data.name != "Web Bookmark" && nodeCopy.name == "Web Bookmark") {
                                    nodeCopy.name = data.name
                                }
                                waitingOnNode--
                            }
                        }

                        $.ajax({
                            url: "/writermap/content",
                            type: "POST",
                            data: JSON.stringify({bookmark_url: urlAndTitle[0]}),
                            contentType: 'application/json',
                            processData: false,
                            success: onSuccess,
                            error: function (err) {
                                // Error handling
                                waitingOnNode--;
                                RED.notify(`Bookmark upload not possible: ${err.message}`, {
                                        type: "warning"
                                    }
                                );
                            }
                        })

                    })
                } else if (itm.type.startsWith("image/")) {
                    waitingOnNode++
                    let yPos = waitingOnNode * 40

                    let file = event.originalEvent.dataTransfer.files[idx]

                    let formData = new FormData();
                    formData.append('file', file, file.name);

                    let onSuccess = (response) => {
                        nodesToBeImported.push({
                            "id": RED.nodes.id(),
                            "type": "Art",
                            "name": file.name,
                            "info": `![img](${response.relative_url})\n`,
                            "sumPass": false,
                            "sumPassPrio": 0,
                            "sumPassNodeId": "",
                            "createdAt": new Date().toISOString(),
                            "updatedAt": new Date().toISOString(),
                            "x": 0,
                            "y": yPos,
                            "wires": [[]]
                        })
                    }

                    $.ajax({
                        url: "/writermap/content",
                        type: "POST",
                        data: formData,
                        contentType: false,
                        processData: false,
                        enctype: 'multipart/form-data',
                        success: onSuccess,
                        error: function (err) {
                            // Error handling
                            waitingOnNode--
                            RED.notify(`Image upload not possible: ${err.message}`, {
                                type: "warning"
                            }
                            );
                        }
                    })
                } else if ( (itm.type == "text/markdown" || itm.type == "text/plain") && itm.kind == "file" ) {
                    waitingOnNode++

                    let file = event.originalEvent.dataTransfer.files[idx]
                    let yPos = waitingOnNode * 40

                    file.arrayBuffer().then(d => {
                        nodesToBeImported.push({
                            "id": RED.nodes.id(),
                            "type": "Text",
                            "name": file.name,
                            "info": new TextDecoder().decode(d),
                            "sumPass": false,
                            "sumPassPrio": 0,
                            "sumPassNodeId": "",
                            "createdAt": new Date().toISOString(),
                            "updatedAt": new Date().toISOString(),
                            "x": 0,
                            "y": yPos,
                            "wires": [[]]
                        })
                    }).catch(ex => { console.log(ex) })
                } else if ( (itm.type == "text/markdown" || itm.type == "text/plain") && itm.kind == "string" ) {
                    waitingOnNode++

                    let yPos = waitingOnNode * 40
                    
                    event.originalEvent.dataTransfer.items[idx].getAsString( content => {
                        nodesToBeImported.push({
                            "id": RED.nodes.id(),
                            "type": "Text",
                            "name": "No Name",
                            "info": content,
                            "sumPass": false,
                            "sumPassPrio": 0,
                            "sumPassNodeId": "",
                            "createdAt": new Date().toISOString(),
                            "updatedAt": new Date().toISOString(),
                            "x": 0,
                            "y": yPos,
                            "wires": [[]]
                        })
                    })
                }
            }

            let checkIfAllIsThere = () => {
                if (waitingOnNode > 0 && nodesToBeImported.length == waitingOnNode) {
                    setTimeout(() => {
                        try {
                            RED.view.importNodes(nodesToBeImported)
                        } catch (ex) { /*keep quiet*/ }
                    }, 400);
                } else {
                    setTimeout(checkIfAllIsThere, 400)
                }
            }

            if (waitingOnNode > 0) {
                setTimeout(checkIfAllIsThere, 200)
                setTimeout(() => {
                    /* this causes the waiting to stop */
                    nodesToBeImported.length = waitingOnNode
                }, (1000 * waitingOnNode) + 2000)
            }
        }

        /*
         * Because this happens before the workspace is setup, we set the drop listen
         * when the target becomes available.
         */
        let defineCustomDropHandler = () => {
            if ($('#red-ui-drop-target').length > 0) {
                $('#red-ui-drop-target').on("drop", customDropHandler)
            } else {
                setTimeout(defineCustomDropHandler, 300)
            }
        }
        setTimeout(defineCustomDropHandler, 300)

        // handle a generate paste in the browser window. But this only
// works outside of the workspace area. But this is only a prototype.
$(window).on('paste', (event) => {
    try {
        let pasteText = event.originalEvent.clipboardData.getData('text')
        let data = JSON.parse(pasteText)

        if (Array.isArray(data)) {
            RED.view.importNodes(data, {
                generateIds: true,
                addFlow: false,
                touchImport: false,
                generateDefaultNames: false
            })
        }
    } catch (ex) { /* keep quiet */ }
})

    };

    RED.events.on('runtime-state', initialiseConfigNodeOnce);
})();

</script>

<!-- --- [red-plugin:@gorenje/node-red-contrib-blogger/blog-pages-sidebar] --- -->
<script type="text/javascript">

(function() {

  /**
 * Code for the mindmap stats tab
 */
var fillNumOfUpdatesMindMapStats = () => {
    var sltObj = $('#node-input-mindmap-stats-numOfUpdates');
    sltObj.html("");

    sltObj.append(
        $('<option></option>').val(-1).html("-- All --")
    );
    [5, 10, 20, 50, 100, 150, 200].forEach(function (v) {
        sltObj.append($('<option></option>').val(v).html(v));
    });

    sltObj.val(20);
};

var setupTreelistForMindMapStats = () => {
    return $("#node-input-mindmap-stats-target-container-div").css({
        width: "100%",
        height: "calc(100%)"
    }).treeList(
        {
            multi: false
        }
    ).on("treelistitemmouseover", function (e, item) {
    }).on("treelistitemmouseout", function (e, item) {
    }).on('treelistselect', function (event, item) {
        if (item.node) {
            RED.workspaces.show(item.node.z, false, false, true);
            var ndeid = item.node.id;
            setTimeout(() => {
                RED.view.reveal(ndeid, true);
                RED.view.redraw();
            }, 38);
        }
    }).on('treelistconfirm', function (event, item) {
        if (item.node) {
            RED.workspaces.show(item.node.z, false, false, true);
            var ndeid = item.node.id;

            setTimeout(() => {
                const nodeToShow = RED.nodes.node(ndeid)

                if (nodeToShow) {
                    RED.view.reveal(nodeToShow.id);
                    RED.view.select(nodeToShow.id);
                    RED.editor.edit(nodeToShow);
                }

                if (ndeid == RED.workspaces.active()) {
                    RED.workspaces.edit()
                }
            }, 50);
        }
    });
};



/**
 * Code for the blog changes tab
 */
var fillNumOfUpdates = () => {
    var sltObj = $('#node-input-blogchangesidebar-numOfUpdates');
    sltObj.html("");

    sltObj.append(
        $('<option></option>').val(-1).html("-- All --")
    );
    [5, 10, 20, 50, 100, 150, 200].forEach(function (v) {
        sltObj.append($('<option></option>').val(v).html(v));
    });

    sltObj.val(20);
};

var setupTreelistForBlogChanges = () => {
    return $("#node-input-blogchangesidebar-target-container-div").css({
        width: "100%",
        height: "calc(100%)"
    }).treeList(
        {
            multi: false
        }
    ).on("treelistitemmouseover", function (e, item) {
    }).on("treelistitemmouseout", function (e, item) {
    }).on('treelistselect', function (event, item) {
        if (item.node) {
            RED.workspaces.show(item.node.z, false, false, true);
            var ndeid = item.node.id;
            setTimeout(() => {
                RED.view.reveal(ndeid, true);
                RED.view.redraw();
            }, 38);
        }
    }).on('treelistconfirm', function (event, item) {
        if (item.node) {
            RED.workspaces.show(item.node.z, false, false, true);
            var ndeid = item.node.id;

            setTimeout(() => {
                const nodeToShow = RED.nodes.node(ndeid)

                if (nodeToShow) {
                    RED.view.reveal(nodeToShow.id);
                    RED.view.select(nodeToShow.id);
                    RED.editor.edit(nodeToShow);
                }

                if (ndeid == RED.workspaces.active()) {
                    RED.workspaces.edit()
                }
            }, 50);
        }
    });
};

/**
 * tab tracker list
 */
var setupTabTrackerTreelist = () => {
    return $("#node-input-blogchangesidebar-tab-tracker").css({
        width: "100%",
        height: "calc(100%)"
    }).treeList(
        {
            multi: false
        }
    ).on("treelistitemmouseover", function (e, item) {
    }).on("treelistitemmouseout", function (e, item) {
    }).on('treelistselect', function (event, item) {
        if (item.obj) {
            RED.workspaces.show(item.obj.id, false, false, true);
        }
    }).on('treelistconfirm', function (event, item) {
        if (item.obj) {
            RED.workspaces.show(item.obj.id, false, false, true);
            setTimeout(() => {
                RED.workspaces.edit(item.obj.id)
            }, 132)
        }
    });
};



/**
 * Code for the blog pages tab
 */
var setupTreelist = () => {
    return $("#node-input-blogpagessidebar-target-container-div").css({
        width: "100%",
        height: "calc(100%)"
    }).treeList(
        {
            multi: false
        }
    ).on("treelistitemmouseover", function (e, item) {
        /* if ( item.node && item.node.z == RED.workspaces.active()) {
         *   RED.view.reveal(item.node.id,true)
         *   RED.view.redraw();
         * }*/
    }).on("treelistitemmouseout", function (e, item) {
    }).on('treelistselect', function (event, item) {
        if (item.node) {
            RED.workspaces.show(item.node.z, false, false, true);
            var ndeid = item.node.id;
            setTimeout(() => {
                RED.view.reveal(ndeid, true);
                RED.view.redraw();
            }, 38);
        }
    }).on('treelistconfirm', function (event, item) {
        if (item.node) {
            RED.workspaces.show(item.node.z, false, false, true);

            var ndeid = item.node.id;
            setTimeout(() => {
                const nodeToShow = RED.nodes.node(ndeid)

                if (nodeToShow) {
                    RED.view.reveal(nodeToShow.id);
                    RED.view.select(nodeToShow.id);
                    RED.editor.edit(nodeToShow);
                }

                if (ndeid == RED.workspaces.active()) {
                    RED.workspaces.edit()
                }
            }, 50);
        }
    });
};

var retrieveBlogPages = () => {
    var blogPageNodes = [];

    RED.nodes.eachNode(function (n) {
        if (n.type == "link in" && n.name.match(/^\[[^\]]+\] /)) {
            blogPageNodes.push({ ...n });
        }
    });

    blogPageNodes = blogPageNodes.filter(function (nde) {
        return RED.nodes.getNodeLinks(nde.id).filter(function (b) {
            return b.target.type == "BlogPageInfo"
        }).length > 0;
    })
    blogPageNodes.sort(function (a, b) { return a.name > b.name });

    var items = [];
    var nodeItemMap = {};

    var duplicatePaths = {};

    blogPageNodes.forEach(function (nde) {
        var nId = nde.id;
        var n = RED.nodes.node(nId);

        var blogInfoNode = { reloadOnEdit: false };
        RED.nodes.getNodeLinks(nId).forEach(function (lnk) {
            if (lnk.target.type == "BlogPageInfo") {
                blogInfoNode = RED.nodes.node(lnk.target.id);
            }
        });

        /* provide an indication what the different pages are doing */
        var sublabel = blogInfoNode.reloadOnEdit ? "↻" : "─";
        sublabel += blogInfoNode.draft ? "Ɛ" : "─";
        sublabel += blogInfoNode.redirectToNode ? "↗" : "─";
        sublabel += blogInfoNode.incIndex ? "⌂" : "─";
        sublabel += blogInfoNode.incRss ? "⋔" : "─";
        sublabel += blogInfoNode.incSitemap ? "⅄" : "─";
        sublabel += blogInfoNode.image ? "⊞" : "─";

        var nodeDef = RED.nodes.getType(n.type);
        var label;

        if (nodeDef) {
            var l = nodeDef.label;
            label = (typeof l === "function" ? l.call(n) : l) || "";

            if (sublabel.indexOf("subflow:") === 0) {
                return;
            }
        }

        if (!nodeDef || !label) {
            label = n.type;
        }

        (duplicatePaths[label] ||= []).push(n.id);

        nodeItemMap[n.id] = {
            node: n,
            label: label,
            icon: n.d ? "fa fa-eye-slash" : "fa fa-eye",
            class: "",
            sublabel: sublabel,
            selected: false,
            checkbox: false,
            children: undefined
        };

        items.push(nodeItemMap[n.id]);
    });

    $.each(duplicatePaths, (propName) => {
        if (duplicatePaths[propName].length > 1) {
            items.forEach((itm) => {
                if (itm.label == propName) {
                    itm.sublabel = "DUPLICATE";
                    itm.class = "duplicate-path"
                }
            });
        }
    });

    $("#node-input-blogpagessidebar-target-container-div").treeList(
        'data', items
    );
};


  
  var initialiseSidebarNodeOnce = () => {
    RED.events.off('runtime-state', initialiseSidebarNodeOnce);

    var content = $($('script[type="text/x-red"][data-template-name="BlogPagesSidebar"]').i18n().html());

    RED.sidebar.addTab({
        id: "BlogPagesSidebar",
        label: "Mindmap", // short name for the tab
        name: "Mindmap", // long name for the menu
        content: content,
        closeable: true,
        enableOnEdit: true,
        iconClass: "fa fa-file-o" // your fontawesome icon
    });


    var tabs = RED.tabs.create({
        id: 'func-blogcntrlsidebar-tabs',
        onchange: function (tab) {
            $('#func-blogcntrlsidebar-tabs-content').children().hide();
            $('#' + tab.id).show();

            if (tab.id == "func-blogpagessidebar-tab-blogpages") {
                setTimeout(retrieveBlogPages, 150)
            } else if (tab.id == "func-blogpagessidebar-tab-blogchanges" ) {
                setTimeout(updateBlogChanges, 150);
            } else if (tab.id == "func-blogpagessidebar-tab-mindmap-stats" ) {
                setTimeout(updateMindMapStats, 150)
            }
        }
    });

    // Add first tab, pull

    // Add second tab, changes
    tabs.addTab({
        id: 'func-blogpagessidebar-tab-blogchanges',
        iconClass: 'fa fa-tty',
        label: 'Changes'
    });

    // Add third tab, mindmap stats
    tabs.addTab({
        id: 'func-blogpagessidebar-tab-mindmap-stats',
        iconClass: 'fa fa-percent',
        label: 'Stats'
    });

    /***
    * Blog Pages
    * ************/

    var blogPagesListing = setupTreelist();

    var blogPagesSearch = $("#node-input-blogpagessidebar-target-filter").searchBox({
        style: "compact",
        delay: 300,
        change: function () {
            var val = $(this).val().trim().toLowerCase();
            if (val === "") {
                blogPagesListing.treeList("filter", null);
                blogPagesSearch.searchBox("count", "");
            } else {
                var count = blogPagesListing.treeList("filter", function (item) {
                    return item.label.toLowerCase().indexOf(val) > -1 || item.node.type.toLowerCase().indexOf(val) > -1
                });
                blogPagesSearch.searchBox("count", count + " / " + blogPagesListing.treeList('data').length);
            }
        }
    });

    $('#node-input-blogpagessidebar-refresh-but').on('click', (e) => {
        retrieveBlogPages()
    })

    /***
    * Mindmap statistics code
    * ************/

    fillNumOfUpdatesMindMapStats();

    var blogMindMapStats = setupTreelistForMindMapStats();

    var blogMindMapStatsSearch = $("#node-input-mindmap-stats-target-filter").searchBox({
        style: "compact",
        delay: 300,
        change: function () {
            var val = $(this).val().trim().toLowerCase();
            if (val === "") {
                blogMindMapStats.treeList("filter", null);
                blogMindMapStatsSearch.searchBox("count", "");
            } else {
                var count = blogMindMapStats.treeList("filter", function (item) {
                    return item._label.toLowerCase().indexOf(val) > -1 || item.node.type.toLowerCase().indexOf(val) > -1
                });
                blogMindMapStatsSearch.searchBox("count", count + " / " + blogMindMapStats.treeList('data').length);
            }
        }
    });

    var updateMindMapStats = (e) => {
        if (e) { e.preventDefault(); }

        var blogPageNodes = [];
        var that = this;

        var sortFunction = (a, b) => a.wordCount < b.wordCount ;
        if ( $('#mindmap-stats-reverse-sorting').is(":checked") ) { 
            sortFunction = (a, b) => a.wordCount > b.wordCount;
        }

        var addToBlogPageNodes = (n) => {
            if (n._def._collection == "writermap") {
                blogPageNodes.push({
                    id: n.id,
                    updatedAt: Date.parse(n.updatedAt),
                    createdAt: Date.parse(n.createdAt),
                    wordCount: n.info ? n.info.split(/\s+/).filter(word => word !== '').length : 0,
                });
            }                
        }

        // check whether nodes have been selected.
        if ($('#mindmap-stats-only-selected-nodes').is(":checked")) {
            (RED.view.selection().nodes || []).forEach( n => {
                addToBlogPageNodes(n)
            })
        } else {
            RED.nodes.eachNode((n) => {
                addToBlogPageNodes(n)
            });
        }

        blogPageNodes.sort(sortFunction) 
    
        $('#mindmap-stats-nodeCount').html(blogPageNodes.length)
        $('#mindmap-stats-byteLength').html(blogPageNodes.reduce((acc, val) => acc + val.wordCount, 0))

        let numChanges = parseInt(
            $("#node-input-mindmap-stats-numOfUpdates").val()
        );

        if (numChanges > 0 && blogPageNodes.length > numChanges) {
            blogPageNodes.length = numChanges;
        }

        $('#mindmap-stats-nodeCount-selection').html(blogPageNodes.length)
        $('#mindmap-stats-byteLength-selection').html(blogPageNodes.reduce((acc, val) => acc + val.wordCount, 0))

        var items = [];
        var nodeItemMap = {};

        blogPageNodes.forEach(function (nde) {
            var nId = nde.id;
            var n = RED.nodes.node(nId);

            nodeItemMap[n.id] = {
                node: n,
                label: "",
                _label: RED.utils.getNodeLabel(n),
                icon: RED.utils.createNodeIcon(n, true),
                class: "",
                sublabel: nde.wordCount,
                selected: false,
                checkbox: false,
                children: undefined
            };

            items.push(nodeItemMap[n.id]);
        });

        blogMindMapStats.treeList('data', items);
    }

    // all checkboxes update the list automagically
    $("#node-input-mindmap-stats-numOfUpdates").on("change", updateMindMapStats)
    $('#mindmap-stats-reverse-sorting').on('change', updateMindMapStats)
    $('#mindmap-stats-only-selected-nodes').on('change', updateMindMapStats)
    $('#node-input-mindmap-stats-refresh-button').on('click', updateMindMapStats);

    /***
    * Blog Changes
    * ************/

    fillNumOfUpdates();

    var blogChangesListing = setupTreelistForBlogChanges();

    var blogChangeSearch = $("#node-input-blogchangesidebar-target-filter").searchBox({
        style: "compact",
        delay: 300,
        change: function () {
            var val = $(this).val().trim().toLowerCase();
            if (val === "") {
                blogChangesListing.treeList("filter", null);
                blogChangeSearch.searchBox("count", "");
            } else {
                var count = blogChangesListing.treeList("filter", function (item) {
                    return item._label.toLowerCase().indexOf(val) > -1 || item.node.type.toLowerCase().indexOf(val) > -1
                });
                blogChangeSearch.searchBox("count", count + " / " + blogChangesListing.treeList('data').length);
            }
        }
    });

    var updateBlogChanges = (e) => {
        if (e) { e.preventDefault(); }

        var blogPageNodes = [];
        var that = this;

        RED.nodes.eachNode(function (n) {
            if (n.updatedAt && n.createdAt) {
                blogPageNodes.push({
                    id: n.id,
                    updatedAt: Date.parse(n.updatedAt),
                    createdAt: Date.parse(n.createdAt),
                });
            }
        });

        blogPageNodes.sort(function (a, b) {
            return a.updatedAt < b.updatedAt;
        }); let numChanges = parseInt($("#node-input-blogchangesidebar-numOfUpdates").val()
        ); if (numChanges > 0) {
            blogPageNodes.length = numChanges;
        }

        var items = [];
        var nodeItemMap = {};
        var definedAsNew = Date.now() - (1000 * 60 * 60 * 12); //last 12 hours

        blogPageNodes.forEach(function (nde) {
            var nId = nde.id;
            var n = RED.nodes.node(nId);

            var blogInfoNode = { reloadOnEdit: false };
            RED.nodes.getNodeLinks(nId).forEach(function (lnk) {
                if (lnk.target.type == "BlogPageInfo") {
                    blogInfoNode = RED.nodes.node(lnk.target.id);
                }
            });

            nodeItemMap[n.id] = {
                node:     n,
                label:    "",
                _label:   RED.utils.getNodeLabel(n),
                icon:     RED.utils.createNodeIcon(n, true),
                class:    "",
                sublabel: n.updatedAt.replace(/T/, ' ').replace(/....Z$/, ''),
                selected: false,
                checkbox: false,
                children: undefined
            };

            items.push(nodeItemMap[n.id]);
        });

        blogChangesListing.treeList('data', items);
    }

    $("#node-input-blogchangesidebar-numOfUpdates").on("change", updateBlogChanges)
    $('#node-input-blogchangesidebar-refresh-button').on('click', updateBlogChanges);

    /* 
     * Setup the code for the tab tracker.
     */
    RED.events.on("workspace:change", (evnt) => {
        let newitem = {
            class: "",
            selected: true,
            checkbox: false,
            children: undefined
        }

        let obj = RED.nodes.workspace(evnt.workspace)
        if ( obj ) {
            newitem = {
                ...newitem,
                obj: obj,
                label: "",
                _label: RED.utils.getNodeLabel(obj), 
                icon: RED.utils.createNodeIcon(obj, true),
                sublabel: 'tab',
            }
        }

        obj = RED.nodes.subflow(evnt.workspace)
        if ( obj ) {
            newitem = { 
                ...newitem,
                obj: obj,
                label: "",
                _label: RED.utils.getNodeLabel(obj), 
                icon: RED.utils.createNodeIcon(obj, true),
                sublabel: 'subflow',
            }
        }

        /* This moves the new item to the top if the stack even if it was already in the stack
         *
         * This behaviour is confusing so try something else ....
        if ( newitem.obj ) {
            let olddata = $('#node-input-blogchangesidebar-tab-tracker').treeList('data').map( (itm) => {
                return {
                    class: "",
                    selected: false,
                    checkbox: false,
                    children: undefined,
                    obj: itm.obj,
                    label: itm.label,
                    icon: itm.icon,
                    sublabel: itm.sublabel
                }
            }).filter( itm => itm.obj.id != newitem.obj.id )

            $('#node-input-blogchangesidebar-tab-tracker').treeList('data', [newitem, ...olddata])
        }
        */

        /* this behaviour leaves the stack, only placing the new item on top IFF it doesn't already
         * exist in the statck.
         */
        if ( newitem.obj ) {
            let olddata = $('#node-input-blogchangesidebar-tab-tracker').treeList('data').map( (itm) => {
                return {
                    class:    "",
                    selected: newitem.obj.id == itm.obj.id, // select the newitem, regardless where it is in the list
                    checkbox: false,
                    children: undefined,
                    obj:      itm.obj,
                    _label:   itm._label,
                    label:    itm.label,
                    icon:     itm.icon,
                    sublabel: itm.sublabel
                }
            })

            if ( !olddata.some( itm => itm.obj.id == newitem.obj.id) ) {
                // new item isn't already in the treelist
                $('#node-input-blogchangesidebar-tab-tracker').treeList('data', [newitem, ...olddata])
            } else {
                // newitem is in the list and will be highlighted becuase it has been selected.
                $('#node-input-blogchangesidebar-tab-tracker').treeList('data', olddata)
            }
        }
    })

    var tabTrackerListing = setupTabTrackerTreelist();

    var tabTrackerSearch = $("#node-input-blogchangesidebar-tab-tracker-filter").searchBox({
        style: "compact",
        delay: 300,
        change: function () {
            var val = $(this).val().trim().toLowerCase();
            if (val === "") {
                tabTrackerListing.treeList("filter", null);
                tabTrackerSearch.searchBox("count", "");
            } else {
                var count = tabTrackerListing.treeList("filter", function (item) {
                    return item._label.toLowerCase().indexOf(val) > -1
                });
                tabTrackerSearch.searchBox("count", count + " / " + tabTrackerListing.treeList('data').length);
            }
        }
    });

    $('#node-input-blogchangesidebar-clear-stack-button').on('click', (e) => {
        if (e) e.preventDefault();

        $('#node-input-blogchangesidebar-tab-tracker').treeList('empty');
        $('#node-input-blogchangesidebar-tab-tracker').treeList('data', []);
    });


    // ensure all functions are defined that are used in the 'onchange' callback before
    // setting the default tab.
    tabs.activateTab("func-blogpagessidebar-tab-blogchanges");
};

RED.events.on('runtime-state', initialiseSidebarNodeOnce);
  
})();
</script>

<style>
   .duplicate-path {
      background-color: #f6c1cc !important;
   }
</style>

<!-- the html for the right sidebar plugin screen -->
<script type="text/x-red" data-template-name="BlogPagesSidebar">
<div class="form-row func-blogcntrlsidebar-tabs-row">
    <ul style="min-width: 600px; margin-bottom: 20px;" id="func-blogcntrlsidebar-tabs"></ul>
</div>

<div id="func-blogcntrlsidebar-tabs-content" style="min-height: calc(100% - 95px);">
    <div id="func-blogpagessidebar-tab-blogchanges" style="display:none">

    <div class="form-row" style="margin-left: 10px; margin-top: 30px;">
        <button id="node-input-blogchangesidebar-refresh-button"
     class="red-ui-button"><i class="fa fa-shower"></i> Refresh</button>
        <select id="node-input-blogchangesidebar-numOfUpdates"></select>
    </div>

    <div class="form-row node-input-target-row node-input-target-list-row"
        style="min-height: 250px; height: 450px; margin-left: 10px; margin-right: 15px;">
        <div>
            <label for="node-input-blogchangesidebar-target-filter" style="width: 100%">
                    <span>Search Blog Latest Changes: </span>
                </label>
            <input type="text" id="node-input-blogchangesidebar-target-filter">
        </div>

        <div id="node-input-blogchangesidebar-target-container-div" style="margin-top:10px; min-height: 450px;"></div>
    </div>

    <div class="form-row node-input-target-row node-input-target-list-row"
        style="min-height: 300px; height: 300px; margin-left: 10px; margin-right: 15px; margin-top: 120px;">
        <div>
            <label for="node-input-blogchangesidebar-tab-tracker-filter" style="width: 100%">
                        <span>Search Tab Stack: </span>
                    </label>
            <input type="text" id="node-input-blogchangesidebar-tab-tracker-filter">
        </div>

        <div id="node-input-blogchangesidebar-tab-tracker" style="margin-top:10px; min-height: 300px;"></div>
    </div>
    
    <div class="form-row" style="margin-left: 10px; margin-top: 100px;">
        <button id="node-input-blogchangesidebar-clear-stack-button"
             class="red-ui-button"><i class="fa fa-shower"></i> Clear Stack</button>
    </div>
</div>

    <div id="func-blogpagessidebar-tab-mindmap-stats" style="display:none">

    <div class="form-row" style="margin-left: 10px; margin-top: 30px;">
        <select id="node-input-mindmap-stats-numOfUpdates"></select>

        <span style="margin-left: 10px;" id="mindmap-stats-nodeCount-selection">0</span> /
        <span id="mindmap-stats-nodeCount">0</span> Texts |
        <span id="mindmap-stats-byteLength-selection">0</span> /
        <span id="mindmap-stats-byteLength">0</span> Words
    </div>

    <div class="form-row" style="margin-left: 10px;">
        <label for="mindmap-stats-only-selected-nodes" style="width: 40%;"><i class="fa fa-search" ></i> Only selected nodes?</label>
        <input style="width: 10%;" type="checkbox" id="mindmap-stats-only-selected-nodes"/>
    </div>

    <div class="form-row" style="margin-left: 10px;">
        <label for="mindmap-stats-reverse-sorting" style="width: 40%;"><i class="fa fa-search" ></i> Reverse sorting?</label>
        <input style="width: 10%;" type="checkbox" id="mindmap-stats-reverse-sorting"/>
    </div>

    <div class="form-row" style="margin-left: 10px;">
        <button id="node-input-mindmap-stats-refresh-button"
         class="red-ui-button"><i class="fa fa-shower"></i> Refresh</button>
    </div>

    <div class="form-row node-input-target-row node-input-target-list-row"
        style="min-height: 300px; height: 500px; margin-left: 10px; margin-right: 15px;">
        <div>
            <label for="node-input-mindmap-stats-target-filter">
                        <span>Search: </span>
                    </label>
            <input type="text" id="node-input-mindmap-stats-target-filter">
        </div>

        <div id="node-input-mindmap-stats-target-container-div" style="margin-top:10px; min-height: 500px;"></div>
    </div>
</div>
</div>
</script>
